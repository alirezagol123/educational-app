<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>مِنو - تحلیل سوال</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
                // Check login status on page load - DISABLED FOR NOW
        function checkLoginStatus() {
            // Set default user data for testing
            if (!localStorage.getItem('user_id')) {
                localStorage.setItem('user_id', '1');
                localStorage.setItem('is_verified', 'true');
                localStorage.setItem('user_phone', '+1234567890');
            }
            return true;
        }
        
        // Check login status immediately - DISABLED FOR NOW
        checkLoginStatus();
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'meno-blue': '#3B82F6',
                        'meno-gray': '#6B7280',
                        'meno-light-gray': '#F3F4F6'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 1rem; /* 16px */
            line-height: 1.6;
        }
        
        .question-container {
            background: linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 100%);
            border-radius: 3.125rem; /* 50px */
            transition: all 0.3s ease;
        }
        
        .question-container.biology {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
        }
        
        .choice-button {
            transition: all 0.2s ease;
            border-radius: 1.875rem; /* 30px */
        }
        
        .choice-button:hover {
            transform: translateY(-0.125rem); /* -2px */
            box-shadow: 0 0.5rem 1.5625rem rgba(0, 0, 0, 0.15); /* 0 8px 25px */
        }
        
        .choice-button.selected {
            background-color: #F3F4F6;
            color: #374151;
            border-color: #D1D5DB;
            transform: scale(1.02);
        }
        
        .choice-button.correct {
            background-color: #10B981;
            color: white;
            border-color: #10B981;
        }
        
        .choice-button.incorrect {
            background-color: #EF4444;
            color: white;
            border-color: #EF4444;
        }
        
        /* Navigation icon states */
        .nav-icon {
            color: #9CA3AF; /* Pale gray for inactive icons */
            transition: color 0.3s ease;
        }
        
        .nav-icon.active {
            color: #374151; /* Full color for active icon */
        }
        
        .nav-icon:hover {
            color: #6B7280; /* Slightly darker on hover */
        }
        
        .analysis-section {
            transition: all 0.3s ease;
            border-radius: 3.125rem; /* 50px */
        }
        
        .analysis-section.hidden {
            opacity: 0;
            transform: translateY(1.25rem); /* 20px */
            pointer-events: none;
        }
        
        .analysis-section.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .submit-button {
            border-radius: 1.875rem; /* 30px */
            transition: all 0.3s ease;
        }
        
        .submit-button:hover:not(:disabled) {
            transform: translateY(-0.125rem); /* -2px */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        
        /* Editable tabs styling */
        .editable-tab {
            position: relative;
            overflow: hidden;
        }
        
        .editable-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }
        
        .editable-tab:hover::before {
            transform: translateX(100%);
        }
        
        /* Modal animations */
        #selection-modal-overlay {
            animation: fadeIn 0.3s ease-out;
        }
        
        #selection-modal-overlay > div {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(1.25rem); } /* 20px */
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Critical mobile viewport fixes */
        html {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            overflow-x: hidden;
        }
        
        body {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        
        /* Prevent mobile zoom on input focus */
        input, textarea, select {
            font-size: 1rem !important; /* 16px */
        }
        
        /* Mobile Performance Optimizations */
        @media (max-width: 768px) {
            /* Fix mobile layout issues */
            html, body {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            main {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }
            
            .icons-container {
                width: 100% !important;
                max-width: 100% !important;
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }
        }
        
        /* Additional mobile fixes */
        @media (max-width: 480px) {
            /* Extra small screens */
            .icons-container {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }
            
            main {
                padding-left: 0.25rem !important;
                padding-right: 0.25rem !important;
            }
        }
        
        /* Ensure proper mobile layout on all devices */
        @media screen and (max-width: 1024px) {
            body {
                -webkit-text-size-adjust: 100%;
                -ms-text-size-adjust: 100%;
            }
            
            /* Force proper mobile layout */
            html {
                -webkit-text-size-adjust: 100%;
                -ms-text-size-adjust: 100%;
            }
            
            /* Ensure icons container stays at bottom */
        /* Removed conflicting bottom positioning CSS */
        }
        
        /* Comprehensive Mobile Media Queries */
        
        /* Extra Small Devices (phones, 320px and up) */
        @media (min-width: 320px) and (max-width: 479px) {
            html, body {
                font-size: 0.875rem; /* 14px */
            }
            
            .icons-container {
                padding: 0.75rem 0.5rem !important;
            }
            
            main {
                padding-left: 0.25rem !important;
                padding-right: 0.25rem !important;
            }
            
            .question-container {
                padding: 0.75rem !important;
                margin-bottom: 0.75rem !important;
            }
        }
        
        /* Small Devices (phones, 480px and up) */
        @media (min-width: 480px) and (max-width: 639px) {
            html, body {
                font-size: 1rem; /* 16px */
            }
            
            .icons-container {
                padding: 1rem 0.75rem !important;
            }
            
            .question-container {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }
        }
        
        /* Medium Devices (tablets, 640px and up) */
        @media (min-width: 640px) and (max-width: 767px) {
            html, body {
                font-size: 1.0625rem; /* 17px */
            }
            
            .icons-container {
                padding: 1rem 1rem !important;
            }
            
            .question-container {
                padding: 1.125rem !important;
                margin-bottom: 1.125rem !important;
            }
        }
        
        /* Large Devices (desktops, 768px and up) */
        @media (min-width: 768px) and (max-width: 1023px) {
            html, body {
                font-size: 1.125rem; /* 18px */
            }
            
            .icons-container {
                padding: 1.25rem 1.25rem !important;
            }
            
            .question-container {
                padding: 1.25rem !important;
                margin-bottom: 1.25rem !important;
            }
        }
        
        /* Extra Large Devices (large desktops, 1024px and up) */
        @media (min-width: 1024px) {
            html, body {
                font-size: 1.125rem; /* 18px */
            }
            
            .icons-container {
                padding: 1.5rem 1.5rem !important;
            }
            
            .question-container {
                padding: 1.5rem !important;
                margin-bottom: 1.5rem !important;
            }
        }
    </style>
</head>
<body style="background-color: #F8F9FA;">
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 border-b border-gray-200 z-50" style="background-color: #F8F9FA;">
        <div class="flex justify-between items-center px-6 py-4">
            <!-- Left: Spacer for balance -->
            <div class="w-10"></div>
            
            <!-- Center: Page Title -->
            <div class="text-center">
                <h1 class="text-xl font-bold text-gray-900">تحلیل سوال</h1>
            </div>
            
            <!-- Right: Close Button (X) -->
            <button class="p-2 hover:bg-gray-200 rounded-lg transition-colors" onclick="goBack()">
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Content -->
            <main class="pt-20 pb-24 px-6" style="background-color: #F8F9FA;">
        <div class="max-w-4xl mx-auto">
            <!-- Question Section -->
            <div id="question-container" class="question-container shadow-2xl p-8 mb-8">
                <div class="mb-6 text-center">
                    <!-- Chapter Information -->
                    <div id="chapter-info" class="flex items-center justify-center space-x-3 space-x-reverse mb-4">
                        <!-- Chapter info will be populated by JavaScript -->
                    </div>
                    
                    <span class="inline-block bg-white bg-opacity-80 text-gray-800 text-lg font-bold px-6 py-2 rounded-full shadow-lg">
                        سوال <span id="question-number">۱</span>
                    </span>
                </div>
                
                <h2 id="question-text" class="text-xl font-bold text-gray-900 mb-8 leading-relaxed text-center">
                    <!-- Question text will be populated by JavaScript -->
                </h2>
                
                <!-- Multiple Choice Options -->
                <div id="choices-container" class="space-y-4 mb-8">
                    <!-- Choices will be populated by JavaScript -->
                </div>
                
                <!-- Action Buttons -->
                <div id="action-buttons" class="mt-6">
                    <div class="flex space-x-4 max-w-md mx-auto">
                                                 <!-- Answer Button -->
                         <button id="submit-btn" 
                                 class="submit-button flex-1 bg-gradient-to-r from-green-100 to-green-200 text-green-800 font-bold py-3 px-6 text-lg hover:from-green-200 hover:to-green-300 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg rounded-full"
                                 onclick="submitAnswer()" disabled>
                             پاسخ
                         </button>
                         
                         <!-- Next Question Button -->
                         <button id="next-question-btn" 
                                 class="submit-button flex-1 bg-gradient-to-r from-blue-100 to-blue-200 text-blue-800 font-bold py-3 px-6 text-lg hover:from-blue-200 hover:to-blue-300 transition-all shadow-lg rounded-full"
                                 onclick="loadNextQuestion()">
                             سوال بعدی
                         </button>
                    </div>
                </div>
            </div>

            <!-- Loading State (Hidden by default) -->
            <div id="question-submit-loading" class="question-container shadow-2xl p-8 mb-8 hidden">
                <div class="text-center">
                    <div class="mb-6">
                        <div class="inline-block bg-white bg-opacity-80 text-gray-800 text-lg font-bold px-6 py-2 rounded-full shadow-lg">
                            سوال <span id="loading-question-number">۱</span>
                        </div>
                    </div>
                    
                    <h2 id="loading-question-text" class="text-xl font-bold text-gray-900 mb-8 leading-relaxed text-center">
                        <!-- Question text will be populated by JavaScript -->
                    </h2>
                    
                    <!-- Loading Animation -->
                    <div class="flex flex-col items-center justify-center py-12">
                        <div class="spinning-logo-container mb-6">
                            <div class="thinking-text text-lg font-semibold text-gray-700 mb-4">در حال تحلیل پاسخ...</div>
                            <div class="loading-dots flex space-x-2">
                                <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce"></div>
                                <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                                <div class="w-3 h-3 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm">لطفاً صبر کنید...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Mobile Navigation - Matching Chat Page Icons -->
    <div class="icons-container fixed bottom-0 left-0 right-0 pt-2 pb-0 px-6 flex justify-around items-center space-x-8 z-40 shadow-lg" style="background-color: #E8E8E4;">
        <!-- First Icon: Circle with tick inside (Test page) -->
        <button class="icon-button p-2 hover:text-gray-600 transition-colors" onclick="window.location.href='test.html'">
            <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke-width="2"/>
                <path d="M9 12l2 2 4-4" stroke-width="2"/>
            </svg>
        </button>
        
        <!-- Second Icon: Open book (Library) -->
        <button class="icon-button p-2 hover:text-gray-600 transition-colors" onclick="window.location.href='library.html'">
            <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" stroke-width="2"/>
            </svg>
        </button>
        
        <!-- Third Icon: Document with pencil (Chat page) -->
        <button class="icon-button p-2 hover:text-gray-600 transition-colors" onclick="window.location.href='index.html'">
            <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke-width="2"/>
                <path d="M14 2v6h6" stroke-width="2"/>
                <path d="M16 13H8" stroke-width="2"/>
                <path d="M16 17H8" stroke-width="2"/>
                <path d="M10 9H8" stroke-width="2"/>
            </svg>
        </button>
    </div>

    <script>
        let selectedChoice = null;
        let currentSubject = '';
        let currentGrade = '';
        let currentField = '';
        let currentChapter = '';
        let currentBook = '';
        let currentQuestion = null;
        let questionIndex = 0;

        // Chapter data for display
        const chaptersData = {
            math: {
                'دهم': [
                    { 
                        number: 1, 
                        name: 'الگوها و دنباله‌ها', 
                        persian: 'الگوها و دنباله‌ها',
                        questions: [
                            {
                                book: "میکروطلایی گاج",
                                question: "در یک دنباله حسابی، اگر جمله اول ۵ و قدر نسبت ۳ باشد، جمله پنجم چند است؟",
                                options: [
                                    "A. ۱۷",
                                    "B. ۲۰",
                                    "C. ۲۳",
                                    "D. ۲۹"
                                ]
                            },
                            {
                                book: "مهروماه",
                                question: "اگر در یک دنباله هندسی، جمله اول a و قدر نسبت r باشد، شرط لازم برای همگرایی مجموع بی‌نهایت جمله‌ها چیست؟",
                                options: [
                                    "A. |r| > ۱",
                                    "B. |r| < ۱",
                                    "C. r = ۱",
                                    "D. r < ۰"
                                ]
                            },
                            {
                                book: "خیلی سبز",
                                question: "در دنباله فیبوناچی که با ۱ و ۱ شروع می‌شود، نسبت جمله n+۱ به جمله n با افزایش n به چه عددی میل می‌کند؟",
                                options: [
                                    "A. عدد طلایی (۱ + √۵)/۲",
                                    "B. عدد e",
                                    "C. π",
                                    "D. √۲"
                                ]
                            }
                        ]
                    },
                    { 
                        number: 2, 
                        name: 'مثلثات', 
                        persian: 'مثلثات',
                        questions: [
                            {
                                book: "میکروطلایی گاج",
                                question: "اگر در یک مثلث قائم‌الزاویه، زاویه تند θ باشد و ضلع مقابل آن ۳ و وتر ۵ باشد، مقدار sin(θ) برابر است با:",
                                options: [
                                    "A. ۳/۵",
                                    "B. ۴/۵",
                                    "C. ۳/۴",
                                    "D. ۵/۳"
                                ]
                            },
                            {
                                book: "مهروماه",
                                question: "کدام یک از روابط زیر برای هر زاویه θ صادق است؟",
                                options: [
                                    "A. sin²(θ) + cos²(θ) = ۱",
                                    "B. sin(θ) + cos(θ) = ۱",
                                    "C. tan(θ) = sin(θ) + cos(θ)",
                                    "D. cot(θ) = ۱/sin(θ)"
                                ]
                            },
                            {
                                book: "خیلی سبز",
                                question: "اگر tan(θ) = ۲ و θ در ربع اول باشد، مقدار cos(θ) برابر است با:",
                                options: [
                                    "A. ۱/√۵",
                                    "B. ۲/√۵",
                                    "C. ۱/√۳",
                                    "D. √۵/۲"
                                ]
                            }
                        ]
                    },
                    { 
                        number: 3, 
                        name: 'توان‌های گویا و عبارات جبری', 
                        persian: 'توان‌های گویا و عبارات جبری',
                        questions: [
                            {
                                book: "میکروطلایی گاج",
                                question: "مقدار عبارت \\( 2^{1/3} \\times 2^{2/3} \\) برابر است با:",
                                options: [
                                    "A. ۲",
                                    "B. ۴",
                                    "C. ۸",
                                    "D. ۱۶"
                                ]
                            },
                            {
                                book: "مهروماه",
                                question: "اگر \\( x = \\sqrt[3]{8} \\) و \\( y = 2^{-1} \\)، مقدار \\( x^2 y \\) برابر است با:",
                                options: [
                                    "A. ۱",
                                    "B. ۲",
                                    "C. ۴",
                                    "D. ۸"
                                ]
                            },
                            {
                                book: "خیلی سبز",
                                question: "عبارت \\( \\frac{a^2 - b^2}{a - b} \\) با فرض \\( a \\neq b \\) ساده می‌شود به:",
                                options: [
                                    "A. a + b",
                                    "B. a - b",
                                    "C. a² + b²",
                                    "D. ab"
                                ]
                            }
                        ]
                    }
                ],
                'یازدهم': [
                    { 
                        number: 1, 
                        name: 'هندسه تحلیلی', 
                        persian: 'هندسه تحلیلی',
                        questions: [
                            {
                                book: "میکروطلایی گاج",
                                question: "در یک دستگاه مختصات، معادله خطی \\( y = 2x - 3 \\) چه تعداد نقطه تقاطع با محور \\( x \\) دارد و مختصات آن چیست؟",
                                options: [
                                    "A. یک نقطه، \\( (1.5, 0) \\)",
                                    "B. یک نقطه، \\( (3, 0) \\)",
                                    "C. دو نقطه، \\( (1.5, 0) \\) و \\( (-1.5, 0) \\)",
                                    "D. هیچ نقطه‌ای"
                                ]
                            },
                            {
                                book: "مهروماه",
                                question: "اگر تابع \\( f(x) = 3x + 5 \\) باشد، معکوس این تابع \\( f^{-1}(x) \\) کدام است؟",
                                options: [
                                    "A. f^{-1}(x) = \\frac{x - 5}{3}",
                                    "B. f^{-1}(x) = \\frac{x + 5}{3}",
                                    "C. f^{-1}(x) = 3x - 5",
                                    "D. f^{-1}(x) = \\frac{3}{x - 5}"
                                ]
                            },
                            {
                                book: "خیلی سبز",
                                question: "در یک دستگاه مختصات، فاصله بین دو نقطه \\( A(2, 3) \\) و \\( B(-1, 7) \\) برابر است با:",
                                options: [
                                    "A. ۵",
                                    "B. √۲۰",
                                    "C. √۲۹",
                                    "D. √۳۴"
                                ]
                            }
                        ]
                    },
                    { 
                        number: 2, 
                        name: 'توابع نمایی و لگاریتمی', 
                        persian: 'توابع نمایی و لگاریتمی',
                        questions: [
                            {
                                book: "میکروطلایی گاج",
                                question: "اگر \\( 2^x = 8 \\)، مقدار \\( x \\) برابر است با:",
                                options: [
                                    "A. ۲",
                                    "B. ۳",
                                    "C. ۴",
                                    "D. ۸"
                                ]
                            },
                            {
                                book: "مهروماه",
                                question: "مقدار \\( \\log_2(16) + \\log_3(9) \\) برابر است با:",
                                options: [
                                    "A. ۴",
                                    "B. ۶",
                                    "C. ۸",
                                    "D. ۱۰"
                                ]
                            },
                            {
                                book: "خیلی سبز",
                                question: "اگر \\( f(x) = e^{2x} \\) باشد و \\( g(x) = \\ln(x) \\)، ترکیب تابع \\( f(g(x)) \\) برابر است با:",
                                options: [
                                    "A. x²",
                                    "B. e^{x²}",
                                    "C. x",
                                    "D. e^{2\\ln(x)}"
                                ]
                            }
                        ]
                    },
                    { 
                        number: 3, 
                        name: 'حد و پیوستگی', 
                        persian: 'حد و پیوستگی',
                        questions: [
                            {
                                book: "میکروطلایی گاج",
                                question: "حد \\( \\lim_{x \\to 2} \\frac{x^2 - 4}{x - 2} \\) برابر است با:",
                                options: [
                                    "A. ۲",
                                    "B. ۴",
                                    "C. ۶",
                                    "D. حد وجود ندارد"
                                ]
                            },
                            {
                                book: "مهروماه",
                                question: "کدام یک از شرایط زیر برای پیوستگی تابع \\( f(x) \\) در نقطه \\( x = c \\) ضروری نیست؟",
                                options: [
                                    "A. وجود حد \\( \\lim_{x \\to c} f(x) \\)",
                                    "B. تعریف بودن \\( f(c) \\)",
                                    "C. برابر بودن \\( \\lim_{x \\to c} f(x) = f(c) \\)",
                                    "D. صعودی بودن تابع در اطراف \\( x = c \\)"
                                ]
                            },
                            {
                                book: "خیلی سبز",
                                question: "اگر \\( f(x) = \\frac{1}{x - 3} \\)، حد چپ و راست تابع در \\( x = 3 \\) به ترتیب کدام است؟",
                                options: [
                                    "A. منفی بی‌نهایت و مثبت بی‌نهایت",
                                    "B. مثبت بی‌نهایت و منفی بی‌نهایت",
                                    "C. صفر و صفر",
                                    "D. حد وجود ندارد"
                                ]
                            }
                        ]
                    }
                ],
                'دوازدهم': [
                    { 
                        number: 1, 
                        name: 'مشتق', 
                        persian: 'مشتق',
                        questions: [
                            {
                                book: "میکروطلایی گاج",
                                question: "اگر تابع \\( f(x) = x^4 - 4x^2 + 3 \\) باشد، نقاطی که در آن‌ها مشتق اول صفر است، کدام‌اند؟",
                                options: [
                                    "A. x = 0, x = ±1",
                                    "B. x = ±√2",
                                    "C. x = 0, x = ±√2",
                                    "D. x = ±1, x = ±√2"
                                ]
                            },
                            {
                                book: "مهروماه",
                                question: "مشتق دوم تابع \\( f(x) = \\sin(2x) + \\cos(x) \\) در نقطه \\( x = \\frac{\\pi}{2} \\) برابر است با:",
                                options: [
                                    "A. -۳",
                                    "B. -۱",
                                    "C. ۱",
                                    "D. ۳"
                                ]
                            },
                            {
                                book: "خیلی سبز",
                                question: "اگر \\( f(x) = e^{2x} \\cdot \\ln(x) \\)، مشتق تابع \\( f'(x) \\) کدام است؟",
                                options: [
                                    "A. 2e^{2x} \\cdot \\ln(x) + \\frac{e^{2x}}{x}",
                                    "B. e^{2x} \\cdot \\ln(x) + \\frac{e^{2x}}{x}",
                                    "C. 2e^{2x} \\cdot \\ln(x) + e^{2x}",
                                    "D. e^{2x} \\cdot \\ln(x) + \\frac{2e^{2x}}{x}"
                                ]
                            }
                        ]
                    },
                    { 
                        number: 2, 
                        name: 'کاربردهای مشتق', 
                        persian: 'کاربردهای مشتق',
                        questions: [
                            {
                                book: "میکروطلایی گاج",
                                question: "تابع \\( f(x) = x^3 - 3x^2 + 4 \\) در کدام بازه صعودی است؟",
                                options: [
                                    "A. (-∞, 0) ∪ (2, +∞)",
                                    "B. (0, 2)",
                                    "C. (-∞, 1) ∪ (2, +∞)",
                                    "D. (1, +∞)"
                                ]
                            },
                            {
                                book: "مهروماه",
                                question: "نقطه اکسترمم نسبی تابع \\( f(x) = 2x^3 - 6x^2 + 6x + 1 \\) در کدام نقطه رخ می‌دهد و نوع آن چیست؟",
                                options: [
                                    "A. x = 1، بیشینه",
                                    "B. x = 1، کمینه",
                                    "C. x = 0، بیشینه",
                                    "D. x = 0، کمینه"
                                ]
                            },
                            {
                                book: "خیلی سبز",
                                question: "اگر سرعت یک متحرک در زمان \\( t \\) بر حسب \\( v(t) = 3t^2 - 12t + 9 \\) باشد، در چه زمانی شتاب متحرک صفر است؟",
                                options: [
                                    "A. t = 1",
                                    "B. t = 2",
                                    "C. t = 3",
                                    "D. t = 4"
                                ]
                            }
                        ]
                    },
                    { 
                        number: 3, 
                        name: 'انتگرال', 
                        persian: 'انتگرال',
                        questions: [
                            {
                                book: "میکروطلایی گاج",
                                question: "انتگرال نامعین \\( \\int (3x^2 + 2x + 1) \\, dx \\) برابر است با:",
                                options: [
                                    "A. x³ + x² + x + C",
                                    "B. 3x³ + x² + x + C",
                                    "C. x³ + 2x² + x + C",
                                    "D. 3x³ + 2x² + x + C"
                                ]
                            },
                            {
                                book: "مهروماه",
                                question: "مقدار انتگرال معین \\( \\int_{0}^{1} (2x + 1) \\, dx \\) برابر است با:",
                                options: [
                                    "A. ۱",
                                    "B. ۲",
                                    "C. ۳",
                                    "D. ۴"
                                ]
                            },
                            {
                                book: "خیلی سبز",
                                question: "اگر \\( f(x) = x^2 \\) و \\( F(x) \\) انتگرال نامعین \\( f(x) \\) باشد، مقدار \\( F(2) - F(1) \\) برابر است با:",
                                options: [
                                    "A. ۷/۳",
                                    "B. ۸/۳",
                                    "C. ۵/۳",
                                    "D. ۴/۳"
                                ]
                            }
                        ]
                    }
                ]
            },
            biology: {
                'دهم': [
                     { 
                         number: 1, 
                         name: 'جهان زنده', 
                         persian: 'جهان زنده',
                         questions: [
                             {
                                 book: "IQ گاج",
                                 question: "کدام یک از ویژگی‌های زیر برای همه موجودات زنده صدق می‌کند؟",
                                 options: [
                                     "A. حرکت مستقل",
                                     "B. تنفس هوازی",
                                     "C. رشد و نمو",
                                     "D. تولید مثل جنسی"
                                 ]
                             },
                             {
                                 book: "خیلی سبز",
                                 question: "کدام سطح سازمان‌یافتگی در موجودات زنده، شامل مجموعه‌ای از مولکول‌ها است که با هم یک ساختار عملکردی را تشکیل می‌دهند؟",
                                 options: [
                                     "A. سلول",
                                     "B. بافت",
                                     "C. اندامک",
                                     "D. دستگاه"
                                 ]
                             },
                             {
                                 book: "ازمونیوم مهر و ماه",
                                 question: "کدام یک از موارد زیر به عنوان شاخه‌ای از زیست‌شناسی به مطالعه روابط موجودات زنده با محیط اطرافشان می‌پردازد؟",
                                 options: [
                                     "A. ژنتیک",
                                     "B. اکولوژی",
                                     "C. فیزیولوژی",
                                     "D. میکروبیولوژی"
                                 ]
                             }
                         ]
                     },
                     { 
                         number: 2, 
                         name: 'هضم و جذب', 
                         persian: 'هضم و جذب',
                         questions: [
                             {
                                 book: "IQ گاج",
                                 question: "کدام یک از ساختارهای زیر در گوارش شیمیایی کربوهیدرات‌ها در دهان نقش دارد؟",
                                 options: [
                                     "A. آمیلاز بزاقی",
                                     "B. لیپاز معدی",
                                     "C. پپسین",
                                     "D. تریپسین"
                                 ]
                             },
                             {
                                 book: "خیلی سبز",
                                 question: "کدام بخش از دستگاه گوارش انسان بیشترین جذب مواد مغذی را انجام می‌دهد؟",
                                 options: [
                                     "A. معده",
                                     "B. روده باریک",
                                     "C. روده بزرگ",
                                     "D. مری"
                                 ]
                             },
                             {
                                 book: "ازمونیوم مهر و ماه",
                                 question: "نقش اصلی کیسه صفرا در دستگاه گوارش چیست؟",
                                 options: [
                                     "A. تولید صفرا",
                                     "B. ذخیره و ترشح صفرا",
                                     "C. گوارش پروتئین‌ها",
                                     "D. جذب ویتامین‌ها"
                                 ]
                             }
                         ]
                     },
                                         { 
                         number: 3, 
                         name: 'تبادل گازها', 
                         persian: 'تبادل گازها',
                         questions: [
                             {
                                 book: "IQ گاج",
                                 question: "کدام ساختار در دستگاه تنفسی انسان مسئول اصلی تبادل گازها بین خون و هوای تنفسی است؟",
                                 options: [
                                     "A. نای",
                                     "B. کیسه‌های هوایی",
                                     "C. نایژه‌ها",
                                     "D. حنجره"
                                 ]
                             },
                             {
                                 book: "خیلی سبز",
                                 question: "در فرآیند تنفس سلولی، اکسیژن در نهایت در کدام بخش سلول مصرف می‌شود؟",
                                 options: [
                    "A. هسته",
                                     "B. میتوکندری",
                                     "C. شبکه آندوپلاسمی",
                                     "D. دستگاه گلژی"
                                 ]
                             },
                             {
                                 book: "ازمونیوم مهر و ماه",
                                 question: "کدام گاز در خون عمدتاً به صورت ترکیب با هموگلوبین حمل می‌شود؟",
                                 options: [
                                     "A. دی‌اکسید کربن",
                                     "B. نیتروژن",
                                     "C. اکسیژن",
                                     "D. مونوکسید کربن"
                                 ]
                             }
                         ]
                     }
                ],
                'یازدهم': [
                    { 
                        number: 1, 
                        name: 'تنظیم عصبی', 
                        persian: 'تنظیم عصبی',
                        questions: [
                            {
                                book: "IQ گاج",
                                question: "در یک نورون، اگر پتانسیل استراحت غشا حدود -70 میلی‌ولت باشد و در اثر تحریک، پتانسیل عمل به +30 میلی‌ولت برسد، این تغییر پتانسیل عمدتاً به دلیل حرکت کدام یون‌ها از طریق کانال‌های غشایی است؟",
                                options: [
                                    "A. ورود یون‌های پتاسیم و خروج یون‌های سدیم",
                                    "B. ورود یون‌های سدیم و خروج یون‌های پتاسیم",
                                    "C. ورود یون‌های کلسیم و خروج یون‌های کلر",
                                    "D. خروج یون‌های کلسیم و ورود یون‌های پتاسیم"
                                ]
                            },
                            {
                                book: "خیلی سبز",
                                question: "کدام یک از موارد زیر در مورد نقش هسته‌های قاعده‌ای در مغز صحیح است؟",
                                options: [
                                    "A. تنظیم ضربان قلب و تنفس",
                                    "B. کنترل حرکات ارادی و هماهنگی آن‌ها",
                                    "C. پردازش اطلاعات حسی مانند بینایی",
                                    "D. تنظیم چرخه خواب و بیداری"
                                ]
                            },
                            {
                                book: "ازمونیوم مهر و ماه",
                                question: "اگر در یک سیناپس شیمیایی، آزاد شدن انتقال‌دهنده عصبی به دلیل کمبود یون‌های کلسیم متوقف شود، کدام مرحله از انتقال پیام عصبی مختل می‌شود؟",
                                options: [
                                    "A. تولید پتانسیل عمل در نورون پس‌سیناپسی",
                                    "B. ورود یون‌های سدیم به آکسون",
                                    "C. آزاد شدن انتقال‌دهنده عصبی به فضای سیناپسی",
                                    "D. بازجذب انتقال‌دهنده عصبی توسط نورون پیش‌سیناپسی"
                                ]
                            }
                        ]
                    },
                    { 
                        number: 2, 
                        name: 'حواس', 
                        persian: 'حواس',
                        questions: [
                            {
                                book: "IQ گاج",
                                question: "کدام یک از سلول‌های گیرنده در شبکیه چشم، مسئول تشخیص رنگ‌ها در نور زیاد است و در دید مرکزی نقش اصلی دارد؟",
                                options: [
                                    "A. سلول‌های استوانه‌ای",
                                    "B. سلول‌های مخروطی",
                                    "C. سلول‌های گانگلیونی",
                                    "D. سلول‌های دوقطبی"
                                ]
                            },
                            {
                                book: "خیلی سبز",
                                question: "اگر در گوش داخلی، سلول‌های مویی در حلزون آسیب ببینند، کدام جنبه از حس شنوایی بیشتر تحت تأثیر قرار می‌گیرد؟",
                                options: [
                                    "A. تشخیص جهت منبع صدا",
                                    "B. تعادل و موقعیت بدن",
                                    "C. تشخیص شدت و فرکانس صدا",
                                    "D. انتقال ارتعاشات به استخوانچه‌ها"
                                ]
                            },
                            {
                                book: "ازمونیوم مهر و ماه",
                                question: "در حس چشایی، گیرنده‌های حسی برای کدام طعم به طور مستقیم با کانال‌های یونی سدیم در ارتباط هستند و نیازی به پروتئین G ندارند؟",
                                options: [
                                    "A. شیرین",
                                    "B. ترش",
                                    "C. شور",
                                    "D. تلخ"
                                ]
                            }
                        ]
                    },
                    { 
                        number: 3, 
                        name: 'دستگاه عضلانی اسکلتی', 
                        persian: 'دستگاه عضلانی اسکلتی',
                        questions: [
                            {
                                book: "IQ گاج",
                                question: "در فرآیند انقباض عضلانی، نقش اصلی یون‌های کلسیم در فیبرهای عضلانی چیست؟",
                                options: [
                                    "A. اتصال به میوزین برای شروع حرکت سر میوزین",
                                    "B. اتصال به تروپونین برای جابجایی تروپومیوزین و آزاد شدن جایگاه‌های اتصال اکتین",
                                    "C. فعال‌سازی آنزیم ATPآز برای تجزیه ATP",
                                    "D. افزایش نفوذپذیری غشای سارکولم به یون‌های سدیم"
                                ]
                            },
                            {
                                book: "خیلی سبز",
                                question: "کدام یک از موارد زیر در مورد تفاوت بین عضله اسکلتی و عضله صاف صحیح است؟",
                                options: [
                                    "A. عضله صاف دارای تارهای عرضی است، اما عضله اسکلتی خیر",
                                    "B. عضله اسکلتی تحت کنترل ارادی است، اما عضله صاف غیرارادی است",
                                    "C. عضله صاف از میتوکندری بیشتری نسبت به عضله اسکلتی برخوردار است",
                                    "D. عضله اسکلتی فاقد پروتئین‌های اکتین و میوزین است"
                                ]
                            },
                            {
                                book: "ازمونیوم مهر و ماه",
                                question: "اگر در یک مفصل زانو، رباط صلیبی قدامی (ACL) پاره شود، کدام عملکرد مفصل بیشتر تحت تأثیر قرار می‌گیرد؟",
                                options: [
                                    "A. خم شدن زانو به سمت عقب",
                                    "B. پایداری زانو در برابر جابجایی قدامی استخوان درشت‌نی",
                                    "C. چرخش جانبی زانو",
                                    "D. حفظ تعادل مایع سینوویال در مفصل"
                                ]
                            }
                        ]
                    }
                ],
                'دوازدهم': [
                    { 
                        number: 1, 
                        name: 'مولکول‌های اطلاعاتی', 
                        persian: 'مولکول‌های اطلاعاتی',
                        questions: [
                            {
                                book: "IQ گاج",
                                question: "کدام ویژگی DNA در مقایسه با RNA باعث پایداری بیشتر آن در برابر تجزیه شیمیایی می‌شود؟",
                                options: [
                                    "A. وجود قند ریبوز در ساختار RNA",
                                    "B. دو رشته‌ای بودن DNA در مقابل تک‌رشته‌ای بودن RNA",
                                    "C. حضور تیمین در DNA به جای یوراسیل در RNA",
                                    "D. اتصال فسفودی‌استر قوی‌تر در RNA"
                                ]
                            },
                            {
                                book: "خیلی سبز",
                                question: "در فرآیند همانندسازی DNA، آنزیم هلیکاز چه نقشی ایفا می‌کند و در کدام مرحله از این فرآیند دخیل است؟",
                                options: [
                                    "A. اتصال نوکلئوتیدها به رشته در حال ساخت، در مرحله طویل‌سازی",
                                    "B. باز کردن پیچ‌خوردگی‌های DNA، در مرحله آغاز",
                                    "C. اتصال قطعات اوکازاکی، در مرحله پایان",
                                    "D. تشکیل پرایمر RNA، در مرحله طویل‌سازی"
                                ]
                            },
                            {
                                book: "ازمونیوم مهر و ماه",
                                question: "اگر در یک قطعه DNA، توالی نوکلئوتیدی یک رشته 5'-AGCT-3' باشد، توالی رشته مکمل آن چیست؟",
                                options: [
                                    "A. 5'-TCGA-3'",
                                    "B. 3'-TCGA-5'",
                                    "C. 5'-AGCT-3'",
                                    "D. 3'-AGCT-5'"
                                ]
                            }
                        ]
                    },
                    { 
                        number: 2, 
                        name: 'جریان اطلاعات ژنتیکی در سلول', 
                        persian: 'جریان اطلاعات ژنتیکی در سلول',
                        questions: [
                            {
                                book: "IQ گاج",
                                question: "در فرآیند ترجمه (ترانسلیشن)، کدون AUG روی mRNA چه نقشی ایفا می‌کند و چه آمینواسیدی را کد می‌کند؟",
                                options: [
                                    "A. کدون توقف، هیچ آمینواسیدی",
                                    "B. کدون شروع، متیونین",
                                    "C. کدون شروع، فنیل‌آلانین",
                                    "D. کدون توقف، آرژنین"
                                ]
                            },
                            {
                                book: "خیلی سبز",
                                question: "اگر در فرآیند رونویسی، یک جهش نقطه‌ای باعث تغییر یک نوکلئوتید در ژن شود و این تغییر منجر به تشکیل کدون توقف زودرس شود، چه اتفاقی در پروتئین نهایی رخ می‌دهد؟",
                                options: [
                                    "A. پروتئین طولانی‌تر از حالت عادی تولید می‌شود",
                                    "B. پروتئین کوتاه‌تر و احتمالاً غیرفعال تولید می‌شود",
                                    "C. پروتئین با همان طول اما با یک آمینواسید متفاوت تولید می‌شود",
                                    "D. هیچ پروتئینی تولید نمی‌شود"
                                ]
                            },
                            {
                                book: "ازمونیوم مهر و ماه",
                                question: "کدام یک از موارد زیر به درستی نقش tRNA را در فرآیند ترجمه توصیف می‌کند؟",
                                options: [
                                    "A. حمل کدون‌های مکمل به ریبوزوم برای ساخت mRNA",
                                    "B. اتصال به DNA و کپی‌برداری از اطلاعات ژنتیکی",
                                    "C. حمل آمینواسیدها و تطبیق آنتی‌کدون با کدون‌های mRNA",
                                    "D. تشکیل ساختار ریبوزوم و کاتالیز پیوند پپتیدی"
                                ]
                            }
                        ]
                    },
                    { 
                        number: 3, 
                        name: 'انتقال اطلاعات ژنتیکی بین نسل‌ها', 
                        persian: 'انتقال اطلاعات ژنتیکی بین نسل‌ها',
                        questions: [
                            {
                                book: "IQ گاج",
                                question: "در یک جاندار دیپلوئید با دو جفت کروموزوم (2n=4)، اگر ژن A روی یک کروموزوم و ژن B روی کروموزوم دیگر باشد، در صورت وقوع نوترکیبی (crossing over) بین این دو ژن، چه درصدی از گامت‌ها حاوی ترکیب جدید AB خواهند بود؟",
                                options: [
                                    "A. 25%",
                                    "B. 50%",
                                    "C. 75%",
                                    "D. 100%"
                                ]
                            },
                            {
                                book: "خیلی سبز",
                                question: "اگر در یک صفت وابسته به جنس که روی کروموزوم X قرار دارد، زنی با ژنوتیپ X^aX^A و مردی با ژنوتیپ X^AY ازدواج کنند، احتمال اینکه فرزند پسر آن‌ها دارای صفت مغلوب باشد، چقدر است؟",
                                options: [
                                    "A. 0%",
                                    "B. 25%",
                                    "C. 50%",
                                    "D. 100%"
                                ]
                            },
                            {
                                book: "ازمونیوم مهر و ماه",
                                question: "کدام یک از موارد زیر به درستی قانون دوم مندل (تفکیک مستقل) را توضیح می‌دهد؟",
                                options: [
                                    "A. الل‌های یک ژن به طور مستقل از هم به گامت‌ها منتقل می‌شوند",
                                    "B. ژن‌های مختلف روی کروموزوم‌های غیرهومولوگ به طور مستقل از هم تفکیک می‌شوند",
                                    "C. الل‌های غالب همیشه در گامت‌ها نسبت به الل‌های مغلوب غالب هستند",
                                    "D. ژن‌های روی کروموزوم‌های هومولوگ همیشه با هم منتقل می‌شوند"
                                ]
                            }
                        ]
                    }
                ]
            }
        };





        // Get URL parameters
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            currentSubject = urlParams.get('subject') || 'math';
            currentGrade = urlParams.get('grade') || '12th';
            currentField = urlParams.get('field') || 'math';
            currentChapter = urlParams.get('chapter') || '1';
            currentBook = urlParams.get('book') || '';
            
            // Set default book if none selected
            if (!currentBook) {
                if (currentSubject === 'biology') {
                    currentBook = 'IQ گاج';
                } else if (currentSubject === 'math') {
                    currentBook = 'میکروطلایی گاج';
                }
            }
        }

        // Display chapter information in question card with clickable tabs
        function displayChapterInfo() {
            console.log('displayChapterInfo called with:', currentSubject, currentGrade, currentChapter, currentBook);
            
            const subjectNames = {
                'math': 'ریاضی',
                'biology': 'زیست‌شناسی'
            };

            const gradeNames = {
                'دهم': 'دهم',
                'یازدهم': 'یازدهم',
                'دوازدهم': 'دوازدهم'
            };

            // Get chapter data
            const chapters = chaptersData[currentSubject]?.[currentGrade];
            const chapter = chapters?.find(ch => ch.number == currentChapter);
            
            console.log('Found chapters:', chapters);
            console.log('Found chapter:', chapter);
            
            if (chapter) {
                const chapterInfo = document.getElementById('chapter-info');
                console.log('Updating chapter-info element:', chapterInfo);
                
                const newHTML = `
                    <button onclick="editSelection('subject')" class="editable-tab bg-gradient-to-r from-blue-100 to-blue-200 text-blue-800 px-4 py-2 rounded-full text-sm font-medium hover:from-blue-200 hover:to-blue-300 transition-all duration-200 cursor-pointer shadow-md hover:shadow-lg transform hover:scale-105">
                        ${subjectNames[currentSubject]} ${gradeNames[currentGrade]}
                        <svg class="w-4 h-4 inline-block mr-2 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                        </svg>
                    </button>
                    <button onclick="editSelection('chapter')" class="editable-tab bg-gradient-to-r from-green-100 to-green-200 text-green-800 px-4 py-2 rounded-full text-sm font-medium hover:from-green-200 hover:to-green-300 transition-all duration-200 cursor-pointer shadow-md hover:shadow-lg transform hover:scale-105">
                        فصل ${chapter.number}: ${chapter.persian}
                        <svg class="w-4 h-4 inline-block mr-2 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                        </svg>
                    </button>
                    <button onclick="editSelection('book')" class="editable-tab bg-gradient-to-r from-purple-100 to-purple-200 text-purple-800 px-4 py-2 rounded-full text-sm font-medium hover:from-purple-200 hover:to-purple-300 transition-all duration-200 cursor-pointer shadow-md hover:shadow-lg transform hover:scale-105">
                        ${currentBook || 'انتخاب کتاب'}
                        <svg class="w-4 h-4 inline-block mr-2 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                        </svg>
                    </button>
                `;
                
                console.log('New HTML:', newHTML);
                chapterInfo.innerHTML = newHTML;
                console.log('HTML updated successfully');
            } else {
                console.log('No chapter found for:', currentSubject, currentGrade, currentChapter);
            }
        }

        // Edit selection modal
        function editSelection(type) {
            showSelectionModal(type);
        }

        // Show selection modal
        function showSelectionModal(type) {
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'selection-modal-overlay';
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modalOverlay.onclick = () => hideSelectionModal();
            
            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.className = 'bg-white rounded-3xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto';
            modalContent.onclick = (e) => e.stopPropagation();
            
            let modalTitle = '';
            let options = [];
            
            switch(type) {
                case 'subject':
                    modalTitle = 'انتخاب درس و پایه';
                    options = [
                        { value: 'math-12th', label: 'ریاضی دوازدهم', color: 'from-blue-100 to-blue-200' },
                        { value: 'math-11th', label: 'ریاضی یازدهم', color: 'from-blue-100 to-blue-200' },
                        { value: 'math-10th', label: 'ریاضی دهم', color: 'from-blue-100 to-blue-200' },
                        { value: 'biology-12th', label: 'زیست‌شناسی دوازدهم', color: 'from-green-100 to-green-200' },
                        { value: 'biology-11th', label: 'زیست‌شناسی یازدهم', color: 'from-green-100 to-green-200' },
                        { value: 'biology-10th', label: 'زیست‌شناسی دهم', color: 'from-green-100 to-green-200' }
                    ];
                    break;
                case 'chapter':
                    modalTitle = 'انتخاب فصل';
                    const chapters = chaptersData[currentSubject]?.[currentGrade] || [];
                    options = chapters.map(ch => ({
                        value: ch.number,
                        label: `فصل ${ch.number}: ${ch.persian}`,
                        color: currentSubject === 'biology' ? 'from-green-100 to-green-200' : 'from-blue-100 to-blue-200'
                    }));
                    break;
                case 'book':
                    modalTitle = 'انتخاب کتاب';
                    let bookOptions = [];
                    if (currentSubject === 'biology' || currentSubject === 'math') {
                        // For both biology and math, only show books that have questions for the current chapter
                        const chapters = chaptersData[currentSubject]?.[currentGrade];
                        const chapter = chapters?.find(ch => ch.number == currentChapter);
                        if (chapter && chapter.questions && chapter.questions.length > 0) {
                            bookOptions = chapter.questions.map(q => q.book);
                        }
                    }
                    
                    options = bookOptions.map(book => ({
                        value: book,
                        label: book,
                        color: 'from-purple-100 to-purple-200'
                    }));
                    break;
            }
            
            modalContent.innerHTML = `
                <div class="text-center mb-6">
                    <h3 class="text-xl font-bold text-gray-900">${modalTitle}</h3>
                </div>
                <div class="space-y-3">
                    ${options.map(option => `
                        <button onclick="selectOption('${type}', '${option.value}')" 
                                class="w-full text-right p-4 rounded-2xl bg-gradient-to-r ${option.color} hover:from-opacity-80 hover:to-opacity-80 transition-all duration-200 transform hover:scale-105 shadow-md hover:shadow-lg">
                            <span class="text-gray-800 font-medium">${option.label}</span>
                        </button>
                    `).join('')}
                </div>
                <div class="mt-6 text-center">
                    <button onclick="hideSelectionModal()" 
                            class="px-6 py-2 bg-gray-200 text-gray-700 rounded-full hover:bg-gray-300 transition-colors">
                        انصراف
                    </button>
                </div>
            `;
            
            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);
        }

        // Hide selection modal
        function hideSelectionModal() {
            const modal = document.getElementById('selection-modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        // Select option and update
        function selectOption(type, value) {
            switch(type) {
                case 'subject':
                    const [subject, grade] = value.split('-');
                    currentSubject = subject;
                     
                     // Convert English grade to Persian grade
                     const gradeMapping = {
                         '10th': 'دهم',
                         '11th': 'یازدهم', 
                         '12th': 'دوازدهم'
                     };
                     currentGrade = gradeMapping[grade] || grade;
                     
                     console.log('Subject changed to:', currentSubject, currentGrade);
                     
                     // Always reset to Chapter 1 and default book for new subject/grade
                    const chapters = chaptersData[currentSubject]?.[currentGrade];
                    if (chapters && chapters.length > 0) {
                         currentChapter = chapters[0].number; // Always reset to Chapter 1
                    }
                     
                     // Set default book for new subject
                    if (currentSubject === 'biology') {
                         const chapter = chapters?.find(ch => ch.number == currentChapter);
                         if (chapter && chapter.questions && chapter.questions.length > 0) {
                             currentBook = chapter.questions[0].book; // First book in Chapter 1
                         } else {
                        currentBook = 'IQ گاج';
                         }
                    } else if (currentSubject === 'math') {
                        currentBook = 'میکروطلایی گاج';
                    }
                     
                     console.log('Updated values:', currentSubject, currentGrade, currentChapter, currentBook);
                     
                     // Update URL parameters first
                     updateURLParameters();
                     
                     // Load the first question from Chapter 1 for the new subject/grade
                     if (currentSubject === 'biology') {
                         const chapter = chapters?.find(ch => ch.number == currentChapter);
                         if (chapter && chapter.questions && chapter.questions.length > 0) {
                             currentQuestion = chapter.questions[0]; // First question from Chapter 1
                             document.getElementById('question-container').classList.add('biology');
                             document.getElementById('question-number').textContent = '۱';
                             document.getElementById('question-text').textContent = currentQuestion.question;
                             generateChoices();
                             resetSubmitButton();
                             
                             // Force update the display
                             setTimeout(() => {
                                 displayChapterInfo();
                                 console.log('Display updated for biology');
                             }, 100);
                             
                             hideSelectionModal();
                             return;
                         }
                     }
                     
                     // For math subjects, also update display and load question
                     if (currentSubject === 'math') {
                         document.getElementById('question-container').classList.remove('biology');
                         
                         // Force update the display
                         setTimeout(() => {
                             displayChapterInfo();
                             console.log('Display updated for math');
                         }, 100);
                         
                         loadRandomQuestion();
                         hideSelectionModal();
                         return;
                    }
                    break;
                case 'chapter':
                    currentChapter = value;
                    // For both biology and math, automatically load the first available question for the new chapter
                    if (currentSubject === 'biology' || currentSubject === 'math') {
                        const chapters = chaptersData[currentSubject]?.[currentGrade];
                        const chapter = chapters?.find(ch => ch.number == currentChapter);
                        if (chapter && chapter.questions && chapter.questions.length > 0) {
                            // Load the first question from the new chapter
                            currentQuestion = chapter.questions[0];
                            currentBook = currentQuestion.book; // Set the book to match the question
                            
                            // Set biology class for biology, remove for math
                            if (currentSubject === 'biology') {
                                document.getElementById('question-container').classList.add('biology');
                            } else {
                                document.getElementById('question-container').classList.remove('biology');
                            }
                            
                            document.getElementById('question-number').textContent = '۱';
                            document.getElementById('question-text').textContent = currentQuestion.question;
                            generateChoices();
                            resetSubmitButton();
                            displayChapterInfo(); // Update the display to show the new book
                            hideSelectionModal();
                            return; // Don't continue with the normal flow
                        }
                    }
                    break;
                case 'book':
                    currentBook = value;
                    // For both biology and math, automatically load the question for the selected book
                    if (currentSubject === 'biology' || currentSubject === 'math') {
                        loadQuestionForBook(value);
                        return; // Don't call loadRandomQuestion() here since we're loading a specific question
                    }
                    break;
            }
            
            // Update URL parameters
            updateURLParameters();
            
            // Refresh display
            displayChapterInfo();
            loadRandomQuestion();
            
            // Hide modal
            hideSelectionModal();
        }

        // Update URL parameters
        function updateURLParameters() {
            const url = new URL(window.location);
            url.searchParams.set('subject', currentSubject);
            url.searchParams.set('grade', currentGrade);
            url.searchParams.set('chapter', currentChapter);
            url.searchParams.set('book', currentBook);
            window.history.replaceState({}, '', url);
        }

        // Load random question
        function loadRandomQuestion() {
            // Check if we have a custom question from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const customQuestion = urlParams.get('question');
            const questionType = urlParams.get('type');
            
            if (customQuestion && questionType === 'practice') {
                // Load custom question from chapters page
                try {
                    currentQuestion = JSON.parse(decodeURIComponent(customQuestion));
                    document.getElementById('question-container').classList.add('biology');
                    
                    // Update question display
                    document.getElementById('question-number').textContent = '۱';
                    document.getElementById('question-text').textContent = currentQuestion.question;
                    
                    // Generate choice buttons
                    generateChoices();
                    
                    // Reset submit button state
                    resetSubmitButton();
                    return;
                } catch (error) {
                    console.error('Error parsing custom question:', error);
                }
            }
            
            // Fallback to default questions
            let questions = [];
            if (currentSubject === 'biology') {
                // For biology, load questions from chapters data
                const chapters = chaptersData[currentSubject]?.[currentGrade];
                const chapter = chapters?.find(ch => ch.number == currentChapter);
                
                if (chapter && chapter.questions && chapter.questions.length > 0) {
                    // Select random question from chapter
                    questionIndex = Math.floor(Math.random() * chapter.questions.length);
                    currentQuestion = chapter.questions[questionIndex];
                document.getElementById('question-container').classList.add('biology');
                    
                    // Update question display
                    document.getElementById('question-number').textContent = questionIndex + 1;
                    document.getElementById('question-text').textContent = currentQuestion.question;
                    
                    // Generate choice buttons
                    generateChoices();
                    
                    // Reset submit button state
                    resetSubmitButton();
                    return;
            } else {
                    // No questions available for this chapter
                document.getElementById('question-container').classList.add('biology');
                    document.getElementById('question-text').textContent = 'هیچ سوالی برای این فصل در دسترس نیست. لطفاً به صفحه فصول برگردید.';
                    document.getElementById('choices-container').innerHTML = '';
                    document.getElementById('action-buttons').innerHTML = `
                        <button onclick="goBack()" class="submit-button bg-gradient-to-r from-blue-400 to-blue-500 text-white font-bold py-3 px-6 text-lg rounded-full">
                            بازگشت به فصول
                        </button>
                    `;
                    return;
                }
            } else if (currentSubject === 'math') {
                // For math, load questions from chapters data (same as biology)
                const chapters = chaptersData[currentSubject]?.[currentGrade];
                const chapter = chapters?.find(ch => ch.number == currentChapter);
                
                if (chapter && chapter.questions && chapter.questions.length > 0) {
                    // Select random question from chapter
                    questionIndex = Math.floor(Math.random() * chapter.questions.length);
                    currentQuestion = chapter.questions[questionIndex];
                    document.getElementById('question-container').classList.remove('biology');
            
            // Update question display
            document.getElementById('question-number').textContent = questionIndex + 1;
            document.getElementById('question-text').textContent = currentQuestion.question;
            
            // Generate choice buttons
            generateChoices();
            
            // Reset submit button state
            resetSubmitButton();
                    return;
                } else {
                    // No questions available for this chapter
                    document.getElementById('question-container').classList.remove('biology');
                    document.getElementById('question-text').textContent = 'هیچ سوالی برای این فصل در دسترس نیست. لطفاً به صفحه فصول برگردید.';
                    document.getElementById('choices-container').innerHTML = '';
                    document.getElementById('action-buttons').innerHTML = `
                        <button onclick="goBack()" class="submit-button bg-gradient-to-r from-blue-400 to-blue-500 text-white font-bold py-3 px-6 text-lg rounded-full">
                            بازگشت به فصول
                        </button>
                    `;
                    return;
                }
            }
        }

        // Load question for specific book (for biology and math)
        function loadQuestionForBook(bookName) {
            const chapters = chaptersData[currentSubject]?.[currentGrade];
            const chapter = chapters?.find(ch => ch.number == currentChapter);
            
            if (chapter && chapter.questions && chapter.questions.length > 0) {
                // Find the question for the specific book
                const questionForBook = chapter.questions.find(q => q.book === bookName);
                
                if (questionForBook) {
                    currentQuestion = questionForBook;
                    // Set biology class for biology, remove for math
                    if (currentSubject === 'biology') {
                        document.getElementById('question-container').classList.add('biology');
                    } else {
                        document.getElementById('question-container').classList.remove('biology');
                    }
                    
                    // Update question display
                    document.getElementById('question-number').textContent = '۱';
                    document.getElementById('question-text').textContent = questionForBook.question;
                    
                    // Generate choice buttons
                    generateChoices();
                    
                    // Reset submit button state
                    resetSubmitButton();
                    
                    // Update the book tab to show the selected book
                    displayChapterInfo();
                    
                    console.log(`✅ Loaded question for book: ${bookName}`);
                } else {
                    // If no question found for this book in current chapter, show message
                    if (currentSubject === 'biology') {
                        document.getElementById('question-container').classList.add('biology');
                    } else {
                        document.getElementById('question-container').classList.remove('biology');
                    }
                    document.getElementById('question-text').textContent = `هیچ سوالی برای کتاب ${bookName} در فصل ${currentChapter} موجود نیست.`;
                    document.getElementById('choices-container').innerHTML = '';
                    document.getElementById('action-buttons').innerHTML = `
                        <button onclick="goBack()" class="submit-button bg-gradient-to-r from-blue-400 to-blue-500 text-white font-bold py-3 px-6 text-lg rounded-full">
                            بازگشت به فصول
                        </button>
                    `;
                    console.log(`❌ No question found for book: ${bookName} in chapter ${currentChapter}`);
                }
            } else {
                // No questions available for this chapter
                if (currentSubject === 'biology') {
                    document.getElementById('question-container').classList.add('biology');
                } else {
                    document.getElementById('question-container').classList.remove('biology');
                }
                document.getElementById('question-text').textContent = 'هیچ سوالی برای این فصل در دسترس نیست. لطفاً به صفحه فصول برگردید.';
                document.getElementById('choices-container').innerHTML = '';
                document.getElementById('action-buttons').innerHTML = `
                    <button onclick="goBack()" class="submit-button bg-gradient-to-r from-blue-400 to-blue-500 text-white font-bold py-3 px-6 text-lg rounded-full">
                        بازگشت به فصول
                    </button>
                `;
            }
        }

        // Load next question
        function loadNextQuestion() {
            // Reset selection
            selectedChoice = null;
            
            // Remove selected state from all choices
            document.querySelectorAll('.choice-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // For biology questions, go back to chapters page since we only have one question per book
            if (currentSubject === 'biology') {
                window.location.href = `chapters.html?subject=${currentSubject}&grade=${currentGrade}&field=${currentField}`;
                return;
            }
            
            // Load new random question for math
            loadRandomQuestion();
        }

        // Reset submit button to initial state
        function resetSubmitButton() {
            const submitBtn = document.getElementById('submit-btn');
            const actionButtons = document.getElementById('action-buttons');
            
            // Move action buttons back to original position
            actionButtons.className = 'mt-6';
            
                         // Reset button to disabled state with light green gradient
             submitBtn.disabled = true;
             submitBtn.className = 'submit-button flex-1 bg-gradient-to-r from-green-100 to-green-200 text-green-800 font-bold py-3 px-6 text-lg hover:from-green-200 hover:to-green-300 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg rounded-full';
        }

        // Generate choice buttons
        function generateChoices() {
            const container = document.getElementById('choices-container');
            container.innerHTML = '';
            
            // Handle all questions with A, B, C, D format (both math and biology now)
            currentQuestion.options.forEach((option, index) => {
                const choice = String.fromCharCode(65 + index); // A, B, C, D
                const button = document.createElement('button');
                button.className = 'choice-button w-full text-left p-5 border-2 border-gray-200 hover:border-blue-300 transition-all bg-white bg-opacity-80 hover:bg-opacity-100';
                button.setAttribute('data-choice', choice);
                button.onclick = () => selectChoice(choice);
                
                button.innerHTML = `
                    <span class="font-bold text-gray-800 text-lg">${choice}.</span>
                    <span class="mr-4 text-gray-700 text-lg">${option.substring(option.indexOf('.') + 1).trim()}</span>
                `;
                
                container.appendChild(button);
            });
        }

        // Select a choice
        function selectChoice(choice) {
            // Remove previous selection
            document.querySelectorAll('.choice-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Select new choice
            selectedChoice = choice;
            document.querySelector(`[data-choice="${choice}"]`).classList.add('selected');
            
            // Move action buttons above bottom navigation
            const actionButtons = document.getElementById('action-buttons');
            actionButtons.className = 'fixed bottom-24 left-0 right-0 px-6 z-40';
            
                         // Enable submit button and change to light green gradient
             const submitBtn = document.getElementById('submit-btn');
             submitBtn.disabled = false;
             submitBtn.className = 'submit-button flex-1 bg-gradient-to-r from-green-200 to-green-300 text-green-800 font-bold py-3 px-6 text-lg hover:from-green-300 hover:to-green-400 transition-all shadow-lg rounded-full';
        }

        // Flag to prevent double submission
        let isSubmitting = false;

        // Submit answer
        function submitAnswer() {
            if (!selectedChoice) {
                alert('لطفاً یک گزینه انتخاب کنید');
                return;
            }

            // Prevent double submission
            if (isSubmitting) {
                console.log('⚠️ Already submitting, ignoring duplicate click');
                return;
            }

            // Set submission flag
            isSubmitting = true;

            // Disable submit button to prevent multiple clicks
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'در حال پردازش...';

            // Prepare analysis data
            let analysisData;
            if (currentSubject === 'biology') {
                analysisData = {
                    question: currentQuestion.question,
                    options: currentQuestion.options,
                    userAnswer: selectedChoice,
                    subject: currentSubject,
                    grade: currentGrade,
                    field: currentField,
                    chapter: currentChapter,
                    book: currentBook
                };
            } else {
                analysisData = {
                question: currentQuestion.question,
                options: currentQuestion.options,
                correctAnswer: currentQuestion.correctAnswer,
                userAnswer: selectedChoice,
                subject: currentSubject,
                grade: currentGrade,
                field: currentField,
                chapter: currentChapter
            };
            }
            
            // Store data in localStorage instead of URL for better Persian text handling
            localStorage.setItem('analysisData', JSON.stringify(analysisData));
            
            // Navigate immediately to analysis results (no loading state)
            window.location.href = `analysis-results.html`;
        }

        // Show loading state for question submission
        function showQuestionLoading() {
            console.log('🔄 Showing question loading state...');
            
            // Update loading state with current question info
            const questionNumber = document.getElementById('question-number').textContent;
            const questionText = document.getElementById('question-text').textContent;
            
            document.getElementById('loading-question-number').textContent = questionNumber;
            document.getElementById('loading-question-text').textContent = questionText;
            
            // Hide question container and show loading - use both methods to ensure it works
            const questionContainer = document.getElementById('question-container');
            const questionLoading = document.getElementById('question-submit-loading');
            
            // Hide question container completely
            questionContainer.style.display = 'none';
            questionContainer.classList.add('hidden');
            
            // Show loading state completely
            questionLoading.style.display = 'block';
            questionLoading.classList.remove('hidden');
            
            console.log('✅ Question loading state shown successfully');
        }



        // Get choice text
        function getChoiceText(choice) {
            if (!currentQuestion) return '';
            
            const choiceIndex = choice.charCodeAt(0) - 65; // Convert A=0, B=1, etc.
            const option = currentQuestion.options[choiceIndex];
            return option.substring(option.indexOf('.') + 1).trim();
        }

        // Go back to previous page
        function goBack() {
            // Go back to chapters page with current selections
            window.location.href = `chapters.html?subject=${currentSubject}&grade=${currentGrade}&field=${currentField}`;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            getUrlParams();
            displayChapterInfo();
            loadRandomQuestion();
            
            // Set initial button text
            document.getElementById('submit-btn').textContent = 'پاسخ';
        });
    </script>
</body>
</html>
