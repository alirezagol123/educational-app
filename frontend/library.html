<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#E8E8E4">
    <meta name="msapplication-navbutton-color" content="#E8E8E4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="light-content">
    <title>Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ - High School</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Check login status on page load - DISABLED FOR NOW
        function checkLoginStatus() {
            // Set default user data for testing
            if (!localStorage.getItem('user_id')) {
                localStorage.setItem('user_id', '1');
                localStorage.setItem('is_verified', 'true');
                localStorage.setItem('user_phone', '+1234567890');
            }
            return true;
        }
        
        // Check login status immediately - DISABLED FOR NOW
        checkLoginStatus();
    </script>
    <style>
        * {
            font-family: 'Vazirmatn', 'IranSans', sans-serif;
        }

        body {
            background-color: #F8F9FA;
            color: #333333;
        }

        /* Library specific styling */
        .library-container {
            background-color: #F8F9FA;
            min-height: 100vh;
        }

        .conversation-item {
            background-color: transparent;
            border: none;
            border-bottom: 1px solid #e0e0e0;
            border-radius: 0;
            margin-bottom: 0;
            transition: background-color 0.2s ease;
            padding: 1rem 1.25rem; /* 16px 20px */
        }

        .conversation-item:hover {
            background-color: #f0f0f0;
            box-shadow: none;
            transform: none;
        }

        .conversation-item:last-child {
            border-bottom: none;
        }

        .conversation-title {
            color: #333333;
            font-weight: 500;
            font-size: 1rem; /* 16px */
            line-height: 1.4;
            margin-bottom: 0.5rem; /* 8px */
        }

        .conversation-snippet {
            color: #666666;
            font-size: 0.875rem; /* 14px */
            line-height: 1.5;
            margin-bottom: 0.75rem; /* 12px */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .conversation-meta {
            color: #888888;
            font-size: 0.75rem; /* 12px */
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .search-input {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            color: #333333;
            border-radius: 12px;
        }

        .search-input:focus {
            outline: none;
            border-color: #3182ce;
            background-color: #ffffff;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .search-input::placeholder {
            color: #a0aec0;
        }
        
        /* Navigation icon states */
        .nav-icon {
            color: #9CA3AF; /* Pale gray for inactive icons */
            transition: color 0.3s ease;
        }
        
        .nav-icon.active {
            color: #374151; /* Full color for active icon */
        }
        
        .nav-icon:hover {
            color: #6B7280; /* Slightly darker on hover */
        }

        /* Loading animation */
        .loading-spinner {
            border: 2px solid #e2e8f0;
            border-top: 2px solid #3182ce;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }


        /* Mobile optimizations */
        @media (max-width: 640px) {
            .conversation-title {
                font-size: 1rem; /* 16px */
            }
            
            .conversation-snippet {
                font-size: 0.875rem; /* 14px */
            }
            
            .conversation-meta {
                font-size: 0.75rem; /* 12px */
            }
        }
        
        /* Critical mobile viewport fixes */
        html {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            overflow-x: hidden;
        }
        
        body {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        
        /* Prevent mobile zoom on input focus */
        input, textarea, select {
            font-size: 16px !important;
        }
        
        /* Mobile Performance Optimizations */
        @media (max-width: 768px) {
            /* Fix mobile layout issues */
            html, body {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            main {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }
            
            .icons-container {
                width: 100% !important;
                max-width: 100% !important;
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }
        }
        
        /* Additional mobile fixes */
        @media (max-width: 480px) {
            /* Extra small screens */
            .icons-container {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }
            
            main {
                padding-left: 0.25rem !important;
                padding-right: 0.25rem !important;
            }
        }
        
        /* Ensure proper mobile layout on all devices */
        @media screen and (max-width: 1024px) {
            body {
                -webkit-text-size-adjust: 100%;
                -ms-text-size-adjust: 100%;
            }
            
            /* Force proper mobile layout */
            html {
                -webkit-text-size-adjust: 100%;
                -ms-text-size-adjust: 100%;
            }
            
            /* Ensure icons container stays at bottom */
            .icons-container {
                position: fixed !important;
                bottom: 1rem !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 40 !important;
            }
        }
        
        /* Comprehensive Mobile Media Queries */
        
        /* Extra Small Devices (phones, 320px and up) */
        @media (min-width: 320px) and (max-width: 479px) {
            html, body {
                font-size: 0.875rem; /* 14px */
            }
            
            .icons-container {
                padding: 0.75rem 0.5rem !important;
                bottom: 0.5rem !important;
            }
            
            main {
                padding-left: 0.25rem !important;
                padding-right: 0.25rem !important;
            }
            
            .library-container {
                padding: 0.5rem !important;
            }
        }
        
        /* Small Devices (phones, 480px and up) */
        @media (min-width: 480px) and (max-width: 639px) {
            html, body {
                font-size: 1rem; /* 16px */
            }
            
            .icons-container {
                padding: 1rem 0.75rem !important;
                bottom: 0.75rem !important;
            }
            
            .library-container {
                padding: 0.75rem !important;
            }
        }
        
        /* Medium Devices (tablets, 640px and up) */
        @media (min-width: 640px) and (max-width: 767px) {
            html, body {
                font-size: 1.0625rem; /* 17px */
            }
            
            .icons-container {
                padding: 1rem 1rem !important;
                bottom: 1rem !important;
            }
            
            .library-container {
                padding: 1rem !important;
            }
        }
        
        /* Large Devices (desktops, 768px and up) */
        @media (min-width: 768px) and (max-width: 1023px) {
            html, body {
                font-size: 1.125rem; /* 18px */
            }
            
            .icons-container {
                padding: 1.25rem 1.25rem !important;
                bottom: 1.25rem !important;
            }
            
            .library-container {
                padding: 1.25rem !important;
            }
        }
        
        /* Extra Large Devices (large desktops, 1024px and up) */
        @media (min-width: 1024px) {
            html, body {
                font-size: 1.125rem; /* 18px */
            }
            
            .icons-container {
                padding: 1.5rem 1.5rem !important;
                bottom: 1.5rem !important;
            }
            
            .library-container {
                padding: 1.5rem !important;
            }
        }
    </style>
</head>
<body>
    <div class="library-container">
        <!-- Header -->
        <header class="sticky top-0 z-50 flex items-center justify-between px-6 py-4 border-b border-gray-200" style="background-color: #F8F9FA;">
            <div class="flex items-center space-x-4 space-x-reverse">
                <!-- Search Icon -->
                <button id="search-toggle" class="text-gray-600 hover:text-gray-800 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </button>
                
            </div>
            
            <h1 class="text-xl font-semibold text-gray-800">Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡</h1>
        </header>

        <!-- Search Bar (Hidden by default) -->
        <div id="search-container" class="hidden px-6 py-4 border-b border-gray-200" style="background-color: #F8F9FA;">
            <div class="relative">
                <input 
                    type="text" 
                    id="search-input" 
                    placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ú¯ÙØªÚ¯ÙˆÙ‡Ø§..." 
                    class="search-input w-full px-4 py-3 pr-12 text-right"
                >
                <div class="absolute left-3 top-1/2 transform -translate-y-1/2">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="flex-1">
            <!-- Loading State -->
            <div id="loading-state" class="flex items-center justify-center py-12">
                <div class="loading-spinner"></div>
                <span class="mr-3 text-gray-600">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="empty-state hidden">
                <div class="empty-state-icon">ğŸ“š</div>
                <h3 class="text-lg font-medium mb-2">Ù‡ÛŒÚ† Ú¯ÙØªÚ¯ÙˆÛŒÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
                <p class="text-gray-500">Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯</p>
            </div>

            <!-- Conversations List -->
            <div id="conversations-list" class="hidden">
                <!-- Conversations will be dynamically added here -->
            </div>
            
            <!-- Analysis List -->
            <div id="analysis-list" class="hidden">
                <!-- Analysis items will be dynamically added here -->
            </div>
        </main>

        <!-- Bottom Mobile Navigation - Matching Chat Page Icons -->
        <div class="icons-container fixed bottom-0 left-0 right-0 pt-2 pb-6 px-6 flex justify-around items-center space-x-8 z-40 rounded-t-2xl shadow-lg" style="background-color: #E8E8E4;">
            <!-- First Icon: Circle with tick inside (Test page) -->
            <button class="icon-button p-2 hover:text-gray-600 transition-colors" onclick="window.location.href='test.html'">
                <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10" stroke-width="2"/>
                    <path d="M9 12l2 2 4-4" stroke-width="2"/>
                </svg>
            </button>
            
            <!-- Second Icon: Open book (Library) -->
            <button class="icon-button p-2 hover:text-gray-600 transition-colors" onclick="window.location.href='library.html'">
                <svg class="w-6 h-6 nav-icon active" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" stroke-width="2"/>
                </svg>
            </button>
            
            <!-- Third Icon: Document with pencil (Chat page) -->
            <button class="icon-button p-2 hover:text-gray-600 transition-colors" onclick="window.location.href='index.html'">
                <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke-width="2"/>
                    <path d="M14 2v6h6" stroke-width="2"/>
                    <path d="M16 13H8" stroke-width="2"/>
                    <path d="M16 17H8" stroke-width="2"/>
                    <path d="M10 9H8" stroke-width="2"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // Global variables for thread management
        let threads = [];
        let currentPage = 0;
        const threadsPerPage = 20;
        let isLoading = false;
        let hasMoreThreads = true;
        let searchTimeout = null;
        let currentSearch = '';
        let currentSort = 'last_message_at';
        let currentSortOrder = 'DESC';
        let includeArchived = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Library page initialized');
            loadThreads();
            setupEventListeners();
        });





        // Load threads from API
        async function loadThreads(reset = false) {
            if (isLoading) return;
            
            try {
                const userId = localStorage.getItem('user_id');
                if (!userId) {
                    showEmptyState('Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ØŒ Ù„Ø·ÙØ§Ù‹ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯');
                    return;
                }
                
                isLoading = true;
                if (reset) {
                    currentPage = 0;
                    threads = [];
                    hasMoreThreads = true;
                }
                
                showLoading();
                
                const params = new URLSearchParams({
                    user_id: userId,
                    limit: threadsPerPage,
                    offset: currentPage * threadsPerPage,
                    sort_by: currentSort,
                    sort_order: currentSortOrder,
                    include_archived: includeArchived,
                    type: 'chat', // Only load chat threads
                    ...(currentSearch && { search: currentSearch })
                });
                
                const response = await fetch(`/api/threads?${params}`);
                
                if (response.status === 429) {
                    console.error('âš ï¸ Rate limit exceeded, please wait a moment');
                    showEmptyState('Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ§Ø¯ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡. Ù„Ø·ÙØ§Ù‹ Ú©Ù…ÛŒ ØµØ¨Ø± Ú©Ù†ÛŒØ¯.');
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    if (reset) {
                        threads = data.threads;
                    } else {
                        threads = [...threads, ...data.threads];
                    }
                    
                    hasMoreThreads = data.pagination.hasMore;
                    currentPage++;
                    
                    console.log('ğŸ“š Loaded threads:', threads.length);
                    displayThreads();
                } else {
                    console.error('Failed to load threads:', data.error);
                    showError('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§');
                }
            } catch (error) {
                console.error('Load threads error:', error);
                showError('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            } finally {
                isLoading = false;
            }
        }

        // Display threads in the UI
        async function displayThreads() {
            const threadsList = document.getElementById('conversations-list');
            const emptyState = document.getElementById('empty-state');
            const loadingState = document.getElementById('loading-state');
            
            // Hide loading state
            loadingState.classList.add('hidden');
            
            if (threads.length === 0) {
                threadsList.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            threadsList.classList.remove('hidden');
            
            // Create thread items with async snippets
            const threadItems = await Promise.all(threads.map(async (thread) => {
                const timeAgo = getTimeAgo(thread.last_message_at);
                const snippet = await getThreadSnippet(thread);
                
                return `
                    <div class="conversation-item cursor-pointer transition-colors" 
                         onclick="openThread('${thread.id}')">
                        <div class="flex flex-col">
                            <h3 class="conversation-title">${escapeHtml(thread.title)}</h3>
                            ${snippet ? `<p class="conversation-snippet">${escapeHtml(snippet)}</p>` : ''}
                            <div class="conversation-meta">
                                <span>${timeAgo}</span>
                                <div class="flex items-center space-x-2 space-x-reverse">
                                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }));
            
            threadsList.innerHTML = threadItems.join('');
            
            // Add load more button if there are more threads
            if (hasMoreThreads) {
                threadsList.innerHTML += `
                    <div class="px-6 py-4 text-center">
                        <button onclick="loadMoreThreads()" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨ÛŒØ´ØªØ±
                        </button>
                    </div>
                `;
            }
        }

        // Load more threads (pagination)
        function loadMoreThreads() {
            if (!isLoading && hasMoreThreads) {
                loadThreads(false);
            }
        }

        // Open a thread
        function openThread(threadId) {
            console.log('ğŸ“š Opening thread:', threadId);
            
            // Store thread ID for the target page
            localStorage.setItem('viewing_thread', threadId);
            
            // Navigate to chat page
            window.location.href = 'index.html';
        }

        // Archive/Unarchive a thread
        async function archiveThread(threadId, archive) {
            try {
                const userId = localStorage.getItem('user_id');
                if (!userId) return;
                
                const response = await fetch(`/api/threads/${threadId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        is_archived: archive
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    // Reload threads
                    loadThreads(true);
                } else {
                    console.error('Failed to archive thread:', data.error);
                    showError('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ø±Ø´ÛŒÙˆ Ú©Ø±Ø¯Ù† Ú¯ÙØªÚ¯Ùˆ');
                }
            } catch (error) {
                console.error('Archive thread error:', error);
                showError('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        // Delete a thread
        async function deleteThread(threadId) {
            if (!confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ú¯ÙØªÚ¯Ùˆ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ')) {
                return;
            }
            
            try {
            const userId = localStorage.getItem('user_id');
                if (!userId) return;
                
                const response = await fetch(`/api/threads/${threadId}?user_id=${userId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                if (data.success) {
                    // Reload threads
                    loadThreads(true);
            } else {
                    console.error('Failed to delete thread:', data.error);
                    showError('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú¯ÙØªÚ¯Ùˆ');
                }
            } catch (error) {
                console.error('Delete thread error:', error);
                showError('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±');
            }
        }

        // Search threads
        function searchThreads(query) {
            currentSearch = query;
            clearTimeout(searchTimeout);
            
            searchTimeout = setTimeout(() => {
                loadThreads(true);
            }, 300);
        }

        // Sort threads
        function sortThreads(sortBy, sortOrder) {
            currentSort = sortBy;
            currentSortOrder = sortOrder;
            loadThreads(true);
        }

        // Toggle archived threads
        function toggleArchived() {
            includeArchived = !includeArchived;
            loadThreads(true);
        }


        // Setup event listeners
        function setupEventListeners() {
            // Search toggle
            document.getElementById('search-toggle').addEventListener('click', toggleSearch);
            
            // Search input
            document.getElementById('search-input').addEventListener('input', handleSearch);
            
            // Search input enter key
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const query = document.getElementById('search-input').value.trim();
                    searchThreads(query);
                }
            });
            
            // Sort functionality
            const sortSelect = document.getElementById('sort-select');
            if (sortSelect) {
                sortSelect.addEventListener('change', (e) => {
                    const [sortBy, sortOrder] = e.target.value.split('_');
                    sortThreads(sortBy, sortOrder);
                });
            }
            
            // Archive toggle
            const archiveToggle = document.getElementById('archive-toggle');
            if (archiveToggle) {
                archiveToggle.addEventListener('change', (e) => {
                    toggleArchived();
                });
            }
        }

        // Toggle search bar
        function toggleSearch() {
            const searchContainer = document.getElementById('search-container');
            const searchInput = document.getElementById('search-input');
            
            if (searchContainer.classList.contains('hidden')) {
                searchContainer.classList.remove('hidden');
                searchInput.focus();
            } else {
                searchContainer.classList.add('hidden');
                searchInput.value = '';
                loadThreads(true); // Reset to show all threads
            }
        }

        // Handle search input
        function handleSearch() {
            const query = document.getElementById('search-input').value.trim();
            
            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // Set new timeout for search
            searchTimeout = setTimeout(() => {
                searchThreads(query);
            }, 500);
        }

        // TODO: Implement conversation loading from scratch

        // Show empty state with custom message
        function showEmptyState(message) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('conversations-list').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            
            const emptyState = document.getElementById('empty-state');
            emptyState.innerHTML = `
                <div class="empty-state-icon">ğŸ”</div>
                <h3 class="text-lg font-medium mb-2">ÙˆØ±ÙˆØ¯ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²</h3>
                <p class="text-gray-500 mb-4">${message}</p>
                <button onclick="window.location.href='auth.html'" class="bg-blue-500 hover:bg-blue-600 px-6 py-2 text-white font-medium rounded-lg transition-colors">
                    ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øª Ù†Ø§Ù…
                </button>
            `;
        }

        // Helper functions
        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
            
            if (diffInHours < 1) {
                return 'Ú©Ù…ØªØ± Ø§Ø² Û± Ø³Ø§Ø¹Øª';
            } else if (diffInHours < 24) {
                return `${diffInHours} Ø³Ø§Ø¹Øª`;
            } else {
                const diffInDays = Math.floor(diffInHours / 24);
                return `${diffInDays} Ø±ÙˆØ²`;
            }
        }

        async function getThreadSnippet(thread) {
            try {
                // Fetch the first few messages to get AI response
                const response = await fetch(`/api/threads/${thread.id}/messages?limit=5`);
                const data = await response.json();
                
                if (data.success && data.messages && data.messages.length > 0) {
                    // Find the first AI response
                    const aiMessage = data.messages.find(msg => msg.sender_role === 'assistant');
                    if (aiMessage && aiMessage.content) {
                        // Clean the content and limit length
                        let content = aiMessage.content.replace(/<[^>]*>/g, ''); // Remove HTML tags
                        content = content.replace(/\s+/g, ' ').trim(); // Clean whitespace
                        
                        // Limit to 120 characters for better UX
                        return content.length > 120 ? 
                            content.substring(0, 120) + '...' : 
                            content;
                    }
                }
                
                // Fallback to summary if available
                if (thread.summary) {
                    return thread.summary.length > 120 ? 
                        thread.summary.substring(0, 120) + '...' : 
                        thread.summary;
                }
                
                return 'Ú¯ÙØªÚ¯ÙˆÛŒ Ø¬Ø¯ÛŒØ¯';
            } catch (error) {
                console.error('Error fetching thread snippet:', error);
                return thread.summary || 'Ú¯ÙØªÚ¯ÙˆÛŒ Ø¬Ø¯ÛŒØ¯';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showLoading() {
            document.getElementById('loading-state').classList.remove('hidden');
            document.getElementById('conversations-list').classList.add('hidden');
            document.getElementById('empty-state').classList.add('hidden');
        }

        function showEmptyState(message) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('conversations-list').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            
            const emptyState = document.getElementById('empty-state');
            emptyState.innerHTML = `
                <div class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">${message}</h3>
                    <p class="mt-1 text-sm text-gray-500">Ù‡Ù†ÙˆØ² Ú¯ÙØªÚ¯ÙˆÛŒÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</p>
                </div>
            `;
        }

        function showError(message) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('conversations-list').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            
            const emptyState = document.getElementById('empty-state');
            emptyState.innerHTML = `
                <div class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">Ø®Ø·Ø§</h3>
                    <p class="mt-1 text-sm text-gray-500">${message}</p>
                    <button onclick="loadThreads(true)" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯
                    </button>
                </div>
            `;
        }

        // Show loading state
        function showLoading() {
            document.getElementById('loading-state').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('conversations-list').classList.add('hidden');
        }

        // Show error
        function showError(message) {
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            document.getElementById('conversations-list').classList.add('hidden');
            
            // Update empty state with error message
            const emptyState = document.getElementById('empty-state');
            emptyState.innerHTML = `
                <div class="empty-state-icon">âš ï¸</div>
                <h3 class="text-lg font-medium mb-2">Ø®Ø·Ø§</h3>
                <p class="text-gray-500">${message}</p>
            `;
        }
    </script>
</body>
</html>
