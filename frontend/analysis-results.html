<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>مِنو - نتایج تحلیل سوال</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'meno-blue': '#3B82F6',
                        'meno-gray': '#6B7280',
                        'meno-light-gray': '#F3F4F6'
                    }
                }
            }
        }
    </script>
    <style>
                 body {
             font-family: 'Vazirmatn', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
             font-size: 16px; /* Changed from 18px to match chat page */
             line-height: 1.6;
             background: #fcfdf8 !important;
         }
        
        .result-container {
            background: linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 100%);
            border-radius: 50px;
            transition: all 0.5s ease;
            overflow: hidden;
            position: relative;
        }
        
        .result-container.biology {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
        }
        
                 .result-container.collapsed {
             max-height: 30vh;
             padding: 1rem;
             margin: 0;
             opacity: 0.3;
             transform: none;
             transform-origin: top;
             overflow: hidden;
         }
        
                 /* Remove extra space below collapsed results */
        
        .result-container.collapsed .mb-8 {
            margin-bottom: 0.5rem;
        }
        
        .result-container.collapsed h2 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .result-container.collapsed #result-display {
            margin-bottom: 0.5rem;
        }
        
        .result-container.collapsed #analysis-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
                 .detailed-analysis-section {
             transition: none;
             transform: none;
             opacity: 1;
             display: block;
             margin-top: 2rem;
             position: static;
             background: transparent !important;
             box-shadow: none;
             border-radius: 0;
             overflow: hidden;
         }
        
        .detailed-analysis-section.show {
             display: block !important;
         }
         
         /* Detailed analysis section styling - seamlessly integrated with main page */
         #detailed-analysis-section {
             background: transparent;
             border-radius: 0;
             box-shadow: none;
             overflow: hidden;
             border: none;
             margin-top: 2rem;
             margin-left: 0;
             margin-right: 0;
             transition: all 0.3s ease;
         }
         
         /* Mobile responsive - full width on small screens */
         @media (max-width: 768px) {
             #detailed-analysis-section {
                 margin-left: -1.5rem;
                 margin-right: -1.5rem;
             }
         }
         
         #detailed-analysis-section:not(.hidden) {
             display: block !important;
        }
        
                         .analysis-content {
            line-height: 1.8;
            text-align: right;
            font-size: 16px; /* Changed from 18px to match chat page base size */
            background: transparent !important;
            display: block !important;
        }
         
         #chat-messages {
             display: block !important;
             background: transparent;
             border-radius: 0;
             margin-top: 0;
             padding: 0 32px 32px 32px;
             border-top: 1px solid #f3f4f6;
         }
         
                 /* Mobile responsive - full width for chat messages */
        @media (max-width: 768px) {
            #chat-messages {
                margin-left: -1.5rem;
                margin-right: -1.5rem;
                padding-left: 1.5rem;
                padding-right: 1.5rem;
                width: calc(100% + 3rem);
                background: transparent;
            }
            
            /* Remove the border on mobile for seamless appearance */
            #chat-messages {
                border-top: none;
            }
            
            /* AI responses use same width as detailed analysis on mobile */
            .message-bubble.ai {
                margin: 0;
                width: 100%;
                max-width: 100%;
                border-radius: 0;
                background: transparent;
            }
            
            /* Helper response content uses same width as detailed analysis on mobile */
            .helper-response-content {
                margin: 0;
                width: 100%;
                max-width: 100%;
                background: transparent;
            }
         }
        
        .analysis-content h4 {
            font-weight: 600;
            color: #1f2937;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .analysis-content p {
            margin-bottom: 1rem;
            color: #374151;
        }
        
        .analysis-content ul {
            margin: 1rem 0;
            padding-right: 1.5rem;
        }
        
        .analysis-content li {
            margin-bottom: 0.5rem;
            color: #374151;
        }
        
                 /* Special styling for structured analysis sections */
         .analysis-section {
             margin: 16px 0;
             padding: 0;
         }
         
         .analysis-section h3 {
             font-weight: 700;
             color: #1e40af;
             margin-bottom: 12px;
             font-size: 1.3rem;
         }
        
        /* Enhanced text styling for structured content */
        .analysis-content h1, .analysis-content h2, .analysis-content h3 {
            font-weight: 700;
            color: #1e40af;
            margin-top: 1.5rem;
            margin-bottom: 0.8rem;
            font-size: 1.4rem;
        }
        
        .analysis-content h4, .analysis-content h5, .analysis-content h6 {
            font-weight: 600;
            color: #1e40af;
            margin-top: 1.2rem;
            margin-bottom: 0.6rem;
            font-size: 1rem; /* Changed from 1.2rem to match chat page */
        }
        
        .analysis-content ol {
            margin: 1rem 0;
            padding-right: 1.5rem;
            counter-reset: item;
        }
        
        .analysis-content ol li {
            margin-bottom: 0.8rem;
            color: #374151;
            counter-increment: item;
            position: relative;
        }
        
        .analysis-content ol li::before {
            content: counter(item) ".";
            font-weight: 700;
            color: #1e40af;
            margin-left: 0.5rem;
            font-size: 1.1rem;
        }
        
        .analysis-content ul {
            margin: 1rem 0;
            padding-right: 1.5rem;
        }
        
        .analysis-content ul li {
            margin-bottom: 0.8rem;
            color: #374151;
            position: relative;
        }
        
        .analysis-content ul li::before {
            content: "•";
            font-weight: 700;
            color: #1e40af;
            margin-left: 0.5rem;
            font-size: 1rem; /* Changed from 1.2rem to match chat page */
        }
        
        /* Enhanced list styling for all responses */
        .bullet-list {
            margin: 1rem 0;
            padding-right: 1.5rem;
            list-style: none;
        }
        
        .bullet-list li {
            margin-bottom: 0.8rem;
            color: #374151;
            position: relative;
            padding-right: 1.5rem;
        }
        
        .bullet-list li::before {
            content: "•";
            font-weight: 700;
            color: #1e40af;
            position: absolute;
            right: 0;
            font-size: 1rem; /* Changed from 1.2rem to match chat page */
        }
        
        .numbered-list {
            margin: 1rem 0;
            padding-right: 1.5rem;
            counter-reset: item;
        }
        
        .numbered-list li {
            margin-bottom: 0.8rem;
            color: #374151;
            counter-increment: item;
            position: relative;
            padding-right: 1.5rem;
        }
        
        .numbered-list li::before {
            content: counter(item) ".";
            font-weight: 700;
            color: #1e40af;
            position: absolute;
            right: 0;
            font-size: 1.1rem;
        }
        
                 /* Button hover effects */
         button:hover {
             transform: translateY(-2px);
             box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
             transition: all 0.3s ease;
         }
         
                           /* Ensure helper question AI responses have no background */
        .streaming-answer {
            background: transparent !important;
        }
        
        /* Mathematical formulas styling for helper questions */
        .streaming-answer .ai-tutor-response p,
        .streaming-answer .ai-tutor-response .msg-body p {
            color: #1e293b !important;
            font-size: 16px !important; /* Changed from 20px to match chat page */
            font-weight: 500 !important;
        }
        
        /* Enhanced styling for mathematical expressions and formulas */
        .streaming-answer .ai-tutor-response p {
            color: #000000 !important;
            font-size: 16px !important; /* Changed from 18px to match chat page */
            font-weight: 600 !important;
         
         /* Helper question response styling - seamless integration */
         .helper-response-content {
             background: transparent;
             border: none;
             box-shadow: none;
             margin: 0;
             padding: 0;
             width: 100%; /* Same width as detailed analysis */
             max-width: 100%;
         }
         
         .helper-response-content p {
             margin-bottom: 1rem;
             color: #374151;
             line-height: 1.6;
         }
         
         /* Enhanced list styling for helper question responses */
         .helper-response-content ul.bullet-list {
             margin: 1rem 0;
             padding-right: 1.5rem;
             list-style: none;
         }
         
         .helper-response-content ul.bullet-list li {
             margin-bottom: 0.8rem;
             color: #374151;
             position: relative;
             padding-right: 1.5rem;
         }
         
         .helper-response-content ul.bullet-list li::before {
             content: "•";
             font-weight: 700;
             color: #1e40af;
             position: absolute;
             right: 0;
             font-size: 1.2rem; /* Increased for better readability */
         }
         
         .helper-response-content ol.numbered-list {
             margin: 1rem 0;
             padding-right: 1.5rem;
             counter-reset: item;
         }
         
         .helper-response-content ol.numbered-list li {
             margin-bottom: 0.8rem;
             color: #374151;
             counter-increment: item;
             position: relative;
             padding-right: 1.5rem;
         }
         
         .helper-response-content ol.numbered-list li::before {
             content: counter(item) ".";
             font-weight: 700;
             color: #1e40af;
             position: absolute;
             right: 0;
             font-size: 1.1rem;
         }
         
         /* Callout box styling for special notes */
         .helper-response-content .callout-box {
             background: #f0f9ff;
             border: 1px solid #0ea5e9;
             border-radius: 8px;
             padding: 1rem;
             margin: 1rem 0;
             border-right: 4px solid #0ea5e9;
         }
         
         .helper-response-content .callout-box strong {
             color: #0c4a6e;
             font-weight: 600;
         }
         
                 /* Mobile responsive - same width as detailed analysis for helper question responses */
        @media (max-width: 768px) {
            .helper-response-content {
                margin: 0;
                width: 100%;
                max-width: 100%;
                background: transparent;
            }
            
            .helper-response-content ul.bullet-list,
            .helper-response-content ol.numbered-list {
                margin: 0.75rem 0;
                padding-right: 1rem;
            }
            
            .helper-response-content ul.bullet-list li,
            .helper-response-content ol.numbered-list li {
                margin-bottom: 0.6rem;
                padding-right: 1rem;
                font-size: 18px; /* Increased for better readability */
            }
            
            .helper-response-content .callout-box {
                padding: 0.75rem;
                margin: 0.75rem 0;
            }
            
            /* Mobile styling for general list classes */
            .bullet-list,
            .numbered-list {
                margin: 0.75rem 0;
                padding-right: 1rem;
            }
            
            .bullet-list li,
            .numbered-list li {
                margin-bottom: 0.6rem;
                padding-right: 1rem;
                font-size: 18px; /* Increased for better readability */
            }
            
            .message-bubble.ai {
                margin: 0;
                width: 100%;
                max-width: 100%;
                border-radius: 0;
                background: transparent;
            }
            
            /* Ensure the entire chat message has same width as detailed analysis */
            .chat-message.ai {
                margin: 0;
                width: 100%;
                max-width: 100%;
            }
        }
        }
        
        /* Specific styling for mathematical symbols */
        .streaming-answer .ai-tutor-response .msg-body {
            color: #000000 !important;
        }
        
        /* Make all text in helper questions bigger and black */
        .streaming-answer .ai-tutor-response * {
            color: #000000 !important;
        }
        
        /* Mobile-specific fixes for helper questions */
        @media (max-width: 768px) {
            .bg-gray-100 {
                background-color: #e5e7eb !important;
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
                touch-action: manipulation;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
            }
            
            .bg-gray-100:active {
                background-color: #d1d5db !important;
                transform: scale(0.98);
            }
            
            .bg-gray-100:hover {
                background-color: #f3f4f6 !important;
            }
            
            /* Ensure proper touch area */
            .cursor-pointer {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Fix mobile text rendering */
            .text-gray-700 {
                color: #374151 !important;
                font-size: 16px !important;
                line-height: 1.5 !important;
            }
            
            /* Mobile-specific spacing */
            .space-y-3 > * + * {
                margin-top: 0.75rem;
            }
            
            /* Ensure proper mobile padding */
            .p-4 {
                padding: 1rem !important;
            }
            
            /* Mobile-friendly borders */
            .border {
                border-width: 1px !important;
            }
            
            /* Mobile-specific transitions */
            .transition-all {
                transition: all 0.15s ease !important;
            }
        }
          
                 /* Floating Action Button (FAB) Styling */
         #fab-container {
             position: fixed;
             bottom: 7rem; /* 112px - moved up from 6rem */
             left: 1.5rem; /* 24px from left edge */
             z-index: 60; /* Higher than bottom navigation (z-50) */
             transition: all 0.3s ease;
         }
        
        #fab-container.scale-0 {
            transform: scale(0);
            opacity: 0;
        }
        
        #fab-container.scale-100 {
            transform: scale(1);
            opacity: 1;
        }
        
        #fab-button {
            width: 3.5rem; /* 56px */
            height: 3.5rem; /* 56px */
            background-color: #d1d5db; /* Pale/light gray */
            border: 1px solid #9ca3af; /* Lighter gray border */
            border-radius: 1rem; /* 16px - rounded square */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        
        #fab-button:hover {
            background-color: #9ca3af; /* Slightly darker pale gray on hover */
            transform: translateY(-2px) scale(1.1);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0,0, 0, 0.1);
        }
        
        #fab-button:active {
            transform: scale(0.95);
        }
        
        #fab-button svg {
            width: 1.75rem; /* 28px */
            height: 1.75rem; /* 28px */
            color: #374151; /* Dark gray icon for better contrast on pale background */
            transition: color 0.3s ease;
        }
        
        #fab-button:hover svg {
            color: #1f2937; /* Even darker on hover */
        }
        
                 /* Mobile-specific FAB adjustments */
         @media (max-width: 768px) {
             #fab-container {
                 bottom: 6.5rem; /* Moved up from 5.5rem to match desktop positioning */
                 left: 1rem; /* Closer to left edge on mobile */
                 z-index: 60; /* Ensure it's above navigation on mobile too */
             }
             
             #fab-button {
                 width: 3rem; /* Slightly smaller on mobile */
                 height: 3rem;
                 background-color: #d1d5db; /* Keep consistent pale gray on mobile */
                 /* Mobile touch optimizations - less restrictive */
                 touch-action: auto; /* Allow all touch actions */
                 -webkit-tap-highlight-color: transparent;
                 -webkit-user-select: none;
                 user-select: none;
                 /* Ensure mobile clickability */
                 cursor: pointer;
                 -webkit-touch-callout: none;
             }
             
             #fab-button svg {
                 width: 1.5rem;
                 height: 1.5rem;
                 color: #374151; /* Keep dark gray icon on mobile */
             }
             
             /* Mobile FAB positioning when chat input is shown */
             #fab-container.fab-above-input {
                 bottom: 11rem;
            }
            
            /* Ensure FAB button is clickable on mobile */
            #fab-button:active {
                transform: scale(0.95);
                background-color: #9ca3af;
            }
        }
          
        /* AI Tutor Response Styling */
        .ai-tutor-response {
            font-family: 'Vazirmatn', 'Inter', sans-serif;
            direction: rtl;
            background: transparent;
            border-radius: 12px;
            overflow: hidden;
        }

        .ai-tutor-response .msg-head {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            border-radius: 12px 12px 0 0;
        }

        .ai-tutor-response .who {
            color: #2563eb;
            font-weight: 600;
            font-size: 16px; /* Changed from 18px to match chat page */
        }

        .ai-tutor-response .timestamp {
            color: #64748b;
            font-size: 14px;
        }

        .ai-tutor-response .msg-body {
            padding: 20px;
            background: transparent;
        }

        .ai-tutor-response p {
            color: #1e293b;
            line-height: 1.8;
            margin-bottom: 16px;
            font-size: 16px; /* Changed from 18px to match chat page */
            font-weight: 500;
        }

        .ai-tutor-response .ordered-list {
            margin: 20px 0;
            padding-right: 24px;
            list-style-type: decimal;
        }

        .ai-tutor-response .unordered-list {
            margin: 20px 0;
            padding-right: 24px;
            list-style-type: disc;
        }

        .ai-tutor-response .ordered-list li,
        .ai-tutor-response .unordered-list li {
            color: #374151;
            line-height: 1.8;
            margin-bottom: 12px;
            font-size: 16px; /* Changed from 18px to match chat page */
            font-weight: 500;
        }

        .ai-tutor-response .callout {
            margin: 20px 0;
            padding: 16px 20px;
            border-radius: 8px;
            border-right: 4px solid;
        }

        .ai-tutor-response .callout.warning {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .ai-tutor-response .callout.tip {
            background: #dbeafe;
            border-color: #3b82f6;
        }

        .ai-tutor-response .callout.info {
            background: #e0e7ff;
            border-color: #6366f1;
        }

        .ai-tutor-response .callout-content p {
            color: #1e293b;
            font-weight: 600;
            margin: 0;
            font-size: 16px; /* Changed from 18px to match chat page */
        }

        .ai-tutor-response .code-block {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px 16px;
            margin: 16px 0;
            font-family: 'Courier New', monospace;
            font-size: 16px;
        }

        .ai-tutor-response pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .ai-tutor-response code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
        }

        .ai-tutor-response strong {
            font-weight: 700;
            color: #1e293b;
        }

        .ai-tutor-response em {
            font-style: italic;
            color: #475569;
        }

        .ai-tutor-response h3 {
            font-size: 16px; /* Changed from 20px to match chat page */
            font-weight: 700;
            color: #1e293b;
            margin: 24px 0 16px 0;
        }
          
          /* Callout Styling */
          .ai-tutor-response .callout {
              margin: 1.5rem 0;
              padding: 1rem;
              border-radius: 0.5rem;
              border-right-width: 4px;
          }
          
          .ai-tutor-response .callout.tip {
              background-color: #f0f9ff;
              border-right-color: #3b82f6;
          }
          
          .ai-tutor-response .callout.warning {
              background-color: #fef3c7;
              border-right-color: #f59e0b;
          }
          
          .ai-tutor-response .callout.info {
              background-color: #f0fdf4;
              border-right-color: #10b981;
          }
          
          .ai-tutor-response .callout-icon {
              font-size: 1.25rem;
              margin-left: 0.75rem;
          }
          
          .ai-tutor-response .callout-content p {
              margin: 0;
              font-weight: 500;
              color: #1f2937;
          }
          
          /* Code Block Styling */
          .ai-tutor-response .code-block {
              background-color: #f9fafb;
              border: 1px solid #e5e7eb;
              border-radius: 0.5rem;
              padding: 0.75rem;
              margin: 1.5rem 0;
          }
          
          .ai-tutor-response .code-block pre {
              margin: 0;
              font-family: 'Courier New', monospace;
              font-size: 0.875rem;
              color: #374151;
              overflow-x: auto;
              white-space: pre-wrap;
              word-wrap: break-word;
          }
          
          .ai-tutor-response .code-block code {
              background: none;
              padding: 0;
              border: none;
              font-family: inherit;
          }
          
          /* Enhanced Typography for AI Responses */
          .ai-tutor-response strong {
              font-weight: 600;
              color: #1f2937;
          }
          
          .ai-tutor-response em {
              font-style: italic;
              color: #4b5563;
          }
          
          .ai-tutor-response h3 {
              font-size: 1.1rem;
              font-weight: 600;
              color: #1e40af;
              margin: 1rem 0 0.5rem 0;
              border-bottom: 1px solid #e5e7eb;
              padding-bottom: 0.25rem;
          }
          
          .ai-tutor-response code {
              background-color: #f3f4f6;
              padding: 0.125rem 0.25rem;
              border-radius: 0.25rem;
              font-family: 'Courier New', monospace;
              font-size: 0.875rem;
              color: #dc2626;
          }
          
          /* Better spacing and visual hierarchy */
          .ai-tutor-response .msg-body > *:first-child {
              margin-top: 0;
          }
          
          .ai-tutor-response .msg-body > *:last-child {
              margin-bottom: 0;
          }

                          /* Make results container clickable for toggle */
          .result-container {
              background: linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 100%);
              border-radius: 50px;
              transition: all 0.5s ease;
              overflow: hidden;
              position: relative;
              cursor: pointer;
          }
          
                     /* Modern Related Questions Section Styling */
           .related-questions-section {
               background: transparent;
               border-radius: 0;
               box-shadow: none;
               padding: 0;
               margin: 24px 0;
               border: none;
           }
           
           .related-questions-section h3 {
               color: #007bff !important;
               font-weight: 700 !important;
               font-size: 1.5rem !important;
               margin-bottom: 1.5rem !important;
               text-align: center;
               border-bottom: 2px solid #e0eaff;
               padding-bottom: 12px;
           }
           
           .question-button {
               transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
               position: relative;
               overflow: hidden;
               border: 2px solid #e5e7eb !important;
               background-color: #f3f4f6 !important;
               margin-bottom: 12px !important;
           }
           
                       .question-button:hover {
                background-color: #e0eaff !important;
                transform: translateY(-2px) scale(1.02) !important;
                box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15) !important;
            }
           
           .question-button:active {
               transform: scale(0.98) !important;
               background-color: #d1d5db !important;
               border-color: #6b7280 !important;
           }
           
           .question-text {
               font-weight: 500;
               color: #374151;
               line-height: 1.6;
               word-wrap: break-word;
               hyphens: auto;
               font-size: 1rem; /* Changed from 1.2rem to match chat page base size */
           }
          
                     /* Mobile responsiveness for related questions */
           @media (max-width: 768px) {
               .related-questions-section {
                   padding: 0;
                   margin: 20px 0;
                   border-radius: 0;
               }
               
                          .related-questions-section h3 {
               font-size: 1.25rem !important; /* Changed from 1.5rem to match chat page */
               margin-bottom: 1rem !important;
           }
               
               .question-button {
                   padding: 12px 16px !important;
                   font-size: 16px !important; /* Changed from 18px to match chat page */
                   min-height: 48px !important;
                   margin-bottom: 10px !important;
               }
               
               .question-text {
                   font-size: 16px !important; /* Changed from 18px to match chat page */
               }
           }
          
                     /* Focus states for accessibility */
           .question-button:focus {
               outline: none;
               background-color: #e0eaff !important;
           }
          
                     /* Loading state styling */
           .question-button.loading {
               background-color: #f3f4f6 !important;
               color: #6b7280 !important;
               cursor: not-allowed !important;
               pointer-events: none !important;
           }
           
                       /* Chat Input Section Styling - No border, just calm gray background */
            .user-input {
                background: #E5E7EB;
                border: none;
                border-radius: 24px;
                box-shadow: none;
            }
            

            
            /* Typing states for input */
            .user-input.typing-active {
                border: none;
                box-shadow: none;
            }
            
            /* Button color changes based on input state */
            .user-input.typing-active + button {
                background-color: #000000 !important;
            }
            
            /* Ensure input area stays visible */
            #chat-input-field {
                position: relative;
                z-index: 10;
            }
            
            #chat-input-section.show {
                transform: translateY(0) !important;
                opacity: 1 !important;
            }
            
            /* Chat Messages Styling */
            .chat-message {
                display: flex;
                margin-bottom: 1rem;
                animation: fadeInUp 0.3s ease-out;
            }
            
            .chat-message.user {
                justify-content: flex-end;
            }
            
            .chat-message.ai {
                justify-content: flex-start;
            }
            
                    .message-bubble {
            max-width: 95%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.4;
            font-size: 1rem; /* Changed from 1.1rem to match chat page */
        }
            
            .message-bubble.user {
                background-color: #F3F4F6;
                color: #374151;
                border-bottom-right-radius: 6px;
                max-width: 70%;
                align-self: flex-end;
            }
            
            .message-bubble.ai {
                background-color: transparent;
                color: #1F2937;
                border: none;
                border-bottom-left-radius: 6px;
                box-shadow: none;
                max-width: 100%;
                width: 100%;
                margin: 0;
            }
            
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            /* Send button positioning and sizing */
            #send-chat-button {
                position: absolute;
                right: 8px; /* 2rem = 8px */
                top: 7%;
                transform: translateY(-50%);
                width: 48px; /* w-12 = 48px */
                height: 48px; /* h-12 = 48px */
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 20;
            }
            
            /* Mobile responsiveness for chat input */
            @media (max-width: 768px) {
                #chat-input-section {
                    bottom: 20px; /* Position much closer to bottom navigation */
                    padding-bottom: 0;
                    /* Mobile-specific positioning fixes */
                    transform: translateY(100%) !important; /* Force initial hidden state */
                    transition: transform 0.3s ease, opacity 0.3s ease;
                }
                
                #chat-input-section.show {
                    transform: translateY(0) !important; /* Force visible state on mobile */
                    opacity: 1 !important;
                }
                
                                 #send-chat-button {
                     width: 48px;
                     height: 48px;
                     right: 6px;
                     top: 7%;
                     /* Mobile-specific send button fixes */
                     touch-action: auto;
                     -webkit-tap-highlight-color: transparent;
                     cursor: pointer;
                     z-index: 20;
                 }
                
                /* Standard width message bubbles on mobile */
                .message-bubble {
                    max-width: 90%;
                    margin-left: 0;
                    margin-right: 0;
                    width: auto;
                    border-radius: 18px;
                }
                
                .message-bubble.ai {
                    background: transparent;
                    max-width: 100%;
                    width: 100%;
                }
                
                /* User messages stay shorter on mobile */
                .message-bubble.user {
                    max-width: 70%;
                    margin-left: 0;
                    margin-right: 0;
                    width: auto;
                    border-radius: 18px;
                    border-bottom-right-radius: 6px;
                }
                
                /* Comprehensive Content Formatting Styles */
                .content-header {
                    font-family: Arial, Roboto, system-ui, sans-serif;
                    font-weight: 700;
                    color: #1e40af;
                    margin-top: 1.5rem;
                    margin-bottom: 1rem;
                    line-height: 1.3;
                }
                
                .content-header.h1 {
                    font-size: 2rem;
                    color: #1e40af;
                }
                
                .content-header.h2 {
                    font-size: 1.75rem;
                    color: #1e40af;
                }
                
                .content-header.h3 {
                    font-size: 1.5rem;
                    color: #1e40af;
                }
                
                .content-header.h4 {
                    font-size: 1.25rem;
                    color: #1e40af;
                }
                
                .content-header.h5 {
                    font-size: 1rem; /* Changed from 1.125rem to match chat page */
                    color: #1e40af;
                }
                
                .content-header.h6 {
                    font-size: 1rem;
                    color: #1e40af;
                }
                
                .content-paragraph {
                    font-size: 18px; /* Increased for better readability */
                    line-height: 1.6;
                    margin-bottom: 1rem;
                    color: #374151;
                    text-align: justify;
                }
                
                .content-list {
                    margin: 1rem 0;
                    padding-right: 1.5rem;
                    list-style: none;
                }
                
                .content-list li {
                    margin-bottom: 0.8rem;
                    color: #374151;
                    position: relative;
                    padding-right: 1.5rem;
                    font-size: 18px; /* Increased for better readability */
                    line-height: 1.5;
                }
                
                .content-list li::before {
                    content: "•";
                    font-weight: 700;
                    color: #1e40af;
                    position: absolute;
                    right: 0;
                    font-size: 1rem; /* Changed from 1.2rem to match chat page */
                }
                
                .content-list ol li::before {
                    content: counter(item) ".";
                    counter-increment: item;
                }
                
                .code-block {
                    background-color: transparent;
                    border: none;
                    padding: 0.5rem 0;
                    margin: 1rem 0;
                    overflow-x: auto;
                    font-family: 'Courier New', monospace;
                    font-size: 16px; /* Increased for better readability */
                    line-height: 1.4;
                }
                
                .code-block code {
                    color: #374151;
                    background: transparent;
                }
                
                .inline-code {
                    background-color: transparent;
                    border: none;
                    padding: 0;
                    font-family: 'Courier New', monospace;
                    font-size: 16px; /* Increased for better readability */
                    color: #374151;
                    font-weight: 600;
                }
                
                .content-link {
                    color: #2563eb;
                    text-decoration: underline;
                    transition: color 0.2s ease;
                }
                
                .content-link:hover {
                    color: #1d4ed8;
                    text-decoration: none;
                }
                
                .content-blockquote {
                    background-color: transparent;
                    border: none;
                    padding: 0.5rem 0;
                    margin: 1rem 0;
                    font-style: italic;
                    color: #6b7280;
                    font-size: 18px; /* Increased for better readability */
                    line-height: 1.6;
                }
                
                .content-hr {
                    border: none;
                    height: 1px;
                    background-color: #d1d5db;
                    margin: 1.5rem 0;
                }
                
                /* Simple callout box styling - clean and minimal */
                .callout-box {
                    background: transparent;
                    border: none;
                    padding: 0.5rem 0;
                    margin: 1rem 0;
                    position: relative;
                }
                
                .callout-box strong {
                    color: #1e40af;
                    font-weight: 600;
                    font-size: 1rem;
                    display: inline;
                    margin-left: 0.5rem;
                }
                

        
        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .content-header.h1 { font-size: 1.75rem; }
                            .content-header.h2 { font-size: 1.25rem; /* Changed from 1.5rem to match chat page */ }
        .content-header.h3 { font-size: 1rem; /* Changed from 1.25rem to match chat page */ }
            .content-header.h4 { font-size: 1.125rem; }
            .content-header.h5 { font-size: 1rem; }
            .content-header.h6 { font-size: 0.95rem; }
            
            .content-paragraph {
                font-size: 18px; /* Increased for better readability */
                margin-bottom: 0.875rem;
            }
            
            .content-list li {
                        font-size: 18px; /* Increased for better readability */
                        margin-bottom: 0.7rem;
                        padding-right: 1.25rem;
                    }
                    
                    .code-block {
                        padding: 0.875rem;
                        font-size: 16px; /* Increased for better readability */
                    }
                    
                    .inline-code {
                        font-size: 16px; /* Increased for better readability */
                        padding: 0.2rem 0.4rem;
                    }
                    
                    .content-blockquote {
                        padding: 0.875rem 1.25rem;
                        font-size: 18px; /* Increased for better readability */
                    }
                    
                    .callout-box {
                        padding: 1rem;
                        margin: 1.25rem 0;
                    }
                }
            }
        </style>
</head>
         <body style="background-color: #F8F9FA;">
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 bg-gradient-to-r from-gray-50 via-gray-75 to-gray-50 border-b border-gray-200 z-50">
        <div class="flex justify-center items-center px-6 py-4 relative">
            <!-- Center: Page Title -->
            <div class="text-center">
                <h1 class="text-2xl font-bold text-gray-900">نتایج تحلیل سوال</h1>
            </div>
            
            <!-- Right: Cross Logo (Back to Chapter) -->
            <button class="p-2 hover:bg-gray-200 rounded-lg transition-colors absolute right-6" onclick="goToChapter()" title="بازگشت به صفحه فصل">
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Content -->
         <main class="pt-20 pb-24 px-6" style="background-color: #F8F9FA;">
        <div class="max-w-4xl mx-auto">
            <!-- Results Section -->
            <div id="result-container" class="result-container shadow-2xl p-8 mb-8" onclick="toggleResults()">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">نتیجه پاسخ شما</h2>
                    
                    <!-- Result Display -->
                    <div id="result-display" class="mb-8">

                         
                        <!-- Loading State -->
                        <div id="question-loading" class="hidden">
                            <!-- Simple loading state for question results -->
                            <div class="flex items-center justify-center space-x-3 space-x-reverse p-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                <span class="text-gray-600 text-lg">در حال بررسی پاسخ شما...</span>
                            </div>
                        </div>
                        
                        <!-- Results Content -->
                        <div id="question-results">
                            <!-- Results will be populated by JavaScript -->
                        </div>
                    </div>
                     
                    <!-- Analysis Request Button -->
                    <div class="mb-8 text-center">
                        <button id="analysis-btn" 
                                class="bg-blue-600 text-white font-bold py-4 px-12 rounded-full hover:bg-blue-700 transition-all shadow-lg text-2xl mx-2"
                                onclick="event.stopPropagation(); requestAnalysis()">
                            تحلیل سوال
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Detailed Analysis Section - Outside Results but on Main Page -->
            <div id="detailed-analysis-section" class="hidden mt-8">
                <!-- Analysis Content -->
                <div id="analysis-content" class="p-8">
                    <!-- Streaming content will appear here -->
                    <div id="streaming-content"></div>
                    
                    <!-- AI-generated help questions will be rendered here dynamically -->
                    <div id="ai-help-questions"></div>
                </div>
                
                <!-- Chat Messages Display Area - Seamlessly Integrated -->
                <div id="chat-messages" class="mt-0 space-y-3">
                    <!-- Chat messages will appear here -->
                </div>
                
                <!-- Error State -->
                <div id="analysis-error" class="hidden text-center py-8">
                    <div class="bg-red-50 rounded-xl p-6 border border-red-200">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </div>
                        <p class="text-red-800 font-semibold mb-2 text-xl">خطا در تحلیل سوال</p>
                        <p class="text-red-600 mb-4 text-lg">لطفاً دوباره تلاش کنید</p>
                        <button onclick="requestAnalysis()" class="bg-red-600 text-white px-8 py-3 rounded-lg hover:bg-red-700 transition-colors font-medium">
                            تلاش مجدد
                        </button>
                    </div>
                </div>
            </div>

                         <!-- Floating Action Button (FAB) - Initially Hidden -->
             <div id="fab-container" class="fixed bottom-24 left-6 z-50 transition-all duration-500 transform scale-0 opacity-0">
                 

                 <button id="fab-button" 
                         class="w-14 h-14 bg-gray-100 hover:bg-gray-200 rounded-2xl shadow-lg flex items-center justify-center transition-all duration-300 hover:scale-110 active:scale-95 border border-gray-200"
                         title="پرسش جدید">
                     <svg class="w-7 h-7 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                     </svg>
                 </button>
             </div>
             

             
                           <!-- Chat Input Section - Initially Hidden -->
              <div id="chat-input-section" class="fixed bottom-0 left-0 right-0 bg-transparent transition-all duration-300 transform translate-y-full opacity-0" style="z-index: 50;">
                  <!-- User Input -->
                  <div class="px-4 sm:px-6 pb-4" style="z-index: 10; pointer-events: none;">
                      <div class="max-w-5xl mx-auto flex justify-center">
                          <div class="relative w-full max-w-2xl">
                              <textarea 
                                  id="chat-input-field" 
                                  class="user-input w-full px-5 py-4 pr-20 resize-none text-gray-900 placeholder-gray-500 text-xl transition-all duration-200"
                                  placeholder="...Learn anything"
                                  rows="1"
                                  oninput="autoResize(this)"
                                  onfocus="handleInputFocus(this)"
                                  onblur="handleInputBlur(this)"
                                  onclick="handleInputFocus(this)"
                                  style="pointer-events: auto; min-height: 56px; border: none; outline: none;"
                              ></textarea>
                              
                              <!-- Send Button - Hidden initially, shown on input focus -->
                              <button 
                                  id="send-chat-button"
                                  class="absolute right-2 top-1/2 w-16 h-16 bg-gray-400 text-white rounded-full transition-all duration-200 flex items-center justify-center z-20"
                                  style="opacity: 0; pointer-events: none; transform: translateY(-50%) scale(0.75);"
                              >
                                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                                  </svg>
                              </button>
                          </div>
                      </div>
                  </div>
              </div>
            
        </div>
    </main>

    <!-- Bottom Mobile Navigation -->
    <nav id="bottom-navigation" class="fixed bottom-0 left-0 right-0 bg-[#e8e8e4] z-50 transition-opacity duration-300">
        <div class="flex justify-around items-center py-4 px-6">
            <!-- Chat Icon (Document with Pencil) -->
            <button class="flex flex-col items-center justify-center p-3 rounded-2xl transition-all duration-300 hover:bg-gray-100/40 active:scale-90 hover:scale-105" onclick="window.location.href='index.html'">
                <div class="w-6 h-6 relative">
                    <!-- Document with text lines -->
                    <svg class="w-6 h-6 text-gray-400" fill="white" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <rect x="3" y="3" width="18" height="18" rx="2" fill="white" stroke="currentColor" stroke-width="2"/>
                        <line x1="9" y1="9" x2="15" y2="9" stroke="currentColor" stroke-width="2"/>
                        <line x1="9" y1="13" x2="15" y2="13" stroke="currentColor" stroke-width="2"/>
                </svg>
                    <!-- Pencil positioned diagonally from bottom-right -->
                    <svg class="w-4 h-4 text-gray-400 absolute -bottom-1 -right-1 transform rotate-45" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                    </svg>
                </div>
                                        <span class="text-xs text-gray-400 mt-1">چت</span>
            </button>
            
            <!-- Library Icon -->
            <button class="flex flex-col items-center justify-center p-3 rounded-2xl transition-all duration-300 hover:bg-gray-100/40 active:scale-90 hover:scale-105" onclick="window.location.href='chapters.html'">
                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                </svg>
                                        <span class="text-xs text-gray-400 mt-1">کتابخانه</span>
            </button>
            
            <!-- Analysis/Test Icon (Checkmark) -->
            <button class="flex flex-col items-center justify-center p-3 rounded-2xl transition-all duration-300 hover:bg-gray-100/40 active:scale-90 hover:scale-105 bg-blue-100" onclick="window.location.href='#'">
                <div class="w-6 h-6 rounded-full border-2 border-gray-900 flex items-center justify-center bg-white">
                    <svg class="w-4 h-4 text-gray-900" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
                </div>
                                        <span class="text-xs text-blue-600 mt-1 font-medium">تحلیل</span>
            </button>
        </div>
    </nav>

    <script>
        let questionData = null;
        let currentSubject = '';
        
        // Conversation history system variables
        let currentConversationId = 'analysis_' + Date.now();
        let conversationMessages = [];
        let isConversationInitialized = false;

        // Initialize conversation history system
        async function initializeConversation() {
            try {
                const response = await fetch('/api/chat/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                currentConversationId = data.conversationId;
                isConversationInitialized = true;
                console.log('✅ Analysis page conversation started:', currentConversationId);
            } catch (error) {
                console.error('❌ Failed to start conversation:', error);
                // Use fallback conversation ID
                currentConversationId = 'analysis_' + Date.now();
                isConversationInitialized = true;
            }
        }
        
        // Add message to conversation history
        function addToConversationHistory(role, content, messageType = 'text') {
            const message = {
                role: role,
                content: content,
                type: messageType,
                timestamp: new Date().toISOString()
            };
            
            conversationMessages.push(message);
            console.log(`📝 Added ${role} message to conversation history. Total: ${conversationMessages.length}`);
            
            // Keep only last 20 messages to prevent memory issues
            if (conversationMessages.length > 20) {
                conversationMessages.splice(0, conversationMessages.length - 20);
            }
            
            // Display updated conversation history for debugging
            displayConversationHistory();
        }
        
        // Get conversation context for AI responses
        function getConversationContext() {
            return conversationMessages.map(msg => ({
                role: msg.role,
                content: msg.content
            }));
        }
        
        // Display conversation history (for debugging and user reference)
        function displayConversationHistory() {
            console.log('📚 Current conversation history:');
            conversationMessages.forEach((msg, index) => {
                console.log(`${index + 1}. [${msg.role.toUpperCase()}] ${msg.type}: ${msg.content.substring(0, 100)}...`);
            });
            console.log(`📊 Total messages: ${conversationMessages.length}`);
        }
        
        // Clear conversation history (useful for starting fresh)
        function clearConversationHistory() {
            conversationMessages = [];
            console.log('🗑️ Conversation history cleared');
        }
        
                // Get URL parameters and decode data
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            
            console.log('🔍 getUrlParams() called');
            console.log('📊 URL data param:', dataParam);
            
            if (dataParam) {
                try {
                    questionData = JSON.parse(decodeURIComponent(dataParam));
                    currentSubject = questionData.subject;
                    console.log('✅ Question data parsed successfully:', questionData);
                    console.log('🚀 About to call displayResults()...');
                    displayResults();
                } catch (error) {
                    console.error('Error parsing data:', error);
                    alert('خطا در بارگذاری اطلاعات سوال');
                }
            } else {
                console.log('⚠️ No question data found in URL');
                alert('اطلاعات سوال یافت نشد');
                goBack();
            }
        }

        // Display the results
        async function displayResults() {
            if (!questionData) return;

            console.log('🚀 displayResults() called with questionData:', questionData);

            // Apply subject-specific styling
            const container = document.getElementById('result-container');
            if (currentSubject === 'biology') {
                container.classList.add('biology');
            } else {
                container.classList.remove('biology');
            }
            
            console.log('🚀 displayResults() called, about to show loading state...');
            
            // Show loading state
            showQuestionLoading();
            
            console.log('⏳ Loading state shown, starting AI evaluation...');
            
            // Get AI evaluation of the answer with timeout
            try {
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('AI evaluation timed out')), 15000); // 15 second timeout
                });
                
                await Promise.race([
                    getAIResultEvaluation(),
                    timeoutPromise
                ]);
            } catch (error) {
                console.error('❌ AI evaluation failed or timed out:', error);
                console.log('🔄 Falling back to static result display...');
                // Fallback to static display
                showStaticResult();
            }
        }
        
        // Get AI evaluation of the question result
        async function getAIResultEvaluation() {
            try {
                const evaluationData = {
                    question: questionData.question,
                    options: questionData.options,
                    userAnswer: questionData.userAnswer,
                    subject: questionData.subject,
                    grade: questionData.grade,
                    chapter: questionData.chapter
                };
                
                console.log('🚀 Starting AI evaluation for:', questionData.question);
                console.log('📊 User answer:', questionData.userAnswer, 'Correct answer:', questionData.correctAnswer);
                
                // First check if backend is accessible
                try {
                    const testResponse = await fetch('/api/chat/result-evaluation', { method: 'HEAD' });
                    console.log('🔍 Backend accessibility test:', testResponse.status);
                } catch (testError) {
                    console.log('⚠️ Backend might not be running or accessible');
                }
                
                const response = await fetch('/api/chat/result-evaluation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(evaluationData)
                });
                
                console.log('📡 Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`خطا در ارتباط با سرور: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('✅ AI evaluation successful:', result);
                displayAIResult(result.content);
                
            } catch (error) {
                console.error('❌ AI evaluation failed:', error);
                throw error;
            }
        }
        
        // Show loading state for question results
        function showQuestionLoading() {
            console.log('🔄 Showing question loading state...');
            const questionLoading = document.getElementById('question-loading');
            const questionResults = document.getElementById('question-results');
            
            console.log('🔍 Elements found:', {
                questionLoading: questionLoading,
                questionResults: questionResults
            });
            
            // Check if elements exist
            if (!questionLoading || !questionResults) {
                console.error('❌ Loading state elements not found');
                return;
            }
            
            // Hide results content and show loading
            questionResults.classList.add('hidden');
            questionLoading.classList.remove('hidden');
            
            console.log('✅ Question loading state shown successfully');
            console.log('👁️ Loading element classes:', questionLoading.className);
            console.log('👁️ Results element classes:', questionResults.className);
        }
        
        // Display AI-generated result
        function displayAIResult(content) {
            console.log('🎯 Displaying AI result...');
            console.log('📝 AI content received:', content.substring(0, 100) + '...');
            
            const questionLoading = document.getElementById('question-loading');
            const questionResults = document.getElementById('question-results');
            
            console.log('🔍 Elements found for AI result:', {
                questionLoading: questionLoading,
                questionResults: questionResults
            });
            
            // Check if elements exist
            if (!questionLoading || !questionResults) {
                console.error('❌ Result display elements not found');
                return;
            }
            
            // Add a small delay to make loading state more visible
            setTimeout(() => {
                // Hide loading and show results
                questionLoading.classList.add('hidden');
                questionResults.classList.remove('hidden');
                console.log('✅ Loading hidden, AI results shown');
                
                // Parse the AI response to determine if answer is correct (check for Persian words)
                const isCorrect = content.includes('صحیح') || content.includes('درست');
                const colorClass = isCorrect ? 'green' : 'red';
                
                console.log('📊 AI result analysis:', { isCorrect, colorClass });
                
                // Convert numbered lists to bullet points and format content
                let formattedContent = content
                    .replace(/^\d+\.\s+/gm, '• ') // Convert numbered lists to bullet points
                    .replace(/\n/g, '<br>');
                
                questionResults.innerHTML = `
                    <div class="bg-${colorClass}-50 rounded-xl p-6 border border-${colorClass}-200 mb-6">
                        <div class="flex items-center justify-center space-x-4 space-x-reverse">
                            <div class="w-12 h-12 bg-${colorClass}-100 rounded-full flex items-center justify-center">
                                <svg class="w-7 h-7 text-${colorClass}-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    ${isCorrect ? 
                                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' :
                                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'
                                    }
                                </svg>
                            </div>
                            <div class="text-center">
                                <div class="analysis-content text-xl font-semibold text-black">
                                    ${formattedContent}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }, 1000); // Show loading for at least 1 second
        }
        
        // Fallback to static result display
        function showStaticResult() {
            console.log('🔄 Showing static result...');
            const questionLoading = document.getElementById('question-loading');
            const questionResults = document.getElementById('question-results');
            
            // Check if elements exist
            if (!questionLoading || !questionResults) {
                console.error('❌ Static result display elements not found');
                return;
            }
            
            // Hide loading and show results
            questionLoading.classList.add('hidden');
            questionResults.classList.remove('hidden');
            console.log('✅ Loading hidden, static results shown');
            
            const isCorrect = questionData.userAnswer === questionData.correctAnswer;
            const colorClass = isCorrect ? 'green' : 'red';
            questionResults.innerHTML = `
                <div class="bg-${colorClass}-50 rounded-xl p-6 border border-${colorClass}-200 mb-6">
                    <div class="flex items-center justify-center space-x-4 space-x-reverse">
                        <div class="w-12 h-12 bg-${colorClass}-100 rounded-full flex items-center justify-center">
                            <svg class="w-7 h-7 text-${colorClass}-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                ${isCorrect ? 
                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' :
                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'
                                }
                            </svg>
                        </div>
                        <div class="text-center">
                            <p class="text-xl font-bold text-${colorClass}-800">
                                ${isCorrect ? 'پاسخ صحیح!' : 'پاسخ نادرست'}
                            </p>
                            <p class="text-lg text-${colorClass}-600">
                                پاسخ صحیح: ${questionData.correctAnswer}) ${getChoiceText(questionData.correctAnswer)}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Get choice text
        function getChoiceText(choice) {
            if (!questionData) return '';
            
            const choiceIndex = choice.charCodeAt(0) - 65; // Convert A=0, B=1, etc.
            const option = questionData.options[choiceIndex];
            return option.substring(option.indexOf('.') + 1).trim();
        }
        


                 // Request analysis from LLM API
         async function requestAnalysis() {
             console.log('Analysis button clicked!'); // Debug log
             
             // First, collapse the results section with smooth animation
             const resultContainer = document.getElementById('result-container');
             resultContainer.classList.add('collapsed');
             
                           // Arrow button removed - no need to update
            
                         // Wait for collapse animation to complete, then prepare detailed analysis
             setTimeout(() => {
                 // Show the detailed analysis section
                 const detailedAnalysisSection = document.getElementById('detailed-analysis-section');
                 console.log('Detailed analysis section element:', detailedAnalysisSection); // Debug log
                 
                 if (detailedAnalysisSection) {
                     // Show the analysis section
                     detailedAnalysisSection.classList.remove('hidden');
                     detailedAnalysisSection.style.display = 'block';
                 }
                
                                 // Prepare analysis content area with loading state immediately
                 const analysisContent = document.getElementById('analysis-content');
                 const analysisError = document.getElementById('analysis-error');
                 
                 if (analysisContent) {
                     // Ensure ai-help-questions div exists
                     let helpQuestionsDiv = document.getElementById('ai-help-questions');
                     if (!helpQuestionsDiv) {
                         helpQuestionsDiv = document.createElement('div');
                         helpQuestionsDiv.id = 'ai-help-questions';
                         analysisContent.appendChild(helpQuestionsDiv);
                     }
                 }
                 
                 if (analysisError) {
                     analysisError.classList.add('hidden');
                 }
            
                         // Show loading state immediately
             const streamingContent = document.getElementById('streaming-content');
                           streamingContent.innerHTML = `
                  <div class="analysis-content text-xl">
                                              <!-- Loading state as first line -->
                         <div class="flex items-center justify-center space-x-3 space-x-reverse mb-6">
                             <div class="relative">
                                 <!-- Graduation Cap Logo -->
                                 <div class="w-10 h-10 bg-gradient-to-br from-blue-500 via-blue-600 to-blue-700 rounded-xl shadow-lg flex items-center justify-center">
                                     <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"></path>
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"></path>
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"></path>
                                     </svg>
                                 </div>
                                 <!-- Spinning Ring -->
                                 <div class="absolute inset-0 animate-spin rounded-xl border-2 border-transparent border-t-blue-400 border-r-blue-300"></div>
                             </div>
                             <span class="text-gray-600 text-lg">در حال فکر کردن...</span>
                         </div>
                     <div id="streaming-text"></div>
                 </div>
             `;
            
                // FAB button will be shown only when helper questions are sent
                // hideFloatingActionButton(); // Keep hidden until helper questions are used
                
                // Start the API request after showing the analysis section
                startAnalysisRequest();
            }, 500); // Wait for collapse animation to complete
        }
        
        // Separate function to start the actual analysis request
        async function startAnalysisRequest() {
            // Disable analysis button
            document.getElementById('analysis-btn').disabled = true;
            document.getElementById('analysis-btn').textContent = 'در حال تحلیل...';
            
            try {
                // Prepare the analysis request
                const analysisData = {
                    question: questionData.question,
                    options: questionData.options,
                    correctAnswer: questionData.correctAnswer,
                    userAnswer: questionData.userAnswer,
                    subject: questionData.subject,
                    grade: questionData.grade,
                    chapter: questionData.chapter
                };
                
                console.log('Sending analysis request:', analysisData); // Debug log
                
                // Call the streaming LLM API
                const response = await fetch('/api/chat/analysis/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(analysisData)
                });
                
                if (!response.ok) {
                    throw new Error('خطا در ارتباط با سرور');
                }
                
                // Stream the analysis with typewriter effect
                await streamAnalysisResponse(response);
                
            } catch (error) {
                console.error('Analysis error:', error);
                
                // Show error message
                document.getElementById('analysis-error').classList.remove('hidden');
            } finally {
                // Re-enable analysis button
                document.getElementById('analysis-btn').disabled = false;
                document.getElementById('analysis-btn').textContent = 'تحلیل سوال';
            }
        }
        
                 // Function to toggle results section between collapsed and expanded
         function toggleResults() {
             console.log('Toggle button clicked!'); // Debug log
             
             const resultContainer = document.getElementById('result-container');
             const isCollapsed = resultContainer.classList.contains('collapsed');
             
                           if (isCollapsed) {
                  // Expand results section
                  resultContainer.classList.remove('collapsed');
                  console.log('Results expanded');
              } else {
                  // Collapse results section
                  resultContainer.classList.add('collapsed');
                  console.log('Results collapsed');
              }
         }
         
                   // Arrow button function removed - no longer needed

        // Analysis function for detailed question breakdown
        
        // Toggle function removed for simplicity

                // Stream analysis response with typewriter effect
        async function streamAnalysisResponse(response) {
            const streamingContent = document.getElementById('streaming-content');
            const loadingDiv = streamingContent.querySelector('.flex.items-center.justify-center');
            const streamingText = document.getElementById('streaming-text');
            let fullResponse = '';
            
            // Hide loading state and show streaming content
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }
            
            try {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            
                            if (data === '[DONE]') {
                                // Final formatting after streaming is complete
                                formatFinalAnalysis(streamingText.innerHTML);
                                return;
                            }
                            
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.content && parsed.type === 'chunk') {
                                    fullResponse += parsed.content;
                                    
                                    // Process and display the content
                                    const formattedContent = formatStreamingContent(fullResponse);
                                    streamingText.innerHTML = formattedContent;
                                    
                                    // Auto-scroll to bottom
                                    streamingText.scrollTop = streamingText.scrollHeight;
                                }
                            } catch (e) {
                                // Ignore parsing errors for incomplete chunks
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Streaming error:', error);
                throw error;
            }
        }
        
                           // Format streaming content in real-time with smart bullet point detection
          function formatStreamingContent(content) {
              let formatted = content;
              
              // Replace line breaks with proper HTML
              formatted = formatted.replace(/\n\n/g, '</p><p class="content-paragraph">');
              formatted = formatted.replace(/\n/g, '<br>');
              
              // Smart bullet point detection - only convert actual list items
              const lines = formatted.split('<br>');
              const processedLines = lines.map(line => {
                  // Only convert to bullet point if it looks like a list item
                  if (line.trim().match(/^-\s+\w+/)) {
                      // Check if the next line also starts with dash (indicating a list)
                      const lineIndex = lines.indexOf(line);
                      const nextLine = lines[lineIndex + 1];
                      const prevLine = lines[lineIndex - 1];
                      
                      // Convert to bullet point if it's part of a list structure
                      if ((nextLine && nextLine.trim().match(/^-\s+\w+/)) || 
                          (prevLine && prevLine.trim().match(/^-\s+\w+/))) {
                          return line.replace(/^-\s+/, '• ');
                      }
                  }
                  return line;
              });
              
              formatted = processedLines.join('<br>');
              
              // Add paragraph tags with proper font size class
              formatted = `<p class="content-paragraph">${formatted}</p>`;
              
              // Add special styling for structured sections with clean formatting
              formatted = formatted
                  .replace(/1\. ✅\/❌/g, '<div class="analysis-section"><h3>1. ✅/❌ نتیجه پاسخ</h3>')
                  .replace(/2\. 📝/g, '</div><div class="analysis-section"><h3>2. 📝 راه‌حل گام به گام</h3>')
                  .replace(/3\. ⚡/g, '</div><div class="analysis-section"><h3>3. ⚡ روش سریع</h3>')
                  .replace(/4\. ❗/g, '</div><div class="analysis-section"><h3>4. ❗ اشتباه رایج</h3>')
                  .replace(/5\. 🎯/g, '</div><div class="analysis-section"><h3>5. 🎯 نکته کلیدی</h3>');
              
              // Close the last section
              formatted += '</div>';
              
              // Clean up any extra formatting
              formatted = formatted.replace(/<p><\/p>/g, '');
              
              return formatted;
          }
          
                     // Function to clean content by removing JSON helper questions
         function cleanContentFromHelpQuestions(content) {
             if (!content) return content;
             
             // Remove JSON helper questions block from main content
             try {
                 const jsonMatch = content.match(/\{[\s\S]*"helper_questions"[\s\S]*\}/);
                 if (jsonMatch) {
                     console.log('✅ Removing JSON helper questions block from main content');
                     return content.replace(jsonMatch[0], '').trim();
                 }
             } catch (error) {
                 console.log('❌ Error removing JSON helper questions');
             }
             
             return content;
         }
        
                                     // Final formatting after streaming is complete
           function formatFinalAnalysis(content) {
               const contentDiv = document.getElementById('analysis-content');
               if (contentDiv) {
                    // First, extract helper questions from the original content
                    const questions = extractRelatedQuestions(content);
                    
                    // Then, remove ONLY the helper questions section from the content before formatting
                    // Be very careful not to remove the main analysis content with dash-prefixed lines
                    let cleanedContent = content;
                    if (questions && questions.length > 0) {
                        // Use a more targeted approach to only remove the "Related Questions" section
                        // without affecting the main analysis content (like نکته طلایی)
                        
                        // Strategy 1: Remove the entire "Related Questions:" section with its questions
                        // Look for the specific pattern: header + newline + questions
                        const relatedQuestionsPattern = /(?:Related Questions|سوالات مرتبط|سوالات کمکی|سوالات مشابه|سوالات)\s*:?\s*[\r\n]+((?:-\s*[^\r\n]+[\r\n]*)+)/gi;
                        cleanedContent = cleanedContent.replace(relatedQuestionsPattern, '');
                        
                        // Strategy 2: Remove HTML formatted helper questions section
                        // Look for the pattern: header + <br> + questions
                        const htmlQuestionsPattern = /(?:Related Questions|سوالات مرتبط|سوالات کمکی|سوالات مشابه|سوالات)\s*:?\s*<br>((?:-\s*[^<]+<br>)+)/gi;
                        cleanedContent = cleanedContent.replace(htmlQuestionsPattern, '');
                        
                        // Strategy 3: Remove any remaining helper questions that might be at the end
                        // This is the safest approach - only remove questions that come after the main content
                        const endQuestionsPattern = /[\r\n]+\s*(?:Related Questions|سوالات مرتبط|سوالات کمکی|سوالات مشابه|سوالات)\s*:?\s*[\r\n]*((?:-\s*[^\r\n]+[\r\n]*)+)\s*$/gi;
                        cleanedContent = cleanedContent.replace(endQuestionsPattern, '');
                        
                        // Strategy 4: Remove HTML end questions that are at the very end
                        const htmlEndQuestionsPattern = /<br>\s*(?:Related Questions|سوالات مرتبط|سوالات کمکی|سوالات مشابه|سوالات)\s*:?\s*<br>((?:-\s*[^<]+<br>)+)\s*$/gi;
                        cleanedContent = cleanedContent.replace(htmlEndQuestionsPattern, '');
                        
                        // Strategy 5: Remove the specific pattern we found in the AI response
                        // This removes the pattern: "حالا بیایید تمرین کنیم تا مطمئن شویم مفهوم را خوب فهمیده‌ایم:" + questions
                        const exercisePattern = /حالا بیایید تمرین کنیم تا مطمئن شویم مفهوم را خوب فهمیده‌ایم\s*:?\s*<br>((?:-\s*[^<]+<br>)+)/gi;
                        cleanedContent = cleanedContent.replace(exercisePattern, '');
                        
                        // Strategy 6: Remove any remaining dash-prefixed questions at the end
                        // This catches the specific format: "- سوال؟- سوال؟- سوال؟- سوال؟"
                        const remainingQuestionsPattern = /<br>\s*-\s*[^<]+(?:-\s*[^<]+)*<br>\s*$/gi;
                        cleanedContent = cleanedContent.replace(remainingQuestionsPattern, '');
                        
                        // Strategy 7: Remove ONLY the specific question section at the end (much safer)
                        // This targets only the very end where questions appear, not the main content
                        const endQuestionSectionPattern = /<br>\s*حالا بیایید تمرین کنیم تا مطمئن شویم مفهوم را خوب فهمیده‌ایم\s*:?\s*<br>((?:-\s*[^<]+<br>)+)\s*$/gi;
                        cleanedContent = cleanedContent.replace(endQuestionSectionPattern, '');
                        
                        // Strategy 8: Remove any trailing questions that are clearly at the end
                        // This is much more conservative and only removes questions at the very end
                        const trailingQuestionsPattern = /<br>\s*-\s*[^<]+(?:<br>\s*-\s*[^<]+)*\s*$/gi;
                        cleanedContent = cleanedContent.replace(trailingQuestionsPattern, '');
                        
                        // Strategy 9: SUPER SAFE - Only remove the very specific format at the very end
                        // Look for the exact pattern: "حالا بیایید تمرین کنیم" followed by 4 dash questions
                        const exactExercisePattern = /حالا بیایید تمرین کنیم تا مطمئن شویم مفهوم را خوب فهمیده‌ایم\s*:?\s*<br>\s*-\s*[^<]+<br>\s*-\s*[^<]+<br>\s*-\s*[^<]+<br>\s*-\s*[^<]+/gi;
                        cleanedContent = cleanedContent.replace(exactExercisePattern, '');
                        
                        // Strategy 10: SUPER SAFE - Only remove if we see exactly 4 dash questions in sequence
                        // This is much more conservative and only targets the specific case
                        const fourDashPattern = /(?:<br>\s*-\s*[^<]+){4,}/gi;
                        if (fourDashPattern.test(cleanedContent)) {
                            // Only remove if we have exactly 4+ dash questions AND they're at the end
                            const endFourDashPattern = /(?:<br>\s*-\s*[^<]+){4,}\s*$/gi;
                            cleanedContent = cleanedContent.replace(endFourDashPattern, '');
                        }
                        
                        // Clean up any trailing empty lines or br tags
                        cleanedContent = cleanedContent.replace(/[\r\n\s]+$/, '');
                        cleanedContent = cleanedContent.replace(/<br>\s*$/i, '');
                        
                        console.log('✅ Removed ONLY helper questions section from main content');
                        console.log('✅ Preserved main analysis content with structured sections');
                        console.log('✅ Content length before:', content.length, 'after:', cleanedContent.length);
                        console.log('🔍 DEBUG: Original content preview:', content.substring(Math.max(0, content.length - 500)));
                        console.log('🔍 DEBUG: Cleaned content preview:', cleanedContent.substring(Math.max(0, cleanedContent.length - 500)));
                    }
                    
                    // Now format the cleaned content for display
                   const formattedContent = formatAIResponseWithStructure(cleanedContent, 'detailed-analysis');
                   contentDiv.innerHTML = formattedContent;
                   
                   // Add detailed analysis to conversation history
                   addToConversationHistory('assistant', cleanedContent, 'detailed_analysis');
                   
                   // Ensure ai-help-questions div exists before rendering helper questions
                   let helpQuestionsDiv = document.getElementById('ai-help-questions');
                   if (!helpQuestionsDiv) {
                       console.log('🔧 Creating ai-help-questions div in formatFinalAnalysis...');
                       helpQuestionsDiv = document.createElement('div');
                       helpQuestionsDiv.id = 'ai-help-questions';
                       contentDiv.appendChild(helpQuestionsDiv);
                   }
                   
                   // Render helper questions with the extracted questions
                   if (questions && questions.length > 0) {
                       renderQuestionsUI(questions);
                   }
                    
                    // FAB button will be shown only when helper questions are sent
                    // showFloatingActionButton(); // Keep hidden until helper questions are used
               } else {
                   console.error('analysis-content element not found in formatFinalAnalysis');
               }
           }
         
                             // REMOVED: Old helper question extraction system
        // REMOVED: Old function - replaced with new system
        
        // Function to extract questions from content (placeholder - not used in new system)
        function extractQuestionsFromContent(content) {
            try {
                console.log('🔍 Starting question extraction...');
                console.log('🔍 Content length:', content.length);
                

                
                let questions = [];
                let cleanContent = content;
                
                // Pattern 1: Look for dash format questions (- سوال) in HTML content
                // This is the main pattern that should work with the AI response
                const dashPattern = /-\s*([^<>\n]+)(?:<br>|<\/p>|$)/g;
                const dashMatches = content.match(dashPattern);
                console.log('🔍 Dash pattern matches:', dashMatches);
                
                if (dashMatches && dashMatches.length >= 3) {
                    questions = dashMatches.map(match => {
                        // Clean up the match by removing HTML tags and dashes
                        let cleanQuestion = match.replace(/^-\s*/, ''); // Remove leading dash
                        cleanQuestion = cleanQuestion.replace(/<br>$|<\/p>$|<p>$/, ''); // Remove trailing HTML
                        cleanQuestion = cleanQuestion.trim();
                        return cleanQuestion;
                    }).filter(q => q.length > 5); // Filter out very short questions
                    
                    console.log('🔍 Found dash questions:', questions);
                    
                    if (questions.length >= 3) {
                        // Remove these questions from the main content
                        dashMatches.forEach(match => {
                            cleanContent = cleanContent.replace(match, '');
                        });
                        cleanContent = cleanContent.trim();
                        
                        console.log('✅ Successfully extracted questions:', questions);
                        console.log('✅ Cleaned content length:', cleanContent.length);
                        
                        return {
                            questions: questions.slice(0, 3).map((question, index) => ({
                                id: index + 1,
                                question: question
                            })),
                            mainContent: cleanContent
                        };
                    }
                }
                
                // Pattern 2: Look for bullet point questions (• سوال) in HTML content
                if (questions.length === 0) {
                    const bulletPattern = /•\s*([^<>\n]+)(?:<br>|<\/p>|<p>|$)/g;
                    const bulletMatches = content.match(bulletPattern);
                    console.log('🔍 Bullet pattern matches:', bulletMatches);
                    
                    if (bulletMatches && bulletMatches.length >= 3) {
                        questions = bulletMatches.map(match => {
                            let cleanQuestion = match.replace(/^•\s*/, '');
                            cleanQuestion = cleanQuestion.replace(/<br>$|<\/p>$|<p>$/, '');
                            cleanQuestion = cleanQuestion.trim();
                            return cleanQuestion;
                        }).filter(q => q.length > 5);
                        
                        console.log('🔍 Found bullet questions:', questions);
                        
                        if (questions.length >= 3) {
                            debugNeeded = false;
                            // Remove these questions from the main content
                            bulletMatches.forEach(match => {
                                cleanContent = cleanContent.replace(match, '');
                            });
                            cleanContent = cleanContent.trim();
                            
                            return {
                                questions: questions.slice(0, 3).map((question, index) => ({
                                    id: index + 1,
                                    question: question
                                })),
                                mainContent: cleanContent
                            };
                        }
                    }
                }
                
                // Pattern 3: Look for any dash patterns in the last part of content (fallback)
                if (questions.length === 0) {
                    console.log('🔍 Looking for any dash patterns in content...');
                    
                    // Get the last 2000 characters to look for questions
                    const lastPart = content.substring(Math.max(0, content.length - 2000));
                    console.log('🔍 Last part of content:', lastPart);
                    
                    // Look for dash patterns in the last part
                    const lastDashMatches = lastPart.match(/-\s*([^<>\n]+)/g);
                    console.log('🔍 Last part dash matches:', lastDashMatches);
                    
                    if (lastDashMatches && lastDashMatches.length >= 3) {
                        questions = lastDashMatches.map(match => {
                            return match.replace(/^-\s*/, '').trim();
                        }).filter(q => q.length > 5);
                        
                        console.log('🔍 Found dash questions in last part:', questions);
                        
                        if (questions.length >= 3) {
                            debugNeeded = false;
                            // Remove these questions from the main content
                            lastDashMatches.forEach(match => {
                                cleanContent = cleanContent.replace(match, '');
                            });
                            cleanContent = cleanContent.trim();
                            
                            return {
                                questions: questions.slice(0, 3).map((question, index) => ({
                                    id: index + 1,
                                    question: question
                                })),
                                mainContent: cleanContent
                            };
                        }
                    }
                }
                
                // Pattern 4: Look for numbered questions (1. 2. 3.) as last resort
                if (questions.length === 0) {
                    console.log('🔍 Trying to find numbered questions...');
                    const numberedPattern = /\d+\.\s*([^<>\n]+)(?:<br>|<\/p>|<p>|$)/g;
                    const numberedMatches = content.match(numberedPattern);
                    
                    if (numberedMatches && numberedMatches.length >= 3) {
                        questions = numberedMatches.map(match => {
                            let cleanQuestion = match.replace(/^\d+\.\s*/, '');
                            cleanQuestion = cleanQuestion.replace(/<br>$|<\/p>$|<p>$/, '');
                            cleanQuestion = cleanQuestion.trim();
                            return cleanQuestion;
                        }).filter(q => q.length > 5);
                        
                        console.log('🔍 Found numbered questions:', questions);
                        
                        if (questions.length >= 3) {
                            debugNeeded = false;
                            // Remove these questions from the main content
                            numberedMatches.forEach(match => {
                                cleanContent = cleanContent.replace(match, '');
                            });
                            cleanContent = cleanContent.trim();
                            
                            return {
                                questions: questions.slice(0, 3).map((question, index) => ({
                                    id: index + 1,
                                    question: question
                                })),
                                mainContent: cleanContent
                            };
                        }
                    }
                }
                
                // If we still don't have questions, debug the content
                if (debugNeeded) {
                    console.log('❌ No questions found - debugging content structure...');
                    debugContentStructure(content);
                }
                
                console.log('❌ Not enough questions found. Found:', questions.length);
                console.log('🔍 Questions found:', questions);
                
                // Use more contextually relevant fallback questions
                const fallbackQuestions = [
                    'چه مفاهیم مشابهی در این فصل وجود دارد؟',
                    'چگونه می‌توان این موضوع را با مفاهیم قبلی مرتبط کرد؟',
                    'چه سوالات مشابهی در آزمون‌های قبلی آمده است؟'
                ];
                
                return {
                    questions: fallbackQuestions.map((question, index) => ({
                        id: index + 1,
                        question: question
                    })),
                    mainContent: content
                };
                
            } catch (error) {
                console.error('❌ Error in question extraction:', error);
                // Return fallback questions on error
                const fallbackQuestions = [
                    'چه مفاهیم مشابهی در این فصل وجود دارد؟',
                    'چگونه می‌توان این موضوع را با مفاهیم قبلی مرتبط کرد؟',
                    'چه سوالات مشابهی در آزمون‌های قبلی آمده است؟'
                ];
                return {
                    questions: fallbackQuestions.map((question, index) => ({
                        id: index + 1,
                        question: question
                    })),
                    mainContent: content
                };
            }
        }
        
        
        // REMOVED: All old helper question code - replaced with new system

        // Function to format AI response with structure for detailed analysis
        function formatAIResponseWithStructure(content, type) {
            let formatted = content;
            
            // Replace line breaks with proper HTML
            formatted = formatted.replace(/\n\n/g, '</p><p class="content-paragraph">');
            formatted = formatted.replace(/\n/g, '<br>');
            
            // Add special styling for structured sections with clean formatting
            formatted = formatted
                .replace(/1\. ✅\/❌/g, '<div class="analysis-section"><h3>1. ✅/❌ نتیجه پاسخ</h3>')
                .replace(/2\. 📝/g, '</div><div class="analysis-section"><h3>2. 📝 راه‌حل گام به گام</h3>')
                .replace(/3\. ⚡/g, '</div><div class="analysis-section"><h3>3. ⚡ روش سریع</h3>')
                .replace(/4\. ❗/g, '</div><div class="analysis-section"><h3>4. ❗ اشتباه رایج</h3>')
                .replace(/5\. 🎯/g, '</div><div class="analysis-section"><h3>5. 🎯 نکته کلیدی</h3>');
            
            // Close the last section
            formatted += '</div>';
            
            // Add paragraph tags with proper font size class
            formatted = `<p class="content-paragraph">${formatted}</p>`;
            
            // Clean up any extra formatting
            formatted = formatted.replace(/<p><\/p>/g, '');
            
            return formatted;
        }
        
        // Function to format streaming chunks quickly (for real-time updates)
        function formatStreamingChunk(content) {
            let formatted = content;
            
            // Basic streaming formatting - just handle line breaks and basic structure
            formatted = formatted.replace(/\n\n/g, '</p><p class="content-paragraph">');
            formatted = formatted.replace(/\n/g, '<br>');
            
            // Wrap in paragraph tags with proper font size class
            formatted = `<p class="content-paragraph">${formatted}</p>`;
            
            return formatted;
        }
        
        // Function to format helper question responses - SIMPLE SYSTEM LIKE DETAILED ANALYSIS
        // Only handles bullet points and numbered lists, NO markdown formatting
        function formatHelperQuestionResponse(content) {
            let formatted = content;
            
            // Replace line breaks with proper HTML (same as detailed analysis)
            formatted = formatted.replace(/\n\n/g, '</p><p class="content-paragraph">');
            formatted = formatted.replace(/\n/g, '<br>');
            
            // Handle bullet points (dash format) - convert to HTML lists
            formatted = formatted.replace(/^-\s+(.+)$/gm, '<li>$1</li>');
            // Group consecutive list items into <ul> tags
            formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul class="content-list">$1</ul>');
            
            // Handle numbered lists (1. 2. 3.) - convert to HTML lists
            formatted = formatted.replace(/^(\d+)\.\s+(.+)$/gm, '<li>$1. $2</li>');
            // Group consecutive numbered list items into <ol> tags
            formatted = formatted.replace(/(<li>\d+\.\s+.*<\/li>)/s, '<ol class="content-list">$1</ol>');
            
            // Add paragraph tags with proper font size class (same as detailed analysis)
            formatted = `<p class="content-paragraph">${formatted}</p>`;
            
            // Clean up any extra formatting
            formatted = formatted.replace(/<p><\/p>/g, '');
            
            return formatted;
        }

        // Go back to previous page
        function goBack() {
            // Go back to chapters page
            window.location.href = `chapters.html?subject=${questionData?.subject || 'biology'}&grade=${questionData?.grade || '12th'}&field=${questionData?.field || 'experimental'}`;
        }

        // Go back to chapter page (cross icon)
        function goToChapter() {
            // Go back to chapters page
            window.location.href = `chapters.html?subject=${questionData?.subject || 'biology'}&grade=${questionData?.grade || '12th'}&field=${questionData?.field || 'experimental'}`;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOMContentLoaded event fired');
            console.log('📱 Page initialization starting...');
            
            getUrlParams();
            
            console.log('📊 After getUrlParams(), questionData:', questionData);
            
            // Ensure FAB is hidden initially
            hideFloatingActionButton();
            
            // Initialize loading state - hide loading, show results container
            const questionLoading = document.getElementById('question-loading');
            const questionResults = document.getElementById('question-results');
            if (questionLoading && questionResults) {
                questionLoading.classList.add('hidden');
                questionResults.classList.remove('hidden');
                console.log('✅ Question elements initialized');
            }
            
            // Add mobile-specific touch event handling
            if ('ontouchstart' in window) {
                console.log('Mobile device detected, adding touch optimizations');
                addMobileTouchHandling();
            }
            
            console.log('🎯 Page initialization complete');
        });
        
        // Add mobile-specific touch event handling
        function addMobileTouchHandling() {
            console.log('Setting up mobile touch handling...');
            
            // Prevent double-tap zoom on mobile
            document.addEventListener('touchstart', function(event) {
                if (event.target.closest('.bg-gray-100')) {
                    event.preventDefault();
                    console.log('Touch event prevented on helper question');
                }
            }, { passive: false });
            
            // Add touch feedback for helper questions
            document.addEventListener('touchstart', function(event) {
                const questionDiv = event.target.closest('.bg-gray-100');
                if (questionDiv) {
                    questionDiv.style.backgroundColor = '#d1d5db';
                    questionDiv.style.transform = 'scale(0.98)';
                    console.log('Touch feedback applied to helper question');
                }
            });
            
            document.addEventListener('touchend', function(event) {
                const questionDiv = event.target.closest('.bg-gray-100');
                if (questionDiv) {
                    questionDiv.style.backgroundColor = '';
                    questionDiv.style.transform = '';
                    console.log('Touch feedback removed from helper question');
                }
            });
            
            console.log('Mobile touch handling setup complete');
        }
        
        // ========================================
        // CLEANUP COMPLETE - OLD SYSTEM REMOVED
        // ========================================
        
        // The following functions were removed:
        // - extractSimpleTextHelperQuestions()
        // - renderHelpQuestions() 
        // - handleQuestionClickFromData()
        // - handleQuestionClick()
        // - showHelpQuestionAnswer()
        // - streamHelpQuestionResponse()
        // - formatHelpQuestionAnswer()
        // - formatAIResponseWithStructure()
        // - formatHelpQuestionAnswerEnhanced()
        
        // ========================================
        // NEW HELPER QUESTION RENDERING SYSTEM
        // ========================================
        

        

        

        
        // Function to render helper questions at the end of detailed analysis
        function renderHelperQuestions(content) {
            console.log('🎯 Rendering helper questions at the end of analysis');
            
            // Ensure ai-help-questions div exists
            let helpQuestionsDiv = document.getElementById('ai-help-questions');
            if (!helpQuestionsDiv) {
                console.log('🔧 Creating ai-help-questions div...');
                const analysisContent = document.getElementById('analysis-content');
                if (analysisContent) {
                    helpQuestionsDiv = document.createElement('div');
                    helpQuestionsDiv.id = 'ai-help-questions';
                    analysisContent.appendChild(helpQuestionsDiv);
                    console.log('✅ ai-help-questions div created successfully');
                } else {
                    console.error('❌ analysis-content element not found');
                    return;
                }
            }
            
            // Extract the 4 related questions from the AI response
            // The AI generates them in this format:
            // Related Questions:
            // - [Question 1]
            // - [Question 2]
            // - [Question 3]
            // - [Question 4]
            const questions = extractRelatedQuestions(content);
            console.log('🔍 DEBUG: Content passed to extractRelatedQuestions:', content);
            console.log('🔍 DEBUG: Questions returned:', questions);
            console.log('🔍 DEBUG: Questions type:', typeof questions);
            console.log('🔍 DEBUG: Is array:', Array.isArray(questions));
            
            if (questions && questions.length > 0) {
                console.log('✅ Found AI-generated questions:', questions);
                console.log('🔍 DEBUG: Questions array details:', {
                    length: questions.length,
                    firstQuestion: questions[0],
                    lastQuestion: questions[questions.length - 1]
                });
                renderQuestionsUI(questions);
            } else {
                console.log('❌ No AI questions found - not rendering helper questions');
                // Don't show any questions if extraction fails
                return;
            }
        }
        
        // Function to extract ALL related questions from AI response (flexible count)
        function extractRelatedQuestions(content) {
            try {
                console.log('🔍 Extracting related questions from content...');
                console.log('🔍 Content length:', content.length);
                console.log('🔍 Content preview (last 1000 chars):', content.substring(Math.max(0, content.length - 1000)));
                
                // SUPER AGGRESSIVE HTML CLEANING - Remove ALL HTML content first
                let cleanContent = content;
                
                // Remove all HTML tags and their content
                cleanContent = cleanContent.replace(/<[^>]*>/g, '');
                
                // Remove any remaining HTML entities
                cleanContent = cleanContent.replace(/&[a-zA-Z0-9#]+;/g, '');
                
                // Remove any JavaScript code or attributes
                cleanContent = cleanContent.replace(/on\w+\s*=\s*["'][^"']*["']/g, '');
                cleanContent = cleanContent.replace(/style\s*=\s*["'][^"']*["']/g, '');
                cleanContent = cleanContent.replace(/class\s*=\s*["'][^"']*["']/g, '');
                cleanContent = cleanContent.replace(/id\s*=\s*["'][^"']*["']/g, '');
                
                // Remove any remaining HTML attributes
                cleanContent = cleanContent.replace(/\s+\w+\s*=\s*["'][^"']*["']/g, '');
                
                // Remove any remaining quotes or special characters that might be left
                cleanContent = cleanContent.replace(/['"]/g, '');
                cleanContent = cleanContent.replace(/\)/g, '');
                
                // Clean up any extra whitespace
                cleanContent = cleanContent.replace(/\s+/g, ' ').trim();
                
                console.log('🔍 Cleaned content preview:', cleanContent.substring(Math.max(0, cleanContent.length - 500)));
                
                // Now look for questions in the cleaned content
                // Strategy 1: Look for lines starting with "-" that look like questions
                const dashQuestions = cleanContent.match(/-\s*([^\r\n]+)/g);
                console.log('🔍 All dash lines found:', dashQuestions);
                
                if (dashQuestions && dashQuestions.length > 0) {
                    // Filter for question-like content
                    const filteredQuestions = dashQuestions
                        .map(q => {
                            // Remove the dash prefix and clean up
                            let cleanQuestion = q.replace(/^-\s*/, '').trim();
                            
                            // Clean up any extra whitespace
                            cleanQuestion = cleanQuestion.replace(/\s+/g, ' ').trim();
                            
                            return cleanQuestion;
                        })
                        .filter(q => {
                            const length = q.length;
                            const hasQuestionMark = q.includes('؟') || q.includes('?');
                            const looksLikeQuestion = q.match(/^(چه|چرا|چگونه|کدام|آیا|چطور|کجا|کی|چند|کدام|مثال|تفاوت|نقش|عملکرد|مکانیزم|فرآیند|مراحل|مرحله|گام|قدم|کدام یک|چگونه|آیا|چرا|کجا|کی|چند|مثال|تفاوت|نقش|عملکرد|مکانیزم|فرآیند|مراحل|مرحله|گام|قدم)/);
                            
                            // Accept if it's a reasonable length and either has question mark or looks like a question
                            return length > 8 && length < 300 && (hasQuestionMark || looksLikeQuestion);
                        });
                    
                    console.log('🔍 Filtered questions:', filteredQuestions);
                    
                    if (filteredQuestions.length > 0) {
                        console.log('✅ Found questions after aggressive cleaning:', filteredQuestions);
                        
                        // Check if any question contains multiple questions separated by dashes
                        const finalQuestions = [];
                        filteredQuestions.forEach(question => {
                            // Split by dash if the question contains multiple questions
                            if (question.includes('-')) {
                                const splitQuestions = question.split('-').map(q => q.trim()).filter(q => q.length > 5);
                                finalQuestions.push(...splitQuestions);
                            } else {
                                finalQuestions.push(question);
                            }
                        });
                        
                        console.log('🔍 Final split questions:', finalQuestions);
                        return finalQuestions;
                    }
                }
                
                // Strategy 2: Look for any text that looks like a question (fallback)
                console.log('🔍 Strategy 2 - Looking for question-like text...');
                const questionPatterns = [
                    /([^.!?؟]*[؟?][^.!?؟]*)/g,  // Text ending with question mark
                    /([^.!?؟]*\b(چه|چرا|چگونه|کدام|آیا|چطور|کجا|کی|چند|مثال|تفاوت|نقش|عملکرد|مکانیزم|فرآیند|مراحل|مرحله|گام|قدم)\b[^.!?؟]*)/g  // Text starting with question words
                ];
                
                for (const pattern of questionPatterns) {
                    const matches = cleanContent.match(pattern);
                    if (matches && matches.length > 0) {
                        const questions = matches
                            .map(q => q.trim())
                            .filter(q => q.length > 10 && q.length < 200);
                        
                        if (questions.length > 0) {
                            console.log('✅ Found questions with pattern matching:', questions);
                            return questions.slice(0, 4); // Limit to 4 questions
                        }
                    }
                }
                
                // Strategy 3: Look for any lines starting with "-" that look like questions in HTML content
                console.log('🔍 Strategy 3 - Looking for dash-prefixed lines in HTML...');
                const dashQuestionsHTML = content.match(/-\s*([^<]+)/g);
                console.log('🔍 All dash lines found:', dashQuestionsHTML);
                
                if (dashQuestionsHTML && dashQuestionsHTML.length > 0) {
                    // More flexible filtering - look for question-like content
                    const filteredQuestions = dashQuestionsHTML
                        .map(q => {
                            // Clean the question text by removing HTML tags and extra content
                            let cleanQuestion = q.replace(/^-\s*/, '').trim();
                            
                            // Remove any HTML tags that might have been included
                            cleanQuestion = cleanQuestion.replace(/<[^>]*>/g, '');
                            
                            // Remove any JavaScript code or attributes that might have leaked in
                            cleanQuestion = cleanQuestion.replace(/on\w+\s*=\s*["'][^"']*["']/g, '');
                            cleanQuestion = cleanQuestion.replace(/style\s*=\s*["'][^"']*["']/g, '');
                            cleanQuestion = cleanQuestion.replace(/class\s*=\s*["'][^"']*["']/g, '');
                            cleanQuestion = cleanQuestion.replace(/id\s*=\s*["'][^"']*["']/g, '');
                            
                            // Remove any remaining HTML attributes
                            cleanQuestion = cleanQuestion.replace(/\s+\w+\s*=\s*["'][^"']*["']/g, '');
                            
                            // Clean up any extra whitespace
                            cleanQuestion = cleanQuestion.replace(/\s+/g, ' ').trim();
                            
                            return cleanQuestion;
                        })
                        .filter(q => {
                            const length = q.length;
                            const hasQuestionMark = q.includes('؟') || q.includes('?');
                            const looksLikeQuestion = q.match(/^(چه|چرا|چگونه|کدام|آیا|چطور|کجا|کی|چند|کدام|مثال|تفاوت|نقش|عملکرد|مکانیزم|فرآیند|مراحل|مرحله|گام|قدم)/);
                            
                            // Accept if it's a reasonable length and either has question mark or looks like a question
                            return length > 8 && length < 300 && (hasQuestionMark || looksLikeQuestion);
                        });
                    
                    console.log('🔍 Filtered questions:', filteredQuestions);
                    
                    if (filteredQuestions.length > 0) {
                        console.log('✅ Found dash questions as fallback:', filteredQuestions);
                        
                        // Check if any question contains multiple questions separated by dashes
                        const finalQuestions = [];
                        filteredQuestions.forEach(question => {
                            // Split by dash if the question contains multiple questions
                            if (question.includes('-')) {
                                const splitQuestions = question.split('-').map(q => q.trim()).filter(q => q.length > 5);
                                finalQuestions.push(...splitQuestions);
                            } else {
                                finalQuestions.push(question);
                            }
                        });
                        
                        console.log('🔍 Final split questions (Strategy 3):', finalQuestions);
                        return finalQuestions;
                    }
                    
                    // If still no clean questions, try aggressive cleaning
                    console.log('🔍 Trying aggressive cleaning for dash questions...');
                    const aggressiveDashQuestions = dashQuestionsHTML.map(q => {
                        // Remove the dash prefix
                        let cleanQuestion = q.replace(/^-\s*/, '').trim();
                        
                        // Remove ALL HTML content - everything from first < to end
                        const firstTagIndex = cleanQuestion.indexOf('<');
                        if (firstTagIndex !== -1) {
                            cleanQuestion = cleanQuestion.substring(0, firstTagIndex);
                        }
                        
                        // Remove any remaining quotes or special characters that might be left
                        cleanQuestion = cleanQuestion.replace(/['"]/g, '');
                        cleanQuestion = cleanQuestion.replace(/\)/g, '');
                        
                        // Clean up any extra whitespace
                        cleanQuestion = cleanQuestion.replace(/\s+/g, ' ').trim();
                        
                        return cleanQuestion;
                    }).filter(q => {
                        const length = q.length;
                        const hasQuestionMark = q.includes('؟') || q.includes('?');
                        const looksLikeQuestion = q.match(/^(چه|چرا|چگونه|کدام|آیا|چطور|کجا|کی|چند|کدام|مثال|تفاوت|نقش|عملکرد|مکانیزم|فرآیند|مراحل|مرحله|گام|قدم)/);
                        
                        return length > 8 && length < 300 && (hasQuestionMark || looksLikeQuestion);
                    });
                    
                    if (aggressiveDashQuestions.length > 0) {
                        console.log('✅ Found dash questions with aggressive cleaning:', aggressiveDashQuestions);
                        return aggressiveDashQuestions;
                    }
                }
                
                // Strategy 4: Look for the last part of content for questions in HTML content
                console.log('🔍 Strategy 4 - Looking for questions in last part of HTML...');
                const lastPart = content.substring(Math.max(0, content.length - 3000));
                const lastDashLines = lastPart.match(/-\s*([^<]+)/g);
                
                if (lastDashLines && lastDashLines.length > 0) {
                    const questions = lastDashLines.map(q => {
                        // Clean the question text by removing HTML tags and extra content
                        let cleanQuestion = q.replace(/^-\s*/, '').trim();
                        
                        // Remove any HTML tags that might have been included
                        cleanQuestion = cleanQuestion.replace(/<[^>]*>/g, '');
                        
                        // Remove any JavaScript code or attributes that might have leaked in
                        cleanQuestion = cleanQuestion.replace(/on\w+\s*=\s*["'][^"']*["']/g, '');
                        cleanQuestion = cleanQuestion.replace(/style\s*=\s*["'][^"']*["']/g, '');
                        cleanQuestion = cleanQuestion.replace(/class\s*=\s*["'][^"']*["']/g, '');
                        cleanQuestion = cleanQuestion.replace(/id\s*=\s*["'][^"']*["']/g, '');
                        
                        // Remove any remaining HTML attributes
                        cleanQuestion = cleanQuestion.replace(/\s+\w+\s*=\s*["'][^"']*["']/g, '');
                        
                        // Clean up any extra whitespace
                        cleanQuestion = cleanQuestion.replace(/\s+/g, ' ').trim();
                        
                        return cleanQuestion;
                    }).filter(q => {
                        const length = q.length;
                        const hasQuestionMark = q.includes('؟') || q.includes('?');
                        const looksLikeQuestion = q.match(/^(چه|چرا|چگونه|کدام|آیا|چطور|کجا|کی|چند|کدام|مثال|تفاوت|نقش|عملکرد|مکانیزم|فرآیند|مراحل|مرحله|گام|قدم)/);
                        
                        return length > 8 && length < 300 && (hasQuestionMark || looksLikeQuestion);
                    });
                    
                    if (questions.length > 0) {
                        console.log('✅ Found questions in last part:', questions);
                        
                        // Check if any question contains multiple questions separated by dashes
                        const finalQuestions = [];
                        questions.forEach(question => {
                            // Split by dash if the question contains multiple questions
                            if (question.includes('-')) {
                                const splitQuestions = question.split('-').map(q => q.trim()).filter(q => q.length > 5);
                                finalQuestions.push(...splitQuestions);
                            } else {
                                finalQuestions.push(question);
                            }
                        });
                        
                        console.log('🔍 Final split questions (Strategy 4):', finalQuestions);
                        return finalQuestions;
                    }
                    
                    // If still no clean questions, try aggressive cleaning
                    console.log('🔍 Trying aggressive cleaning for last part questions...');
                    const aggressiveLastQuestions = lastDashLines.map(q => {
                        // Remove the dash prefix
                        let cleanQuestion = q.replace(/^-\s*/, '').trim();
                        
                        // Remove ALL HTML content - everything from first < to end
                        const firstTagIndex = cleanQuestion.indexOf('<');
                        if (firstTagIndex !== -1) {
                            cleanQuestion = cleanQuestion.substring(0, firstTagIndex);
                        }
                        
                        // Remove any remaining quotes or special characters that might be left
                        cleanQuestion = cleanQuestion.replace(/['"]/g, '');
                        cleanQuestion = cleanQuestion.replace(/\)/g, '');
                        
                        // Clean up any extra whitespace
                        cleanQuestion = cleanQuestion.replace(/\s+/g, ' ').trim();
                        
                        return cleanQuestion;
                    }).filter(q => {
                        const length = q.length;
                        const hasQuestionMark = q.includes('؟') || q.includes('?');
                        const looksLikeQuestion = q.match(/^(چه|چرا|چگونه|کدام|آیا|چطور|کجا|کی|چند|کدام|مثال|تفاوت|نقش|عملکرد|مکانیزم|فرآیند|مراحل|مرحله|گام|قدم)/);
                        
                        return length > 8 && length < 300 && (hasQuestionMark || looksLikeQuestion);
                    });
                    
                    if (aggressiveLastQuestions.length > 0) {
                        console.log('✅ Found last part questions with aggressive cleaning:', aggressiveLastQuestions);
                        return aggressiveLastQuestions;
                    }
                }
                
                // Strategy 5: Look for questions in HTML content with different formatting
                console.log('🔍 Strategy 5 - Looking for questions in HTML with different patterns...');
                
                // Look for questions that might be wrapped in <p> tags or other HTML elements
                const htmlQuestionPatterns = [
                    /<p[^>]*>-\s*([^<]+)<\/p>/g,
                    /<div[^>]*>-\s*([^<]+)<\/div>/g,
                    /<br>-\s*([^<]+)<br>/g
                ];
                
                for (const pattern of htmlQuestionPatterns) {
                    const matches = content.match(pattern);
                    if (matches && matches.length > 0) {
                        console.log('🔍 Found HTML pattern matches:', matches);
                        const questions = matches.map(match => {
                            const questionMatch = match.match(/-\s*([^<]+)/);
                            if (questionMatch) {
                                // Clean the question text by removing HTML tags and extra content
                                let cleanQuestion = questionMatch[1].trim();
                                
                                // Remove any HTML tags that might have been included
                                cleanQuestion = cleanQuestion.replace(/<[^>]*>/g, '');
                                
                                // Remove any JavaScript code or attributes that might have leaked in
                                cleanQuestion = cleanQuestion.replace(/on\w+\s*=\s*["'][^"']*["']/g, '');
                                cleanQuestion = cleanQuestion.replace(/style\s*=\s*["'][^"']*["']/g, '');
                                cleanQuestion = cleanQuestion.replace(/class\s*=\s*["'][^"']*["']/g, '');
                                cleanQuestion = cleanQuestion.replace(/id\s*=\s*["'][^"']*["']/g, '');
                                
                                // Remove any remaining HTML attributes
                                cleanQuestion = cleanQuestion.replace(/\s+\w+\s*=\s*["'][^"']*["']/g, '');
                                
                                // Clean up any extra whitespace
                                cleanQuestion = cleanQuestion.replace(/\s+/g, ' ').trim();
                                
                                return cleanQuestion;
                            }
                            return null;
                        }).filter(q => q && q.length > 8 && q.length < 300);
                        
                        if (questions.length > 0) {
                            console.log('✅ Found questions with HTML patterns:', questions);
                            return questions;
                        }
                    }
                }
                
                console.log('❌ No related questions found in content');
                console.log('🔍 Final debug - returning null');
                return null;
                
            } catch (error) {
                console.error('❌ Error extracting related questions:', error);
                return null;
            }
        }
        
        // Debug function to test question extraction
        function debugQuestionExtraction(content) {
            console.log('🔍 DEBUG: Testing question extraction with content:', content);
            const questions = extractRelatedQuestions(content);
            console.log('🔍 DEBUG: Extracted questions:', questions);
            console.log('🔍 DEBUG: Questions type:', typeof questions);
            console.log('🔍 DEBUG: Is array:', Array.isArray(questions));
            if (questions) {
                console.log('🔍 DEBUG: Questions length:', questions.length);
                questions.forEach((q, idx) => {
                    console.log(`🔍 DEBUG: Question ${idx}:`, q);
                });
            }
            return questions;
        }
        
        // Function to render helper questions at the end of detailed analysis
        function renderQuestionsUI(questions) {
            console.log('🎨 renderQuestionsUI called with questions:', questions);
            console.log('🔍 Number of questions to render:', questions.length);
            
            // First try to find ai-help-questions directly, then within analysis-content
            let helpQuestionsDiv = document.getElementById('ai-help-questions');
            if (!helpQuestionsDiv) {
                const analysisContent = document.getElementById('analysis-content');
                if (analysisContent) {
                    helpQuestionsDiv = analysisContent.querySelector('#ai-help-questions');
                }
            }
            
            console.log('🔍 Looking for ai-help-questions div:', helpQuestionsDiv);
            
            if (!helpQuestionsDiv) {
                console.error('❌ ai-help-questions div not found');
                console.log('🔍 Available divs with similar names:');
                document.querySelectorAll('[id*="help"]').forEach(div => {
                    console.log('  -', div.id, div);
                });
                return;
            }
            
            console.log('✅ Found ai-help-questions div, rendering questions...');
            console.log('🔍 Questions array details:', {
                length: questions.length,
                questions: questions,
                isArray: Array.isArray(questions),
                type: typeof questions
            });
            
                                                   // Modern UI design with individual borders for each question
                        const questionsHTML = `
                  <div class="related-questions-section">
                      <div class="max-w-2xl mx-auto">
                          <ul class="space-y-3" style="list-style: none; padding: 0; margin: 0;">
                              ${questions.map((questionText, idx) => {
                            console.log(`🔍 Question ${idx + 1}:`, questionText);
                                console.log(`🔍 Question ${idx + 1} type:`, typeof questionText);
                                console.log(`🔍 Question ${idx + 1} length:`, questionText ? questionText.length : 'null/undefined');
                            
                            return `
                                      <li class="question-item" style="margin: 0; padding: 0;">
                                          <button
                                            data-query="${questionText ? questionText.replace(/"/g, '&quot;') : ''}"
                                            onclick="onSuggestionClick('${questionText ? questionText.replace(/'/g, '\\\'') : ''}')"
                                              class="question-button w-full text-right transition-all duration-300 cursor-pointer"
                                              style="
                                                  background-color: #f3f4f6;
                                                  border: 2px solid #e5e7eb;
                                                  border-radius: 12px;
                                                  padding: 16px 20px;
                                                  font-size: 16px;
                                                  font-family: 'Inter', 'Vazir', sans-serif;
                                                  color: #374151;
                                                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                                                  min-height: 48px;
                                                  display: flex;
                                                  align-items: center;
                                                  justify-content: flex-end;
                                                  margin-bottom: 12px;
                                              "
                                              onmouseover="this.style.backgroundColor='#e0eaff'; this.style.transform='scale(1.02)'"
                                              onmouseout="this.style.backgroundColor='#f3f4f6'; this.style.transform='scale(1)'"
                                          >
                                            <span class="question-text" style="line-height: 1.5;">${questionText || 'Question text missing'}</span>
                                          </button>
                                      </li>
                            `;
                        }).join('')}
                          </ul>
                    </div>
                </div>
            `;
            
            console.log('🔍 Generated HTML:', questionsHTML);
            
            helpQuestionsDiv.innerHTML = questionsHTML;
            helpQuestionsDiv.style.display = 'block';
            
            // Add mobile-specific touch handling
            const questionButtons = helpQuestionsDiv.querySelectorAll('.question-button');
            questionButtons.forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.backgroundColor = '#d1d5db';
                    this.style.transform = 'scale(0.98)';
                });
                
                button.addEventListener('touchend', function() {
                    this.style.backgroundColor = '#f0f4f8';
                    this.style.transform = 'scale(1)';
                });
            });
            
            console.log('✅ Helper questions rendered successfully with modern UI');
        }
        
        // Handle suggestion clicks
        function onSuggestionClick(query) {
            console.log('🎯 Suggestion clicked:', query);
            
            // Add helper question to conversation history
            addToConversationHistory('user', query, 'helper_question');
            
             // Ensure detailed analysis section is visible
             const detailedAnalysisSection = document.getElementById('detailed-analysis-section');
             
             console.log('🔍 Detailed Analysis Section:', detailedAnalysisSection);
             
             if (detailedAnalysisSection && detailedAnalysisSection.classList.contains('hidden')) {
                 console.log('✅ Making detailed analysis section visible');
                 detailedAnalysisSection.classList.remove('hidden');
                 detailedAnalysisSection.style.display = 'block';
             }
             
             // Also ensure analysis content is visible
             const analysisContent = document.getElementById('analysis-content');
             if (analysisContent && analysisContent.classList.contains('hidden')) {
                 console.log('✅ Making analysis content visible');
                 analysisContent.classList.remove('hidden');
             }
             
             // Add helper question to chat messages area (like user messages)
             const chatMessages = document.getElementById('chat-messages');
             console.log('🔍 Chat Messages Area:', chatMessages);
             
             if (!chatMessages) {
                 console.error('❌ Chat messages area not found');
                 console.log('🔍 Current HTML structure around chat-messages:');
                 console.log('🔍 detailed-analysis-section:', document.getElementById('detailed-analysis-section')?.outerHTML);
                 console.log('🔍 analysis-content:', document.getElementById('analysis-content')?.outerHTML);
                 return;
             }
             
             const helperQuestionMessage = document.createElement('div');
             helperQuestionMessage.className = 'chat-message user';
             helperQuestionMessage.innerHTML = `<div class="message-bubble user">${query}</div>`;
             chatMessages.appendChild(helperQuestionMessage);
             
             console.log('✅ Helper question message added to chat');
             
             // Move page up to show the helper question in a better visible area
             setTimeout(() => {
                 helperQuestionMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
             }, 100);
             
             // Show FAB button when helper question is sent
             showFloatingActionButton();
             
             // Make API call to get help response (without showing loading state in button)
            getHelpResponse(query);
        }
        
        // Show loading state for clicked suggestion
        function showSuggestionLoading(query) {
            // Find the clicked button and show loading
            const buttons = document.querySelectorAll('[data-query]');
            buttons.forEach(button => {
                if (button.getAttribute('data-query') === query) {
                    button.innerHTML = `
                        <div class="flex items-center justify-center space-x-2 space-x-reverse">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                            <span class="text-gray-600">در حال پاسخ...</span>
                        </div>
                    `;
                    button.disabled = true;
                }
            });
        }
        
        // Get help response from API with streaming effect
        async function getHelpResponse(query) {
            try {
                // First, add AI loading message to chat display (like detailed analysis)
                // First try to find chat-messages directly, then within detailed-analysis-section
                let chatMessages = document.getElementById('chat-messages');
                if (!chatMessages) {
                    const detailedAnalysisSection = document.getElementById('detailed-analysis-section');
                    if (detailedAnalysisSection) {
                        chatMessages = detailedAnalysisSection.querySelector('#chat-messages');
                    }
                }
                
                if (!chatMessages) {
                    console.error('❌ Chat messages area not found in getHelpResponse');
                    return;
                }
                
                const aiLoadingMessage = document.createElement('div');
                aiLoadingMessage.className = 'chat-message ai';
                aiLoadingMessage.id = `ai-loading-${Date.now()}`;
                aiLoadingMessage.innerHTML = `
                    <div class="message-bubble ai">
                        <div class="flex items-center space-x-2 space-x-reverse">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                            <span class="text-gray-600">در حال پاسخ...</span>
                        </div>
                    </div>
                `;
                
                chatMessages.appendChild(aiLoadingMessage);
                
                // Scroll to show the loading message
                aiLoadingMessage.scrollIntoView({ behavior: 'smooth' });
                
                const response = await fetch('/api/chat/help-question/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: query,
                        subject: questionData?.subject || 'biology',
                        grade: questionData?.grade || 'دوم',
                        chapter: questionData?.chapter || '1',
                        originalAnalysis: questionData?.analysis || '',
                        conversationId: currentConversationId,
                        conversationContext: getConversationContext()
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Handle streaming response with real-time updates
                await streamHelpResponse(response, query, aiLoadingMessage);
                
            } catch (error) {
                console.error('Error getting help response:', error);
                showSuggestionError(query, error.message);
            }
        }
        
                 // Stream help response with real-time updates (like detailed analysis)
         async function streamHelpResponse(response, query, aiLoadingMessage) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullResponse = '';
            let lastUpdateTime = 0;
            const UPDATE_INTERVAL = 500; // Update every 500ms instead of every word
            
            try {
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            
                            if (data === '[DONE]') {
                                // Final formatting and display
                                 displayHelpResponse(query, fullResponse, aiLoadingMessage);
                                return;
                            }
                            
                            try {
                                const parsed = JSON.parse(data);
                                 if (parsed.content && parsed.type === 'chunk') {
                                    fullResponse += parsed.content;
                                    
                                    // Only update every 500ms to avoid constant flickering
                                    const currentTime = Date.now();
                                    if (currentTime - lastUpdateTime >= UPDATE_INTERVAL) {
                                        updateHelpResponseStreaming(query, fullResponse, aiLoadingMessage);
                                        lastUpdateTime = currentTime;
                                    }
                                }
                            } catch (e) {
                                // Ignore parsing errors for incomplete chunks
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Streaming error:', error);
                showSuggestionError(query, 'خطا در دریافت پاسخ');
            }
        }
        
                 // Update help response in real-time with streaming effect (like detailed analysis)
         function updateHelpResponseStreaming(query, response, aiLoadingMessage) {
             // Safety check for aiLoadingMessage
             if (!aiLoadingMessage) {
                 console.error('❌ aiLoadingMessage is undefined in updateHelpResponseStreaming');
                 return;
             }
             
             // Update the loading message with streaming content in real-time
             // Use the same simple approach as detailed analysis
             const messageBubble = aiLoadingMessage.querySelector('.message-bubble.ai');
             if (messageBubble) {
                 // Simple streaming update using the same system as detailed analysis
                 messageBubble.innerHTML = formatStreamingChunk(response);
             }
             
             console.log('✅ Streaming update for:', query, response.length);
         }
         
         // Update help response in real-time (legacy function)
        function updateHelpResponse(query, response) {
            // This can be used for real-time updates if needed
            console.log('Updating response for:', query, response.length);
        }
        
                 // Display final help response with streaming effect
         function displayHelpResponse(query, response, aiLoadingMessage) {
             // Safety check for aiLoadingMessage
             if (!aiLoadingMessage) {
                 console.error('❌ aiLoadingMessage is undefined in displayHelpResponse');
                 return;
             }
             
             // Add AI response to conversation history
             addToConversationHistory('assistant', response, 'helper_response');
             
             // Update the existing loading message with the final formatted response
             // Use the simple helper question formatting (bullet points and numbered lists only)
             const messageBubble = aiLoadingMessage.querySelector('.message-bubble.ai');
             if (messageBubble) {
                 // Simple final display with bullet points and numbered lists only
                 messageBubble.innerHTML = formatHelperQuestionResponse(response);
             }
             
             console.log('✅ Helper question response displayed successfully with streaming effect');
        }
        
        // Format response for display with enhanced structure
        function formatResponse(response) {
            let formatted = response;
            
            // Convert dashes and asterisks to proper bullet points
            formatted = formatted.replace(/^[-*]\s+/gm, '• ');
            formatted = formatted.replace(/\n[-*]\s+/g, '\n• ');
            
            // Convert numbered lists (1. 2. 3.) to proper HTML lists
            formatted = formatted.replace(/^(\d+\.\s+)(.+)$/gm, '<li>$1$2</li>');
            formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ol class="numbered-list">$1</ol>');
            
            // Convert bullet points to proper HTML lists
            formatted = formatted.replace(/^(•\s+)(.+)$/gm, '<li>$2</li>');
            formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul class="bullet-list">$1</ul>');
            
            // Replace line breaks with proper HTML structure
            formatted = formatted.replace(/\n\n/g, '</p><p class="content-paragraph">');
            formatted = formatted.replace(/\n/g, '<br>');
            
            // Add paragraph tags with proper font size class
            formatted = `<p class="content-paragraph">${formatted}</p>`;
            
            // Clean up any extra formatting
            formatted = formatted.replace(/<p><\/p>/g, '');
            formatted = formatted.replace(/<p><ul/g, '<ul');
            formatted = formatted.replace(/<\/ul><\/p>/g, '</ul>');
            formatted = formatted.replace(/<p><ol/g, '<ol');
            formatted = formatted.replace(/<\/ol><\/p>/g, '</ol>');
            
            return formatted;
        }
        
        // Show error for suggestion
        function showSuggestionError(query, errorMessage) {
            const buttons = document.querySelectorAll('[data-query]');
            buttons.forEach(button => {
                if (button.getAttribute('data-query') === query) {
                    button.innerHTML = `
                        <div class="text-red-500 text-center">
                            <p class="text-sm">خطا: ${errorMessage}</p>
                        </div>
                    `;
                    button.disabled = true;
                }
            });
        }
        
        // Restore suggestion button to original state
        function restoreSuggestionButton(query) {
            const buttons = document.querySelectorAll('[data-query]');
            buttons.forEach(button => {
                if (button.getAttribute('data-query') === query) {
                    button.innerHTML = `<span class="text-gray-700 text-lg font-medium leading-relaxed">${query}</span>`;
                    button.disabled = false;
                }
            });
        }
        
        // ========================================
        // END OF NEW HELPER QUESTION SYSTEM
        // ========================================
        
        // ========================================
        // FLOATING ACTION BUTTON (FAB) FUNCTIONS
        // ========================================
        
        // Show the Floating Action Button with smooth animation
        function showFloatingActionButton() {
            const fabContainer = document.getElementById('fab-container');
            if (fabContainer) {
                // Add a small delay to ensure smooth transition
                setTimeout(() => {
                    fabContainer.classList.remove('scale-0', 'opacity-0');
                    fabContainer.classList.add('scale-100', 'opacity-100');
                    console.log('✅ Floating Action Button is now visible');
                }, 300);
            }
        }
        
        // Hide the Floating Action Button
        function hideFloatingActionButton() {
            const fabContainer = document.getElementById('fab-container');
            if (fabContainer) {
                fabContainer.classList.add('scale-0', 'opacity-0');
                fabContainer.classList.remove('scale-100', 'opacity-100');
            }
        }
        
                 // Toggle chat input visibility
         function toggleChatInput() {
             console.log('🎯 FAB button clicked - toggling chat input!');
             
             // Add click feedback
             const fabButton = document.getElementById('fab-button');
             if (fabButton) {
                 fabButton.classList.add('scale-95');
                 setTimeout(() => {
                     fabButton.classList.remove('scale-95');
                 }, 150);
             }
             
             const chatInputSection = document.getElementById('chat-input-section');
             const fabContainer = document.getElementById('fab-container');
             const inputField = document.getElementById('chat-input-field');
             const isVisible = chatInputSection.classList.contains('show');
             
             if (isVisible) {
                 // Hide chat input
                 hideChatInput();
             } else {
                 // Show chat input
                 showChatInput();
             }
         }
         
                  // Show chat input and hide FAB button
         function showChatInput() {
             console.log('🚀 showChatInput function called');
             
             const chatInputSection = document.getElementById('chat-input-section');
             const fabContainer = document.getElementById('fab-container');
             const inputField = document.getElementById('chat-input-field');
             
             console.log('🔍 chatInputSection found:', chatInputSection);
             console.log('🔍 fabContainer found:', fabContainer);
             console.log('🔍 inputField found:', inputField);
             
             if (!chatInputSection) {
                 console.error('❌ Chat input section not found!');
                 return;
             }
             
             // Show chat input using the same approach as working test
             chatInputSection.classList.add('show');
             chatInputSection.style.transform = 'translateY(0)';
             chatInputSection.style.opacity = '1';
             console.log('✅ Added "show" class and forced transform/opacity');
             console.log('🔍 Chat input section styles after showing:', {
                 transform: chatInputSection.style.transform,
                 opacity: chatInputSection.style.opacity,
                 classes: chatInputSection.className
             });
             
             // Hide FAB button completely
             fabContainer.style.opacity = '0';
             fabContainer.style.pointerEvents = 'none';
             fabContainer.style.transform = 'scale(0)';
             
             // Reset input field to ensure consistent behavior
             if (inputField) {
                 inputField.value = '';
                 inputField.style.height = '56px'; // Reset to original height
                 inputField.classList.remove('typing-active');
                 
                 // Reset send button state
                 const sendButton = document.getElementById('send-chat-button');
                 if (sendButton) {
                     console.log('🔍 Resetting send button state');
                     sendButton.style.opacity = '0';
                     sendButton.style.pointerEvents = 'none';
                     sendButton.style.transform = 'translateY(-50%) scale(0.75)';
                     sendButton.classList.remove('bg-black');
                     sendButton.classList.add('bg-gray-400');
                     
                     // Ensure send button is properly positioned and clickable
                     sendButton.style.position = 'absolute';
                     sendButton.style.zIndex = '20';
                     sendButton.style.right = '8px';
                     sendButton.style.top = '50%';
                     
                     console.log('🔍 Send button styles after reset:', {
                         opacity: sendButton.style.opacity,
                         pointerEvents: sendButton.style.pointerEvents,
                         transform: sendButton.style.transform,
                         position: sendButton.style.position,
                         zIndex: sendButton.style.zIndex
                     });
                 } else {
                     console.error('❌ Send button not found in showChatInput!');
                 }
             }
             
             // Focus the input field
             setTimeout(() => {
                 if (inputField) {
                     inputField.focus();
                     console.log('✅ Input field focused');
                 }
             }, 100);
             
             console.log('✅ Chat input shown and reset, FAB button hidden');
         }
         
         // Hide chat input and show FAB button
         function hideChatInput() {
             const chatInputSection = document.getElementById('chat-input-section');
             const fabContainer = document.getElementById('fab-container');
             
             // Hide chat input using the same approach as working test
             chatInputSection.classList.remove('show');
             chatInputSection.style.transform = 'translateY(100%)';
             chatInputSection.style.opacity = '0';
             
             // Show FAB button again
             fabContainer.style.opacity = '1';
             fabContainer.style.pointerEvents = 'auto';
             fabContainer.style.transform = 'scale(1)';
             
             console.log('✅ Chat input hidden with transform/opacity, FAB button shown again');
         }
         
         // Ensure FAB button is always visible and properly styled
         function ensureFABVisible() {
             const fabContainer = document.getElementById('fab-container');
             const chatInputSection = document.getElementById('chat-input-section');
             
             if (fabContainer && chatInputSection) {
                 // If chat input is not visible, ensure FAB is visible
                 if (!chatInputSection.classList.contains('show')) {
                     fabContainer.style.opacity = '1';
                     fabContainer.style.pointerEvents = 'auto';
                     fabContainer.style.transform = 'scale(1)';
                     console.log('✅ FAB button visibility ensured');
                 }
             }
         }
         

         
         // Send custom question from chat input
         async function sendCustomQuestion() {
             console.log('🚀 sendCustomQuestion function called');
             
             const inputField = document.getElementById('chat-input-field');
             if (!inputField) {
                 console.error('❌ Chat input field not found!');
                 return;
             }
             
             const question = inputField.value.trim();
             
             if (!question) {
                 console.log('❌ No question entered');
                 return;
             }
             
             console.log('🎯 Sending custom question:', question);
             console.log('🔍 Current questionData:', questionData);
             console.log('🔍 Current subject:', currentSubject);
             console.log('🔍 Current conversationId:', currentConversationId);
             console.log('🔍 Conversation context:', getConversationContext());
             
             // Add custom question to conversation history
             addToConversationHistory('user', question, 'custom_question');
             
             // Add user message to chat display (left side, like helper questions)
             // First try to find chat-messages directly, then within detailed-analysis-section
             let chatMessages = document.getElementById('chat-messages');
             console.log('🔍 Looking for chat-messages element:', chatMessages);
             
             if (!chatMessages) {
                 const detailedAnalysisSection = document.getElementById('detailed-analysis-section');
                 console.log('🔍 detailed-analysis-section found:', detailedAnalysisSection);
                 if (detailedAnalysisSection) {
                     chatMessages = detailedAnalysisSection.querySelector('#chat-messages');
                     console.log('🔍 chat-messages found within detailed-analysis-section:', chatMessages);
                 }
             }
             
             if (!chatMessages) {
                 console.error('❌ Chat messages area not found in sendCustomQuestion');
                 console.log('🔍 Available elements with "chat" in ID:');
                 document.querySelectorAll('[id*="chat"]').forEach(el => {
                     console.log('  -', el.id, el.tagName, el.className);
                 });
                 return;
             }
             
             const userMessage = document.createElement('div');
             userMessage.className = 'chat-message user';
             userMessage.innerHTML = `<div class="message-bubble user">${question}</div>`;
             chatMessages.appendChild(userMessage);
             
             // Clear input field
             inputField.value = '';
             
             // Show loading state for custom question (separate from helper questions)
             showCustomQuestionLoading(question);
             
             // Show FAB button when custom question is sent
             showFloatingActionButton();
             
             // Hide chat input and show FAB button AFTER showing loading
             // Add small delay to ensure loading message is visible
             setTimeout(() => {
                 hideChatInput();
             }, 200);
             
             // Make API call to get help response with streaming effect
             try {
                 const requestBody = {
                     question: question,
                     subject: questionData?.subject || 'biology',
                     grade: questionData?.grade || 'دوم',
                     chapter: questionData?.chapter || '1',
                     originalAnalysis: questionData?.analysis || '',
                     conversationId: currentConversationId,
                     conversationContext: getConversationContext()
                 };
                 
                 console.log('📤 Making API call to /api/chat/help-question/stream');
                 console.log('📤 Request body:', requestBody);
                 
                 const response = await fetch('/api/chat/help-question/stream', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify(requestBody)
                 });
                 
                 console.log('📥 API response received:', response);
                 console.log('📥 Response status:', response.status);
                 console.log('📥 Response headers:', response.headers);
                 
                 if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                 }
                 
                 console.log('✅ API response received, starting streaming...');
                 
                 // Handle streaming response with real-time updates
                 await streamCustomQuestionResponse(response, question);
                 
             } catch (error) {
                 console.error('❌ Error getting custom question response:', error);
                 console.error('❌ Error details:', error.message, error.stack);
                 showCustomQuestionError(question, error.message);
             }
         }
         
         // Show loading state for custom question (separate from helper questions)
         function showCustomQuestionLoading(question) {
             // Add AI loading message to chat display (below the user's custom question)
             // First try to find chat-messages directly, then within detailed-analysis-section
             let chatMessages = document.getElementById('chat-messages');
             if (!chatMessages) {
                 const detailedAnalysisSection = document.getElementById('detailed-analysis-section');
                 if (detailedAnalysisSection) {
                     chatMessages = detailedAnalysisSection.querySelector('#chat-messages');
                 }
             }
             
             if (!chatMessages) {
                 console.error('❌ Chat messages area not found in showCustomQuestionLoading');
                 return;
             }
             
             const aiLoadingMessage = document.createElement('div');
             aiLoadingMessage.className = 'chat-message ai loading-message';
             aiLoadingMessage.id = `custom-ai-loading-${Date.now()}`; // Unique ID for custom questions
             aiLoadingMessage.innerHTML = `
                 <div class="message-bubble ai">
                     <div class="flex items-center space-x-2 space-x-reverse">
                         <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                         <span class="text-gray-600">در حال پاسخ...</span>
                     </div>
                 </div>
             `;
             
             chatMessages.appendChild(aiLoadingMessage);
             
             // Scroll to the new content
             aiLoadingMessage.scrollIntoView({ behavior: 'smooth' });
             
             console.log('✅ Loading message created with ID:', aiLoadingMessage.id);
         }
         
         // Stream custom question response with real-time updates
         async function streamCustomQuestionResponse(response, question) {
             console.log('🚀 Starting to stream custom question response...');
             
             const reader = response.body.getReader();
             const decoder = new TextDecoder();
             let fullResponse = '';
             
             // Find the existing AI loading message for custom questions (unique ID)
             // Use the most recent loading message
             const aiLoadingMessage = document.querySelector('.loading-message:last-of-type');
             
             if (!aiLoadingMessage || !aiLoadingMessage.classList.contains('ai')) {
                 console.error('❌ AI loading message not found for streaming');
                 return;
             }
             
             console.log('🎯 Found loading message for streaming:', aiLoadingMessage.id);
             
             try {
                 while (true) {
                     const { done, value } = await reader.read();
                     
                     if (done) break;
                     
                     const chunk = decoder.decode(value);
                     const lines = chunk.split('\n');
                     
                     for (const line of lines) {
                         if (line.startsWith('data: ')) {
                             const data = line.slice(6);
                             
                             if (data === '[DONE]') {
                                 // Final formatting and display
                                 displayCustomQuestionResponse(question, fullResponse, aiLoadingMessage);
                                 return;
                             }
                             
                             try {
                                 const parsed = JSON.parse(data);
                                 if (parsed.content && parsed.type === 'chunk') {
                                     fullResponse += parsed.content;
                                     
                                     // Update immediately for real-time rendering during streaming
                                     updateCustomQuestionResponseStreaming(question, fullResponse, aiLoadingMessage);
                                 }
                             } catch (e) {
                                 // Ignore parsing errors for incomplete chunks
                             }
                         }
                     }
                 }
             } catch (error) {
                 console.error('Streaming error:', error);
                 showCustomQuestionError(question, error.message);
                 
                 // Ensure FAB button is visible after streaming error
                 setTimeout(() => {
                     ensureFABVisible();
                 }, 100);
             }
         }
         
         // Update custom question response in real-time with streaming effect
         function updateCustomQuestionResponseStreaming(question, response, aiLoadingMessage) {
             // Update the loading message with streaming content in real-time
             // Use the same simple approach as detailed analysis
             const messageBubble = aiLoadingMessage.querySelector('.message-bubble.ai');
             if (messageBubble) {
                 // Simple streaming update using the same system as detailed analysis
                 messageBubble.innerHTML = formatStreamingChunk(response);
                 
                 console.log('✅ Streaming update applied to message bubble:', aiLoadingMessage.id);
             } else {
                 console.error('❌ Message bubble not found in updateCustomQuestionResponseStreaming');
             }
             
             console.log('✅ Streaming update for custom question:', question, response.length);
         }
         
         // Update custom question response in real-time (legacy function)
         function updateCustomQuestionResponse(question, response) {
             // This can be used for real-time updates if needed
             console.log('Updating custom response for:', question, response.length);
         }
         
         // Display final custom question response with streaming effect
         function displayCustomQuestionResponse(question, response, aiLoadingMessage) {
             // Add AI response to conversation history
             addToConversationHistory('assistant', response, 'custom_response');
             
             // Update the existing loading message with the final formatted response
             // Use the simple helper question formatting (bullet points and numbered lists only)
             const messageBubble = aiLoadingMessage.querySelector('.message-bubble.ai');
             if (messageBubble) {
                 // Simple final display with bullet points and numbered lists only
                 messageBubble.innerHTML = formatHelperQuestionResponse(response);
             }
             
             // Ensure FAB button is visible after response is displayed
             setTimeout(() => {
                 ensureFABVisible();
             }, 100);
             
             console.log('✅ Custom question response displayed successfully with streaming effect');
         }
         
         // Show error for custom question
         function showCustomQuestionError(question, errorMessage) {
             // Find the existing AI loading message for custom questions and show error
             const aiLoadingMessage = document.querySelector('.loading-message:last-of-type');
             if (!aiLoadingMessage) return;
             
             const messageBubble = aiLoadingMessage.querySelector('.message-bubble.ai');
             if (messageBubble) {
                 messageBubble.innerHTML = `
                     <div class="text-red-500 text-center">
                         <p class="text-sm">خطا: ${errorMessage}</p>
                     </div>
                 `;
             }
             
             // Ensure FAB button is visible after error
             setTimeout(() => {
                 ensureFABVisible();
             }, 100);
         }
         
                   // Handle Enter key in chat input
          document.addEventListener('DOMContentLoaded', function() {
              // Initialize conversation history system
              initializeConversation();
              
              // FAB button will be shown only when helper questions are sent
              // ensureFABVisible(); // Keep hidden until helper questions are used
              
                           // Add mobile touch event handling for FAB button
             const fabButton = document.getElementById('fab-button');
             if (fabButton) {
                 // Simplified mobile touch handling - no preventDefault
                 fabButton.addEventListener('touchstart', function(e) {
                     console.log('📱 Mobile touch detected on FAB button');
                     // Small delay to ensure touch is registered
                     setTimeout(() => {
                         toggleChatInput();
                     }, 50);
                 }, { passive: true });
                 
                 // Also keep click for desktop
                 fabButton.addEventListener('click', function(e) {
                     console.log('🖱️ Desktop click detected on FAB button');
                     toggleChatInput();
                 });
                 
                 // Add touchend as backup for mobile
                 fabButton.addEventListener('touchend', function(e) {
                     console.log('📱 Mobile touch ended on FAB button');
                 });
             }
             
             // Setup send button functionality
             const sendButton = document.getElementById('send-chat-button');
             if (sendButton) {
                 console.log('🔍 Send button found during initialization');
                 
                 // Remove any existing event listeners
                 sendButton.replaceWith(sendButton.cloneNode(true));
                 const newSendButton = document.getElementById('send-chat-button');
                 
                 // Add proper event listeners for both desktop and mobile
                 newSendButton.addEventListener('click', function(e) {
                     console.log('🖱️ Send button clicked (desktop)');
                     e.preventDefault();
                     e.stopPropagation();
                     sendCustomQuestion();
                 });
                 
                 newSendButton.addEventListener('touchstart', function(e) {
                     console.log('📱 Send button touched (mobile)');
                     e.preventDefault();
                     e.stopPropagation();
                     sendCustomQuestion();
                 });
                 
                 newSendButton.addEventListener('touchend', function(e) {
                     console.log('📱 Send button touch ended (mobile)');
                 });
                 
                 console.log('✅ Send button event listeners properly set up');
             } else {
                 console.error('❌ Send button not found during initialization!');
             }
             
             // Log device type for debugging
             if ('ontouchstart' in window) {
                 console.log('📱 Mobile device detected');
             } else {
                 console.log('🖥️ Desktop device detected');
             }
              
              const chatInputField = document.getElementById('chat-input-field');
              if (chatInputField) {
                  chatInputField.addEventListener('keypress', function(e) {
                      if (e.key === 'Enter') {
                          sendCustomQuestion();
                      }
                  });
              }
              
              // Close chat input when clicking outside
              document.addEventListener('click', function(e) {
                  const chatInputSection = document.getElementById('chat-input-section');
                  const fabButton = document.getElementById('fab-button');
                  const fabContainer = document.getElementById('fab-container');
                  
                  if (chatInputSection && chatInputSection.classList.contains('show')) {
                      if (!chatInputSection.contains(e.target) && !fabButton.contains(e.target)) {
                          hideChatInput();
                          console.log('✅ Chat input closed (clicked outside), FAB button shown again');
                      }
                  }
              });
          });
          
                   // Auto-resize textarea function with proper send button handling
         function autoResize(textarea) {
             console.log('📝 autoResize called with value:', textarea.value);
             
             textarea.style.height = 'auto';
             textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
             
             // Update button color and visibility based on typing
             const sendButton = document.getElementById('send-chat-button');
             if (!sendButton) {
                 console.error('❌ Send button not found in autoResize!');
                 return;
             }
             
             if (textarea.value.trim() !== '') {
                 console.log('✅ Text detected, showing send button');
                 textarea.classList.add('typing-active');
                 
                 // Change button color
                 sendButton.classList.remove('bg-gray-400');
                 sendButton.classList.add('bg-black');
                 
                 // Show send button when typing
                 sendButton.style.opacity = '1';
                 sendButton.style.pointerEvents = 'auto';
                 sendButton.style.transform = 'translateY(-50%) scale(1)';
                 sendButton.style.cursor = 'pointer';
                 sendButton.style.zIndex = '20';
                 
                 console.log('🔍 Send button styles after showing:', {
                     opacity: sendButton.style.opacity,
                     pointerEvents: sendButton.style.pointerEvents,
                     transform: sendButton.style.transform,
                     cursor: sendButton.style.cursor,
                     zIndex: sendButton.style.zIndex
                 });
                 
                 // Test if button is now clickable
                 console.log('🧪 Send button should now be clickable');
             } else {
                 console.log('❌ No text, hiding send button');
                 textarea.classList.remove('typing-active');
                 
                 // Change button color back
                 sendButton.classList.remove('bg-black');
                 sendButton.classList.add('bg-gray-400');
                 
                 // Hide send button when no text
                 sendButton.style.opacity = '0';
                 sendButton.style.pointerEvents = 'none';
                 sendButton.style.transform = 'translateY(-50%) scale(0.75)';
                 
                 console.log('🔍 Send button hidden');
             }
         }
          
                   // Function to handle input focus - make button black immediately
         function handleInputFocus(textarea) {
             console.log('🎯 Input focused, showing send button');
             
             const sendButton = document.getElementById('send-chat-button');
             if (!sendButton) {
                 console.error('❌ Send button not found in handleInputFocus!');
                 return;
             }
             
             // Show send button with animation
             sendButton.style.opacity = '1';
             sendButton.style.pointerEvents = 'auto';
             sendButton.style.transform = 'translateY(-50%) scale(1)';
             sendButton.style.cursor = 'pointer';
             sendButton.style.zIndex = '20';
             
             sendButton.classList.remove('bg-gray-400');
             sendButton.classList.add('bg-black');
             textarea.classList.add('typing-active');
             
             console.log('✅ Send button shown on input focus');
             
             // Hide bottom navigation when input is focused
             const bottomNav = document.getElementById('bottom-navigation');
             if (bottomNav) {
                 bottomNav.style.opacity = '0';
                 bottomNav.style.pointerEvents = 'none';
             }
         }
          
                   // Function to handle input blur - make button gray if no text
         function handleInputBlur(textarea) {
             console.log('🎯 Input blur, checking if should hide send button');
             
             if (textarea.value.length === 0) {
                 const sendButton = document.getElementById('send-chat-button');
                 if (sendButton) {
                     sendButton.classList.remove('bg-black');
                     sendButton.classList.add('bg-gray-400');
                     textarea.classList.remove('typing-active');
                     
                     // Hide send button when no text
                     sendButton.style.opacity = '0';
                     sendButton.style.pointerEvents = 'none';
                     sendButton.style.transform = 'translateY(-50%) scale(0.75)';
                     
                     console.log('✅ Send button hidden on blur (no text)');
                 }
             } else {
                 console.log('ℹ️ Text still present, keeping send button visible');
             }
              
              // Show bottom navigation when input loses focus
              const bottomNav = document.getElementById('bottom-navigation');
              if (bottomNav) {
                  bottomNav.style.opacity = '1';
                  bottomNav.style.pointerEvents = 'auto';
              }
              
              // Auto-hide chat input after a delay if no text
              setTimeout(() => {
                  if (textarea.value.length === 0) {
                      const chatInputSection = document.getElementById('chat-input-section');
                      const fabContainer = document.getElementById('fab-container');
                      
                      if (chatInputSection.classList.contains('show')) {
                          chatInputSection.classList.remove('show');
                          
                          // Show FAB button again
                          fabContainer.style.opacity = '1';
                          fabContainer.style.pointerEvents = 'auto';
                          fabContainer.style.transform = 'scale(1)';
                          
                          console.log('✅ Chat input auto-hidden, FAB button shown again');
                      }
                  }
              }, 2000); // 2 second delay
          }
        

        
        // ========================================
        // END OF FAB FUNCTIONS
        // ========================================
    </script>
</body>
</html>

