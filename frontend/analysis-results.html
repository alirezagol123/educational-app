<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#E8E8E4">
    <meta name="msapplication-navbutton-color" content="#E8E8E4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="light-content">
    <title>مِنو - نتایج تحلیل سوال</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Enhanced MathJax for comprehensive math rendering -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                packages: {'[+]': ['ams', 'amscd', 'amssymb', 'mathtools', 'physics', 'bm', 'cancel', 'cases', 'empheq', 'geometry', 'mhchem', 'pgf', 'textmacros', 'unicode', 'upgreek', 'verbatim']}
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/ams', '[tex]/amscd', '[tex]/amssymb', '[tex]/mathtools', '[tex]/physics', '[tex]/bm', '[tex]/cancel', '[tex]/cases', '[tex]/empheq', '[tex]/geometry', '[tex]/mhchem', '[tex]/pgf', '[tex]/textmacros', '[tex]/unicode', '[tex]/upgreek', '[tex]/verbatim']
            }
        };
    </script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        // Global error handling to prevent error dialogs
        window.addEventListener('error', function(e) {
            console.error('Global error caught:', e.error);
            // Don't prevent default - let the page handle errors normally
            // e.preventDefault();
            // return false;
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Global unhandled promise rejection:', e.reason);
            // Don't prevent default - let the page handle errors normally
            // e.preventDefault();
            // return false;
        });
        
        // Prevent any alert/confirm dialogs
        const originalAlert = window.alert;
        const originalConfirm = window.confirm;
        
        window.alert = function(message) {
            console.log('Alert prevented:', message);
            return;
        };
        
        window.confirm = function(message) {
            console.log('Confirm prevented:', message);
            return true; // Always return true to prevent navigation
        };
        
        // Check login status on page load - DISABLED FOR NOW
        function checkLoginStatus() {
            // Set default user data for testing
            if (!localStorage.getItem('user_id')) {
                localStorage.setItem('user_id', '1');
                localStorage.setItem('is_verified', 'true');
                localStorage.setItem('user_phone', '+1234567890');
            }
            return true;
        }
        
        // Check login status immediately - DISABLED FOR NOW
        checkLoginStatus();
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'meno-blue': '#3B82F6',
                        'meno-gray': '#6B7280',
                        'meno-light-gray': '#F3F4F6'
                    }
                }
            }
        }
    </script>
    <style>
                 body {
             font-family: 'Vazirmatn', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
             font-size: 16px; /* Changed from 18px to match chat page */
             line-height: 1.6;
             background: #fcfdf8 !important;
         }
        
        .result-container {
            background: linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 100%);
            border-radius: 50px;
            transition: all 0.5s ease;
            overflow: hidden;
            position: relative;
        }
        
        .result-container.biology {
            background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
        }
        
                 .result-container.collapsed {
             max-height: 30vh;
             padding: 1rem;
             margin: 0;
             opacity: 0.3;
             transform: none;
             transform-origin: top;
             overflow: hidden;
         }
        
                 /* Remove extra space below collapsed results */
        
        .result-container.collapsed .mb-8 {
            margin-bottom: 0.5rem;
        }
        
        .result-container.collapsed h2 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .result-container.collapsed #result-display {
            margin-bottom: 0.5rem;
        }
        
        .result-container.collapsed #analysis-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
                 .detailed-analysis-section {
             transition: none;
             transform: none;
             opacity: 1;
             display: block;
             margin-top: 2rem;
             position: static;
             background: transparent !important;
             box-shadow: none;
             border-radius: 0;
             overflow: hidden;
         }
        
        .detailed-analysis-section.show {
             display: block !important;
         }
         
         /* Detailed analysis section styling - seamlessly integrated with main page */
         #detailed-analysis-section {
             background: transparent;
             border-radius: 0;
             box-shadow: none;
             overflow: hidden;
             border: none;
             margin-top: 2rem;
             margin-left: 0;
             margin-right: 0;
             transition: all 0.3s ease;
         }
         
         /* Mobile responsive - full width on small screens */
         @media (max-width: 768px) {
             #detailed-analysis-section {
                 margin-left: -1.5rem;
                 margin-right: -1.5rem;
             }
         }
         
         #detailed-analysis-section:not(.hidden) {
             display: block !important;
        }
        
                         .analysis-content {
            line-height: 1.8;
            text-align: right;
            font-size: 16px; /* Changed from 18px to match chat page base size */
            background: transparent !important;
            display: block !important;
        }
         
         #chat-messages {
             display: block !important;
             background: transparent;
             border-radius: 0;
             margin-top: 0;
             padding: 0 32px 32px 32px;
             border-top: 1px solid #f3f4f6;
         }
         
                 /* Mobile responsive - full width for chat messages */
        @media (max-width: 768px) {
            #chat-messages {
                margin-left: -1.5rem;
                margin-right: -1.5rem;
                padding-left: 1.5rem;
                padding-right: 1.5rem;
                width: calc(100% + 3rem);
                background: transparent;
            }
            
            /* Remove the border on mobile for seamless appearance */
            #chat-messages {
                border-top: none;
            }
            
            /* AI responses use same width as detailed analysis on mobile */
            .message-bubble.ai {
                margin: 0;
                width: 100%;
                max-width: 100%;
                border-radius: 0;
                background: transparent;
            }
            
            /* Helper response content uses same width as detailed analysis on mobile */
            .helper-response-content {
                margin: 0;
                width: 100%;
                max-width: 100%;
                background: transparent;
            }
         }
        
        .analysis-content h4 {
            font-weight: 600;
            color: #1f2937;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .analysis-content p {
            margin-bottom: 1rem;
            color: #374151;
        }
        
        .analysis-content ul {
            margin: 1rem 0;
            padding-right: 1.5rem;
        }
        
        .analysis-content li {
            margin-bottom: 0.5rem;
            color: #374151;
        }
        
                 /* Special styling for structured analysis sections */
         .analysis-section {
             margin: 16px 0;
             padding: 0;
         }
         
         .analysis-section h3 {
             font-weight: 700;
             color: #1e40af;
             margin-bottom: 12px;
             font-size: 1.3rem;
         }
        
        /* Enhanced text styling for structured content */
        .analysis-content h1, .analysis-content h2, .analysis-content h3 {
            font-weight: 700;
            color: #1e40af;
            margin-top: 1.5rem;
            margin-bottom: 0.8rem;
            font-size: 1.4rem;
        }
        
        .analysis-content h4, .analysis-content h5, .analysis-content h6 {
            font-weight: 600;
            color: #1e40af;
            margin-top: 1.2rem;
            margin-bottom: 0.6rem;
            font-size: 1rem; /* Changed from 1.2rem to match chat page */
        }
        
        .analysis-content ol {
            margin: 1rem 0;
            padding-right: 1.5rem;
            counter-reset: item;
        }
        
        .analysis-content ol li {
            margin-bottom: 0.8rem;
            color: #374151;
            counter-increment: item;
            position: relative;
        }
        
        .analysis-content ol li::before {
            content: counter(item) ".";
            font-weight: 700;
            color: #1e40af;
            margin-left: 0.5rem;
            font-size: 1.1rem;
        }
        
        .analysis-content ul {
            margin: 1rem 0;
            padding-right: 1.5rem;
        }
        
        .analysis-content ul li {
            margin-bottom: 0.8rem;
            color: #374151;
            position: relative;
        }
        
        .analysis-content ul li::before {
            content: "•";
            font-weight: 700;
            color: #1e40af;
            margin-left: 0.5rem;
            font-size: 1.5rem; /* Made bigger like GPT study mode */
            vertical-align: middle; /* Align with text baseline */
            line-height: 1; /* Prevent extra spacing */
        }
        
        /* Enhanced list styling for all responses */
        .bullet-list {
            margin: 1rem 0;
            padding-right: 0; /* Remove padding, we'll use individual item padding */
            list-style: none;
        }
        
        .bullet-list li {
            margin-bottom: 0.8rem;
            color: #374151;
            text-align: right;
        }
        
        .bullet-list li::before {
            content: "• ";
            font-weight: 700;
            color: #1e40af;
            font-size: 1.5rem; /* Made bigger like GPT study mode */
            line-height: 1; /* Prevent extra spacing */
            margin-left: 0.5rem; /* Space between bullet and text */
        }
        
        .numbered-list {
            margin: 1rem 0;
            padding-right: 0; /* Remove padding, we'll use individual item padding */
            counter-reset: item;
        }
        
        .numbered-list li {
            margin-bottom: 0.8rem;
            color: #374151;
            counter-increment: item;
            text-align: right;
        }
        
        .numbered-list li::before {
            content: counter(item) ". ";
            font-weight: 700;
            color: #1e40af;
            font-size: 1.5rem; /* Made bigger like GPT study mode */
            line-height: 1; /* Prevent extra spacing */
            margin-left: 0.5rem; /* Space between number and text */
        }
        
                 /* Button hover effects */
         button:hover {
             transform: translateY(-2px);
             box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
             transition: all 0.3s ease;
         }
         
                           /* Ensure helper question AI responses have no background */
        .streaming-answer {
            background: transparent !important;
        }
        
        /* Mathematical formulas styling for helper questions */
        .streaming-answer .ai-tutor-response p,
        .streaming-answer .ai-tutor-response .msg-body p {
            color: #1e293b !important;
            font-size: 16px !important; /* Changed from 20px to match chat page */
            font-weight: 500 !important;
        }
        
        /* Enhanced styling for mathematical expressions and formulas */
        .streaming-answer .ai-tutor-response p {
            color: #000000 !important;
            font-size: 16px !important; /* Changed from 18px to match chat page */
            font-weight: 600 !important;
         
         /* Helper question response styling - seamless integration */
         .helper-response-content {
             background: transparent;
             border: none;
             box-shadow: none;
             margin: 0;
             padding: 0;
             width: 100%; /* Same width as detailed analysis */
             max-width: 100%;
         }
         
         .helper-response-content p {
             margin-bottom: 1rem;
             color: #374151;
             line-height: 1.6;
         }
         
         /* Enhanced list styling for helper question responses */
         .helper-response-content ul.bullet-list {
             margin: 1rem 0;
             padding-right: 0; /* Remove padding, we'll use individual item padding */
             list-style: none;
         }
         
         .helper-response-content ul.bullet-list li {
             margin-bottom: 0.8rem;
             color: #374151;
             text-align: right;
         }
         
         .helper-response-content ul.bullet-list li::before {
            content: "• ";
             font-weight: 700;
             color: #1e40af;
            font-size: 1.5rem; /* Made bigger like GPT study mode */
            line-height: 1; /* Prevent extra spacing */
            margin-left: 0.5rem; /* Space between bullet and text */
         }
         
         .helper-response-content ol.numbered-list {
             margin: 1rem 0;
             padding-right: 1.5rem;
             counter-reset: item;
         }
         
         .helper-response-content ol.numbered-list li {
             margin-bottom: 0.8rem;
             color: #374151;
             counter-increment: item;
             position: relative;
             padding-right: 1.5rem;
         }
         
         .helper-response-content ol.numbered-list li::before {
             content: counter(item) ".";
             font-weight: 700;
             color: #1e40af;
             position: absolute;
             right: 0;
             font-size: 1.1rem;
         }
         
         /* Callout box styling for special notes */
         .helper-response-content .callout-box {
             background: #f0f9ff;
             border: 1px solid #0ea5e9;
             border-radius: 8px;
             padding: 1rem;
             margin: 1rem 0;
             border-right: 4px solid #0ea5e9;
         }
         
         .helper-response-content .callout-box strong {
             color: #0c4a6e;
             font-weight: 600;
         }
         
                 /* Mobile responsive - same width as detailed analysis for helper question responses */
        @media (max-width: 768px) {
            .helper-response-content {
                margin: 0;
                width: 100%;
                max-width: 100%;
                background: transparent;
            }
            
            .helper-response-content ul.bullet-list,
            .helper-response-content ol.numbered-list {
                margin: 0.75rem 0;
                padding-right: 1rem;
            }
            
            .helper-response-content ul.bullet-list li,
            .helper-response-content ol.numbered-list li {
                margin-bottom: 0.6rem;
                padding-right: 1rem;
                font-size: 18px; /* Increased for better readability */
            }
            
            .helper-response-content .callout-box {
                padding: 0.75rem;
                margin: 0.75rem 0;
            }
            
            /* Mobile styling for general list classes */
            .bullet-list,
            .numbered-list {
                margin: 0.75rem 0;
                padding-right: 1rem;
            }
            
            .bullet-list li,
            .numbered-list li {
                margin-bottom: 0.6rem;
                padding-right: 1rem;
                font-size: 18px; /* Increased for better readability */
            }
            
            .message-bubble.ai {
                margin: 0;
                width: 100%;
                max-width: 100%;
                border-radius: 0;
                background: transparent;
            }
            
            /* Ensure the entire chat message has same width as detailed analysis */
            .chat-message.ai {
                margin: 0;
                width: 100%;
                max-width: 100%;
            }
        }
        }
        
        /* Specific styling for mathematical symbols */
        .streaming-answer .ai-tutor-response .msg-body {
            color: #000000 !important;
        }
        
        /* Make all text in helper questions bigger and black */
        .streaming-answer .ai-tutor-response * {
            color: #000000 !important;
        }
        
        /* Mobile-specific fixes for helper questions */
        @media (max-width: 768px) {
            .bg-gray-100 {
                background-color: #e5e7eb !important;
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
                touch-action: manipulation;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
            }
            
            .bg-gray-100:active {
                background-color: #d1d5db !important;
                transform: scale(0.98);
            }
            
            .bg-gray-100:hover {
                background-color: #f3f4f6 !important;
            }
            
            /* Ensure proper touch area */
            .cursor-pointer {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Fix mobile text rendering */
            .text-gray-700 {
                color: #374151 !important;
                font-size: 16px !important;
                line-height: 1.5 !important;
            }
            
            /* Mobile-specific spacing */
            .space-y-3 > * + * {
                margin-top: 0.75rem;
            }
            
            /* Ensure proper mobile padding */
            .p-4 {
                padding: 1rem !important;
            }
            
            /* Mobile-friendly borders */
            .border {
                border-width: 1px !important;
            }
            
            /* Mobile-specific transitions */
            .transition-all {
                transition: all 0.15s ease !important;
            }
        }
          
                 /* Floating Action Button (FAB) Styling */
         #fab-container {
             position: fixed;
             bottom: 7rem; /* 112px - moved up from 6rem */
             left: 1.5rem; /* 24px from left edge */
             z-index: 60; /* Higher than bottom navigation (z-50) */
             transition: all 0.3s ease;
         }
        
        #fab-container.scale-0 {
            transform: scale(0);
            opacity: 0;
        }
        
        #fab-container.scale-100 {
            transform: scale(1);
            opacity: 1;
        }
        
        #fab-button {
            width: 3.5rem; /* 56px */
            height: 3.5rem; /* 56px */
            background-color: #d1d5db; /* Pale/light gray */
            border: 1px solid #9ca3af; /* Lighter gray border */
            border-radius: 1rem; /* 16px - rounded square */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        
        #fab-button:hover {
            background-color: #9ca3af; /* Slightly darker pale gray on hover */
            transform: translateY(-2px) scale(1.1);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0,0, 0, 0.1);
        }
        
        #fab-button:active {
            transform: scale(0.95);
        }
        
        #fab-button svg {
            width: 1.75rem; /* 28px */
            height: 1.75rem; /* 28px */
            color: #374151; /* Dark gray icon for better contrast on pale background */
            transition: color 0.3s ease;
        }
        
        #fab-button:hover svg {
            color: #1f2937; /* Even darker on hover */
        }
        
                 /* Mobile-specific FAB adjustments */
         @media (max-width: 768px) {
             #fab-container {
                 bottom: 6.5rem; /* Moved up from 5.5rem to match desktop positioning */
                 left: 1rem; /* Closer to left edge on mobile */
                 z-index: 60; /* Ensure it's above navigation on mobile too */
             }
             
             #fab-button {
                 width: 3rem; /* Slightly smaller on mobile */
                 height: 3rem;
                 background-color: #d1d5db; /* Keep consistent pale gray on mobile */
                 /* Mobile touch optimizations - less restrictive */
                 touch-action: auto; /* Allow all touch actions */
                 -webkit-tap-highlight-color: transparent;
                 -webkit-user-select: none;
                 user-select: none;
                 /* Ensure mobile clickability */
                 cursor: pointer;
                 -webkit-touch-callout: none;
             }
             
             #fab-button svg {
                 width: 1.5rem;
                 height: 1.5rem;
                 color: #374151; /* Keep dark gray icon on mobile */
             }
             
             /* Mobile FAB positioning when chat input is shown */
             #fab-container.fab-above-input {
                 bottom: 11rem;
            }
            
            /* Ensure FAB button is clickable on mobile */
            #fab-button:active {
                transform: scale(0.95);
                background-color: #9ca3af;
            }
        }
          
        /* AI Tutor Response Styling */
        .ai-tutor-response {
            font-family: 'Vazirmatn', 'Inter', sans-serif;
            direction: rtl;
            background: transparent;
            border-radius: 12px;
            overflow: hidden;
        }

        .ai-tutor-response .msg-head {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            border-radius: 12px 12px 0 0;
        }

        .ai-tutor-response .who {
            color: #2563eb;
            font-weight: 600;
            font-size: 16px; /* Changed from 18px to match chat page */
        }

        .ai-tutor-response .timestamp {
            color: #64748b;
            font-size: 14px;
        }

        .ai-tutor-response .msg-body {
            padding: 20px;
            background: transparent;
        }

        .ai-tutor-response p {
            color: #1e293b;
            line-height: 1.8;
            margin-bottom: 16px;
            font-size: 16px; /* Changed from 18px to match chat page */
            font-weight: 500;
        }

        .ai-tutor-response .ordered-list {
            margin: 20px 0;
            padding-right: 24px;
            list-style-type: decimal;
        }

        .ai-tutor-response .unordered-list {
            margin: 20px 0;
            padding-right: 24px;
            list-style-type: disc;
        }

        .ai-tutor-response .ordered-list li,
        .ai-tutor-response .unordered-list li {
            color: #374151;
            line-height: 1.8;
            margin-bottom: 12px;
            font-size: 16px; /* Changed from 18px to match chat page */
            font-weight: 500;
        }

        .ai-tutor-response .callout {
            margin: 20px 0;
            padding: 16px 20px;
            border-radius: 8px;
            border-right: 4px solid;
        }

        .ai-tutor-response .callout.warning {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .ai-tutor-response .callout.tip {
            background: #dbeafe;
            border-color: #3b82f6;
        }

        .ai-tutor-response .callout.info {
            background: #e0e7ff;
            border-color: #6366f1;
        }

        .ai-tutor-response .callout-content p {
            color: #1e293b;
            font-weight: 600;
            margin: 0;
            font-size: 16px; /* Changed from 18px to match chat page */
        }

        .ai-tutor-response .code-block {
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px 16px;
            margin: 16px 0;
            font-family: 'Courier New', monospace;
            font-size: 16px;
        }

        .ai-tutor-response pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .ai-tutor-response code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
        }

        .ai-tutor-response strong {
            font-weight: 700;
            color: #1e293b;
        }

        .ai-tutor-response em {
            font-style: italic;
            color: #475569;
        }

        .ai-tutor-response h3 {
            font-size: 16px; /* Changed from 20px to match chat page */
            font-weight: 700;
            color: #1e293b;
            margin: 24px 0 16px 0;
        }
          
          /* Callout Styling */
          .ai-tutor-response .callout {
              margin: 1.5rem 0;
              padding: 1rem;
              border-radius: 0.5rem;
              border-right-width: 4px;
          }
          
          .ai-tutor-response .callout.tip {
              background-color: #f0f9ff;
              border-right-color: #3b82f6;
          }
          
          .ai-tutor-response .callout.warning {
              background-color: #fef3c7;
              border-right-color: #f59e0b;
          }
          
          .ai-tutor-response .callout.info {
              background-color: #f0fdf4;
              border-right-color: #10b981;
          }
          
          .ai-tutor-response .callout-icon {
              font-size: 1.25rem;
              margin-left: 0.75rem;
          }
          
          .ai-tutor-response .callout-content p {
              margin: 0;
              font-weight: 500;
              color: #1f2937;
          }
          
          /* Code Block Styling */
          .ai-tutor-response .code-block {
              background-color: #f9fafb;
              border: 1px solid #e5e7eb;
              border-radius: 0.5rem;
              padding: 0.75rem;
              margin: 1.5rem 0;
          }
          
          .ai-tutor-response .code-block pre {
              margin: 0;
              font-family: 'Courier New', monospace;
              font-size: 0.875rem;
              color: #374151;
              overflow-x: auto;
              white-space: pre-wrap;
              word-wrap: break-word;
          }
          
          .ai-tutor-response .code-block code {
              background: none;
              padding: 0;
              border: none;
              font-family: inherit;
          }
          
          /* Enhanced Typography for AI Responses */
          .ai-tutor-response strong {
              font-weight: 600;
              color: #1f2937;
          }
          
          .ai-tutor-response em {
              font-style: italic;
              color: #4b5563;
          }
          
          .ai-tutor-response h3 {
              font-size: 1.1rem;
              font-weight: 600;
              color: #1e40af;
              margin: 1rem 0 0.5rem 0;
              border-bottom: 1px solid #e5e7eb;
              padding-bottom: 0.25rem;
          }
          
          .ai-tutor-response code {
              background-color: #f3f4f6;
              padding: 0.125rem 0.25rem;
              border-radius: 0.25rem;
              font-family: 'Courier New', monospace;
              font-size: 0.875rem;
              color: #dc2626;
          }
          
          /* Better spacing and visual hierarchy */
          .ai-tutor-response .msg-body > *:first-child {
              margin-top: 0;
          }
          
          .ai-tutor-response .msg-body > *:last-child {
              margin-bottom: 0;
          }

                          /* Make results container clickable for toggle */
          .result-container {
              background: linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 100%);
              border-radius: 50px;
              transition: all 0.5s ease;
              overflow: hidden;
              position: relative;
              cursor: pointer;
          }
          
                     /* Modern Related Questions Section Styling */
           .related-questions-section {
               background: transparent;
               border-radius: 0;
               box-shadow: none;
               padding: 0;
               margin: 24px 0;
               border: none;
           }
           
           .related-questions-section h3 {
               color: #007bff !important;
               font-weight: 700 !important;
               font-size: 1.5rem !important;
               margin-bottom: 1.5rem !important;
               text-align: center;
               border-bottom: 2px solid #e0eaff;
               padding-bottom: 12px;
           }
           
           .question-button {
               transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
               position: relative;
               overflow: hidden;
               border: 2px solid #e5e7eb !important;
               background-color: #f3f4f6 !important;
               margin-bottom: 12px !important;
           }
           
                       .question-button:hover {
                background-color: #e0eaff !important;
                transform: translateY(-2px) scale(1.02) !important;
                box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15) !important;
            }
           
           .question-button:active {
               transform: scale(0.98) !important;
               background-color: #d1d5db !important;
               border-color: #6b7280 !important;
           }
           
           .question-text {
               font-weight: 500;
               color: #374151;
               line-height: 1.6;
               word-wrap: break-word;
               hyphens: auto;
               font-size: 1rem; /* Changed from 1.2rem to match chat page base size */
           }
          
                     /* Mobile responsiveness for related questions */
           @media (max-width: 768px) {
               .related-questions-section {
                   padding: 0;
                   margin: 20px 0;
                   border-radius: 0;
               }
               
                          .related-questions-section h3 {
               font-size: 1.25rem !important; /* Changed from 1.5rem to match chat page */
               margin-bottom: 1rem !important;
           }
               
               .question-button {
                   padding: 12px 16px !important;
                   font-size: 16px !important; /* Changed from 18px to match chat page */
                   min-height: 48px !important;
                   margin-bottom: 10px !important;
               }
               
               .question-text {
                   font-size: 16px !important; /* Changed from 18px to match chat page */
               }
           }
          
                     /* Focus states for accessibility */
           .question-button:focus {
               outline: none;
               background-color: #e0eaff !important;
           }
          
        /* Study-mode content styling - simple and standard with bigger font */
            .study-mode-content {
                text-align: right;
            line-height: 1.6;
                color: #374151;
                font-family: 'IranSans', 'Vazirmatn', sans-serif;
            font-size: 18px;
            max-width: 100%;
            word-wrap: break-word;
            }

            .study-paragraph {
            margin-bottom: 1rem;
            font-size: 18px;
            line-height: 1.6;
                color: #374151;
                font-family: 'IranSans', 'Vazirmatn', sans-serif;
            text-align: right;
            }

            .study-list {
            margin: 1rem 0;
            padding-right: 0;
                list-style: none;
            }

            .study-list-item {
            margin-bottom: 0.5rem;
            font-size: 18px;
                line-height: 1.6;
                color: #374151;
                font-family: 'IranSans', 'Vazirmatn', sans-serif;
            text-align: right;
                position: relative;
            }

        /* Good bullet points */
        .study-list .study-list-item:before {
            content: "•";
                color: #6B7280;
            font-weight: bold;
            font-size: 1.4rem;
            line-height: 1;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
                .study-mode-content {
                font-size: 18px;
                    line-height: 1.6;
                }
                
                .study-paragraph {
                font-size: 18px;
                line-height: 1.6;
                }
                
                .study-list-item {
                font-size: 18px;
                line-height: 1.6;
                }
           }

           
                       /* Chat Input Section Styling - No border, just calm gray background */
            .user-input {
                background: #E5E7EB;
                border: none;
                border-radius: 24px;
                box-shadow: none;
            }
            

            
            /* Typing states for input */
            .user-input.typing-active {
                border: none;
                box-shadow: none;
            }
            
            /* Button color changes based on input state */
            .user-input.typing-active + button {
                background-color: #000000 !important;
            }
            
            /* Ensure input area stays visible */
            #chat-input-field {
                position: relative;
                z-index: 10;
            }
            
            #chat-input-section.show {
                transform: translateY(0) !important;
                opacity: 1 !important;
            }
            
            /* Chat Messages Styling */
            .chat-message {
                display: flex;
                margin-bottom: 1rem;
                animation: fadeInUp 0.3s ease-out;
            }
            
            .chat-message.user {
                justify-content: flex-end;
            }
            
            .chat-message.ai {
                justify-content: flex-start;
            }
            
                    .message-bubble {
            max-width: 95%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.4;
            font-size: 1rem; /* Changed from 1.1rem to match chat page */
        }
            
            .message-bubble.user {
                background-color: #F3F4F6;
                color: #374151;
                border-bottom-right-radius: 6px;
                max-width: 70%;
                align-self: flex-end;
            }
            
            .message-bubble.ai {
                background-color: transparent;
                color: #1F2937;
                border: none;
                border-bottom-left-radius: 6px;
                box-shadow: none;
                max-width: 100%;
                width: 100%;
                margin: 0;
            }
            
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            /* Send button positioning and sizing */
            #send-chat-button {
                position: absolute;
                right: 8px; /* 2rem = 8px */
                top: 7%;
                transform: translateY(-50%);
                width: 48px; /* w-12 = 48px */
                height: 48px; /* h-12 = 48px */
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 20;
            }
            
            /* Mobile responsiveness for chat input */
            @media (max-width: 768px) {
                #chat-input-section {
                    bottom: 2px; /* Position much closer to bottom navigation */
                    padding-bottom: 0;
                    /* Mobile-specific positioning fixes */
                    transform: translateY(100%) !important; /* Force initial hidden state */
                    transition: transform 0.3s ease, opacity 0.3s ease;
                }
                
                #chat-input-section.show {
                    transform: translateY(0) !important; /* Force visible state on mobile */
                    opacity: 1 !important;
                }
                
                                 #send-chat-button {
                     width: 48px;
                     height: 48px;
                     right: 6px;
                     top: 7%;
                     /* Mobile-specific send button fixes */
                     touch-action: auto;
                     -webkit-tap-highlight-color: transparent;
                     cursor: pointer;
                     z-index: 20;
                 }
                
                /* Standard width message bubbles on mobile */
                .message-bubble {
                    max-width: 90%;
                    margin-left: 0;
                    margin-right: 0;
                    width: auto;
                    border-radius: 18px;
                }
                
                .message-bubble.ai {
                    background: transparent;
                    max-width: 100%;
                    width: 100%;
                }
                
                /* User messages stay shorter on mobile */
                .message-bubble.user {
                    max-width: 70%;
                    margin-left: 0;
                    margin-right: 0;
                    width: auto;
                    border-radius: 18px;
                    border-bottom-right-radius: 6px;
                }
                
                /* Comprehensive Content Formatting Styles */
                .content-header {
                    font-family: Arial, Roboto, system-ui, sans-serif;
                    font-weight: 700;
                    color: #1e40af;
                    margin-top: 1.5rem;
                    margin-bottom: 1rem;
                    line-height: 1.3;
                }
                
                .content-header.h1 {
                    font-size: 2rem;
                    color: #1e40af;
                }
                
                .content-header.h2 {
                    font-size: 1.75rem;
                    color: #1e40af;
                }
                
                .content-header.h3 {
                    font-size: 1.5rem;
                    color: #1e40af;
                }
                
                .content-header.h4 {
                    font-size: 1.25rem;
                    color: #1e40af;
                }
                
                .content-header.h5 {
                    font-size: 1rem; /* Changed from 1.125rem to match chat page */
                    color: #1e40af;
                }
                
                .content-header.h6 {
                    font-size: 1rem;
                    color: #1e40af;
                }
                
                .content-paragraph {
                    font-size: 18px; /* Increased for better readability */
                    line-height: 1.6;
                    margin-bottom: 1rem;
                    color: #374151;
                    text-align: justify;
                }
                
                .content-list {
                    margin: 1rem 0;
                    padding-right: 1.5rem;
                    list-style: none;
                }
                
                .content-list li {
                    margin-bottom: 0.8rem;
                    color: #374151;
                    position: relative;
                    padding-right: 1.5rem;
                    font-size: 18px; /* Increased for better readability */
                    line-height: 1.5;
                }
                
                .content-list li::before {
                    content: "•";
                    font-weight: 700;
                    color: #1e40af;
                    position: absolute;
                    right: 0;
                    font-size: 1rem; /* Changed from 1.2rem to match chat page */
                }
                
                .content-list ol li::before {
                    content: counter(item) ".";
                    counter-increment: item;
                }
                
                .code-block {
                    background-color: transparent;
                    border: none;
                    padding: 0.5rem 0;
                    margin: 1rem 0;
                    overflow-x: auto;
                    font-family: 'Courier New', monospace;
                    font-size: 16px; /* Increased for better readability */
                    line-height: 1.4;
                }
                
                .code-block code {
                    color: #374151;
                    background: transparent;
                }
                
                .inline-code {
                    background-color: transparent;
                    border: none;
                    padding: 0;
                    font-family: 'Courier New', monospace;
                    font-size: 16px; /* Increased for better readability */
                    color: #374151;
                    font-weight: 600;
                }
                
                .content-link {
                    color: #2563eb;
                    text-decoration: underline;
                    transition: color 0.2s ease;
                }
                
                .content-link:hover {
                    color: #1d4ed8;
                    text-decoration: none;
                }
                
                .content-blockquote {
                    background-color: transparent;
                    border: none;
                    padding: 0.5rem 0;
                    margin: 1rem 0;
                    font-style: italic;
                    color: #6b7280;
                    font-size: 18px; /* Increased for better readability */
                    line-height: 1.6;
                }
                
                .content-hr {
                    border: none;
                    height: 1px;
                    background-color: #d1d5db;
                    margin: 1.5rem 0;
                }
                
                /* Simple callout box styling - clean and minimal */
                .callout-box {
                    background: transparent;
                    border: none;
                    padding: 0.5rem 0;
                    margin: 1rem 0;
                    position: relative;
                }
                
                .callout-box strong {
                    color: #1e40af;
                    font-weight: 600;
                    font-size: 1rem;
                    display: inline;
                    margin-left: 0.5rem;
                }
                

        
        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .content-header.h1 { font-size: 1.75rem; }
                            .content-header.h2 { font-size: 1.25rem; /* Changed from 1.5rem to match chat page */ }
        .content-header.h3 { font-size: 1rem; /* Changed from 1.25rem to match chat page */ }
            .content-header.h4 { font-size: 1.125rem; }
            .content-header.h5 { font-size: 1rem; }
            .content-header.h6 { font-size: 0.95rem; }
            
            .content-paragraph {
                font-size: 18px; /* Increased for better readability */
                margin-bottom: 0.875rem;
            }
            
            .content-list li {
                        font-size: 18px; /* Increased for better readability */
                        margin-bottom: 0.7rem;
                        padding-right: 1.25rem;
                    }
                    
                    .code-block {
                        padding: 0.875rem;
                        font-size: 16px; /* Increased for better readability */
                    }
                    
                    .inline-code {
                        font-size: 16px; /* Increased for better readability */
                        padding: 0.2rem 0.4rem;
                    }
                    
                    .content-blockquote {
                        padding: 0.875rem 1.25rem;
                        font-size: 18px; /* Increased for better readability */
                    }
                    
                    .callout-box {
                        padding: 1rem;
                        margin: 1.25rem 0;
                    }
                }
            }
            
            /* Input bar styling with dark gray border */
            .input-bar {
                border: 1px solid #6b7280;
            }
        /* Navigation icon states */
        .nav-icon {
            color: #9CA3AF; /* Pale gray for inactive icons */
            transition: color 0.3s ease;
        }
        
        .nav-icon.active {
            color: #374151; /* Full color for active icon */
        }
        
        .nav-icon:hover {
            color: #6B7280; /* Slightly darker on hover */
        }
        </style>
</head>
         <body style="background-color: #F8F9FA;">
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 border-b border-gray-200 z-50" style="background-color: #F8F9FA;">
        <div class="flex justify-center items-center px-6 py-4 relative">
            <!-- Center: Page Title -->
            <div class="text-center">
                <h1 class="text-2xl font-bold text-gray-900">نتایج تحلیل سوال</h1>
            </div>
            
            <!-- Right: Cross Logo (Back to Chapter) -->
            <button class="p-2 hover:bg-gray-200 rounded-lg transition-colors absolute right-6" onclick="goToChapter()" title="بازگشت به صفحه فصل">
                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </header>

    <!-- Main Content -->
         <main class="pt-20 pb-24 px-6" style="background-color: #F8F9FA;">
        <div class="max-w-4xl mx-auto">
            <!-- Results Section -->
            <div id="result-container" class="result-container shadow-2xl p-8 mb-8" onclick="toggleResults()">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 mb-6">نتیجه پاسخ شما</h2>
                    
                    <!-- Result Display -->
                    <div id="result-display" class="mb-8">

                         
                        <!-- Loading State -->
                        <div id="question-loading" class="hidden">
                            <!-- Simple loading state for question results -->
                            <div class="flex items-center justify-center space-x-3 space-x-reverse p-8">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                                <span class="text-gray-600 text-lg">در حال بررسی پاسخ شما...</span>
                            </div>
                        </div>
                        
                        <!-- Results Content -->
                        <div id="question-results">
                            <!-- Results will be populated by JavaScript -->
                        </div>
                    </div>
                     
                    <!-- Analysis Request Button -->
                    <div class="mb-8 text-center">
                        <button id="analysis-btn" 
                                class="bg-blue-600 text-white font-bold py-4 px-12 rounded-full hover:bg-blue-700 transition-all shadow-lg text-2xl mx-2"
                                onclick="event.stopPropagation(); requestAnalysis()">
                            تحلیل سوال
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Detailed Analysis Section - Outside Results but on Main Page -->
            <div id="detailed-analysis-section" class="hidden mt-8">
                <!-- Analysis Content -->
                <div id="analysis-content" class="p-8">
                    <!-- Streaming content will appear here -->
                    <div id="streaming-content"></div>
                    
                    <!-- AI-generated help questions will be rendered here dynamically -->
                    <div id="ai-help-questions"></div>
                </div>
                
                <!-- Chat Messages Display Area - Seamlessly Integrated -->
                <div id="chat-messages" class="mt-0 space-y-3">
                    <!-- Chat messages will appear here -->
                </div>
                
                <!-- Error State -->
                <div id="analysis-error" class="hidden text-center py-8">
                    <div class="bg-red-50 rounded-xl p-6 border border-red-200">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </div>
                        <p class="text-red-800 font-semibold mb-2 text-xl">خطا در تحلیل سوال</p>
                        <p class="text-red-600 mb-4 text-lg">لطفاً دوباره تلاش کنید</p>
                        <button onclick="requestAnalysis()" class="bg-red-600 text-white px-8 py-3 rounded-lg hover:bg-red-700 transition-colors font-medium">
                            تلاش مجدد
                        </button>
                    </div>
                </div>
            </div>

                         <!-- Floating Action Button (FAB) - Initially Hidden -->
             <div id="fab-container" class="fixed bottom-24 left-6 z-50 transition-all duration-500 transform scale-0 opacity-0">
                 

                 <button id="fab-button" 
                         class="w-14 h-14 bg-gray-100 hover:bg-gray-200 rounded-2xl shadow-lg flex items-center justify-center transition-all duration-300 hover:scale-110 active:scale-95 border border-gray-200"
                         title="پرسش جدید">
                     <svg class="w-7 h-7 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                     </svg>
                 </button>
             </div>
             

             
                           <!-- Chat Input Section - Initially Hidden -->
              <div id="chat-input-section" class="fixed bottom-0 left-0 right-0 bg-transparent transition-all duration-300 transform translate-y-full opacity-0" style="z-index: 50;">
                  <!-- User Input -->
                  <div class="px-4 sm:px-6 pb-4" style="z-index: 10; pointer-events: none;">
                      <div class="max-w-5xl mx-auto flex justify-center">
                          <div class="relative w-full max-w-2xl">
                              <div class="input-bar bg-[#e8e8e4] rounded-full shadow-lg flex items-center px-6 py-3" style="height: 65px; border-radius: 9999px;">
                              <textarea 
                                  id="chat-input-field" 
                                      class="user-input w-full px-2 py-2 pr-20 resize-none text-gray-900 placeholder-gray-500 text-xl transition-all duration-200 bg-transparent border-none outline-none"
                                      placeholder="Learn anything..."
                                  rows="1"
                                  oninput="autoResize(this)"
                                  onfocus="handleInputFocus(this)"
                                  onblur="handleInputBlur(this)"
                                  onclick="showChatInput()"
                                      style="pointer-events: auto; min-height: 40px;"
                              ></textarea>
                                  
                                  <!-- Microphone/Recorder Icon - Left Side -->
                                  <button 
                                      id="microphone-button"
                                      class="absolute left-2 top-1/2 w-8 h-8 text-gray-600 rounded-full transition-all duration-200 flex items-center justify-center z-20 hover:bg-gray-200"
                                      style="transform: translateY(-50%);"
                                      onclick="startRecording()"
                                  >
                                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                          <path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                          <line x1="12" y1="19" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                          <line x1="8" y1="23" x2="16" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                      </svg>
                                  </button>
                              
                              <!-- Document Icon - Very Right Edge -->
                              <button 
                                  id="document-button"
                                  class="absolute right-2 top-1/2 w-8 h-8 text-gray-600 rounded-full transition-all duration-200 flex items-center justify-center z-20 hover:bg-gray-200"
                                  style="transform: translateY(-50%);"
                                  onclick="attachDocument()"
                                  title="Attach Document"
                              >
                                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                  </svg>
                              </button>
                              
                              <!-- Send Button - Hidden initially, shown on input focus -->
                              <button 
                                  id="send-chat-button"
                                      class="absolute right-12 top-1/2 w-12 h-12 bg-black text-white rounded-full transition-all duration-200 flex items-center justify-center z-20"
                                  style="opacity: 0; pointer-events: none; transform: translateY(-50%) scale(0.75);"
                              >
                                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V5M5 12l7-7 7 7"/>
                                  </svg>
                              </button>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
              
              <!-- Expanded Input Container (Hidden by default) -->
              <div id="analysis-expanded-input-container" class="fixed bottom-0 left-0 right-0 bg-[#e8e8e4] rounded-t-3xl shadow-2xl hidden z-100" style="height: 100px; border-top: 1px solid #d1d5db;">
                  <div class="relative h-full p-6">
                      <!-- Expanded Textarea -->
                      <textarea 
                          id="analysis-expanded-user-input" 
                          class="w-full bg-transparent border-none resize-none focus:outline-none text-[#000000] font-sans text-2xl placeholder-[#1e1e1e] pr-20 text-right absolute top-2 right-0"
                          placeholder="Learn anything..."
                          rows="3"
                          onkeydown="handleAnalysisExpandedInputKeyDown(event)"
                          style="min-height: 80px; line-height: 1.5; cursor: text;"
                      ></textarea>
                      
                      <!-- Send Button -->
                      <button id="analysis-send-button" class="absolute bottom-3 left-4 w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center hover:bg-gray-600 transition-colors shadow-lg" onclick="sendCustomQuestion()">
                          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V5M5 12l7-7 7 7"/>
                          </svg>
                      </button>
                      
                      <!-- Recorder Button - Left of Document -->
                      <button class="recorder-button absolute bottom-3 right-12 w-8 h-8 bg-transparent rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors" onclick="startRecording()" title="Voice Recording">
                          <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              <path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              <line x1="12" y1="19" x2="12" y2="23" stroke-width="2" stroke-linecap="round"/>
                              <line x1="8" y1="23" x2="16" y2="23" stroke-width="2" stroke-linecap="round"/>
                          </svg>
                      </button>
                      
                      <!-- Document Button - Very Right Side -->
                      <button class="document-button absolute bottom-3 right-4 w-8 h-8 bg-transparent rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors" onclick="attachDocument()" title="Attach Document">
                          <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                      </button>
                  </div>
              </div>
            
        </div>
    </main>


    <!-- Bottom Mobile Navigation - Matching Chat Page Icons -->
    <div id="bottom-navigation" class="icons-container fixed bottom-0 left-0 right-0 pt-2 pb-6 px-6 flex justify-around items-center space-x-8 z-40 rounded-t-2xl shadow-lg" style="background-color: #E8E8E4;">
        <!-- First Icon: Circle with tick inside (Test page) -->
        <button class="icon-button p-2 hover:text-gray-600 transition-colors" onclick="window.location.href='test.html'">
            <svg class="w-6 h-6 nav-icon active" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke-width="2"/>
                <path d="M9 12l2 2 4-4" stroke-width="2"/>
            </svg>
        </button>
        
        <!-- Second Icon: Open book (Library) -->
        <button class="icon-button p-2 hover:text-gray-600 transition-colors" onclick="window.location.href='library.html'">
            <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" stroke-width="2"/>
            </svg>
        </button>
        
        <!-- Third Icon: Document with pencil (Chat page) -->
        <button class="icon-button p-2 hover:text-gray-600 transition-colors" onclick="window.location.href='index.html'">
            <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke-width="2"/>
                <path d="M14 2v6h6" stroke-width="2"/>
                <path d="M16 13H8" stroke-width="2"/>
                <path d="M16 17H8" stroke-width="2"/>
                <path d="M10 9H8" stroke-width="2"/>
            </svg>
        </button>
    </div>

    <script>
        let questionData = null;
        let currentSubject = '';
        
        // Conversation history system variables
        let currentConversationId = 'analysis_' + Date.now();
        let conversationMessages = [];
        let isConversationInitialized = false;

        // Debug display function
        function showDebug(message, type = 'info') {
            console.log(`[DEBUG ${type.toUpperCase()}] ${message}`);
        }

        // Initialize conversation history system
        async function initializeConversation() {
            try {
                // Start new conversation for new analysis
                const response = await fetch('/api/chat/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                currentConversationId = data.conversationId;
                isConversationInitialized = true;
                console.log('✅ Analysis page conversation started:', currentConversationId);
            } catch (error) {
                console.error('❌ Failed to start conversation:', error);
                // Use fallback conversation ID
                currentConversationId = 'analysis_' + Date.now();
                isConversationInitialized = true;
            }
        }
        
        // Display analysis content
        function displayAnalysisContent(content) {
            const analysisContainer = document.getElementById('analysis-content');
            if (analysisContainer) {
                analysisContainer.innerHTML = content;
                console.log('📊 Analysis content displayed');
            }
        }
        
        // Display conversation history
        function displayConversationHistory() {
            console.log('📚 Current conversation history:');
            conversationMessages.forEach((msg, index) => {
                const role = msg.role || 'unknown';
                const type = msg.type || 'unknown';
                const content = msg.content || 'no content';
                console.log(`${index + 1}. [${role.toUpperCase()}] ${type}: ${content.substring(0, 100)}...`);
            });
            console.log(`📊 Total messages: ${conversationMessages.length}`);
        }
        
        // Add message to conversation history
        function addToConversationHistory(role, content, messageType = 'text') {
            const message = {
                role: role,
                content: content,
                type: messageType,
                timestamp: new Date().toISOString()
            };
            conversationMessages.push(message);
            console.log(`💬 Added message to history: ${role} - ${content.substring(0, 50)}...`);
        }
        
        // Get detailed analysis content from conversation history
        function getDetailedAnalysisFromConversation() {
            // Find the first assistant message that contains detailed analysis
            const analysisMessage = conversationMessages.find(msg => 
                msg.role === 'assistant' && 
                msg.content && 
                msg.content.length > 100 // Detailed analysis should be substantial
            );
            
            if (analysisMessage) {
                console.log('📋 Found detailed analysis from conversation history');
                return analysisMessage.content;
            }
            
            // Fallback to questionData analysis if available
            if (questionData && questionData.analysis) {
                console.log('📋 Using questionData analysis as fallback');
                return questionData.analysis;
            }
            
            console.log('⚠️ No detailed analysis found, using empty string');
            return '';
        }
        
        // Get conversation context for AI responses
        function getConversationContext() {
            return conversationMessages.map(msg => ({
                role: msg.role,
                content: msg.content
            }));
        }
        
        // Load analysis from library
        async function loadAnalysisFromLibrary(sessionId) {
            try {
                console.log('🔍 Loading analysis from library:', sessionId);
                
                const userId = localStorage.getItem('user_id') || '1';
                const response = await fetch(`/api/conversations?userId=${userId}&type=analysis`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Failed to load conversations');
                }
                
                // Find the specific analysis
                const analysis = data.conversations.find(conv => conv.sessionId === sessionId);
                
                if (!analysis) {
                    throw new Error('Analysis not found');
                }
                
                console.log('✅ Found analysis:', analysis.title);
                
                // Set question data from analysis metadata
                questionData = {
                    subject: analysis.subject || 'biology',
                    grade: analysis.grade || 'دوازدهم',
                    field: analysis.field || 'experimental',
                    chapter: analysis.chapter || '1',
                    book: analysis.book || null
                };
                currentSubject = questionData.subject;
                
                // Load conversation messages
                conversationMessages = analysis.messages || [];
                
                // Display the analysis content
                const analysisContainer = document.getElementById('analysis-content');
                if (analysisContainer) {
                    analysisContainer.innerHTML = analysis.content;
                    analysisContainer.classList.remove('hidden');
                    console.log('✅ Analysis content displayed');
                    console.log('📊 Analysis container visibility:', analysisContainer.style.display);
                    console.log('📊 Analysis container classes:', analysisContainer.className);
                    console.log('📊 Analysis content length:', analysis.content.length);
                    
                    // Force visibility
                    analysisContainer.style.display = 'block';
                    analysisContainer.style.visibility = 'visible';
                    analysisContainer.style.opacity = '1';
                }
                
                // Update page title
                document.title = `مِنو - ${analysis.title}`;
                
                console.log('✅ Analysis loaded successfully from library');
                
            } catch (error) {
                console.error('❌ Failed to load analysis from library:', error);
                // Show error message
                const analysisContainer = document.getElementById('analysis-content');
                if (analysisContainer) {
                    analysisContainer.innerHTML = `
                        <div class="text-center p-8">
                            <h2 class="text-xl font-bold text-red-600 mb-4">خطا در بارگذاری تحلیل</h2>
                            <p class="text-gray-600 mb-4">متأسفانه مشکلی در بارگذاری تحلیل پیش آمده است.</p>
                            <button onclick="window.location.href='/library.html'" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                                بازگشت به کتابخانه
                            </button>
                        </div>
                    `;
                    analysisContainer.classList.remove('hidden');
                }
            }
        }
        
                // Get URL parameters and decode data
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');
            
            console.log('🔍 getUrlParams() called');
            
            // Check if we're viewing an existing analysis from library
            const viewingSession = localStorage.getItem('viewing_session');
            const viewingType = localStorage.getItem('viewing_type');
            
            if (viewingSession && viewingType === 'analysis') {
                console.log('📚 Loading existing analysis from library:', viewingSession);
                // Clear the viewing flags
                localStorage.removeItem('viewing_session');
                localStorage.removeItem('viewing_type');
                
                // Load the actual analysis content
                loadAnalysisFromLibrary(viewingSession);
                return;
            }
            
            // Check for analysis data in localStorage first
            const analysisDataString = localStorage.getItem('analysisData');
            if (analysisDataString) {
                try {
                    // Initialize new analysis session for new analysis
                    if (!currentSessionId) {
                        initializeNewAnalysisSession();
                    }
                    
                    // Parse data from localStorage
                    questionData = JSON.parse(analysisDataString);
                    currentSubject = questionData.subject;
                    
                    console.log('✅ Question data parsed successfully from localStorage:', questionData);
                    console.log('🚀 About to call displayResults()...');
                    
                    // Clear the data from localStorage after using it
                    localStorage.removeItem('analysisData');
                    
                    displayResults();
                    return;
                } catch (error) {
                    console.error('Error parsing data from localStorage:', error);
                    localStorage.removeItem('analysisData');
                }
            }
            
            console.log('📊 No localStorage data, checking URL...');
            
            // Check if we're viewing a conversation from library
            const viewingConversation = localStorage.getItem('viewing_conversation');
            if (viewingConversation) {
                try {
                    const conversation = JSON.parse(viewingConversation);
                    localStorage.removeItem('viewing_conversation');
                    
                    // Display the conversation from library
                    loadAnalysisFromLibrary(conversation);
                    return;
                } catch (error) {
                    console.error('Error parsing library conversation:', error);
                    localStorage.removeItem('viewing_conversation');
                }
            }
            
            if (dataParam) {
                try {
                    // Initialize new analysis session for new analysis
                    if (!currentSessionId) {
                        initializeNewAnalysisSession();
                    }
                    
                    // Decode base64 data with proper UTF-8 handling
                    const decodedData = decodeURIComponent(Array.prototype.map.call(atob(dataParam), (c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                    questionData = JSON.parse(decodedData);
                    currentSubject = questionData.subject;
                    console.log('✅ Question data parsed successfully:', questionData);
                    console.log('🚀 About to call displayResults()...');
                    displayResults();
                } catch (error) {
                    console.error('Error parsing data:', error);
                    console.error('Raw data param:', dataParam);
                    
                    // Try to show a fallback message
                    try {
                        const container = document.getElementById('result-container');
                        container.innerHTML = `
                            <div class="text-center p-8">
                                <h2 class="text-xl font-bold text-red-600 mb-4">خطا در بارگذاری اطلاعات</h2>
                                <p class="text-gray-600 mb-4">متأسفانه مشکلی در بارگذاری اطلاعات سوال پیش آمده است.</p>
                                <button onclick="goBack()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                                    بازگشت
                                </button>
                            </div>
                        `;
                    } catch (fallbackError) {
                    alert('خطا در بارگذاری اطلاعات سوال');
                        goBack();
                    }
                }
            } else {
                console.log('⚠️ No question data found in URL');
                // Check if we're loading from library (has viewing_session)
                const viewingSession = localStorage.getItem('viewing_session');
                if (viewingSession) {
                    console.log('📚 Loading from library, not redirecting');
                    showDebug('📚 Loading from library, not redirecting', 'info');
                    return; // Don't redirect, let the analysis loading handle it
                } else {
                alert('اطلاعات سوال یافت نشد');
                goBack();
                }
            }
        }

        // Load analysis from library
        async function loadAnalysisFromLibrary(sessionId) {
            try {
                console.log('🔍 Loading analysis from library:', sessionId);
                
                const userId = localStorage.getItem('user_id') || '1';
                const response = await fetch(`/api/conversations?userId=${userId}&type=analysis`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Failed to load conversations');
                }
                
                // Find the specific analysis
                const analysis = data.conversations.find(conv => conv.sessionId === sessionId);
                
                if (!analysis) {
                    throw new Error('Analysis not found');
                }
                
                console.log('✅ Found analysis:', analysis.title);
                
                // Set question data from analysis metadata
                questionData = {
                    subject: analysis.subject || 'biology',
                    grade: analysis.grade || 'دوازدهم',
                    field: analysis.field || 'experimental',
                    chapter: analysis.chapter || '1',
                    book: analysis.book || null
                };
                currentSubject = questionData.subject;
                
                // Load conversation messages
                conversationMessages = analysis.messages || [];
                
                // Display the analysis content
                const analysisContainer = document.getElementById('analysis-content');
                if (analysisContainer) {
                    analysisContainer.innerHTML = analysis.content;
                    analysisContainer.classList.remove('hidden');
                    console.log('✅ Analysis content displayed');
                    console.log('📊 Analysis container visibility:', analysisContainer.style.display);
                    console.log('📊 Analysis container classes:', analysisContainer.className);
                    console.log('📊 Analysis content length:', analysis.content.length);
                    
                    // Force visibility
                    analysisContainer.style.display = 'block';
                    analysisContainer.style.visibility = 'visible';
                    analysisContainer.style.opacity = '1';
                }
                
                // Update page title
                document.title = `مِنو - ${analysis.title}`;
                
                console.log('✅ Analysis loaded successfully from library');
                
            } catch (error) {
                console.error('❌ Failed to load analysis from library:', error);
                // Show error message
                const analysisContainer = document.getElementById('analysis-content');
                if (analysisContainer) {
                    analysisContainer.innerHTML = `
                        <div class="text-center p-8">
                            <h2 class="text-xl font-bold text-red-600 mb-4">خطا در بارگذاری تحلیل</h2>
                            <p class="text-gray-600 mb-4">متأسفانه مشکلی در بارگذاری تحلیل پیش آمده است.</p>
                            <button onclick="window.location.href='/library.html'" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                                بازگشت به کتابخانه
                            </button>
                        </div>
                    `;
                    analysisContainer.classList.remove('hidden');
                }
            }
        }

        // Load existing analysis session from database
        async function loadAnalysisSession(sessionId) {
            try {
                // Get user ID from localStorage
                const userId = localStorage.getItem('user_id');
                if (!userId) {
                    console.log('⚠️ No user logged in, cannot load analysis session');
                    return false;
                }
                
                const response = await fetch(`/api/conversations/session/${sessionId}?user_id=${userId}`);
                const data = await response.json();
                
                if (data.success && data.conversation) {
                    currentSessionId = sessionId;
                    
                    // Parse analysis history
                    if (data.conversation.messages) {
                        if (typeof data.conversation.messages === 'string') {
                            try {
                                analysisHistory = JSON.parse(data.conversation.messages);
                            } catch (e) {
                                console.error('Error parsing analysis messages JSON:', e);
                                analysisHistory = [];
                            }
                        } else {
                            analysisHistory = data.conversation.messages;
                        }
                    } else if (data.conversation.content) {
                        // Old format: parse from content field
                        analysisHistory = parseAnalysisContentToHistory(data.conversation.content);
                    } else {
                        analysisHistory = [];
                    }
                    
                    sessionStartTime = data.conversation.created_at;
                    
                    console.log('📚 Parsed analysis history:', analysisHistory);
                    
                    // Load analysis context into UI
                    loadAnalysisContext(data.conversation);
                    console.log('📚 Analysis session loaded:', sessionId);
                    return true;
                } else {
                    console.error('❌ Failed to load analysis session:', data.error);
                    return false;
                }
            } catch (error) {
                console.error('❌ Error loading analysis session:', error);
                return false;
            }
        }

        // Load old format analysis conversation
        async function loadOldFormatAnalysis(conversation) {
            try {
                console.log('📚 Loading old format analysis:', conversation);
                
                // Set current session to the conversation ID for compatibility
                currentSessionId = conversation.id.toString();
                
                // Parse analysis from content field
                if (conversation.content) {
                    analysisHistory = parseAnalysisContentToHistory(conversation.content);
                } else {
                    analysisHistory = [];
                }
                
                sessionStartTime = conversation.created_at;
                
                console.log('📚 Parsed analysis history from old format:', analysisHistory);
                
                // Load analysis context into UI
                loadAnalysisContext(conversation);
                console.log('📚 Old format analysis loaded:', conversation.id);
                
            } catch (error) {
                console.error('❌ Error loading old format analysis:', error);
            }
        }

        // Parse old analysis content to history format
        function parseAnalysisContentToHistory(content) {
            const history = [];
            const lines = content.split('\n');
            
            let question = '';
            let userAnswer = '';
            let analysis = '';
            let currentSection = '';
            
            for (const line of lines) {
                if (line.startsWith('سوال:')) {
                    currentSection = 'question';
                    question = line.replace('سوال:', '').trim();
                } else if (line.startsWith('پاسخ کاربر:')) {
                    currentSection = 'userAnswer';
                    userAnswer = line.replace('پاسخ کاربر:', '').trim();
                } else if (line.startsWith('تحلیل تفصیلی:')) {
                    currentSection = 'analysis';
                    analysis = line.replace('تحلیل تفصیلی:', '').trim();
                } else if (currentSection === 'question' && question) {
                    question += '\n' + line;
                } else if (currentSection === 'userAnswer' && userAnswer) {
                    userAnswer += '\n' + line;
                } else if (currentSection === 'analysis' && analysis) {
                    analysis += '\n' + line;
                }
            }
            
            if (question && userAnswer && analysis) {
                history.push({
                    type: 'question',
                    question: question,
                    userAnswer: userAnswer,
                    content: analysis,
                    timestamp: new Date().toISOString()
                });
            }
            
            return history;
        }

        // Load analysis context into UI
        function loadAnalysisContext(conversation) {
            console.log('📚 Loading analysis context:', conversation);
            console.log('📚 Analysis history:', analysisHistory);
            
            // Show FAB button when loading from library so user can ask follow-ups
            showFloatingActionButton();
            
            // Show the results container
            const loadingContainer = document.getElementById('loading-container');
            const resultsContainer = document.getElementById('results-container');
            
            if (loadingContainer) {
                loadingContainer.classList.add('hidden');
            }
            if (resultsContainer) {
                resultsContainer.classList.remove('hidden');
            }
            
            // Load the analysis from history
            if (analysisHistory && analysisHistory.length > 0) {
                const latestAnalysis = analysisHistory[analysisHistory.length - 1];
                
                // Set question data from the latest analysis
                questionData = {
                    question: latestAnalysis.question,
                    userAnswer: latestAnalysis.userAnswer,
                    correctAnswer: latestAnalysis.correctAnswer || 'غیر مشخص',
                    subject: latestAnalysis.subject || conversation.subject,
                    grade: latestAnalysis.grade || conversation.grade,
                    field: latestAnalysis.field || conversation.field,
                    chapter: latestAnalysis.chapter || conversation.chapter,
                    book: latestAnalysis.book || conversation.book
                };
                
                // Clear existing conversation messages and populate with analysis context
                clearConversationHistory();
                
                // Add the original question and user answer to conversation context
                addToConversationHistory('user', `سوال: ${latestAnalysis.question}\nپاسخ من: ${latestAnalysis.userAnswer}`, 'question_submission');
                
                // Add the detailed analysis to conversation context
                addToConversationHistory('assistant', latestAnalysis.content, 'detailed_analysis');
                
                console.log('📚 Loaded analysis context into conversation history');
                console.log('📊 Conversation context messages:', conversationMessages.length);
                console.log('📋 Detailed analysis content length:', latestAnalysis.content.length);
                
                // Display the question result section first
                const resultDisplay = document.getElementById('result-display');
                if (resultDisplay) {
                    resultDisplay.innerHTML = `
                        <div class="text-center p-6 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg border border-blue-200 shadow-sm">
                            <h2 class="text-2xl font-bold text-gray-900 mb-4">نتیجه سوال</h2>
                            <div class="bg-white rounded-lg p-4 mb-4 shadow-sm">
                                <p class="text-lg text-gray-700 mb-2"><strong>سوال:</strong> ${latestAnalysis.question}</p>
                                <p class="text-lg text-gray-700"><strong>پاسخ شما:</strong> ${latestAnalysis.userAnswer}</p>
                            </div>
                            <button id="analysis-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-lg font-medium text-lg transition-colors shadow-md" onclick="showDetailedAnalysis()">
                                تحلیل سوال
                            </button>
                        </div>
                    `;
                }
                
                // Automatically show the detailed analysis section (main page state)
                const analysisSection = document.getElementById('detailed-analysis-section');
                if (analysisSection) {
                    analysisSection.classList.remove('hidden');
                    analysisSection.classList.add('show');
                }
                
                // Display the detailed analysis content in the main analysis container
                const analysisContent = document.getElementById('analysis-content');
                if (analysisContent) {
                    analysisContent.innerHTML = `
                        <div class="study-mode-content">
                            ${formatChatContent(latestAnalysis.content)}
                        </div>
                    `;
                }
                
                // Collapse the result container to focus on analysis
                const resultContainer = document.getElementById('result-container');
                if (resultContainer) {
                    resultContainer.classList.add('collapsed');
                }
                
                // Make sure the analysis section is fully visible only if user is not interacting
                setTimeout(() => {
                    if (!isUserInteracting) {
                    const analysisSection = document.getElementById('detailed-analysis-section');
                    if (analysisSection) {
                        analysisSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    } else {
                        console.log('🚫 Skipping analysis section scroll - user is interacting with input');
                    }
                }, 500);
                
            } else {
                console.log('📚 No analysis history to display');
            }
        }

        // Display conversation from library
        function displayLibraryConversation(conversation) {
            console.log('📚 Displaying library conversation:', conversation);
            
            // Parse the conversation content
            const content = conversation.content;
            const lines = content.split('\n');
            
            let question = '';
            let userAnswer = '';
            let analysis = '';
            let currentSection = '';
            
            for (const line of lines) {
                if (line.startsWith('سوال:')) {
                    currentSection = 'question';
                    question = line.replace('سوال:', '').trim();
                } else if (line.startsWith('پاسخ کاربر:')) {
                    currentSection = 'userAnswer';
                    userAnswer = line.replace('پاسخ کاربر:', '').trim();
                } else if (line.startsWith('تحلیل تفصیلی:')) {
                    currentSection = 'analysis';
                    analysis = line.replace('تحلیل تفصیلی:', '').trim();
                } else if (currentSection === 'question' && question) {
                    question += '\n' + line;
                } else if (currentSection === 'userAnswer' && userAnswer) {
                    userAnswer += '\n' + line;
                } else if (currentSection === 'analysis' && analysis) {
                    analysis += '\n' + line;
                }
            }
            
            // Create mock questionData for display
            questionData = {
                question: question,
                userAnswer: userAnswer,
                subject: conversation.subject,
                grade: conversation.grade,
                field: conversation.field,
                chapter: conversation.chapter,
                book: conversation.book
            };
            
            // Show the results container
            document.getElementById('loading-container').classList.add('hidden');
            document.getElementById('results-container').classList.remove('hidden');
            
            // Display the analysis
            const analysisContainer = document.getElementById('detailed-analysis-container');
            if (analysisContainer) {
                analysisContainer.innerHTML = `
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">تحلیل تفصیلی</h3>
                        <div class="study-mode-content">
                            ${formatChatContent(analysis)}
                        </div>
                    </div>
                `;
            }
            
            // Display question and answer
            const resultDisplay = document.getElementById('result-display');
            if (resultDisplay) {
                resultDisplay.innerHTML = `
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">سوال</h3>
                        <p class="text-gray-700 mb-4">${question}</p>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">پاسخ شما</h3>
                        <p class="text-gray-700">${userAnswer}</p>
                    </div>
                `;
            }
            
            // Add a "Continue with new question" button
            const continueButton = document.createElement('div');
            continueButton.className = 'flex justify-center mt-6 mb-8';
            continueButton.innerHTML = `
                <button onclick="window.location.href='chapters.html'" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                    سوال جدید بپرسید
                </button>
            `;
            
            const resultsContainer = document.getElementById('results-container');
            if (resultsContainer) {
                resultsContainer.appendChild(continueButton);
            }
        }

        // Display the results
        async function displayResults() {
            if (!questionData) return;

            console.log('🚀 displayResults() called with questionData:', questionData);

            // Apply subject-specific styling
            const container = document.getElementById('result-container');
            if (currentSubject === 'biology') {
                container.classList.add('biology');
            } else {
                container.classList.remove('biology');
            }
            
            console.log('🚀 displayResults() called, about to show loading state...');
            
            // Show loading state
            showQuestionLoading();
            
            console.log('⏳ Loading state shown, starting AI evaluation...');
            
            // Get AI evaluation of the answer with timeout
            try {
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('AI evaluation timed out')), 15000); // 15 second timeout
                });
                
                await Promise.race([
                    getAIResultEvaluation(),
                    timeoutPromise
                ]);
            } catch (error) {
                console.error('❌ AI evaluation failed or timed out:', error);
                console.log('🔄 Falling back to static result display...');
                // Fallback to static display
                showStaticResult();
            }
        }
        
        // Get AI evaluation of the question result
        async function getAIResultEvaluation() {
            try {
                const evaluationData = {
                    question: questionData.question,
                    options: questionData.options,
                    userAnswer: questionData.userAnswer,
                    subject: questionData.subject,
                    grade: questionData.grade,
                    chapter: questionData.chapter
                };
                
                console.log('🚀 Starting AI evaluation for:', questionData.question);
                console.log('📊 User answer:', questionData.userAnswer, 'Correct answer:', questionData.correctAnswer);
                
                // First check if backend is accessible
                try {
                    const testResponse = await fetch('/api/chat/result-evaluation', { method: 'HEAD' });
                    console.log('🔍 Backend accessibility test:', testResponse.status);
                } catch (testError) {
                    console.log('⚠️ Backend might not be running or accessible');
                }
                
                const response = await fetch('/api/chat/result-evaluation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(evaluationData)
                });
                
                console.log('📡 Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`خطا در ارتباط با سرور: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('✅ AI evaluation successful:', result);
                displayAIResult(result.content);
                
            } catch (error) {
                console.error('❌ AI evaluation failed:', error);
                throw error;
            }
        }
        
        // Show loading state for question results
        function showQuestionLoading() {
            console.log('🔄 Showing question loading state...');
            const questionLoading = document.getElementById('question-loading');
            const questionResults = document.getElementById('question-results');
            
            console.log('🔍 Elements found:', {
                questionLoading: questionLoading,
                questionResults: questionResults
            });
            
            // Check if elements exist
            if (!questionLoading || !questionResults) {
                console.error('❌ Loading state elements not found');
                return;
            }
            
            // Hide results content and show loading
            questionResults.classList.add('hidden');
            questionLoading.classList.remove('hidden');
            
            console.log('✅ Question loading state shown successfully');
            console.log('👁️ Loading element classes:', questionLoading.className);
            console.log('👁️ Results element classes:', questionResults.className);
        }
        
        // Simple content formatting - standard with bullet points only
        function formatChatContent(content) {
            if (!content || typeof content !== 'string') {
                return '<p>متأسفانه محتوایی برای نمایش وجود ندارد.</p>';
            }
            
            let formatted = content;
            
            // Remove markdown symbols
            formatted = formatted.replace(/#+\s*/g, ''); // Remove headers
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '$1'); // Remove bold
            formatted = formatted.replace(/\*(.*?)\*/g, '$1'); // Remove italic
            formatted = formatted.replace(/`(.*?)`/g, '$1'); // Remove code blocks
            
            // Split into lines and process
            const lines = formatted.split('\n');
            let result = [];
            let currentList = [];
            let inList = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                
                if (!trimmedLine) {
                    // Empty line - end current list if exists
                    if (inList && currentList.length > 0) {
                        result.push(`<ul class="study-list">${currentList.join('')}</ul>`);
                        inList = false;
                        currentList = [];
                    }
                    continue;
                }
                
                // Check if this line should be a bullet point (only • and -)
                const isBulletPoint = /^[•-]\s*(.+)$/.test(trimmedLine);
                
                if (isBulletPoint) {
                    if (!inList) {
                        inList = true;
                        currentList = [];
                    }
                    
                    // Clean the content (remove bullet markers)
                    let cleanContent = trimmedLine.replace(/^[•-]\s*/, '');
                    currentList.push(`<li class="study-list-item">${cleanContent}</li>`);
                } else {
                    // End current list if exists
                    if (inList && currentList.length > 0) {
                        result.push(`<ul class="study-list">${currentList.join('')}</ul>`);
                        inList = false;
                        currentList = [];
                    }
                    
                    // Add as paragraph
                    result.push(`<p class="study-paragraph">${trimmedLine}</p>`);
                }
            }
            
            // Handle any remaining list
            if (inList && currentList.length > 0) {
                result.push(`<ul class="study-list">${currentList.join('')}</ul>`);
            }
            
            formatted = result.join('');
            
            // Wrap in simple structure
            formatted = `<div dir="rtl" class="study-mode-content">${formatted}</div>`;
            
            return formatted;
        }
        
        // Simple function to process MathJax
        function processMathJax(element) {
            if (window.MathJax) {
                MathJax.typesetPromise([element]);
            }
        }
        
        // Display AI-generated result
        function displayAIResult(content) {
            console.log('🎯 Displaying AI result...');
            console.log('📝 AI content received:', content.substring(0, 100) + '...');
            
            const questionLoading = document.getElementById('question-loading');
            const questionResults = document.getElementById('question-results');
            
            console.log('🔍 Elements found for AI result:', {
                questionLoading: questionLoading,
                questionResults: questionResults
            });
            
            // Check if elements exist
            if (!questionLoading || !questionResults) {
                console.error('❌ Result display elements not found');
                return;
            }
            
            // Add a small delay to make loading state more visible
            setTimeout(() => {
                // Hide loading and show results
                questionLoading.classList.add('hidden');
                questionResults.classList.remove('hidden');
                console.log('✅ Loading hidden, AI results shown');
                
                // Parse the AI response to determine if answer is correct (original simple logic)
                const isCorrect = content.includes('صحیح') || content.includes('درست');
                const colorClass = isCorrect ? 'green' : 'red';
                
                // Update the main result container border/background based on correctness
                const resultContainer = document.getElementById('result-container');
                if (resultContainer) {
                    // Add dynamic border and glow effect
                    if (isCorrect) {
                        resultContainer.style.border = '4px solid #10B981'; // Green border
                        resultContainer.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.3)'; // Green glow
                    } else {
                        resultContainer.style.border = '4px solid #EF4444'; // Red border
                        resultContainer.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.3)'; // Red glow
                    }
                }
                
                // Extract correct answer from AI response (for detailed analysis)
                let correctAnswer = null;
                const correctAnswerPatterns = [
                    /پاسخ صحیح:\s*([ABCD])/i,
                    /گزینه صحیح:\s*([ABCD])/i,
                    /پاسخ درست:\s*([ABCD])/i,
                    /صحیح:\s*([ABCD])/i,
                    /درست:\s*([ABCD])/i
                ];
                
                for (const pattern of correctAnswerPatterns) {
                    const match = content.match(pattern);
                    if (match) {
                        correctAnswer = match[1].toUpperCase();
                        questionData.correctAnswer = correctAnswer;
                        console.log('✅ Correct answer extracted from AI response:', correctAnswer);
                        break;
                    }
                }
                
                // If still no correct answer found, set a fallback to enable detailed analysis
                if (!questionData.correctAnswer) {
                    questionData.correctAnswer = 'A'; // Fallback to enable detailed analysis
                    console.log('🔄 Set fallback correct answer for detailed analysis');
                }
                
                // Convert numbered lists to bullet points and format content using study-mode
                const aiFormattedContent = formatChatContent(content);
                
                questionResults.innerHTML = `
                    <div class="bg-${colorClass}-50 rounded-xl p-6 border border-${colorClass}-200 mb-6">
                        <div class="flex items-center justify-center space-x-4 space-x-reverse">
                            <div class="w-12 h-12 bg-${colorClass}-100 rounded-full flex items-center justify-center">
                                <svg class="w-7 h-7 text-${colorClass}-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    ${isCorrect ? 
                                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' :
                                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'
                                    }
                                </svg>
                            </div>
                            <div class="text-center">
                                <div class="analysis-content text-xl font-semibold text-black">
                                    ${aiFormattedContent}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }, 1000); // Show loading for at least 1 second
        }
        
        // Fallback to static result display
        function showStaticResult() {
            console.log('🔄 Showing static result...');
            const questionLoading = document.getElementById('question-loading');
            const questionResults = document.getElementById('question-results');
            
            // Check if elements exist
            if (!questionLoading || !questionResults) {
                console.error('❌ Static result display elements not found');
                return;
            }
            
            // Hide loading and show results
            questionLoading.classList.add('hidden');
            questionResults.classList.remove('hidden');
            console.log('✅ Loading hidden, static results shown');
            
            const isCorrect = questionData.userAnswer === questionData.correctAnswer;
            const colorClass = isCorrect ? 'green' : 'red';
            
            // Update the main result container border/background based on correctness
            const resultContainer = document.getElementById('result-container');
            if (resultContainer) {
                // Add dynamic border and glow effect
                if (isCorrect) {
                    resultContainer.style.border = '4px solid #10B981'; // Green border
                    resultContainer.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.3)'; // Green glow
                } else {
                    resultContainer.style.border = '4px solid #EF4444'; // Red border
                    resultContainer.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.3)'; // Red glow
                }
            }
            
            questionResults.innerHTML = `
                <div class="bg-${colorClass}-50 rounded-xl p-6 border border-${colorClass}-200 mb-6">
                    <div class="flex items-center justify-center space-x-4 space-x-reverse">
                        <div class="w-12 h-12 bg-${colorClass}-100 rounded-full flex items-center justify-center">
                            <svg class="w-7 h-7 text-${colorClass}-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                ${isCorrect ? 
                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' :
                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'
                                }
                            </svg>
                        </div>
                        <div class="text-center">
                            <p class="text-xl font-bold text-${colorClass}-800">
                                ${isCorrect ? 'پاسخ صحیح!' : 'پاسخ نادرست'}
                            </p>
                            <p class="text-lg text-${colorClass}-600">
                                پاسخ صحیح: ${questionData.correctAnswer}) ${getChoiceText(questionData.correctAnswer)}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Get choice text
        function getChoiceText(choice) {
            if (!questionData) return '';
            
            const choiceIndex = choice.charCodeAt(0) - 65; // Convert A=0, B=1, etc.
            const option = questionData.options[choiceIndex];
            return option.substring(option.indexOf('.') + 1).trim();
        }
        


                 // Request analysis from LLM API
         async function requestAnalysis() {
             console.log('Analysis button clicked!'); // Debug log
             
             // First, collapse the results section with smooth animation
             const resultContainer = document.getElementById('result-container');
             resultContainer.classList.add('collapsed');
             
                           // Arrow button removed - no need to update
            
                         // Wait for collapse animation to complete, then prepare detailed analysis
             setTimeout(() => {
                 // Show the detailed analysis section
                 const detailedAnalysisSection = document.getElementById('detailed-analysis-section');
                 console.log('Detailed analysis section element:', detailedAnalysisSection); // Debug log
                 
                 if (detailedAnalysisSection) {
                     // Show the analysis section
                     detailedAnalysisSection.classList.remove('hidden');
                     detailedAnalysisSection.style.display = 'block';
                     
                     // Enable/disable analysis button based on correctAnswer availability
                     const analysisBtn = document.getElementById('analysis-btn');
                     if (analysisBtn) {
                         if (questionData.correctAnswer) {
                             analysisBtn.disabled = false;
                             analysisBtn.textContent = 'تحلیل سوال';
                             analysisBtn.className = 'bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 px-6 rounded-full transition-all transform hover:scale-105 shadow-lg';
                         } else {
                             analysisBtn.disabled = true;
                             analysisBtn.textContent = 'پاسخ صحیح یافت نشد';
                             analysisBtn.className = 'bg-gray-400 text-white font-bold py-3 px-6 rounded-full cursor-not-allowed';
                         }
                     }
                 }
                
                                 // Prepare analysis content area with loading state immediately
                 const analysisContent = document.getElementById('analysis-content');
                 const analysisError = document.getElementById('analysis-error');
                 
                 if (analysisContent) {
                     // Ensure ai-help-questions div exists
                     let helpQuestionsDiv = document.getElementById('ai-help-questions');
                     if (!helpQuestionsDiv) {
                         helpQuestionsDiv = document.createElement('div');
                         helpQuestionsDiv.id = 'ai-help-questions';
                         analysisContent.appendChild(helpQuestionsDiv);
                     }
                 }
                 
                 if (analysisError) {
                     analysisError.classList.add('hidden');
                 }
            
                         // Show loading state immediately
             const streamingContent = document.getElementById('streaming-content');
                           streamingContent.innerHTML = `
                  <div class="analysis-content text-xl">
                                              <!-- Loading state as first line -->
                         <div class="flex items-center justify-center space-x-3 space-x-reverse mb-6">
                             <div class="relative">
                                 <!-- Graduation Cap Logo -->
                                 <div class="w-10 h-10 bg-gradient-to-br from-blue-500 via-blue-600 to-blue-700 rounded-xl shadow-lg flex items-center justify-center">
                                     <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"></path>
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"></path>
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"></path>
                                     </svg>
                                 </div>
                                 <!-- Spinning Ring -->
                                 <div class="absolute inset-0 animate-spin rounded-xl border-2 border-transparent border-t-blue-400 border-r-blue-300"></div>
                             </div>
                             <span class="text-gray-600 text-lg">در حال فکر کردن...</span>
                         </div>
                     <div id="streaming-text"></div>
                 </div>
             `;
            
                // FAB button will be shown only when helper questions are sent
                // hideFloatingActionButton(); // Keep hidden until helper questions are used
                
                // Start the API request after showing the analysis section
                startAnalysisRequest();
            }, 500); // Wait for collapse animation to complete
        }
        
        // Separate function to start the actual analysis request
        async function startAnalysisRequest() {
            // Disable analysis button
            document.getElementById('analysis-btn').disabled = true;
            document.getElementById('analysis-btn').textContent = 'در حال تحلیل...';
            
            try {
                // Check if correctAnswer is available
                if (!questionData.correctAnswer) {
                    console.error('❌ correctAnswer is missing from questionData:', questionData);
                    throw new Error('پاسخ صحیح یافت نشد. لطفاً ابتدا پاسخ خود را ارسال کنید.');
                }
                
                // Prepare the analysis request
                const analysisData = {
                    question: questionData.question,
                    options: questionData.options,
                    correctAnswer: questionData.correctAnswer,
                    userAnswer: questionData.userAnswer,
                    subject: questionData.subject,
                    grade: questionData.grade,
                    field: questionData.field || 'experimental',
                    chapter: questionData.chapter,
                    book: questionData.book || 'IQ گاج'
                };
                
                console.log('🚀 Sending analysis request:', analysisData);
                
                // Call the streaming LLM API
                const response = await fetch('/api/chat/analysis/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(analysisData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Server response error:', response.status, errorText);
                    throw new Error(`خطا در ارتباط با سرور: ${response.status} - ${errorText}`);
                }
                
                // Stream the analysis with typewriter effect
                await streamAnalysisResponse(response);
                
            } catch (error) {
                console.error('❌ Analysis error:', error);
                
                // Show detailed error message
                const errorElement = document.getElementById('analysis-error');
                if (errorElement) {
                    errorElement.classList.remove('hidden');
                    errorElement.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-red-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                </svg>
                                <span class="text-red-800 font-medium">خطا در تحلیل سوال</span>
                            </div>
                            <p class="text-red-700 mt-2">${error.message}</p>
                            <button onclick="startAnalysisRequest()" class="mt-3 bg-red-100 text-red-800 px-4 py-2 rounded-lg hover:bg-red-200 transition-colors">
                                تلاش مجدد
                            </button>
                        </div>
                    `;
                }
            } finally {
                // Re-enable analysis button
                const analysisBtn = document.getElementById('analysis-btn');
                if (analysisBtn) {
                    analysisBtn.disabled = false;
                    analysisBtn.textContent = 'تحلیل سوال';
                }
            }
        }
        
                 // Function to toggle results section between collapsed and expanded
         function toggleResults() {
             console.log('Toggle button clicked!'); // Debug log
             
             const resultContainer = document.getElementById('result-container');
             const isCollapsed = resultContainer.classList.contains('collapsed');
             
                           if (isCollapsed) {
                  // Expand results section
                  resultContainer.classList.remove('collapsed');
                  console.log('Results expanded');
              } else {
                  // Collapse results section
                  resultContainer.classList.add('collapsed');
                  console.log('Results collapsed');
              }
         }
         
                   // Arrow button function removed - no longer needed

        // Analysis function for detailed question breakdown
        
        // Toggle function removed for simplicity

                // Stream analysis response with typewriter effect
        async function streamAnalysisResponse(response) {
            const streamingContent = document.getElementById('streaming-content');
            const loadingDiv = streamingContent.querySelector('.flex.items-center.justify-center');
            const streamingText = document.getElementById('streaming-text');
            let fullResponse = '';
            
            // Hide loading state and show streaming content
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }
            
            try {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            
                            if (data === '[DONE]') {
                                // Final formatting after streaming is complete
                                formatFinalAnalysis(streamingText.innerHTML);
                                return;
                            }
                            
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.content && parsed.type === 'chunk') {
                                    fullResponse += parsed.content;
                                    
                                    // Process and display the content
                                    const formattedContent = formatStreamingContent(fullResponse);
                                    streamingText.innerHTML = formattedContent;
                                    
                                    // Auto-scroll to bottom
                                    streamingText.scrollTop = streamingText.scrollHeight;
                                }
                            } catch (e) {
                                // Ignore parsing errors for incomplete chunks
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Streaming error:', error);
                throw error;
            }
        }
        
                                   // Format streaming content in real-time - SIMPLE BASIC
          function formatStreamingContent(content) {
            // Use the same basic formatting as final display
            return formatChatContent(content);
          }
          
                     // Function to clean content by removing JSON helper questions
         function cleanContentFromHelpQuestions(content) {
             if (!content) return content;
             
             // Remove JSON helper questions block from main content
             try {
                 const jsonMatch = content.match(/\{[\s\S]*"helper_questions"[\s\S]*\}/);
                 if (jsonMatch) {
                     console.log('✅ Removing JSON helper questions block from main content');
                     return content.replace(jsonMatch[0], '').trim();
                 }
             } catch (error) {
                 console.log('❌ Error removing JSON helper questions');
             }
             
             return content;
         }
        
                                     // Final formatting after streaming is complete
        async function formatFinalAnalysis(content) {
               const contentDiv = document.getElementById('analysis-content');
               if (contentDiv) {
                    // Extract questions first
                    const questions = extractRelatedQuestions(content);
                    
                    // Remove original questions from main content to avoid duplication
                    let cleanedContent = content;
                    if (questions && questions.length > 0) {
                        console.log('🔍 Removing questions from main content:', questions);
                        
                        questions.forEach(question => {
                            console.log('🔍 Removing question:', question);
                            
                            // Remove various patterns of the question
                            const patterns = [
                                // Dash patterns
                                new RegExp(`-\\s*${question.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}`, 'gi'),
                                // Bullet patterns
                                new RegExp(`•\\s*${question.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}`, 'gi'),
                                // HTML patterns
                                new RegExp(`<br>\\s*-\\s*${question.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}`, 'gi'),
                                new RegExp(`<br>\\s*•\\s*${question.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}`, 'gi'),
                                // Line break patterns
                                new RegExp(`\\n\\s*-\\s*${question.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}`, 'gi'),
                                new RegExp(`\\n\\s*•\\s*${question.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}`, 'gi'),
                                // Just the question text (fallback)
                                new RegExp(`${question.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}`, 'gi')
                            ];
                            
                            patterns.forEach(pattern => {
                                const beforeLength = cleanedContent.length;
                                cleanedContent = cleanedContent.replace(pattern, '');
                                if (cleanedContent.length !== beforeLength) {
                                    console.log('✅ Removed question with pattern:', pattern);
                                }
                            });
                        });
                        
                        // Clean up any remaining empty lines and extra spaces
                        cleanedContent = cleanedContent.replace(/\n\s*\n/g, '\n');
                        cleanedContent = cleanedContent.replace(/<br>\s*<br>/g, '<br>');
                        cleanedContent = cleanedContent.replace(/\s+/g, ' ');
                        cleanedContent = cleanedContent.trim();
                        
                        console.log('🔍 Content length before:', content.length, 'after:', cleanedContent.length);
                    }
                    
                   // Format and display the cleaned content (questions already removed)
                   const formattedContent = formatChatContent(cleanedContent);
                   contentDiv.innerHTML = formattedContent;
                   
                   // Process MathJax for math equations
                   setTimeout(() => { processMathJax(contentDiv); }, 100);
                   
                   // Add detailed analysis to conversation history
                   addToConversationHistory('assistant', content, 'detailed_analysis');
                   
                   // Ensure ai-help-questions div exists before rendering helper questions
                   let helpQuestionsDiv = document.getElementById('ai-help-questions');
                   if (!helpQuestionsDiv) {
                       console.log('🔧 Creating ai-help-questions div in formatFinalAnalysis...');
                       helpQuestionsDiv = document.createElement('div');
                       helpQuestionsDiv.id = 'ai-help-questions';
                       contentDiv.appendChild(helpQuestionsDiv);
                   }
                   
                   // Render helper questions using the already extracted questions
                   if (questions && questions.length > 0) {
                       renderQuestionsUI(questions);
                   }
                   
                   // Show the detailed analysis container
                   contentDiv.classList.remove('hidden');
                    
                    // FAB button will be shown when detailed analysis is completed
                    showFloatingActionButton();
               } else {
                   console.error('analysis-content element not found in formatFinalAnalysis');
               }
           }
         
        // Global variables for session management
        let currentSessionId = null;
        let analysisHistory = [];
        let sessionStartTime = null;
        let isUserInteracting = false; // Flag to prevent auto-scrolling during user interaction

        // Generate unique session ID
        function generateAnalysisSessionId() {
            return `analysis_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        // Initialize a new analysis session
        function initializeNewAnalysisSession() {
            currentSessionId = generateAnalysisSessionId();
            analysisHistory = [];
            sessionStartTime = new Date().toISOString();
            console.log('🆕 New analysis session started:', currentSessionId);
        }

        // Save or update complete conversation to database
        async function saveCompleteConversationToDatabase() {
            try {
                // Get user ID from localStorage
                const userId = localStorage.getItem('user_id');

                // If no user is logged in, don't save
                if (!userId) {
                    console.log('⚠️ No user logged in, skipping save');
                    return;
                }

                // Create complete conversation history with proper message format
                const completeHistory = [];
                
                // Add the original question and user answer as first messages
                if (questionData?.question && questionData?.userAnswer) {
                    completeHistory.push({
                        type: 'user',
                        content: `سوال: ${questionData.question}\nپاسخ من: ${questionData.userAnswer}`,
                        timestamp: sessionStartTime || new Date().toISOString()
                    });
                }
                
                // Add detailed analysis
                analysisHistory.forEach(analysis => {
                    completeHistory.push({
                        type: 'ai',
                        content: analysis.content,
                        timestamp: analysis.timestamp
                    });
                });
                
                // Add all conversation messages (helper questions and custom questions)
                conversationMessages.forEach(msg => {
                    completeHistory.push({
                        type: msg.role === 'user' ? 'user' : 'ai',
                        content: msg.content,
                        timestamp: msg.timestamp
                    });
                });

                // Create content field for library display (readable summary)
                let contentSummary = '';
                if (questionData?.question && questionData?.userAnswer) {
                    contentSummary += `سوال: ${questionData.question}\n\n`;
                    contentSummary += `پاسخ کاربر: ${questionData.userAnswer}\n\n`;
                }
                
                // Add analysis content
                if (analysisHistory.length > 0) {
                    contentSummary += `تحلیل تفصیلی: ${analysisHistory[0].content}\n\n`;
                }
                
                // Add helper questions and responses
                conversationMessages.forEach(msg => {
                    if (msg.role === 'user') {
                        contentSummary += `سوال پیگیری: ${msg.content}\n\n`;
                    } else {
                        contentSummary += `پاسخ: ${msg.content}\n\n`;
                    }
                });

                // Create session title from the question
                const title = questionData?.question ?
                    (questionData.question.length > 50 ? questionData.question.substring(0, 50) + '...' : questionData.question) :
                    'تحلیل تفصیلی سوال';

                console.log('💾 Saving/updating complete conversation with ID:', currentSessionId);
                console.log('💾 Question:', questionData?.question);
                console.log('💾 User Answer:', questionData?.userAnswer);
                console.log('💾 Total analysis items:', analysisHistory.length);
                console.log('💾 Total conversation messages:', conversationMessages.length);
                console.log('💾 Total complete history:', completeHistory.length);

                // Save/update analysis as a conversation in database (original approach)
                const response = await fetch('/api/conversations/session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: currentSessionId,
                        userId: userId,
                        title: title,
                        content: contentSummary, // For library display
                        type: 'analysis',
                        createdAt: sessionStartTime,
                        updatedAt: new Date().toISOString(),
                        subject: questionData?.subject || null,
                        grade: questionData?.grade || null,
                        field: questionData?.field || null,
                        chapter: questionData?.chapter || null,
                        book: questionData?.book || null,
                        messages: completeHistory // For conversation loading
                    })
                });
                const data = await response.json();
                if (data.success) { 
                    console.log('✅ Complete conversation saved/updated:', currentSessionId);
                }
                else { console.error('❌ Failed to save complete conversation:', data.error); }
            } catch (error) { console.error('❌ Error saving complete conversation:', error); }
        }

        // Save detailed analysis to database with session management (legacy function - now calls complete save)
        async function saveDetailedAnalysisToDatabase(content) {
            // Add analysis to history if not already added
            if (content && content !== 'Updated conversation with custom question' && content !== 'Updated conversation with helper question') {
                const analysisObj = {
                    type: 'question',
                    question: questionData?.question || 'سوال',
                    userAnswer: questionData?.userAnswer || 'پاسخ',
                    content: content,
                    timestamp: new Date().toISOString(),
                    subject: questionData?.subject || null,
                    grade: questionData?.grade || null,
                    field: questionData?.field || null,
                    chapter: questionData?.chapter || null,
                    book: questionData?.book || null
                };

                analysisHistory.push(analysisObj);
            }

            // Always save the complete conversation
            await saveCompleteConversationToDatabase();
           }
         
                             // REMOVED: Old helper question extraction system
        // REMOVED: Old function - replaced with new system
        
        // Function to extract questions from content (placeholder - not used in new system)
        function extractQuestionsFromContent(content) {
            try {
                console.log('🔍 Starting question extraction...');
                console.log('🔍 Content length:', content.length);
                

                
                let questions = [];
                let cleanContent = content;
                
                // Pattern 1: Look for dash format questions (- سوال) in HTML content
                // This is the main pattern that should work with the AI response
                const dashPattern = /-\s*([^<>\n]+)(?:<br>|<\/p>|$)/g;
                const dashMatches = content.match(dashPattern);
                console.log('🔍 Dash pattern matches:', dashMatches);
                
                if (dashMatches && dashMatches.length >= 3) {
                    questions = dashMatches.map(match => {
                        // Clean up the match by removing HTML tags and dashes
                        let cleanQuestion = match.replace(/^-\s*/, ''); // Remove leading dash
                        cleanQuestion = cleanQuestion.replace(/<br>$|<\/p>$|<p>$/, ''); // Remove trailing HTML
                        cleanQuestion = cleanQuestion.trim();
                        return cleanQuestion;
                    }).filter(q => q.length > 5); // Filter out very short questions
                    
                    console.log('🔍 Found dash questions:', questions);
                    
                    if (questions.length >= 3) {
                        // Remove these questions from the main content
                        dashMatches.forEach(match => {
                            cleanContent = cleanContent.replace(match, '');
                        });
                        cleanContent = cleanContent.trim();
                        
                        console.log('✅ Successfully extracted questions:', questions);
                        console.log('✅ Cleaned content length:', cleanContent.length);
                        
                        return {
                            questions: questions.slice(0, 3).map((question, index) => ({
                                id: index + 1,
                                question: question
                            })),
                            mainContent: cleanContent
                        };
                    }
                }
                
                // Pattern 2: Look for bullet point questions (• سوال) in HTML content
                if (questions.length === 0) {
                    const bulletPattern = /•\s*([^<>\n]+)(?:<br>|<\/p>|<p>|$)/g;
                    const bulletMatches = content.match(bulletPattern);
                    console.log('🔍 Bullet pattern matches:', bulletMatches);
                    
                    if (bulletMatches && bulletMatches.length >= 3) {
                        questions = bulletMatches.map(match => {
                            let cleanQuestion = match.replace(/^•\s*/, '');
                            cleanQuestion = cleanQuestion.replace(/<br>$|<\/p>$|<p>$/, '');
                            cleanQuestion = cleanQuestion.trim();
                            return cleanQuestion;
                        }).filter(q => q.length > 5);
                        
                        console.log('🔍 Found bullet questions:', questions);
                        
                        if (questions.length >= 3) {
                            debugNeeded = false;
                            // Remove these questions from the main content
                            bulletMatches.forEach(match => {
                                cleanContent = cleanContent.replace(match, '');
                            });
                            cleanContent = cleanContent.trim();
                            
                            return {
                                questions: questions.slice(0, 3).map((question, index) => ({
                                    id: index + 1,
                                    question: question
                                })),
                                mainContent: cleanContent
                            };
                        }
                    }
                }
                
                // Pattern 3: Look for any dash patterns in the last part of content (fallback)
                if (questions.length === 0) {
                    console.log('🔍 Looking for any dash patterns in content...');
                    
                    // Get the last 2000 characters to look for questions
                    const lastPart = content.substring(Math.max(0, content.length - 2000));
                    console.log('🔍 Last part of content:', lastPart);
                    
                    // Look for dash patterns in the last part
                    const lastDashMatches = lastPart.match(/-\s*([^<>\n]+)/g);
                    console.log('🔍 Last part dash matches:', lastDashMatches);
                    
                    if (lastDashMatches && lastDashMatches.length >= 3) {
                        questions = lastDashMatches.map(match => {
                            return match.replace(/^-\s*/, '').trim();
                        }).filter(q => q.length > 5);
                        
                        console.log('🔍 Found dash questions in last part:', questions);
                        
                        if (questions.length >= 3) {
                            debugNeeded = false;
                            // Remove these questions from the main content
                            lastDashMatches.forEach(match => {
                                cleanContent = cleanContent.replace(match, '');
                            });
                            cleanContent = cleanContent.trim();
                            
                            return {
                                questions: questions.slice(0, 3).map((question, index) => ({
                                    id: index + 1,
                                    question: question
                                })),
                                mainContent: cleanContent
                            };
                        }
                    }
                }
                
                // Pattern 4: Look for numbered questions (1. 2. 3.) as last resort
                if (questions.length === 0) {
                    console.log('🔍 Trying to find numbered questions...');
                    const numberedPattern = /\d+\.\s*([^<>\n]+)(?:<br>|<\/p>|<p>|$)/g;
                    const numberedMatches = content.match(numberedPattern);
                    
                    if (numberedMatches && numberedMatches.length >= 3) {
                        questions = numberedMatches.map(match => {
                            let cleanQuestion = match.replace(/^\d+\.\s*/, '');
                            cleanQuestion = cleanQuestion.replace(/<br>$|<\/p>$|<p>$/, '');
                            cleanQuestion = cleanQuestion.trim();
                            return cleanQuestion;
                        }).filter(q => q.length > 5);
                        
                        console.log('🔍 Found numbered questions:', questions);
                        
                        if (questions.length >= 3) {
                            debugNeeded = false;
                            // Remove these questions from the main content
                            numberedMatches.forEach(match => {
                                cleanContent = cleanContent.replace(match, '');
                            });
                            cleanContent = cleanContent.trim();
                            
                            return {
                                questions: questions.slice(0, 3).map((question, index) => ({
                                    id: index + 1,
                                    question: question
                                })),
                                mainContent: cleanContent
                            };
                        }
                    }
                }
                
                // If we still don't have questions, debug the content
                if (debugNeeded) {
                    console.log('❌ No questions found - debugging content structure...');
                    debugContentStructure(content);
                }
                
                console.log('❌ Not enough questions found. Found:', questions.length);
                console.log('🔍 Questions found:', questions);
                
                // Use more contextually relevant fallback questions
                const fallbackQuestions = [
                    'چه مفاهیم مشابهی در این فصل وجود دارد؟',
                    'چگونه می‌توان این موضوع را با مفاهیم قبلی مرتبط کرد؟',
                    'چه سوالات مشابهی در آزمون‌های قبلی آمده است؟'
                ];
                
                return {
                    questions: fallbackQuestions.map((question, index) => ({
                        id: index + 1,
                        question: question
                    })),
                    mainContent: content
                };
                
            } catch (error) {
                console.error('❌ Error in question extraction:', error);
                // Return fallback questions on error
                const fallbackQuestions = [
                    'چه مفاهیم مشابهی در این فصل وجود دارد؟',
                    'چگونه می‌توان این موضوع را با مفاهیم قبلی مرتبط کرد؟',
                    'چه سوالات مشابهی در آزمون‌های قبلی آمده است؟'
                ];
                return {
                    questions: fallbackQuestions.map((question, index) => ({
                        id: index + 1,
                        question: question
                    })),
                    mainContent: content
                };
            }
        }
        
        
        // REMOVED: All old helper question code - replaced with new system

        // Function to format AI response with structure for detailed analysis - USING STUDY MODE
        function formatAIResponseWithStructure(content, type) {
            // Use the same study-mode formatting as chat page
            const formattedContent = formatChatContent(content);
            // Wrap in study-mode container for consistent styling
            return `<div class="study-mode-content">${formattedContent}</div>`;
        }
        
        // Function to format streaming chunks quickly (for real-time updates) - USING STUDY MODE
        function formatStreamingChunk(content) {
            // Use the same study-mode formatting as chat page
            const formattedContent = formatChatContent(content);
            // Wrap in study-mode container for consistent styling
            return `<div class="study-mode-content">${formattedContent}</div>`;
        }
        
        // Function to format helper question responses - USING STUDY MODE
        function formatHelperQuestionResponse(content) {
            // Use the same study-mode formatting as chat page
            const formattedContent = formatChatContent(content);
            // Wrap in study-mode container for consistent styling
            const result = `<div class="study-mode-content">${formattedContent}</div>`;
            
            // Process MathJax after content is set
            setTimeout(() => {
                const element = document.querySelector('.study-mode-content:last-child');
                if (element) {
                    processMathJax(element);
                }
            }, 100);
            
            return result;
        }

        // Go back to previous page
        function goBack() {
            // Go back to chapters page
            const gradeMapping = {
                '10th': 'دهم',
                '11th': 'یازدهم', 
                '12th': 'دوازدهم'
            };
            const persianGrade = gradeMapping[questionData?.grade] || 'دوازدهم';
            window.location.href = `chapters.html?subject=${questionData?.subject || 'biology'}&grade=${persianGrade}&field=${questionData?.field || 'experimental'}`;
        }

        // Go back to chapter page (cross icon)
        function goToChapter() {
            // Go back to chapters page
            const gradeMapping = {
                '10th': 'دهم',
                '11th': 'یازدهم', 
                '12th': 'دوازدهم'
            };
            const persianGrade = gradeMapping[questionData?.grade] || 'دوازدهم';
            window.location.href = `chapters.html?subject=${questionData?.subject || 'biology'}&grade=${persianGrade}&field=${questionData?.field || 'experimental'}`;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOMContentLoaded event fired');
            console.log('📱 Page initialization starting...');
            
            getUrlParams();
            
            console.log('📊 After getUrlParams(), questionData:', questionData);
            
            // Ensure FAB is hidden initially
            hideFloatingActionButton();
            
            // Don't initialize loading state here - let displayResults() handle it
            console.log('✅ Page elements ready for displayResults()');
            
            // Add mobile-specific touch event handling
            if ('ontouchstart' in window) {
                console.log('Mobile device detected, adding touch optimizations');
                addMobileTouchHandling();
            }
            
            console.log('🎯 Page initialization complete');
        });
        
        // Add mobile-specific touch event handling
        function addMobileTouchHandling() {
            console.log('Setting up mobile touch handling...');
            
            // Prevent double-tap zoom on mobile
            document.addEventListener('touchstart', function(event) {
                if (event.target.closest('.bg-gray-100')) {
                    event.preventDefault();
                    console.log('Touch event prevented on helper question');
                }
            }, { passive: false });
            
            // Add touch feedback for helper questions
            document.addEventListener('touchstart', function(event) {
                const questionDiv = event.target.closest('.bg-gray-100');
                if (questionDiv) {
                    questionDiv.style.backgroundColor = '#d1d5db';
                    questionDiv.style.transform = 'scale(0.98)';
                    console.log('Touch feedback applied to helper question');
                }
            });
            
            document.addEventListener('touchend', function(event) {
                const questionDiv = event.target.closest('.bg-gray-100');
                if (questionDiv) {
                    questionDiv.style.backgroundColor = '';
                    questionDiv.style.transform = '';
                    console.log('Touch feedback removed from helper question');
                }
            });
            
            console.log('Mobile touch handling setup complete');
        }
        
        // ========================================
        // CLEANUP COMPLETE - OLD SYSTEM REMOVED
        // ========================================
        
        // The following functions were removed:
        // - extractSimpleTextHelperQuestions()
        // - renderHelpQuestions() 
        // - handleQuestionClickFromData()
        // - handleQuestionClick()
        // - showHelpQuestionAnswer()
        // - streamHelpQuestionResponse()
        // - formatHelpQuestionAnswer()
        // - formatAIResponseWithStructure()
        // - formatHelpQuestionAnswerEnhanced()
        
        // ========================================
        // NEW HELPER QUESTION RENDERING SYSTEM
        // ========================================
        

        

        

        
        // Function to render helper questions at the end of detailed analysis
        function renderHelperQuestions(content) {
            console.log('🎯 Rendering helper questions at the end of analysis');
            
            // Ensure ai-help-questions div exists
            let helpQuestionsDiv = document.getElementById('ai-help-questions');
            if (!helpQuestionsDiv) {
                console.log('🔧 Creating ai-help-questions div...');
                const analysisContent = document.getElementById('analysis-content');
                if (analysisContent) {
                    helpQuestionsDiv = document.createElement('div');
                    helpQuestionsDiv.id = 'ai-help-questions';
                    analysisContent.appendChild(helpQuestionsDiv);
                    console.log('✅ ai-help-questions div created successfully');
                } else {
                    console.error('❌ analysis-content element not found');
                    return;
                }
            }
            
            // Extract the 4 related questions from the AI response
            // The AI generates them in this format:
            // Related Questions:
            // - [Question 1]
            // - [Question 2]
            // - [Question 3]
            // - [Question 4]
            const questions = extractRelatedQuestions(content);
            console.log('🔍 DEBUG: Content passed to extractRelatedQuestions:', content);
            console.log('🔍 DEBUG: Questions returned:', questions);
            console.log('🔍 DEBUG: Questions type:', typeof questions);
            console.log('🔍 DEBUG: Is array:', Array.isArray(questions));
            
            if (questions && questions.length > 0) {
                console.log('✅ Found AI-generated questions:', questions);
                console.log('🔍 DEBUG: Questions array details:', {
                    length: questions.length,
                    firstQuestion: questions[0],
                    lastQuestion: questions[questions.length - 1]
                });
                renderQuestionsUI(questions);
            } else {
                console.log('❌ No AI questions found - not rendering helper questions');
                // Don't show any questions if extraction fails
                return;
            }
        }
        
        // Function to extract ALL related questions from AI response (flexible count)
        function extractRelatedQuestions(content) {
            try {
                console.log('🔍 Extracting related questions from content...');
                console.log('🔍 Content length:', content.length);
                console.log('🔍 Content preview (last 1000 chars):', content.substring(Math.max(0, content.length - 1000)));
                
                // SUPER AGGRESSIVE HTML CLEANING - Remove ALL HTML content first
                let cleanContent = content;
                
                // Remove all HTML tags and their content
                cleanContent = cleanContent.replace(/<[^>]*>/g, '');
                
                // Remove any remaining HTML entities
                cleanContent = cleanContent.replace(/&[a-zA-Z0-9#]+;/g, '');
                
                // Remove any JavaScript code or attributes
                cleanContent = cleanContent.replace(/on\w+\s*=\s*["'][^"']*["']/g, '');
                cleanContent = cleanContent.replace(/style\s*=\s*["'][^"']*["']/g, '');
                cleanContent = cleanContent.replace(/class\s*=\s*["'][^"']*["']/g, '');
                cleanContent = cleanContent.replace(/id\s*=\s*["'][^"']*["']/g, '');
                
                // Remove any remaining HTML attributes
                cleanContent = cleanContent.replace(/\s+\w+\s*=\s*["'][^"']*["']/g, '');
                
                // Remove any remaining quotes or special characters that might be left
                cleanContent = cleanContent.replace(/['"]/g, '');
                cleanContent = cleanContent.replace(/\)/g, '');
                
                // Clean up any extra whitespace
                cleanContent = cleanContent.replace(/\s+/g, ' ').trim();
                
                console.log('🔍 Cleaned content preview:', cleanContent.substring(Math.max(0, cleanContent.length - 500)));
                
                // Now look for questions in the cleaned content
                // Strategy 1: Look for lines starting with "-" that look like questions
                const dashQuestions = cleanContent.match(/-\s*([^\r\n]+)/g);
                console.log('🔍 All dash lines found:', dashQuestions);
                
                if (dashQuestions && dashQuestions.length > 0) {
                    // Filter for question-like content
                    const filteredQuestions = dashQuestions
                        .map(q => {
                            // Remove the dash prefix and clean up
                            let cleanQuestion = q.replace(/^-\s*/, '').trim();
                            
                            // Clean up any extra whitespace
                            cleanQuestion = cleanQuestion.replace(/\s+/g, ' ').trim();
                            
                            return cleanQuestion;
                        })
                        .filter(q => {
                            const length = q.length;
                            const hasQuestionMark = q.includes('؟') || q.includes('?');
                            const looksLikeQuestion = q.match(/^(چه|چرا|چگونه|کدام|آیا|چطور|کجا|کی|چند|کدام|مثال|تفاوت|نقش|عملکرد|مکانیزم|فرآیند|مراحل|مرحله|گام|قدم|کدام یک|چگونه|آیا|چرا|کجا|کی|چند|مثال|تفاوت|نقش|عملکرد|مکانیزم|فرآیند|مراحل|مرحله|گام|قدم)/);
                            
                            // Accept if it's a reasonable length and either has question mark or looks like a question
                            return length > 8 && length < 300 && (hasQuestionMark || looksLikeQuestion);
                        });
                    
                    console.log('🔍 Filtered questions:', filteredQuestions);
                    
                    if (filteredQuestions.length > 0) {
                        console.log('✅ Found questions after aggressive cleaning:', filteredQuestions);
                        
                        // Check if any question contains multiple questions separated by dashes
                        const finalQuestions = [];
                        filteredQuestions.forEach(question => {
                            // Split by dash if the question contains multiple questions
                            if (question.includes('-')) {
                                const splitQuestions = question.split('-').map(q => q.trim()).filter(q => q.length > 5);
                                finalQuestions.push(...splitQuestions);
                            } else {
                                finalQuestions.push(question);
                            }
                        });
                        
                        console.log('🔍 Final split questions:', finalQuestions);
                        return finalQuestions;
                    }
                }
                
                // Strategy 2: Look for any text that looks like a question (fallback)
                console.log('🔍 Strategy 2 - Looking for question-like text...');
                const questionPatterns = [
                    /([^.!?؟]*[؟?][^.!?؟]*)/g,  // Text ending with question mark
                    /([^.!?؟]*\b(چه|چرا|چگونه|کدام|آیا|چطور|کجا|کی|چند|مثال|تفاوت|نقش|عملکرد|مکانیزم|فرآیند|مراحل|مرحله|گام|قدم)\b[^.!?؟]*)/g  // Text starting with question words
                ];
                
                for (const pattern of questionPatterns) {
                    const matches = cleanContent.match(pattern);
                    if (matches && matches.length > 0) {
                        const questions = matches
                            .map(q => q.trim())
                            .filter(q => q.length > 10 && q.length < 200);
                        
                        if (questions.length > 0) {
                            console.log('✅ Found questions with pattern matching:', questions);
                            return questions.slice(0, 4); // Limit to 4 questions
                        }
                    }
                }
                
                // Strategy 3: Look for any lines starting with "-" that look like questions in HTML content
                console.log('🔍 Strategy 3 - Looking for dash-prefixed lines in HTML...');
                const dashQuestionsHTML = content.match(/-\s*([^<]+)/g);
                console.log('🔍 All dash lines found:', dashQuestionsHTML);
                
                if (dashQuestionsHTML && dashQuestionsHTML.length > 0) {
                    // More flexible filtering - look for question-like content
                    const filteredQuestions = dashQuestionsHTML
                        .map(q => {
                            // Clean the question text by removing HTML tags and extra content
                            let cleanQuestion = q.replace(/^-\s*/, '').trim();
                            
                            // Remove any HTML tags that might have been included
                            cleanQuestion = cleanQuestion.replace(/<[^>]*>/g, '');
                            
                            // Remove any JavaScript code or attributes that might have leaked in
                            cleanQuestion = cleanQuestion.replace(/on\w+\s*=\s*["'][^"']*["']/g, '');
                            cleanQuestion = cleanQuestion.replace(/style\s*=\s*["'][^"']*["']/g, '');
                            cleanQuestion = cleanQuestion.replace(/class\s*=\s*["'][^"']*["']/g, '');
                            cleanQuestion = cleanQuestion.replace(/id\s*=\s*["'][^"']*["']/g, '');
                            
                            // Remove any remaining HTML attributes
                            cleanQuestion = cleanQuestion.replace(/\s+\w+\s*=\s*["'][^"']*["']/g, '');
                            
                            // Clean up any extra whitespace
                            cleanQuestion = cleanQuestion.replace(/\s+/g, ' ').trim();
                            
                            return cleanQuestion;
                        })
                        .filter(q => {
                            const length = q.length;
                            const hasQuestionMark = q.includes('؟') || q.includes('?');
                            const looksLikeQuestion = q.match(/^(چه|چرا|چگونه|کدام|آیا|چطور|کجا|کی|چند|کدام|مثال|تفاوت|نقش|عملکرد|مکانیزم|فرآیند|مراحل|مرحله|گام|قدم)/);
                            
                            // Accept if it's a reasonable length and either has question mark or looks like a question
                            return length > 8 && length < 300 && (hasQuestionMark || looksLikeQuestion);
                        });
                    
                    console.log('🔍 Filtered questions:', filteredQuestions);
                    
                    if (filteredQuestions.length > 0) {
                        console.log('✅ Found dash questions as fallback:', filteredQuestions);
                        
                        // Check if any question contains multiple questions separated by dashes
                        const finalQuestions = [];
                        filteredQuestions.forEach(question => {
                            // Split by dash if the question contains multiple questions
                            if (question.includes('-')) {
                                const splitQuestions = question.split('-').map(q => q.trim()).filter(q => q.length > 5);
                                finalQuestions.push(...splitQuestions);
                            } else {
                                finalQuestions.push(question);
                            }
                        });
                        
                        console.log('🔍 Final split questions (Strategy 3):', finalQuestions);
                        return finalQuestions;
                    }
                    
                    // If still no clean questions, try aggressive cleaning
                    console.log('🔍 Trying aggressive cleaning for dash questions...');
                    const aggressiveDashQuestions = dashQuestionsHTML.map(q => {
                        // Remove the dash prefix
                        let cleanQuestion = q.replace(/^-\s*/, '').trim();
                        
                        // Remove ALL HTML content - everything from first < to end
                        const firstTagIndex = cleanQuestion.indexOf('<');
                        if (firstTagIndex !== -1) {
                            cleanQuestion = cleanQuestion.substring(0, firstTagIndex);
                        }
                        
                        // Remove any remaining quotes or special characters that might be left
                        cleanQuestion = cleanQuestion.replace(/['"]/g, '');
                        cleanQuestion = cleanQuestion.replace(/\)/g, '');
                        
                        // Clean up any extra whitespace
                        cleanQuestion = cleanQuestion.replace(/\s+/g, ' ').trim();
                        
                        return cleanQuestion;
                    }).filter(q => {
                        const length = q.length;
                        const hasQuestionMark = q.includes('؟') || q.includes('?');
                        const looksLikeQuestion = q.match(/^(چه|چرا|چگونه|کدام|آیا|چطور|کجا|کی|چند|کدام|مثال|تفاوت|نقش|عملکرد|مکانیزم|فرآیند|مراحل|مرحله|گام|قدم)/);
                        
                        return length > 8 && length < 300 && (hasQuestionMark || looksLikeQuestion);
                    });
                    
                    if (aggressiveDashQuestions.length > 0) {
                        console.log('✅ Found dash questions with aggressive cleaning:', aggressiveDashQuestions);
                        return aggressiveDashQuestions;
                    }
                }
                
                // Strategy 4: Look for the last part of content for questions in HTML content
                console.log('🔍 Strategy 4 - Looking for questions in last part of HTML...');
                const lastPart = content.substring(Math.max(0, content.length - 3000));
                const lastDashLines = lastPart.match(/-\s*([^<]+)/g);
                
                if (lastDashLines && lastDashLines.length > 0) {
                    const questions = lastDashLines.map(q => {
                        // Clean the question text by removing HTML tags and extra content
                        let cleanQuestion = q.replace(/^-\s*/, '').trim();
                        
                        // Remove any HTML tags that might have been included
                        cleanQuestion = cleanQuestion.replace(/<[^>]*>/g, '');
                        
                        // Remove any JavaScript code or attributes that might have leaked in
                        cleanQuestion = cleanQuestion.replace(/on\w+\s*=\s*["'][^"']*["']/g, '');
                        cleanQuestion = cleanQuestion.replace(/style\s*=\s*["'][^"']*["']/g, '');
                        cleanQuestion = cleanQuestion.replace(/class\s*=\s*["'][^"']*["']/g, '');
                        cleanQuestion = cleanQuestion.replace(/id\s*=\s*["'][^"']*["']/g, '');
                        
                        // Remove any remaining HTML attributes
                        cleanQuestion = cleanQuestion.replace(/\s+\w+\s*=\s*["'][^"']*["']/g, '');
                        
                        // Clean up any extra whitespace
                        cleanQuestion = cleanQuestion.replace(/\s+/g, ' ').trim();
                        
                        return cleanQuestion;
                    }).filter(q => {
                        const length = q.length;
                        const hasQuestionMark = q.includes('؟') || q.includes('?');
                        const looksLikeQuestion = q.match(/^(چه|چرا|چگونه|کدام|آیا|چطور|کجا|کی|چند|کدام|مثال|تفاوت|نقش|عملکرد|مکانیزم|فرآیند|مراحل|مرحله|گام|قدم)/);
                        
                        return length > 8 && length < 300 && (hasQuestionMark || looksLikeQuestion);
                    });
                    
                    if (questions.length > 0) {
                        console.log('✅ Found questions in last part:', questions);
                        
                        // Check if any question contains multiple questions separated by dashes
                        const finalQuestions = [];
                        questions.forEach(question => {
                            // Split by dash if the question contains multiple questions
                            if (question.includes('-')) {
                                const splitQuestions = question.split('-').map(q => q.trim()).filter(q => q.length > 5);
                                finalQuestions.push(...splitQuestions);
                            } else {
                                finalQuestions.push(question);
                            }
                        });
                        
                        console.log('🔍 Final split questions (Strategy 4):', finalQuestions);
                        return finalQuestions;
                    }
                    
                    // If still no clean questions, try aggressive cleaning
                    console.log('🔍 Trying aggressive cleaning for last part questions...');
                    const aggressiveLastQuestions = lastDashLines.map(q => {
                        // Remove the dash prefix
                        let cleanQuestion = q.replace(/^-\s*/, '').trim();
                        
                        // Remove ALL HTML content - everything from first < to end
                        const firstTagIndex = cleanQuestion.indexOf('<');
                        if (firstTagIndex !== -1) {
                            cleanQuestion = cleanQuestion.substring(0, firstTagIndex);
                        }
                        
                        // Remove any remaining quotes or special characters that might be left
                        cleanQuestion = cleanQuestion.replace(/['"]/g, '');
                        cleanQuestion = cleanQuestion.replace(/\)/g, '');
                        
                        // Clean up any extra whitespace
                        cleanQuestion = cleanQuestion.replace(/\s+/g, ' ').trim();
                        
                        return cleanQuestion;
                    }).filter(q => {
                        const length = q.length;
                        const hasQuestionMark = q.includes('؟') || q.includes('?');
                        const looksLikeQuestion = q.match(/^(چه|چرا|چگونه|کدام|آیا|چطور|کجا|کی|چند|کدام|مثال|تفاوت|نقش|عملکرد|مکانیزم|فرآیند|مراحل|مرحله|گام|قدم)/);
                        
                        return length > 8 && length < 300 && (hasQuestionMark || looksLikeQuestion);
                    });
                    
                    if (aggressiveLastQuestions.length > 0) {
                        console.log('✅ Found last part questions with aggressive cleaning:', aggressiveLastQuestions);
                        return aggressiveLastQuestions;
                    }
                }
                
                // Strategy 5: Look for questions in HTML content with different formatting
                console.log('🔍 Strategy 5 - Looking for questions in HTML with different patterns...');
                
                // Look for questions that might be wrapped in <p> tags or other HTML elements
                const htmlQuestionPatterns = [
                    /<p[^>]*>-\s*([^<]+)<\/p>/g,
                    /<div[^>]*>-\s*([^<]+)<\/div>/g,
                    /<br>-\s*([^<]+)<br>/g
                ];
                
                for (const pattern of htmlQuestionPatterns) {
                    const matches = content.match(pattern);
                    if (matches && matches.length > 0) {
                        console.log('🔍 Found HTML pattern matches:', matches);
                        const questions = matches.map(match => {
                            const questionMatch = match.match(/-\s*([^<]+)/);
                            if (questionMatch) {
                                // Clean the question text by removing HTML tags and extra content
                                let cleanQuestion = questionMatch[1].trim();
                                
                                // Remove any HTML tags that might have been included
                                cleanQuestion = cleanQuestion.replace(/<[^>]*>/g, '');
                                
                                // Remove any JavaScript code or attributes that might have leaked in
                                cleanQuestion = cleanQuestion.replace(/on\w+\s*=\s*["'][^"']*["']/g, '');
                                cleanQuestion = cleanQuestion.replace(/style\s*=\s*["'][^"']*["']/g, '');
                                cleanQuestion = cleanQuestion.replace(/class\s*=\s*["'][^"']*["']/g, '');
                                cleanQuestion = cleanQuestion.replace(/id\s*=\s*["'][^"']*["']/g, '');
                                
                                // Remove any remaining HTML attributes
                                cleanQuestion = cleanQuestion.replace(/\s+\w+\s*=\s*["'][^"']*["']/g, '');
                                
                                // Clean up any extra whitespace
                                cleanQuestion = cleanQuestion.replace(/\s+/g, ' ').trim();
                                
                                return cleanQuestion;
                            }
                            return null;
                        }).filter(q => q && q.length > 8 && q.length < 300);
                        
                        if (questions.length > 0) {
                            console.log('✅ Found questions with HTML patterns:', questions);
                            return questions;
                        }
                    }
                }
                
                console.log('❌ No related questions found in content');
                console.log('🔍 Final debug - returning null');
                return null;
                
            } catch (error) {
                console.error('❌ Error extracting related questions:', error);
                return null;
            }
        }
        
        // Debug function to test question extraction
        function debugQuestionExtraction(content) {
            console.log('🔍 DEBUG: Testing question extraction with content:', content);
            const questions = extractRelatedQuestions(content);
            console.log('🔍 DEBUG: Extracted questions:', questions);
            console.log('🔍 DEBUG: Questions type:', typeof questions);
            console.log('🔍 DEBUG: Is array:', Array.isArray(questions));
            if (questions) {
                console.log('🔍 DEBUG: Questions length:', questions.length);
                questions.forEach((q, idx) => {
                    console.log(`🔍 DEBUG: Question ${idx}:`, q);
                });
            }
            return questions;
        }
        
        // Function to render helper questions at the end of detailed analysis
        function renderQuestionsUI(questions) {
            console.log('🎨 renderQuestionsUI called with questions:', questions);
            console.log('🔍 Number of questions to render:', questions.length);
            
            // First try to find ai-help-questions directly, then within analysis-content
            let helpQuestionsDiv = document.getElementById('ai-help-questions');
            if (!helpQuestionsDiv) {
                const analysisContent = document.getElementById('analysis-content');
                if (analysisContent) {
                    helpQuestionsDiv = analysisContent.querySelector('#ai-help-questions');
                }
            }
            
            console.log('🔍 Looking for ai-help-questions div:', helpQuestionsDiv);
            
            if (!helpQuestionsDiv) {
                console.error('❌ ai-help-questions div not found');
                console.log('🔍 Available divs with similar names:');
                document.querySelectorAll('[id*="help"]').forEach(div => {
                    console.log('  -', div.id, div);
                });
                return;
            }
            
            console.log('✅ Found ai-help-questions div, rendering questions...');
            console.log('🔍 Questions array details:', {
                length: questions.length,
                questions: questions,
                isArray: Array.isArray(questions),
                type: typeof questions
            });
            
            // Create questions HTML with ONLY clickable buttons
                        const questionsHTML = `
                <div class="related-questions-section" style="margin-top: 2rem; padding: 1rem; background-color: #f9fafb; border-radius: 12px;">
                    <h3 style="color: #374151; font-size: 18px; font-weight: 600; margin-bottom: 1rem; text-align: right;">سؤالات مرتبط:</h3>
                    
                      <div class="max-w-2xl mx-auto">
                          <ul class="space-y-3" style="list-style: none; padding: 0; margin: 0;">
                              ${questions.map((questionText, idx) => {
                            console.log(`🔍 Question ${idx + 1}:`, questionText);
                                console.log(`🔍 Question ${idx + 1} type:`, typeof questionText);
                                console.log(`🔍 Question ${idx + 1} length:`, questionText ? questionText.length : 'null/undefined');
                            
                                // Ensure questionText is valid
                                const safeQuestionText = questionText || `سوال ${idx + 1}`;
                            
                            return `
                                      <li class="question-item" style="margin: 0; padding: 0;">
                                          <button
                                            data-query="${safeQuestionText.replace(/"/g, '&quot;')}"
                                            onclick="onSuggestionClick('${safeQuestionText.replace(/'/g, '\\\'')}')"
                                              class="question-button w-full text-right transition-all duration-300 cursor-pointer"
                                              style="
                                                  background-color: #f3f4f6;
                                                  border: 2px solid #e5e7eb;
                                                  border-radius: 12px;
                                                  padding: 16px 20px;
                                                  font-size: 16px;
                                                  font-family: 'Inter', 'Vazir', sans-serif;
                                                  color: #374151;
                                                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                                                  min-height: 48px;
                                                  display: flex;
                                                  align-items: center;
                                                  justify-content: flex-end;
                                                  margin-bottom: 12px;
                                                width: 100%;
                                              "
                                              onmouseover="this.style.backgroundColor='#e0eaff'; this.style.transform='scale(1.02)'"
                                              onmouseout="this.style.backgroundColor='#f3f4f6'; this.style.transform='scale(1)'"
                                          >
                                            <span class="question-text" style="line-height: 1.5;">- ${safeQuestionText}</span>
                                          </button>
                                      </li>
                            `;
                        }).join('')}
                          </ul>
                    </div>
                </div>
            `;
            
            console.log('🔍 Generated HTML:', questionsHTML);
            
            helpQuestionsDiv.innerHTML = questionsHTML;
            helpQuestionsDiv.style.display = 'block';
            
            // Add mobile-specific touch handling
            const questionButtons = helpQuestionsDiv.querySelectorAll('.question-button');
            questionButtons.forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.backgroundColor = '#d1d5db';
                    this.style.transform = 'scale(0.98)';
                });
                
                button.addEventListener('touchend', function() {
                    this.style.backgroundColor = '#f0f4f8';
                    this.style.transform = 'scale(1)';
                });
            });
            
            console.log('✅ Helper questions rendered successfully with modern UI');
        }
        
        // Handle suggestion clicks
        function onSuggestionClick(query) {
            console.log('🎯 Suggestion clicked:', query);
            
            // Add helper question to conversation history
            addToConversationHistory('user', query, 'helper_question');
            
             // Ensure detailed analysis section is visible
             const detailedAnalysisSection = document.getElementById('detailed-analysis-section');
             
             console.log('🔍 Detailed Analysis Section:', detailedAnalysisSection);
             
             if (detailedAnalysisSection && detailedAnalysisSection.classList.contains('hidden')) {
                 console.log('✅ Making detailed analysis section visible');
                 detailedAnalysisSection.classList.remove('hidden');
                 detailedAnalysisSection.style.display = 'block';
             }
             
             // Also ensure analysis content is visible
             const analysisContent = document.getElementById('analysis-content');
             if (analysisContent && analysisContent.classList.contains('hidden')) {
                 console.log('✅ Making analysis content visible');
                 analysisContent.classList.remove('hidden');
             }
             
             // Add helper question to chat messages area (like user messages)
             const chatMessages = document.getElementById('chat-messages');
             console.log('🔍 Chat Messages Area:', chatMessages);
             
             if (!chatMessages) {
                 console.error('❌ Chat messages area not found');
                 console.log('🔍 Current HTML structure around chat-messages:');
                 console.log('🔍 detailed-analysis-section:', document.getElementById('detailed-analysis-section')?.outerHTML);
                 console.log('🔍 analysis-content:', document.getElementById('analysis-content')?.outerHTML);
                 return;
             }
             
             const helperQuestionMessage = document.createElement('div');
             helperQuestionMessage.className = 'chat-message user';
             helperQuestionMessage.innerHTML = `<div class="message-bubble user">${query}</div>`;
             chatMessages.appendChild(helperQuestionMessage);
             
             console.log('✅ Helper question message added to chat');
             
             // Move page up to show the helper question in a better visible area
             setTimeout(() => {
                 helperQuestionMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
             }, 100);
             
             // Hide FAB button when helper question is sent (will be shown again when response completes)
             hideFloatingActionButton();
             
             // Make API call to get help response (without showing loading state in button)
            getHelpResponse(query);
        }
        
        // Show loading state for clicked suggestion
        function showSuggestionLoading(query) {
            // Find the clicked button and show loading
            const buttons = document.querySelectorAll('[data-query]');
            buttons.forEach(button => {
                if (button.getAttribute('data-query') === query) {
                    button.innerHTML = `
                        <div class="flex items-center justify-center space-x-2 space-x-reverse">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                            <span class="text-gray-600">در حال پاسخ...</span>
                        </div>
                    `;
                    button.disabled = true;
                }
            });
        }
        
        // Get help response from API with streaming effect
        async function getHelpResponse(query) {
            try {
                // First, add AI loading message to chat display (like detailed analysis)
                // First try to find chat-messages directly, then within detailed-analysis-section
                let chatMessages = document.getElementById('chat-messages');
                if (!chatMessages) {
                    const detailedAnalysisSection = document.getElementById('detailed-analysis-section');
                    if (detailedAnalysisSection) {
                        chatMessages = detailedAnalysisSection.querySelector('#chat-messages');
                    }
                }
                
                if (!chatMessages) {
                    console.error('❌ Chat messages area not found in getHelpResponse');
                    return;
                }
                
                const aiLoadingMessage = document.createElement('div');
                aiLoadingMessage.className = 'chat-message ai';
                aiLoadingMessage.id = `ai-loading-${Date.now()}`;
                aiLoadingMessage.innerHTML = `
                    <div class="message-bubble ai">
                        <div class="flex items-center space-x-2 space-x-reverse">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                            <span class="text-gray-600">در حال پاسخ...</span>
                        </div>
                    </div>
                `;
                
                chatMessages.appendChild(aiLoadingMessage);
                
                // Scroll to show the loading message only if user is not interacting
                if (!isUserInteracting) {
                aiLoadingMessage.scrollIntoView({ behavior: 'smooth' });
                } else {
                    console.log('🚫 Skipping auto-scroll - user is interacting with input');
                }
                
                const response = await fetch('/api/chat/help-question/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        question: query,
                        subject: questionData?.subject || 'biology',
                        grade: questionData?.grade || 'دوم',
                        chapter: questionData?.chapter || '1',
                        originalAnalysis: questionData?.analysis || '',
                        conversationId: currentConversationId,
                        conversationContext: getConversationContext()
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Handle streaming response with real-time updates
                await streamHelpResponse(response, query, aiLoadingMessage);
                
            } catch (error) {
                console.error('Error getting help response:', error);
                showSuggestionError(query, error.message);
            }
        }
        
                 // Stream help response with real-time updates (like detailed analysis)
         async function streamHelpResponse(response, query, aiLoadingMessage) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullResponse = '';
            let lastUpdateTime = 0;
            const UPDATE_INTERVAL = 0; // Maximum speed streaming - no delay
            
            try {
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            
                            if (data === '[DONE]') {
                                // Final formatting and display
                                 displayHelpResponse(query, fullResponse, aiLoadingMessage);
                                return;
                            }
                            
                            try {
                                const parsed = JSON.parse(data);
                                 if (parsed.content && parsed.type === 'chunk') {
                                    fullResponse += parsed.content;
                                    
                                    // Maximum speed streaming - update immediately
                                    updateHelpResponseStreaming(query, fullResponse, aiLoadingMessage);
                                }
                            } catch (e) {
                                // Ignore parsing errors for incomplete chunks
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Streaming error:', error);
                showSuggestionError(query, 'خطا در دریافت پاسخ');
            }
        }
        
                 // Update help response in real-time with streaming effect (like detailed analysis)
         function updateHelpResponseStreaming(query, response, aiLoadingMessage) {
             // Safety check for aiLoadingMessage
             if (!aiLoadingMessage) {
                 console.error('❌ aiLoadingMessage is undefined in updateHelpResponseStreaming');
                 return;
             }
             
             // Update the loading message with streaming content in real-time
             // Use the same simple approach as detailed analysis
             const messageBubble = aiLoadingMessage.querySelector('.message-bubble.ai');
             if (messageBubble) {
                 // Simple streaming update using the same system as detailed analysis
                 messageBubble.innerHTML = formatStreamingChunk(response);
             }
             
             console.log('✅ Streaming update for:', query, response.length);
         }
         
         // Update help response in real-time (legacy function)
        function updateHelpResponse(query, response) {
            // This can be used for real-time updates if needed
            console.log('Updating response for:', query, response.length);
        }
        
                 // Display final help response with streaming effect
         function displayHelpResponse(query, response, aiLoadingMessage) {
             // Safety check for aiLoadingMessage
             if (!aiLoadingMessage) {
                 console.error('❌ aiLoadingMessage is undefined in displayHelpResponse');
                 return;
             }
             
            // Add AI response to conversation history
            addToConversationHistory('assistant', response, 'helper_response');
            
            // Update the existing loading message with the final formatted response
            // Use the simple helper question formatting (bullet points and numbered lists only)
            const messageBubble = aiLoadingMessage.querySelector('.message-bubble.ai');
            if (messageBubble) {
                // Simple final display with bullet points and numbered lists only
                messageBubble.innerHTML = formatHelperQuestionResponse(response);
                
                // Process MathJax for the message bubble
                setTimeout(() => {
                    processMathJax(messageBubble);
                }, 200);
            }
            
            // Save the updated conversation to database
            saveDetailedAnalysisToDatabase('Updated conversation with helper question');
             
             // Show FAB button again when helper question response is completed
             showFloatingActionButton();
             
             console.log('✅ Helper question response displayed successfully with streaming effect');
        }
        
        // Format response for display - USING STUDY MODE
        function formatResponse(response) {
            // Use the same study-mode formatting as chat page
            return formatChatContent(response);
        }
        
        // Show error for suggestion
        function showSuggestionError(query, errorMessage) {
            const buttons = document.querySelectorAll('[data-query]');
            buttons.forEach(button => {
                if (button.getAttribute('data-query') === query) {
                    button.innerHTML = `
                        <div class="text-red-500 text-center">
                            <p class="text-sm">خطا: ${errorMessage}</p>
                        </div>
                    `;
                    button.disabled = true;
                }
            });
        }
        
        // Restore suggestion button to original state
        function restoreSuggestionButton(query) {
            const buttons = document.querySelectorAll('[data-query]');
            buttons.forEach(button => {
                if (button.getAttribute('data-query') === query) {
                    button.innerHTML = `<span class="text-gray-700 text-lg font-medium leading-relaxed">${query}</span>`;
                    button.disabled = false;
                }
            });
        }
        
        // ========================================
        // END OF NEW HELPER QUESTION SYSTEM
        // ========================================
        
        // ========================================
        // FLOATING ACTION BUTTON (FAB) FUNCTIONS
        // ========================================
        
        // Show the Floating Action Button with smooth animation
        function showFloatingActionButton() {
            const fabContainer = document.getElementById('fab-container');
            if (fabContainer) {
                // Add a small delay to ensure smooth transition
                setTimeout(() => {
                    fabContainer.classList.remove('scale-0', 'opacity-0');
                    fabContainer.classList.add('scale-100', 'opacity-100');
                    console.log('✅ Floating Action Button is now visible');
                }, 300);
            }
        }
        
        // Hide the Floating Action Button
        function hideFloatingActionButton() {
            const fabContainer = document.getElementById('fab-container');
            if (fabContainer) {
                fabContainer.classList.add('scale-0', 'opacity-0');
                fabContainer.classList.remove('scale-100', 'opacity-100');
            }
        }
        
                 // Toggle chat input visibility
         function toggleChatInput() {
             console.log('🎯 FAB button clicked - toggling chat input!');
             
             // Add click feedback
             const fabButton = document.getElementById('fab-button');
             if (fabButton) {
                 fabButton.classList.add('scale-95');
                 setTimeout(() => {
                     fabButton.classList.remove('scale-95');
                 }, 150);
             }
             
             const chatInputSection = document.getElementById('chat-input-section');
             const fabContainer = document.getElementById('fab-container');
             const inputField = document.getElementById('chat-input-field');
             const isVisible = chatInputSection.classList.contains('show');
             
             if (isVisible) {
                 // Hide chat input
                 hideChatInput();
             } else {
                 // Show chat input
                 showChatInput();
             }
         }
         
                  // Show chat input and hide FAB button
         function showChatInput() {
             console.log('🚀 showChatInput function called');
             
             const chatInputSection = document.getElementById('chat-input-section');
             const fabContainer = document.getElementById('fab-container');
             const inputField = document.getElementById('chat-input-field');
             
             console.log('🔍 chatInputSection found:', chatInputSection);
             console.log('🔍 fabContainer found:', fabContainer);
             console.log('🔍 inputField found:', inputField);
             
             if (!chatInputSection) {
                 console.error('❌ Chat input section not found!');
                 return;
             }
             
             // Check if chat input is already visible
             const isAlreadyVisible = chatInputSection.classList.contains('show');
             
             if (!isAlreadyVisible) {
             // Show chat input using the same approach as working test
             chatInputSection.classList.add('show');
             chatInputSection.style.transform = 'translateY(0)';
             chatInputSection.style.opacity = '1';
             console.log('✅ Added "show" class and forced transform/opacity');
             console.log('🔍 Chat input section styles after showing:', {
                 transform: chatInputSection.style.transform,
                 opacity: chatInputSection.style.opacity,
                 classes: chatInputSection.className
             });
             
             // Hide FAB button completely
             fabContainer.style.opacity = '0';
             fabContainer.style.pointerEvents = 'none';
             fabContainer.style.transform = 'scale(0)';
             } else {
                 console.log('✅ Chat input already visible, just focusing input field');
             }
             
             // Reset input field to ensure consistent behavior (only if not already visible)
             if (inputField) {
                 if (!isAlreadyVisible) {
                 inputField.value = '';
                 inputField.style.height = '56px'; // Reset to original height
                 inputField.classList.remove('typing-active');
                 
                 // Reset send button state
                 const sendButton = document.getElementById('send-chat-button');
                 if (sendButton) {
                     console.log('🔍 Resetting send button state');
                     sendButton.style.opacity = '0';
                     sendButton.style.pointerEvents = 'none';
                     sendButton.style.transform = 'translateY(-50%) scale(0.75)';
                     sendButton.classList.remove('bg-black');
                     sendButton.classList.add('bg-gray-400');
                     
                     // Ensure send button is properly positioned and clickable
                     sendButton.style.position = 'absolute';
                     sendButton.style.zIndex = '20';
                     sendButton.style.right = '8px';
                     sendButton.style.top = '50%';
                     
                     console.log('🔍 Send button styles after reset:', {
                         opacity: sendButton.style.opacity,
                         pointerEvents: sendButton.style.pointerEvents,
                         transform: sendButton.style.transform,
                         position: sendButton.style.position,
                         zIndex: sendButton.style.zIndex
                     });
                 } else {
                     console.error('❌ Send button not found in showChatInput!');
                     }
                 }
             }
             
             // Focus the input field
             setTimeout(() => {
                 if (inputField) {
                     // Set flag to prevent auto-scrolling during user interaction
                     isUserInteracting = true;
                     
                     // Prevent scrolling to bottom when focusing input
                     // Store current scroll position
                     const currentScrollY = window.scrollY;
                     
                     // Focus the input without scrolling
                     inputField.focus({ preventScroll: true });
                     console.log('✅ Input field focused');
                     
                     // Restore scroll position if it changed
                     setTimeout(() => {
                         if (Math.abs(window.scrollY - currentScrollY) > 100) {
                             window.scrollTo(0, currentScrollY);
                         }
                     }, 50);
                 }
             }, 100);
             
             console.log('✅ Chat input shown and reset, FAB button hidden');
         }
         
         // Hide chat input and show FAB button
         function hideChatInput() {
             const chatInputSection = document.getElementById('chat-input-section');
             const fabContainer = document.getElementById('fab-container');
             
             // Hide chat input using the same approach as working test
             chatInputSection.classList.remove('show');
             chatInputSection.style.transform = 'translateY(100%)';
             chatInputSection.style.opacity = '0';
             
             // Show FAB button again
             fabContainer.style.opacity = '1';
             fabContainer.style.pointerEvents = 'auto';
             fabContainer.style.transform = 'scale(1)';
             
             // Show bottom navigation when chat input is hidden
             const bottomNav = document.getElementById('bottom-navigation');
             if (bottomNav) {
                 bottomNav.style.display = 'flex';
             }
             
             console.log('✅ Chat input hidden with transform/opacity, FAB button shown again');
         }
         
         // Ensure FAB button is always visible and properly styled
         function ensureFABVisible() {
             const fabContainer = document.getElementById('fab-container');
             const chatInputSection = document.getElementById('chat-input-section');
             
             if (fabContainer && chatInputSection) {
                 // If chat input is not visible, ensure FAB is visible
                 if (!chatInputSection.classList.contains('show')) {
                     fabContainer.style.opacity = '1';
                     fabContainer.style.pointerEvents = 'auto';
                     fabContainer.style.transform = 'scale(1)';
                     console.log('✅ FAB button visibility ensured');
                 }
             }
         }
         

         
         // Send custom question from chat input
         async function sendCustomQuestion() {
             console.log('🚀 sendCustomQuestion function called');
             
             // Get message from expanded input first, then fallback to regular input
             const expandedInput = document.getElementById('analysis-expanded-user-input');
             const regularInput = document.getElementById('chat-input-field');
             
             let inputField = expandedInput;
             let question = '';
             
             if (expandedInput && expandedInput.value.trim() !== '') {
                 question = expandedInput.value.trim();
                 console.log('📝 Using expanded input');
             } else if (regularInput && regularInput.value.trim() !== '') {
                 question = regularInput.value.trim();
                 inputField = regularInput;
                 console.log('📝 Using regular input');
             }
             
             if (!question) {
                 console.log('❌ No question entered');
                 return;
             }
             
             console.log('🎯 Sending custom question:', question);
             console.log('🔍 Current questionData:', questionData);
             console.log('🔍 Current subject:', currentSubject);
             console.log('🔍 Current conversationId:', currentConversationId);
             console.log('🔍 Conversation context:', getConversationContext());
             
             // Add custom question to conversation history
             addToConversationHistory('user', question, 'custom_question');
             
             // Add user message to chat display (left side, like helper questions)
             // First try to find chat-messages directly, then within detailed-analysis-section
             let chatMessages = document.getElementById('chat-messages');
             console.log('🔍 Looking for chat-messages element:', chatMessages);
             
             if (!chatMessages) {
                 const detailedAnalysisSection = document.getElementById('detailed-analysis-section');
                 console.log('🔍 detailed-analysis-section found:', detailedAnalysisSection);
                 if (detailedAnalysisSection) {
                     chatMessages = detailedAnalysisSection.querySelector('#chat-messages');
                     console.log('🔍 chat-messages found within detailed-analysis-section:', chatMessages);
                 }
             }
             
             if (!chatMessages) {
                 console.error('❌ Chat messages area not found in sendCustomQuestion');
                 console.log('🔍 Available elements with "chat" in ID:');
                 document.querySelectorAll('[id*="chat"]').forEach(el => {
                     console.log('  -', el.id, el.tagName, el.className);
                 });
                 return;
             }
             
             const userMessage = document.createElement('div');
             userMessage.className = 'chat-message user';
             userMessage.innerHTML = `<div class="message-bubble user">${question}</div>`;
             chatMessages.appendChild(userMessage);
             
             // Clear input field
             inputField.value = '';
             
             // Hide expanded input
             const expandedInputContainer = document.getElementById('analysis-expanded-input-container');
             if (expandedInputContainer) {
                 expandedInputContainer.classList.add('hidden');
                 expandedInputContainer.style.display = 'none';
             }
             
             // Show bottom navigation when input is hidden
             const bottomNav = document.getElementById('bottom-navigation');
             if (bottomNav) {
                 bottomNav.style.display = 'flex';
             }
             
             // Don't show user input immediately - wait for response completion
             // User input will be shown when response is complete for better UX
             
             // Hide FAB button during AI response for cleaner UX
             const fabContainer = document.getElementById('fab-container');
             if (fabContainer) {
                 fabContainer.style.opacity = '0';
                 fabContainer.style.pointerEvents = 'none';
                 fabContainer.style.transform = 'scale(0)';
                 console.log('✅ FAB button hidden during AI response');
             }
             
             // Show loading state for custom question (separate from helper questions)
             showCustomQuestionLoading(question);
             
             // Make API call to get help response with streaming effect
             try {
                 // Get detailed analysis content from conversation history
                 const detailedAnalysisContent = getDetailedAnalysisFromConversation();
                 
                 const requestBody = {
                     question: question,
                     subject: questionData?.subject || 'biology',
                     grade: questionData?.grade || 'دوم',
                     chapter: questionData?.chapter || '1',
                     originalAnalysis: detailedAnalysisContent,
                     conversationId: currentConversationId,
                     conversationContext: getConversationContext()
                 };
                 
                 console.log('📤 Making API call to /api/chat/custom-question/stream');
                 console.log('📤 Request body:', requestBody);
                 
                 const response = await fetch('/api/chat/custom-question/stream', {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json',
                     },
                     body: JSON.stringify(requestBody)
                 });
                 
                 console.log('📥 API response received:', response);
                 console.log('📥 Response status:', response.status);
                 console.log('📥 Response headers:', response.headers);
                 
                 if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                 }
                 
                 console.log('✅ API response received, starting streaming...');
                 
                 // Handle streaming response with real-time updates
                 await streamCustomQuestionResponse(response, question);
                 
             } catch (error) {
                 console.error('❌ Error getting custom question response:', error);
                 console.error('❌ Error details:', error.message, error.stack);
                 showCustomQuestionError(question, error.message);
             }
         }
         
         // Show loading state for custom question (separate from helper questions)
         function showCustomQuestionLoading(question) {
             // Add AI loading message to chat display (below the user's custom question)
             // First try to find chat-messages directly, then within detailed-analysis-section
             let chatMessages = document.getElementById('chat-messages');
             if (!chatMessages) {
                 const detailedAnalysisSection = document.getElementById('detailed-analysis-section');
                 if (detailedAnalysisSection) {
                     chatMessages = detailedAnalysisSection.querySelector('#chat-messages');
                 }
             }
             
             if (!chatMessages) {
                 console.error('❌ Chat messages area not found in showCustomQuestionLoading');
                 return;
             }
             
             const aiLoadingMessage = document.createElement('div');
             aiLoadingMessage.className = 'chat-message ai loading-message';
             aiLoadingMessage.id = `custom-ai-loading-${Date.now()}`; // Unique ID for custom questions
             aiLoadingMessage.innerHTML = `
                 <div class="message-bubble ai">
                     <div class="flex items-center space-x-2 space-x-reverse">
                         <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                         <span class="text-gray-600">در حال پاسخ...</span>
                     </div>
                 </div>
             `;
             
             chatMessages.appendChild(aiLoadingMessage);
             
             // Scroll to the new content
             aiLoadingMessage.scrollIntoView({ behavior: 'smooth' });
             
             console.log('✅ Loading message created with ID:', aiLoadingMessage.id);
         }
         
         // Stream custom question response with real-time updates
         async function streamCustomQuestionResponse(response, question) {
             console.log('🚀 Starting to stream custom question response...');
             
             const reader = response.body.getReader();
             const decoder = new TextDecoder();
             let fullResponse = '';
             
             // Find the existing AI loading message for custom questions (unique ID)
             // Use the most recent loading message
             const aiLoadingMessage = document.querySelector('.loading-message:last-of-type');
             
             if (!aiLoadingMessage || !aiLoadingMessage.classList.contains('ai')) {
                 console.error('❌ AI loading message not found for streaming');
                 return;
             }
             
             console.log('🎯 Found loading message for streaming:', aiLoadingMessage.id);
             
             try {
                 while (true) {
                     const { done, value } = await reader.read();
                     
                     if (done) break;
                     
                     const chunk = decoder.decode(value);
                     const lines = chunk.split('\n');
                     
                     for (const line of lines) {
                         if (line.startsWith('data: ')) {
                             const data = line.slice(6);
                             
                             if (data === '[DONE]') {
                                 // Final formatting and display
                                 displayCustomQuestionResponse(question, fullResponse, aiLoadingMessage);
                                 return;
                             }
                             
                             try {
                                 const parsed = JSON.parse(data);
                                 if (parsed.content && parsed.type === 'chunk') {
                                     fullResponse += parsed.content;
                                     
                                     // Update immediately for real-time rendering during streaming
                                     updateCustomQuestionResponseStreaming(question, fullResponse, aiLoadingMessage);
                                 }
                             } catch (e) {
                                 // Ignore parsing errors for incomplete chunks
                             }
                         }
                     }
                 }
             } catch (error) {
                 console.error('Streaming error:', error);
                 showCustomQuestionError(question, error.message);
                 
                 // Show user input after streaming error for retry
                 const chatInputSection = document.getElementById('chat-input-section');
                 if (chatInputSection) {
                     chatInputSection.classList.remove('translate-y-full', 'opacity-0');
                     chatInputSection.classList.add('show');
                     chatInputSection.style.transform = 'translateY(0)';
                     chatInputSection.style.opacity = '1';
                     chatInputSection.style.display = 'block';
                     console.log('✅ Chat input shown after streaming error');
                 }
                 
                 // Hide FAB button when chat input is shown
                 const fabContainer = document.getElementById('fab-container');
                 if (fabContainer) {
                     fabContainer.style.opacity = '0';
                     fabContainer.style.pointerEvents = 'none';
                     fabContainer.style.transform = 'scale(0)';
                     console.log('✅ FAB button hidden after streaming error');
                 }
             }
         }
         
         // Update custom question response in real-time with streaming effect
         function updateCustomQuestionResponseStreaming(question, response, aiLoadingMessage) {
             // Update the loading message with streaming content in real-time
             // Use the same simple approach as detailed analysis
             const messageBubble = aiLoadingMessage.querySelector('.message-bubble.ai');
             if (messageBubble) {
                 // Simple streaming update using the same system as detailed analysis
                 messageBubble.innerHTML = formatStreamingChunk(response);
                 
                 console.log('✅ Streaming update applied to message bubble:', aiLoadingMessage.id);
             } else {
                 console.error('❌ Message bubble not found in updateCustomQuestionResponseStreaming');
             }
             
             console.log('✅ Streaming update for custom question:', question, response.length);
         }
         
         // Update custom question response in real-time (legacy function)
         function updateCustomQuestionResponse(question, response) {
             // This can be used for real-time updates if needed
             console.log('Updating custom response for:', question, response.length);
         }
         
         // Display final custom question response with streaming effect
         function displayCustomQuestionResponse(question, response, aiLoadingMessage) {
             // Add AI response to conversation history
             addToConversationHistory('assistant', response, 'custom_response');
             
            // Update the existing loading message with the final formatted response
            // Use the simple helper question formatting (bullet points and numbered lists only)
            const messageBubble = aiLoadingMessage.querySelector('.message-bubble.ai');
            if (messageBubble) {
                // Simple final display with bullet points and numbered lists only
                messageBubble.innerHTML = formatHelperQuestionResponse(response);
                
                // Process MathJax for the message bubble
                setTimeout(() => {
                    processMathJax(messageBubble);
                }, 200);
            }
            
            // Save the updated conversation to database
            saveDetailedAnalysisToDatabase('Updated conversation with custom question');
             
             // Show user input when response is complete for better UX
             const chatInputSection = document.getElementById('chat-input-section');
             if (chatInputSection) {
                 // Remove hidden classes and add show class
                 chatInputSection.classList.remove('translate-y-full', 'opacity-0');
                 chatInputSection.classList.add('show');
                 chatInputSection.style.transform = 'translateY(0)';
                 chatInputSection.style.opacity = '1';
                 chatInputSection.style.display = 'block';
                 console.log('✅ Chat input shown after response completion');
             }
             
             // Hide bottom navigation when user input appears
             const bottomNav = document.getElementById('bottom-navigation');
             if (bottomNav) {
                 bottomNav.style.display = 'none';
             }
             
             // Hide FAB button when chat input is shown
             const fabContainer = document.getElementById('fab-container');
             if (fabContainer) {
                 fabContainer.style.opacity = '0';
                 fabContainer.style.pointerEvents = 'none';
                 fabContainer.style.transform = 'scale(0)';
                 console.log('✅ FAB button hidden after response completion');
             }
             
             console.log('✅ Custom question response displayed and saved to library');
         }
         
         // Show error for custom question
         function showCustomQuestionError(question, errorMessage) {
             // Find the existing AI loading message for custom questions and show error
             const aiLoadingMessage = document.querySelector('.loading-message:last-of-type');
             if (!aiLoadingMessage) return;
             
             const messageBubble = aiLoadingMessage.querySelector('.message-bubble.ai');
             if (messageBubble) {
                 messageBubble.innerHTML = `
                     <div class="text-red-500 text-center">
                         <p class="text-sm">خطا: ${errorMessage}</p>
                     </div>
                 `;
             }
             
             // Ensure FAB button is visible after error
             setTimeout(() => {
                 ensureFABVisible();
             }, 100);
         }
         
                   // Handle Enter key in chat input
          document.addEventListener('DOMContentLoaded', function() {
              // Initialize conversation history system
              initializeConversation();
              
              // FAB button will be shown only when helper questions are sent
              // ensureFABVisible(); // Keep hidden until helper questions are used
              
                           // Add mobile touch event handling for FAB button
             const fabButton = document.getElementById('fab-button');
             if (fabButton) {
                 // Simplified mobile touch handling - no preventDefault
                 fabButton.addEventListener('touchstart', function(e) {
                     console.log('📱 Mobile touch detected on FAB button');
                     // Small delay to ensure touch is registered
                     setTimeout(() => {
                         toggleChatInput();
                     }, 50);
                 }, { passive: true });
                 
                 // Also keep click for desktop
                 fabButton.addEventListener('click', function(e) {
                     console.log('🖱️ Desktop click detected on FAB button');
                     toggleChatInput();
                 });
                 
                 // Add touchend as backup for mobile
                 fabButton.addEventListener('touchend', function(e) {
                     console.log('📱 Mobile touch ended on FAB button');
                 });
             }
             
             // Setup send button functionality
             const sendButton = document.getElementById('send-chat-button');
             if (sendButton) {
                 console.log('🔍 Send button found during initialization');
                 
                 // Remove any existing event listeners
                 sendButton.replaceWith(sendButton.cloneNode(true));
                 const newSendButton = document.getElementById('send-chat-button');
                 
                 // Add proper event listeners for both desktop and mobile
                 newSendButton.addEventListener('click', function(e) {
                     console.log('🖱️ Send button clicked (desktop)');
                     e.preventDefault();
                     e.stopPropagation();
                     sendCustomQuestion();
                 });
                 
                 newSendButton.addEventListener('touchstart', function(e) {
                     console.log('📱 Send button touched (mobile)');
                     e.preventDefault();
                     e.stopPropagation();
                     sendCustomQuestion();
                 });
                 
                 newSendButton.addEventListener('touchend', function(e) {
                     console.log('📱 Send button touch ended (mobile)');
                 });
                 
                 console.log('✅ Send button event listeners properly set up');
             } else {
                 console.error('❌ Send button not found during initialization!');
             }
             
             // Log device type for debugging
             if ('ontouchstart' in window) {
                 console.log('📱 Mobile device detected');
             } else {
                 console.log('🖥️ Desktop device detected');
             }
              
              const chatInputField = document.getElementById('chat-input-field');
              if (chatInputField) {
                  chatInputField.addEventListener('keypress', function(e) {
                      if (e.key === 'Enter') {
                          sendCustomQuestion();
                      }
                  });
              }
              
              // Close chat input when clicking outside
              document.addEventListener('click', function(e) {
                  const chatInputSection = document.getElementById('chat-input-section');
                  const fabButton = document.getElementById('fab-button');
                  const fabContainer = document.getElementById('fab-container');
                  const expandedInput = document.getElementById('analysis-expanded-input-container');
                  
                  if (chatInputSection && chatInputSection.classList.contains('show')) {
                      if (!chatInputSection.contains(e.target) && !fabButton.contains(e.target)) {
                          hideChatInput();
                          console.log('✅ Chat input closed (clicked outside), FAB button shown again');
                      }
                  }
                  
                  // Close expanded input when clicking outside
                  if (expandedInput && expandedInput.style.display === 'block') {
                      if (!expandedInput.contains(e.target)) {
                          expandedInput.classList.add('hidden');
                          expandedInput.style.display = 'none';
                          
                          // Show bottom navigation when expanded input is hidden
                          const bottomNav = document.getElementById('bottom-navigation');
                          if (bottomNav) {
                              bottomNav.style.display = 'flex';
                          }
                          
                          console.log('✅ Expanded input closed (clicked outside), navigation shown');
                      }
                  }
              });
          });
          
                   // Auto-resize textarea function with proper send button handling
         function autoResize(textarea) {
             console.log('📝 autoResize called with value:', textarea.value);
             
             textarea.style.height = 'auto';
             textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
             
             // Update button color and visibility based on typing
             const sendButton = document.getElementById('send-chat-button');
             if (!sendButton) {
                 console.error('❌ Send button not found in autoResize!');
                 return;
             }
             
             if (textarea.value.trim() !== '') {
                 console.log('✅ Text detected, showing send button');
                 textarea.classList.add('typing-active');
                 
                 // Change button color
                 sendButton.classList.remove('bg-gray-400');
                 sendButton.classList.add('bg-black');
                 
                 // Show send button when typing
                 sendButton.style.opacity = '1';
                 sendButton.style.pointerEvents = 'auto';
                 sendButton.style.transform = 'translateY(-50%) scale(1)';
                 sendButton.style.cursor = 'pointer';
                 sendButton.style.zIndex = '20';
                 
                 console.log('🔍 Send button styles after showing:', {
                     opacity: sendButton.style.opacity,
                     pointerEvents: sendButton.style.pointerEvents,
                     transform: sendButton.style.transform,
                     cursor: sendButton.style.cursor,
                     zIndex: sendButton.style.zIndex
                 });
                 
                 // Test if button is now clickable
                 console.log('🧪 Send button should now be clickable');
             } else {
                 console.log('❌ No text, hiding send button');
                 textarea.classList.remove('typing-active');
                 
                 // Change button color back
                 sendButton.classList.remove('bg-black');
                 sendButton.classList.add('bg-gray-400');
                 
                 // Hide send button when no text
                 sendButton.style.opacity = '0';
                 sendButton.style.pointerEvents = 'none';
                 sendButton.style.transform = 'translateY(-50%) scale(0.75)';
                 
                 console.log('🔍 Send button hidden');
             }
         }
          
                   // Function to handle input focus - make button black immediately
         function handleInputFocus(textarea) {
             console.log('🎯 Input focused, showing expanded input');
             
             // Hide the regular chat input section
             const chatInputSection = document.getElementById('chat-input-section');
             if (chatInputSection) {
                 chatInputSection.style.display = 'none';
             }
             
             // Show bottom navigation when chat input is hidden
             const bottomNav = document.getElementById('bottom-navigation');
             if (bottomNav) {
                 bottomNav.style.display = 'flex';
             }
             
             // Show expanded input
             const expandedInput = document.getElementById('analysis-expanded-input-container');
             if (expandedInput) {
                 expandedInput.classList.remove('hidden');
                 expandedInput.style.display = 'block';
             }
             
             // Hide bottom navigation when input appears
             bottomNav.style.display = 'none';
             
            // Focus on the expanded textarea
            setTimeout(() => {
                const expandedTextarea = document.getElementById('analysis-expanded-user-input');
                if (expandedTextarea) {
                    expandedTextarea.focus();
                    
                    // Add input event listener for send button color
                    expandedTextarea.addEventListener('input', () => {
                        const sendButton = document.getElementById('analysis-send-button');
                        if (sendButton) {
                            if (expandedTextarea.value.trim()) {
                                // User is typing - make button black
                                sendButton.classList.remove('bg-gray-400');
                                sendButton.classList.add('bg-black');
                            } else {
                                // No text - make button pale gray
                                sendButton.classList.remove('bg-black');
                                sendButton.classList.add('bg-gray-400');
                            }
                        }
                    });
                }
            }, 100);
         }
          
         // Handle Enter key in expanded input
         function handleAnalysisExpandedInputKeyDown(event) {
             if (event.key === 'Enter' && !event.shiftKey) {
                 event.preventDefault();
                 sendCustomQuestion();
             }
         }
          
                   // Function to handle input blur - make button gray if no text
         function handleInputBlur(textarea) {
             console.log('🎯 Input blur, checking if should hide send button');
             
             // Reset flag after user interaction
             setTimeout(() => {
                 isUserInteracting = false;
             }, 1000); // Give some time for any pending operations
             
             if (textarea.value.length === 0) {
                 const sendButton = document.getElementById('send-chat-button');
                 if (sendButton) {
                     sendButton.classList.remove('bg-black');
                     sendButton.classList.add('bg-gray-400');
                     textarea.classList.remove('typing-active');
                     
                     // Hide send button when no text
                     sendButton.style.opacity = '0';
                     sendButton.style.pointerEvents = 'none';
                     sendButton.style.transform = 'translateY(-50%) scale(0.75)';
                     
                     console.log('✅ Send button hidden on blur (no text)');
                 }
             } else {
                 console.log('ℹ️ Text still present, keeping send button visible');
             }
              
              // Auto-hide chat input after a delay if no text
              setTimeout(() => {
                  if (textarea.value.length === 0) {
                      const chatInputSection = document.getElementById('chat-input-section');
                      const fabContainer = document.getElementById('fab-container');
                      
                      if (chatInputSection.classList.contains('show')) {
                          chatInputSection.classList.remove('show');
                          
                          // Show FAB button again
                          fabContainer.style.opacity = '1';
                          fabContainer.style.pointerEvents = 'auto';
                          fabContainer.style.transform = 'scale(1)';
                          
                          console.log('✅ Chat input auto-hidden, FAB button shown again');
                      }
                  }
              }, 2000); // 2 second delay
          }
        

        
        // ========================================
        // END OF FAB FUNCTIONS
         
         // Microphone/Recorder Functions
         function toggleMicrophone() {
             console.log('🎤 Microphone button clicked');
             // Placeholder for microphone functionality
             // This would integrate with speech recognition API
         }
         
         // Voice recording function
         function startRecording() {
             console.log('🎤 Starting voice recording...');
             alert('Voice recording feature (to be implemented)');
         }
         
         function attachDocument() {
             console.log('📄 Attaching document...');
             alert('Document attachment feature (to be implemented)');
         }
         
        // ========================================
    </script>
</body>
</html>

