<!DOCTYPE html>
<html lang="en" class="no-scroll">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#191b1a">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" as="style">
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    
    <!-- Preload other pages for faster navigation -->
    <link rel="prefetch" href="test.html">
    <link rel="prefetch" href="question-analysis.html">
    <link rel="prefetch" href="chapters.html">
    <link rel="prefetch" href="analysis-results.html">
    
    <!-- Apple Touch Icons for iOS -->
    <!-- <link rel="apple-touch-icon" href="/icon-192.png"> -->
    <!-- <link rel="apple-touch-icon" sizes="152x152" href="/icon-192.png"> -->
    <!-- <link rel="apple-touch-icon" sizes="180x180" href="/icon-192.png"> -->
    <!-- <link rel="apple-touch-icon" sizes="167x167" href="/icon-192.png"> -->
    
    <!-- Web App Manifest for mobile app-like experience -->
    <!-- <link rel="manifest" href="/manifest.json"> -->
    
    <title>ŸÖŸêŸÜŸà - €åÿßÿØ⁄Ø€åÿ±€å ŸáŸàÿ¥ŸÖŸÜÿØ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'meno-blue': '#3B82F6',
                        'meno-gray': '#6B7280',
                        'meno-light-gray': '#F3F4F6'
                    }
                }
            }
        }
    </script>
    <style>
        /* Critical CSS for mobile performance */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        /* Allow text selection for chat messages and content */
        .chat-messages, .chat-messages *, .ai-message, .user-message, p, div[dir="rtl"] {
            -webkit-user-select: text;
            user-select: text;
            -webkit-touch-callout: default;
        }
        
        /* Keep inputs and textareas selectable */
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
        
        /* Keep buttons and clickable elements non-selectable for mobile UX */
        button, .clickable, .subject-icon, nav, .bottom-navigation {
            -webkit-user-select: none;
            user-select: none;
        }
        
        html, body {
            font-family: 'Vazirmatn', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            background-color: #F8F9FA !important;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior: none;
        }
        
        .chat-container {
            min-height: 400px; /* Ensure minimum height for content */
            padding-bottom: 20px;
        }
        
        /* Fix input bar layout */
        .input-bar {
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            height: 55px;
            border-radius: 9999px;
            background-color: #c0c0c0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .user-input-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            margin-top: auto;
            margin-bottom: 2rem;
        }
        
        /* Ensure proper spacing between elements */
        .main {
            padding-top: 5rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .ai-message-font {
            font-size: 18px !important;
        }
        
        /* Ensure chat messages are selectable and copyable */
        .chat-messages {
            -webkit-user-select: text;
            user-select: text;
            cursor: text;
        }
        
        .chat-messages .message-bubble {
            -webkit-user-select: text;
            user-select: text;
            cursor: text;
        }
        
        .chat-messages p, .chat-messages li, .chat-messages div {
            -webkit-user-select: text;
            user-select: text;
            cursor: text;
        }
        
        /* Make sure AI responses are selectable */
        .ai-response, .ai-message, .ai-content {
            -webkit-user-select: text;
            user-select: text;
            cursor: text;
        }
        
        /* Fix icon layout and spacing */
        .icons-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .icon-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease;
            background: transparent;
            border: none;
            cursor: pointer;
        }
        
        .icon-button:hover {
            background-color: rgba(0, 0, 0, 0.05);
            transform: scale(1.05);
        }
        
        .icon-button:active {
            transform: scale(0.95);
        }
        
        /* Responsive icon spacing */
        @media (max-width: 640px) {
            .icons-container {
                gap: 1.5rem;
                margin-top: 1.5rem;
            }
            
            .icon-button {
                padding: 0.5rem;
            }
            
            .icon-button svg {
                width: 1.25rem;
                height: 1.25rem;
            }
        }
        
        /* Basic chat styling - clean slate for new system */
        .chat-messages {
            line-height: 1.6;
        }
        
        .chat-messages p {
            margin-bottom: 1rem;
        }
        
        /* Mobile touch optimizations */
        button, .clickable {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s ease;
        }
        
        button:active, .clickable:active {
            transform: scale(0.95);
        }
        
        /* Prevent zoom on input focus for mobile */
        input[type="text"], input[type="email"], textarea {
            font-size: 16px !important;
        }
        
        /* Mobile scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        
        /* Hidden class for elements */
        .hidden {
            display: none !important;
        }
        
        /* Subject icons styling */
        .subject-icon {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .subject-icon:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .subject-icon:active {
            transform: scale(0.95);
        }
        
        /* Ensure the test icon is always clickable */
        nav button[onclick*="goToTest"] {
            z-index: 102;
            pointer-events: auto !important;
        }
        

        
        .typewriter {
            overflow: hidden;
            border-right: 2px solid #3B82F6;
            white-space: nowrap;
            animation: typing 3.5s steps(40, end), blink-caret 0.75s step-end infinite;
        }
        
        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }
        
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: #3B82F6 }
        }

        /* Chat message content styling */
        .chat-message p {
            margin-bottom: 0.5rem;
        }

        .chat-message ul {
            margin: 0.5rem 0;
            padding-right: 1.5rem;
        }

        .chat-message li {
            
        /* Mathematical formulas styling - SymPy removed for deployment */
        .math-formula {
            font-family: 'Times New Roman', serif;
            font-size: 18px;
            color: #1e293b;
            background: #f8fafc;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            display: inline-block;
            margin: 4px 0;
        }
        
        .math-display {
            text-align: center !important;
            margin: 1rem 0 !important;
            font-size: 1.2em !important;
            font-family: 'Times New Roman', serif !important;
            color: #1f2937 !important;
        }
        
        .math-error {
            color: #dc2626 !important;
            font-style: italic !important;
            background-color: #fef2f2 !important;
            padding: 0.25rem 0.5rem !important;
            border-radius: 0.25rem !important;
        }
            margin-bottom: 0.3rem;
        }

        /* Bullet points and numbered lists styling */
        .ml-auto ul {
            list-style-type: disc;
            padding-right: 1.5rem;
            margin: 0.5rem 0;
        }

        .ml-auto ol {
            list-style-type: decimal;
            padding-right: 1.5rem;
            margin: 0.5rem 0;
        }

        .ml-auto li {
            margin-bottom: 0.3rem;
            text-align: right;
        }

        /* Advanced AI list styling */
        .ai-list {
            list-style: none;
            padding: 0;
            margin: 0.5rem 0;
        }

        .ai-list .list-item {
            position: relative;
            padding-right: 1.5rem;
            margin-bottom: 0.5rem;
            text-align: right;
        }

        .ai-list .list-item:before {
            content: "‚Ä¢";
            position: absolute;
            right: 0;
            top: 0;
            color: #6B7280;
            font-weight: bold;
        }

        /* Mathematical symbols styling */
        .math-symbol {
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            color: #1F2937;
        }

        /* Advanced AI list styling */
        .ai-list {
            list-style: none;
            padding: 0;
            margin: 0.5rem 0;
        }

        .ai-list .list-item {
            position: relative;
            padding-right: 1.5rem;
            margin-bottom: 0.5rem;
            text-align: right;
        }

        .ai-list .list-item:before {
            content: "‚Ä¢";
            position: absolute;
            right: 0;
            top: 0;
            color: #6B7280;
            font-weight: bold;
        }

        /* Mathematical symbols styling */
        .math-symbol {
            font-family: 'Times New Roman', serif;
            font-weight: bold;
            color: #1F2937;
        }

        /* Emoji styling */
        .ml-auto span[class*="emoji"] {
            font-size: 1.1em;
            margin: 0 0.2rem;
        }



        /* AI message right alignment */
        .ml-auto {
            text-align: right;
        }
        
        .ml-auto p, .ml-auto div, .ml-auto span {
            text-align: right;
        }
        
        .ml-auto ul, .ml-auto ol {
            text-align: right;
        }
        
        .chat-message li {
            margin-bottom: 0.3rem;
        }

        /* Bullet point styling for chat messages */
        .chat-message p:contains('‚Ä¢') {
            margin-right: 1rem;
        }

        /* Welcome message styling */
        .welcome-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            pointer-events: none;
            width: 100%;
            text-align: center;
        }

        /* Educational background styling */
        body {
            background: #dcdcdc !important;
            position: relative;
            transition: background-color 0.3s ease;
        }

        /* Professional Scientific Background */
        .scientific-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 1;
            transition: opacity 0.8s ease;
            background: #dcdcdc !important;
        }

        .scientific-background.chat-mode {
            opacity: 0;
        }

        /* Professional Formula Styling */
        .formula-section {
            position: absolute;
            font-family: 'Times New Roman', serif;
            color: rgba(156, 163, 175, 0.15);
            font-size: 1rem;
            line-height: 1.6;
            text-align: center;
            transition: all 0.3s ease;
        }

        .formula-section:hover {
            color: rgba(156, 163, 175, 0.25);
            transform: scale(1.02);
        }

        /* Scattered Formula Positions */
        .formula-top-left {
            top: 8%;
            left: 8%;
            transform: rotate(-3deg);
        }

        .formula-top-right {
            top: 10%;
            right: 10%;
            transform: rotate(4deg);
        }

        .formula-middle-left {
            top: 35%;
            left: 8%;
            transform: rotate(-2deg);
        }

        .formula-middle-right {
            top: 40%;
            right: 8%;
            transform: rotate(3deg);
        }

        .formula-bottom {
            bottom: 8%;
            left: 50%;
            transform: translateX(-50%) rotate(1deg);
        }

        /* Additional scattered positions */
        .formula-top-center {
            top: 15%;
            left: 50%;
            transform: translateX(-50%) rotate(0deg);
        }

        .formula-center-left {
            top: 50%;
            left: 5%;
            transform: translateY(-50%) rotate(-1deg);
        }

        .formula-center-right {
            top: 50%;
            right: 5%;
            transform: translateY(-50%) rotate(2deg);
        }

        .formula-bottom-left {
            bottom: 15%;
            left: 15%;
            transform: rotate(-2deg);
        }

        .formula-bottom-right {
            bottom: 12%;
            right: 15%;
            transform: rotate(3deg);
        }

        .formula-random-1 {
            top: 25%;
            left: 25%;
            transform: rotate(1deg);
        }

        .formula-random-2 {
            top: 65%;
            left: 30%;
            transform: rotate(-1deg);
        }

        .formula-random-3 {
            top: 30%;
            right: 25%;
            transform: rotate(2deg);
        }

        .formula-random-4 {
            top: 70%;
            right: 30%;
            transform: rotate(-2deg);
        }

        /* Mathematical Notation */
        .math-formula {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            margin: 0.2rem 0;
        }

        .math-sup {
            font-size: 0.7em;
            vertical-align: super;
        }

        .math-sub {
            font-size: 0.7em;
            vertical-align: sub;
        }

        .math-sqrt {
            text-decoration: overline;
            text-decoration-thickness: 1px;
        }

        .math-frac {
            display: inline-block;
            vertical-align: middle;
            text-align: center;
        }

        .math-frac .numerator {
            border-bottom: 1px solid currentColor;
            padding-bottom: 1px;
            margin-bottom: 1px;
        }

        /* Chemical Notation */
        .chem-formula {
            font-family: 'Times New Roman', serif;
            font-weight: normal;
        }

        .chem-sub {
            font-size: 0.7em;
            vertical-align: sub;
        }

        /* Graph Elements */
        .graph-element {
            position: relative;
            display: inline-block;
            margin: 0.3rem 0;
        }

        .graph-line {
            width: 40px;
            height: 2px;
            background: currentColor;
            margin: 0.2rem auto;
            position: relative;
        }

        .graph-line::before {
            content: '';
            position: absolute;
            top: -2px;
            left: 0;
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, transparent 0%, currentColor 50%, transparent 100%);
        }

        body.chat-mode {
            background: #dcdcdc !important;
        }

        /* Centered Welcome Text */
        .welcome-center {
            position: absolute;
            top: 30%;
            left: 40%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 2;
            pointer-events: none;
        }

        .welcome-center h1 {
            font-family: 'Times New Roman', serif;
            color: rgba(156, 163, 175, 0.4);
            font-weight: 300;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
            transition: opacity 0.8s ease;
            font-size: 2rem;
        }

        .chat-mode .welcome-center {
            opacity: 0;
        }

        /* Chat container initial state */
        .chat-container.no-scroll {
            overflow: hidden !important;
            max-height: 100vh;
        }

        /* Chat container when scrolling enabled */
        .chat-container {
            min-height: 200px;
            max-height: none; /* Allow full page scroll */
            padding-bottom: 100px; /* Space above the input bar */
            overflow-y: visible; /* Allow content to flow naturally */
            margin-bottom: 0;
            margin-top: 0;
        }
        
        /* Enhanced chat container spacing */
        .chat-container {
            padding-bottom: 100px; /* Space above the input bar */
            margin-bottom: 0;
        }
        
        /* Ensure chat messages are properly spaced and visible */
        .chat-message {
            margin-bottom: 1.5rem;
        }
        
        /* Ensure the last message has proper bottom spacing */
        .chat-message:last-child {
            margin-bottom: 2rem;
        }
        
        /* User input container - integrated into main page */
        .user-input-container {
            /* No background color - inherits from main page */
            /* No fixed positioning - flows naturally in main page */
            background: transparent !important;
            position: relative !important;
            width: 99.99% !important;
            max-width: 800px !important;
            margin: 0 auto !important;
            margin-top: auto !important;
            margin-bottom: 2rem !important;
        }
        
        /* Main container */
        
        /* Spinning logo for AI response waiting */
        .spinning-logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .thinking-text {
            font-size: 1.1rem;
            color: #6B7280;
            font-weight: 500;
        }
        
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Main container - single version */
        main {
            overflow-y: visible;
            height: auto;
            background-color: #dcdcdc !important;
            min-height: 100vh;
            display: flex !important;
            flex-direction: column !important;
        }

        /* User input - single version */
        .user-input {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-family: 'Vazirmatn', 'Inter', sans-serif;
            font-size: 16px;
            line-height: 1.5;
            min-height: 40px;
            max-height: 120px;
            width: 100%;
            color: #000000 !important; /* Pure black text */
        }

        .user-input:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Mobile optimization */
        @media (max-width: 640px) {
            .user-input {
                font-size: 16px;
                padding: 12px 16px;
                border-radius: 8px;
                min-height: 40px;
            }
        }

        .transform-scale-75 {
            transform: scale(0.75);
        }

        .transform-scale-100 {
            transform: scale(1);
        }

        /* Welcome text styles */
        .welcome-text {
            font-family: 'Vazirmatn', 'Inter', sans-serif;
            font-weight: 300;
            color: #9ca3af;
            text-align: center;
            line-height: 1.6;
        }
        /* Mobile Performance Optimizations */
        @media (max-width: 768px) {
            /* Optimize animations for mobile */
            * {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
                -webkit-backface-visibility: hidden;
                backface-visibility: hidden;
            }
            
            /* Reduce motion for better performance */
            .chat-message,
            .user-input,
            .send-button {
                transition: all 0.2s ease;
            }
            
            /* Optimize scrolling */
            .chat-container {
                -webkit-overflow-scrolling: touch;
                overflow-scrolling: touch;
            }
        }
        
        /* Critical CSS for above-the-fold content */
        .welcome-center,
        .user-input-container {
            will-change: transform;
            transform: translateZ(0);
        }
        /* User input container - integrated into main page */
        .user-input-container {
            margin: 2rem auto; /* Proper spacing within main page */
            width: 60%;
            max-width: 400px;
        }
        
        /* Input bar styling - exact specifications */
        .input-bar {
            background-color: #f5f5f5 !important; /* Light gray background color */
            border-radius: 9999px !important; /* Proper oval shape like chapter buttons */
            height: 55px !important; /* Increased height for better usability */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        /* Input field styling */
        #user-input {
            font-family: 'Inter', 'Roboto', sans-serif !important;
            font-size: 16px !important; /* Original font size */
            color: #000000 !important; /* Pure black */
            text-align: center !important;
            line-height: 20px !important;
        }
        
        #user-input::placeholder {
            color: #1e1e1e !important; /* Dark gray for placeholder */
        }
        
        /* Force text color for user input content */
        #user-input:focus {
            color: #000000 !important;
        }
        
        #user-input:active {
            color: #000000 !important;
        }
        
        /* Icons container styling */
        .icons-container {
            margin-top: 32px; /* Original spacing */
            gap: 3rem !important; /* Increased space between icons */
        }
        
        /* Icon button styling */
        .icon-button {
            transition: all 0.2s ease;
            border-radius: 50%;
            padding: 8px; /* Original padding */
        }
        
        .icon-button:hover {
            background-color: rgba(156, 163, 175, 0.1);
            transform: scale(1.05);
        }
        
        .icon-button:active {
            transform: scale(0.95);
        }
        
        /* Ensure content area takes available space */
        main > div:first-child {
            flex: 1 !important;
        }
        
        /* User input container - single version */
        .user-input-container {
            margin: 2rem auto;
            width: 60%;
            max-width: 400px;
            background: transparent !important;
            position: relative !important;
            pointer-events: auto !important;
            z-index: 10 !important;
        }
        
        /* Input bar styling - single version */
        .input-bar {
            background-color: #c0c0c0 !important;
            border-radius: 9999px !important;
            height: 55px !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        /* User input textarea - single version */
        #user-input {
            cursor: text !important;
            pointer-events: auto !important;
            position: relative !important;
            z-index: 10 !important;
            background-color: transparent !important;
            border: none !important;
            outline: none !important;
        }
        
        #user-input:focus {
            outline: none !important;
            border: none !important;
            box-shadow: none !important;
        }
    </style>
</head>
    <body style="background-color: #F8F9FA;">
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 bg-white/80 backdrop-blur-sm border-b border-gray-200 z-50">
        <div class="flex justify-between items-center px-4 sm:px-6 py-3">
            <!-- Left: Menu Icon -->
            <div class="flex items-center">
                <button class="p-2 hover:bg-gray-100 rounded-lg transition-colors" onclick="resetPageToInitialState()" title="Menu">
                <div class="flex flex-col space-y-1">
                        <div class="w-5 h-0.5 bg-gray-600"></div>
                        <div class="w-4 h-0.5 bg-gray-600"></div>
                        <div class="w-3 h-0.5 bg-gray-600"></div>
                </div>
                </button>
            </div>
            
            <!-- Center: App Title -->
            <div class="absolute left-1/2 transform -translate-x-1/2">
                <h1 class="text-lg sm:text-xl font-semibold text-gray-800">ŸÖŸêŸÜŸà</h1>
            </div>
            
            <!-- Right: Settings/Profile -->
            <div class="flex items-center space-x-4">
                <button class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Settings">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Chat Container -->
            <main class="pt-24 px-4 sm:px-6 relative flex flex-col" style="background-color: #F8F9FA; min-height: 100vh; z-index: 1;">
        <div class="max-w-4xl mx-auto flex-1">
            <!-- Chat Messages Container -->
            <div id="chat-messages" class="chat-container space-y-6 hidden" style="padding-bottom: 100px;">
                <!-- Messages will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- User Input - Integrated at bottom of main page -->
        <div class="user-input-container mx-auto mt-auto mb-8" style="width: 99.99%; max-width: 800px;">
            <!-- Input Bar (Search Bar) -->
            <div class="input-bar bg-[#c0c0c0] rounded-full shadow-lg flex items-center px-6 py-3" style="height: 55px; border-radius: 9999px;">
                <!-- Left: Microphone Icon -->
                <button class="p-1 text-[#9CA3AF] hover:text-gray-600 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                    </svg>
                </button>
                
                <!-- Center: Input Field -->
                <div class="flex-1 mx-4">
                    <textarea 
                        id="user-input" 
                        class="w-full bg-transparent border-none resize-none focus:outline-none text-[#000000] text-center font-sans text-base placeholder-[#1e1e1e]"
                        placeholder="...Ask anything"
                        rows="1"
                        oninput="autoResize(this)"
                        onkeydown="handleKeyDown(event, this)"
                        onclick="showExpandedInput()"
                        style="min-height: 20px; max-height: 120px; line-height: 20px; cursor: text;"
                    ></textarea>
                </div>
                
                <!-- Right: Magnifying Glass Icon -->
                <button class="p-1 text-[#1E40AF] hover:text-blue-700 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                </button>
            </div>
            
            <!-- Four Icons Below Input Bar -->
            <div class="icons-container mt-8 flex justify-center items-center space-x-10">
                <!-- First Icon: Checkmark inside a circle -->
                <button class="icon-button p-2 text-gray-800 hover:text-gray-600 transition-colors" onclick="handleChatClick()">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" stroke-width="2"/>
                        <path d="M9 12l2 2 4-4" stroke-width="2"/>
                    </svg>
                </button>
                
                <!-- Second Icon: Open book -->
                <button class="icon-button p-2 text-gray-800 hover:text-gray-600 transition-colors" onclick="window.location.href='chapters.html'">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" stroke-width="2"/>
                    </svg>
                </button>
                
                <!-- Third Icon: Document with a pencil -->
                <button class="icon-button p-2 text-gray-800 hover:text-gray-600 transition-colors" onclick="goToTest()">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke-width="2"/>
                        <path d="M14 2v6h6" stroke-width="2"/>
                        <path d="M16 13H8" stroke-width="2"/>
                        <path d="M16 17H8" stroke-width="2"/>
                        <path d="M10 9H8" stroke-width="2"/>
                    </svg>
                </button>
                
                <!-- Fourth Icon: Reserved for future use -->
                <button class="icon-button p-2 text-gray-800 hover:text-gray-600 transition-colors" onclick="handleSearchClick()">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" stroke-width="2"/>
                    </svg>
                </button>
            </div>
        </div>
        
                 <!-- Second Gainsboro Page (Hidden by default) - This is the REAL second page -->
                 <div id="second-gainsboro-page" class="fixed inset-0 bg-[#F8F9FA] z-10 hidden">
                     <!-- Chat Messages Area - Covers entire second gainsboro page -->
                     <div id="second-page-chat-area" class="absolute top-20 left-3 right-3 sm:left-4 sm:right-4 bottom-32 overflow-y-auto p-2 sm:p-3">
                         <!-- Messages will appear here on the second gainsboro page -->
                     </div>
                     
                     <!-- Close Button - Top Right -->
                     <button id="close-second-page" class="absolute top-4 right-4 w-8 h-8 bg-gray-600 rounded-full flex items-center justify-center hover:bg-gray-700 transition-colors shadow-lg" onclick="hideSecondPage()">
                         <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                </div>
                
                 <!-- Expanded Input (Hidden by default) - Just for typing -->
                 <div id="expanded-input-container" class="fixed bottom-0 left-0 right-0 bg-[#e8e8e4] rounded-t-3xl shadow-2xl hidden z-20" style="height: 110px;">
                     <div class="relative h-full p-6">
                         <!-- Expanded Textarea - Full Section -->
                         <textarea 
                             id="expanded-user-input" 
                             class="w-full bg-transparent border-none resize-none focus:outline-none text-[#000000] font-sans text-lg placeholder-[#1e1e1e] pr-20 text-right"
                             placeholder="Type your message here..."
                             rows="3"
                             onkeydown="handleExpandedInputKeyDown(event)"
                             style="min-height: 80px; line-height: 1.5; cursor: text;"
                         ></textarea>
                         
                         <!-- Send Button - Circle with Arrow at Left Bottom -->
                         <button id="send-button" class="absolute bottom-4 left-6 w-12 h-12 bg-black rounded-full flex items-center justify-center hover:bg-gray-800 transition-colors shadow-lg" onclick="sendMessage()">
                             <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V5M5 12l7-7 7 7"/>
                    </svg>
                </button>
            </div>
        </div>
        
    </main>
    

    
    <!-- Remove the separate white navigation bar -->
    
    <script>
        let currentConversationId = 'default';
        let isStreaming = false;
        
        // Simple approach - no complex event listeners needed
        // All events are handled by inline onclick, onfocus, onblur attributes
        
        // Initialize conversation
        async function initializeConversation() {
            try {
                const response = await fetch('/api/chat/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                currentConversationId = data.conversationId;
                console.log('New conversation started:', currentConversationId);
            } catch (error) {
                console.error('Failed to start conversation:', error);
            }
        }
        

        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            
            // Update button color based on typing
            const sendButton = document.getElementById('send-button');
            if (textarea.value.trim() !== '') {
                textarea.classList.add('typing-active');
                sendButton.classList.remove('bg-gray-400');
                sendButton.classList.add('bg-black');
            } else {
                textarea.classList.remove('typing-active');
                sendButton.classList.remove('bg-black');
                sendButton.classList.add('bg-gray-400');
            }
        }
        
        // Auto-resize function for the chat bar textarea
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }
        
        // Function to handle input changes for button color
        function handleInputChange(textarea) {
            const sendButton = document.getElementById('send-button');
            if (textarea.value.length > 0) {
                // User is typing - make button black
                sendButton.classList.remove('bg-gray-400');
                sendButton.classList.add('bg-black');
            } else {
                // No text - make button gray
                sendButton.classList.remove('bg-black');
                sendButton.classList.add('bg-gray-400');
            }
        }
        
        // Function to show expanded input
        function showExpandedInput() {
            // Hide main user input container and icons
            const userInputContainer = document.querySelector('.user-input-container');
            if (userInputContainer) {
                userInputContainer.style.display = 'none';
            }
            
            // Show second gainsboro page FIRST (background)
            const secondPage = document.getElementById('second-gainsboro-page');
            if (secondPage) {
                secondPage.classList.remove('hidden');
                secondPage.style.display = 'block';
            }
            
            // Show expanded input ON TOP of second page
            const expandedInput = document.getElementById('expanded-input-container');
            if (expandedInput) {
                expandedInput.classList.remove('hidden');
                expandedInput.style.display = 'block';
            }
            
            // Focus on the expanded textarea
            setTimeout(() => {
                const expandedTextarea = document.getElementById('expanded-user-input');
                if (expandedTextarea) {
                    expandedTextarea.focus();
                }
            }, 100);
        }
        
        // Function to hide expanded input
        function hideExpandedInput() {
            // Show main user input container and icons
            const userInputContainer = document.querySelector('.user-input-container');
            if (userInputContainer) {
                userInputContainer.style.display = 'block';
            }
            
            // Hide expanded input
            const expandedInput = document.getElementById('expanded-input-container');
            if (expandedInput) {
                expandedInput.classList.add('hidden');
                expandedInput.style.display = 'none';
            }
            
            // Hide second gainsboro page
            const secondPage = document.getElementById('second-gainsboro-page');
            if (secondPage) {
                secondPage.classList.add('hidden');
                secondPage.style.display = 'none';
            }
        }
        
        // Function to hide second page
        function hideSecondPage() {
            // Hide second gainsboro page
            const secondPage = document.getElementById('second-gainsboro-page');
            if (secondPage) {
                secondPage.classList.add('hidden');
                secondPage.style.display = 'none';
            }
            
            // Hide expanded input
            const expandedInput = document.getElementById('expanded-input-container');
            if (expandedInput) {
                expandedInput.classList.add('hidden');
                expandedInput.style.display = 'none';
            }
            
            // Show main user input container and icons
            const userInputContainer = document.querySelector('.user-input-container');
            if (userInputContainer) {
                userInputContainer.style.display = 'block';
            }
        }
        
        // Handle Enter key in expanded input
        function handleExpandedInputKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // Add message to second gainsboro page
        function addExpandedMessage(content, isUser = false) {
            const chatArea = document.getElementById('second-page-chat-area');
            if (!chatArea) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex w-full ${isUser ? 'justify-start' : 'justify-end'} mb-4`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `max-w-[90%] sm:max-w-[85%] px-3 sm:px-4 py-2 sm:py-3 rounded-2xl ${
                isUser 
                    ? 'bg-[#c0c0c0] text-black text-left' 
                    : 'text-black text-right'
            } leading-relaxed text-base`;
            
            // Use proper formatting for user messages too
            if (isUser) {
                messageBubble.textContent = content;
            } else {
                // For AI messages, use the robust formatting system
                const formattedContent = formatChatContent(content);
                messageBubble.innerHTML = formattedContent;
            }
            
            messageDiv.appendChild(messageBubble);
            chatArea.appendChild(messageDiv);
            
            // Scroll to bottom
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        
        // Add streaming message placeholder in second gainsboro page
        function addExpandedStreamingMessage() {
            const chatArea = document.getElementById('second-page-chat-area');
            if (!chatArea) return null;
            
            // Create unique ID for each message
            const messageId = 'expanded-streaming-message-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = 'flex w-full justify-end mb-4';
            
            const messageBubble = document.createElement('div');
            messageBubble.className = 'max-w-[90%] sm:max-w-[85%] px-3 sm:px-4 py-2 sm:py-3 rounded-2xl text-black text-right leading-relaxed font-medium';
            messageBubble.style.cssText = 'font-size: 18px !important; font-weight: 500 !important;';
            messageBubble.innerHTML = '<span class="typing-indicator">...</span>';
            
            // Add a data attribute to make it easier to find
            messageBubble.setAttribute('data-message-bubble', 'true');
            
            messageDiv.appendChild(messageBubble);
            chatArea.appendChild(messageDiv);
            
            // Scroll to bottom
            chatArea.scrollTop = chatArea.scrollHeight;
            
            return messageId;
        }
        
        // Update streaming message in second gainsboro page
        function updateExpandedStreamingMessage(messageId, content) {
            console.log('üîÑ updateExpandedStreamingMessage called with:', messageId, content);
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                console.log('‚úÖ Found message element:', messageElement);
                const bubble = messageElement.querySelector('[data-message-bubble="true"]');
                if (bubble) {
                    console.log('‚úÖ Found bubble element, updating content');
                    
                    // Use the robust content formatting system instead of raw innerHTML
                    const formattedContent = formatChatContent(content);
                    console.log('üîç Formatted content for streaming:', formattedContent.substring(0, 200));
                    
                    // Replace the typing indicator with the properly formatted content
                    bubble.innerHTML = formattedContent;
                    
                    // Ensure font size is preserved
                    bubble.style.cssText = 'font-size: 18px !important; font-weight: 500 !important;';
                    
                    // Ensure the content is selectable
                    bubble.style.webkitUserSelect = 'text';
                    bubble.style.userSelect = 'text';
                    bubble.style.cursor = 'text';
                } else {
                    console.log('‚ùå Bubble element not found');
                }
            } else {
                console.log('‚ùå Message element not found for ID:', messageId);
            }
        }
        

        

        
        
        
        // Simple function to show bottom navigation - INSTANT
        function showBottomNavigation() {
            // Hide main chat user input and icons - INSTANT
            const userInputContainer = document.querySelector('.user-input-container');
            if (userInputContainer) {
                userInputContainer.style.display = 'none';
            }
            
            // Show bottom navigation - INSTANT
            const bottomNav = document.getElementById('bottom-navigation');
            if (bottomNav) {
                bottomNav.classList.remove('hidden');
                bottomNav.style.display = 'block';
            }
        }
        
        // Simple function to hide bottom navigation - INSTANT
        function hideBottomNavigation() {
            // Show main chat user input and icons - INSTANT
            const userInputContainer = document.querySelector('.user-input-container');
            if (userInputContainer) {
                userInputContainer.style.display = 'block';
            }
            
            // Hide bottom navigation - INSTANT
            const bottomNav = document.getElementById('bottom-navigation');
            if (bottomNav) {
                bottomNav.classList.add('hidden');
                bottomNav.style.display = 'none';
            }
        }
        
        // Simplified focus and blur functions
        function handleInputFocus(textarea) {
            console.log('üéØ INPUT FOCUSED');
            showBottomNavigation();
        }
        
        function handleInputBlur(textarea) {
            console.log('üéØ INPUT BLURRED');
            hideBottomNavigation();
        }
        
                function addMessage(content, isUser = false, messageId = null) {
            console.log('üì® addMessage called with:', { content, isUser, messageId });
            const messagesContainer = document.getElementById('chat-messages');
            console.log('üì® Messages container:', messagesContainer);
            const messageDiv = document.createElement('div');
            
            if (messageId) {
                messageDiv.id = messageId;
            }
            
            // Proper message positioning - user left, AI right
            messageDiv.className = `flex w-full ${isUser ? 'justify-start' : 'justify-end'} mb-6`;
            
            const messageContent = `
                <div class="max-w-3xl ${isUser ? 'bg-gray-200 text-gray-900' : 'text-gray-900'} rounded-3xl px-6 py-4 ${isUser ? 'shadow-sm' : ''} ${!isUser ? 'ml-auto' : ''}">
                    <p class="${isUser ? 'text-base' : 'text-lg'} leading-relaxed" ${!isUser ? 'dir="rtl"' : ''}>${content}</p>
                </div>
            `;
            
            messageDiv.innerHTML = messageContent;
            messagesContainer.appendChild(messageDiv);
            
            // Enable scrolling after first message without hiding navigation
            enableScrollingWithoutHidingNav();
            
            // Mathematical rendering simplified for deployment
            if (!isUser) {
                console.log('‚úÖ Mathematical rendering simplified for deployment');
            }
            
            // Scroll to show the new message at the top
            setTimeout(() => {
                if (isUser) {
                    // For user messages, scroll to show the new message
                    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    // For AI responses, scroll to show the new content below input
                    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
            
            console.log(`Message added: ${isUser ? 'User' : 'AI'} - Total messages: ${messagesContainer.children.length}`);
            
            return messageDiv;
        }
        
        function addStreamingMessage() {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            const messageId = `msg_${Date.now()}`;
            
            messageDiv.id = messageId;
            // AI messages always on the right
            messageDiv.className = 'flex w-full justify-end mb-4';
            
            const messageContent = `
                <div class="ml-auto max-w-3xl text-gray-900 rounded-3xl px-6 py-4">
                    <div class="text-lg leading-relaxed flex items-center justify-center">
                        <div class="spinning-logo-container">
                            <div class="thinking-text">ÿØÿ± ÿ≠ÿßŸÑ ŸÅ⁄©ÿ± ⁄©ÿ±ÿØŸÜ...</div>
                        </div>
                    </div>
                </div>
            `;
            
            messageDiv.innerHTML = messageContent;
            messagesContainer.appendChild(messageDiv);
            
            // Enable scrolling when streaming starts without hiding navigation
            enableScrollingWithoutHidingNav();
            
            // Scroll to show the new message at the top
            setTimeout(() => {
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
            
            console.log(`Streaming message added - Total messages: ${messagesContainer.children.length}`);
            
            return messageId;
        }
        
        function updateStreamingMessage(messageId, content) {
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                // Ensure the message div maintains its right alignment
                messageDiv.className = 'flex w-full justify-end';
                
                const textElement = messageDiv.querySelector('div');
                // Format the content with bullet points and proper structure
                const formattedContent = formatChatContent(content);
                // Wrap content in a div that maintains right alignment
                textElement.innerHTML = `<div class="text-right"><span class="text-lg leading-relaxed">${formattedContent}</span></div>`;
                
                        // Mathematical rendering simplified for deployment
        console.log('‚úÖ Mathematical rendering simplified for deployment');
                
                // Always scroll to show latest content below input
                const messagesContainer = document.getElementById('chat-messages');
                setTimeout(() => {
                    // Scroll to show the new message below input
                    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 50);
            }
        }

        // Content formatting - only bullet points and numbered lists, no headers or bold
        function formatChatContent(content) {
            console.log('üîç Raw AI content:', content);
            
            if (!content || typeof content !== 'string') {
                console.warn('‚ö†Ô∏è Invalid content received:', content);
                return '<p>ŸÖÿ™ÿ£ÿ≥ŸÅÿßŸÜŸá ŸÖÿ≠ÿ™Ÿàÿß€å€å ÿ®ÿ±ÿß€å ŸÜŸÖÿß€åÿ¥ Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ.</p>';
            }
            
            let formatted = content;
            
            // FIRST: Remove ALL markdown symbols from the entire content
            formatted = formatted.replace(/#+\s*/g, ''); // Remove all headers (#, ##, ###, etc.)
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '$1'); // Remove bold
            formatted = formatted.replace(/\*(.*?)\*/g, '$1'); // Remove italic
            formatted = formatted.replace(/`(.*?)`/g, '$1'); // Remove code blocks
            formatted = formatted.replace(/~~(.*?)~~/g, '$1'); // Remove strikethrough
            
            // SECOND: Convert bullet points (lines starting with - or ‚Ä¢)
            formatted = formatted.replace(/^[-‚Ä¢]\s*(.+)$/gm, '<li class="mb-1">$1</li>');
            
            // THIRD: Convert numbered lists (lines starting with 1. 2. etc.)
            formatted = formatted.replace(/^\d+\.\s*(.+)$/gm, '<li class="mb-1">$1</li>');
            
            // FOURTH: Wrap lists in proper HTML structure with dynamic spacing
            formatted = formatted.replace(/(<li class="mb-1">.*<\/li>)/gs, '<ul class="list-disc list-inside space-y-1 mb-3">$1</ul>');
            
            // FIFTH: Handle line breaks
            formatted = formatted.replace(/\n\n/g, '</p><p>');
            formatted = formatted.replace(/\n/g, '<br>');
            
            // Wrap in basic structure
            formatted = `<div dir="rtl" class="text-right"><p>${formatted}</p></div>`;
            
            console.log('üîç Formatted content:', formatted);
            return formatted;
        }
        

        
        async function sendMessage() {
            console.log('üöÄ sendMessage function called');
            if (isStreaming) return;
            
            // Get message from expanded input
            const expandedInput = document.getElementById('expanded-user-input');
            let message = '';
            
            if (expandedInput && expandedInput.value.trim() !== '') {
                message = expandedInput.value.trim();
            }
            
            console.log('üìù Message content:', message);
            if (!message) return;
            
            // Add user message to second gainsboro page
            addExpandedMessage(message, true);
            
            // Clear the expanded input but keep it open
            if (expandedInput) {
                expandedInput.value = '';
            }
            
            // Add AI response placeholder in second gainsboro page
            const streamingMessageId = addExpandedStreamingMessage();
            isStreaming = true;
            
            try {
                // Use streaming API for real-time response
                await streamAIResponse(message, streamingMessageId, true); // true = expanded mode
            } catch (error) {
                console.error('Failed to get AI response:', error);
                updateExpandedStreamingMessage(streamingMessageId, 'ŸÖÿ™ÿ£ÿ≥ŸÅÿßŸÜŸá ÿÆÿ∑ÿß€å€å ÿ±ÿÆ ÿØÿßÿØ. ŸÑÿ∑ŸÅÿßŸã ÿØŸàÿ®ÿßÿ±Ÿá ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ€åÿØ.');
            } finally {
                isStreaming = false;
            }
        }
        
        async function streamAIResponse(message, messageId, isExpanded = false) {
            try {
                console.log('üöÄ Starting API call to /api/chat/stream');
                console.log('üìù Message:', message);
                console.log('üÜî Conversation ID:', currentConversationId);
                
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        conversationId: currentConversationId
                    })
                });
                
                console.log('üì° Response status:', response.status);
                console.log('üì° Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            console.log('üîç Processing data line:', data.substring(0, 100));
                            
                            if (data === '[DONE]') {
                                console.log('‚úÖ Received [DONE] signal');
                                // Add final response to conversation history
                                return fullResponse;
                            }
                            
                                                            try {
                                    const parsed = JSON.parse(data);
                                console.log('üìù Parsed data:', parsed);
                                
                                    if (parsed.content && parsed.type === 'chunk') {
                                    console.log('‚úÖ Valid chunk received, content:', parsed.content);
                                        fullResponse += parsed.content;
                                    
                                    // Update message based on mode
                                    if (isExpanded) {
                                        console.log('üîÑ Updating expanded streaming message');
                                        updateExpandedStreamingMessage(messageId, fullResponse);
                                    } else {
                                        console.log('üîÑ Updating main streaming message');
                                        updateStreamingMessage(messageId, fullResponse);
                                    }
                                        
                                        // Reduced delay for faster typewriter effect
                                        await new Promise(resolve => setTimeout(resolve, 10));
                                } else {
                                    console.log('‚ö†Ô∏è Invalid chunk format:', parsed);
                                    }
                                } catch (e) {
                                console.log('‚ùå JSON parsing error:', e.message);
                                // Ignore parsing errors for incomplete chunks
                                }
                        }
                    }
                }
                
                return fullResponse;
                
            } catch (error) {
                console.error('Streaming error:', error);
                throw error;
            }
        }
        
        // Handle Enter key for both input fields
        function handleKeyDown(event, textarea) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // Handle Enter key
        document.getElementById('user-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // SymPy processing removed for deployment
        // function processSymPy(element) {
        //     SymPy backend rendering - content already processed
        //     console.log('üîç SymPy backend rendering - content already processed');
        //     Content is already rendered by SymPy on the backend
        // }
        
        // Function to enable scrolling and hide welcome message
        function enableScrolling() {
            const chatContainer = document.getElementById('chat-messages');
            const scientificBackground = document.getElementById('scientific-background');
            
            // Enable scrolling on chat container
            chatContainer.classList.remove('no-scroll');
            chatContainer.style.overflow = 'auto';
            chatContainer.style.overflowY = 'auto';
            
            // Hide scientific background
            if (scientificBackground) {
                scientificBackground.classList.add('chat-mode');
            }
            
            // Add chat-mode class to body for clean white background
            document.body.classList.add('chat-mode');
            
            // Hide bottom navigation when scrolling is enabled
            const bottomNav = document.getElementById('bottom-navigation');
            if (bottomNav) {
                bottomNav.style.opacity = '0';
                bottomNav.style.pointerEvents = 'none';
            }
        }

        // Function to enable scrolling without hiding navigation
        function enableScrollingWithoutHidingNav() {
            const chatContainer = document.getElementById('chat-messages');
            const scientificBackground = document.getElementById('scientific-background');
            
            // Only set positioning once - don't change it on every call
            if (!chatContainer.dataset.positioned) {
                chatContainer.style.maxHeight = 'none'; // Allow full page scroll
                chatContainer.style.marginBottom = '0';
                chatContainer.style.paddingBottom = '100px'; // Space above input bar
                chatContainer.style.height = 'auto'; // Let height adjust to content
                chatContainer.dataset.positioned = 'true'; // Mark as positioned
            }
            
            // Enable scrolling on chat container
            chatContainer.classList.remove('no-scroll');
            chatContainer.style.overflow = 'auto';
            chatContainer.style.overflowY = 'auto';
            
            // Hide scientific background
            if (scientificBackground) {
                scientificBackground.classList.add('chat-mode');
            }
            
            // Add chat-mode class to body for clean white background
            document.body.classList.add('chat-mode');
            
            // Hide bottom navigation when input is focused
            const bottomNav = document.getElementById('bottom-navigation');
            if (bottomNav) {
                bottomNav.style.display = 'none';
            }
        }



        // Function to handle input focus/change
        function handleInputChange(input) {
            // Enable scrolling when user starts typing without hiding navigation
            enableScrollingWithoutHidingNav();
        }
        


        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Register service worker for mobile performance
            // Temporarily disabled service worker to fix navigation issues
            /*
            if ('serviceWorker' in navigator) {
                const swPath = self.location.hostname === 'localhost' ? 'sw.js' : '/sw.js';
                navigator.serviceWorker.register(swPath)
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered successfully');
                    })
                    .catch(error => {
                        console.log('‚ö†Ô∏è Service Worker registration failed:', error);
                    });
            }
            */
            
            // Preload critical pages for faster mobile navigation
            preloadPages();
            
            // Initialize chat functionality
            initializeChat();
            
            // Ensure page starts in correct state
            resetPageToInitialState();
        });
        
        // Function to reset page to initial state
        function resetPageToInitialState() {
            // Show welcome text
            const welcomeText = document.getElementById('welcome-text');
            if (welcomeText) {
                welcomeText.style.opacity = '1';
                welcomeText.style.display = 'block';
            }
            
            // Hide chat messages
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.classList.add('hidden');
                chatMessages.style.display = 'none';
            }
            
            // Clear input field
            const userInput = document.getElementById('user-input');
            if (userInput) {
                userInput.value = '';
                userInput.style.height = 'auto';
                userInput.placeholder = "...Ask anything";
            }
        }
        
        // Preload pages for faster mobile navigation
        function preloadPages() {
            const pages = ['test.html', 'question-analysis.html', 'chapters.html', 'analysis-results.html'];
            pages.forEach(page => {
                const link = document.createElement('link');
                link.rel = 'prefetch';
                link.href = page;
                document.head.appendChild(link);
            });
        }
        
        // Initialize chat functionality
        function initializeChat() {
            initializeConversation();
            
            // Debug: Check conversation state every 2 seconds
            setInterval(() => {
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer) {
                    console.log(`Current conversation state: ${messagesContainer.children.length} messages`);
                    console.log('Message IDs:', Array.from(messagesContainer.children).map(el => el.id));
                }
            }, 2000);
        }
        
        // Function to go to test page
        function goToTest() {
            console.log('üîç Navigating to test page...');
            try {
                window.location.href = 'test.html';
            } catch (error) {
                console.error('‚ùå Navigation error:', error);
                // Fallback: try direct assignment
                window.location = 'test.html';
            }
        }
        
        // Function to start a new chat
        function startNewChat() {
            // Clear chat messages
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.innerHTML = '';
                chatMessages.classList.add('hidden');
            }
            
            // Show welcome message
            const welcomeMessage = document.getElementById('welcome-message');
            if (welcomeMessage) {
                welcomeMessage.classList.remove('hidden');
            }
            
            // Start new conversation
            initializeConversation();
            
            // Clear input
            const userInput = document.getElementById('user-input');
            if (userInput) {
                userInput.value = '';
                userInput.style.height = 'auto';
            }
        }
        
        // SymPy processing removed for deployment
        // console.log('‚úÖ Using SymPy backend for mathematical rendering');
    </script>
</body>
</html>


