<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#E8E8E4">
    <meta name="msapplication-navbutton-color" content="#E8E8E4">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="msapplication-TileColor" content="#E8E8E4">
    <meta name="msapplication-navbutton-color" content="#E8E8E4">
    <meta name="theme-color" content="#E8E8E4" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#E8E8E4" media="(prefers-color-scheme: dark)">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap"></noscript>
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    
    <!-- Preload other pages for faster navigation -->
    <link rel="prefetch" href="test.html">
    <link rel="prefetch" href="question-analysis.html">
    <link rel="prefetch" href="chapters.html">
    <link rel="prefetch" href="analysis-results.html">
    
    <!-- Apple Touch Icons for iOS -->
    <!-- <link rel="apple-touch-icon" href="/icon-192.png"> -->
    <!-- <link rel="apple-touch-icon" sizes="152x152" href="/icon-192.png"> -->
    <!-- <link rel="apple-touch-icon" sizes="180x180" href="/icon-192.png"> -->
    <!-- <link rel="apple-touch-icon" sizes="167x167" href="/icon-192.png"> -->
    
    <!-- Web App Manifest for mobile app-like experience -->
    <!-- <link rel="manifest" href="/manifest.json"> -->
    
    <title>ŸÖŸêŸÜŸà - €åÿßÿØ⁄Ø€åÿ±€å ŸáŸàÿ¥ŸÖŸÜÿØ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://polyfill.io">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind CDN production warning
        window.tailwind = window.tailwind || {};
        window.tailwind.config = window.tailwind.config || {};
        window.tailwind.config.safelist = [];
    </script>
    <!-- Enhanced MathJax for comprehensive math rendering -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                packages: {'[+]': ['ams', 'amscd', 'amssymb', 'mathtools', 'physics', 'bm', 'cancel', 'cases', 'empheq', 'geometry', 'mhchem', 'pgf', 'textmacros', 'unicode', 'upgreek', 'verbatim']}
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/ams', '[tex]/amscd', '[tex]/amssymb', '[tex]/mathtools', '[tex]/physics', '[tex]/bm', '[tex]/cancel', '[tex]/cases', '[tex]/empheq', '[tex]/geometry', '[tex]/mhchem', '[tex]/pgf', '[tex]/textmacros', '[tex]/unicode', '[tex]/upgreek', '[tex]/verbatim']
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script>
        // Suppress Tailwind CDN warning
        window.addEventListener('DOMContentLoaded', function() {
            const originalWarn = console.warn;
            console.warn = function(message) {
                if (typeof message === 'string' && message.includes('cdn.tailwindcss.com should not be used in production')) {
                    return; // Suppress this specific warning
                }
                originalWarn.apply(console, arguments);
            };
        });
        
        // IMMEDIATE TEST - This should show in console immediately
        console.log('üîç ===== INDEX PAGE SCRIPT LOADED =====');
        console.log('üîç JavaScript is working in index.html!');
        console.log('üîç Current URL:', window.location.href);
        console.log('üîç viewing_thread in localStorage:', localStorage.getItem('viewing_thread'));
        console.log('üîç Document ready state:', document.readyState);
        console.log('üîç ===== INDEX PAGE SCRIPT LOADED =====');
        
        // Navigate to test page
        function goToTest() {
            console.log('üß™ Navigating to test page');
            window.location.href = 'test.html';
        }
        
        // Navigate to library page
        function goToLibrary() {
            console.log('üìö Navigating to library page');
            window.location.href = 'library.html';
        }
        
        // Navigate to analysis page
        function goToAnalysis() {
            console.log('üìä Navigating to analysis page');
            window.location.href = 'question-analysis.html';
        }
        
        // Navigate to settings page
        function goToSettings() {
            console.log('‚öôÔ∏è Navigating to settings page');
            // For now, just show an alert - you can implement a settings page later
            alert('Settings page coming soon!');
        }
        
        // Set theme color for system navigation bar integration
        function setSystemThemeColor() {
            // Update theme color meta tag dynamically
            let themeColorMeta = document.querySelector('meta[name="theme-color"]');
            if (!themeColorMeta) {
                themeColorMeta = document.createElement('meta');
                themeColorMeta.name = 'theme-color';
                document.head.appendChild(themeColorMeta);
            }
            themeColorMeta.content = '#E8E8E4';
            
            // For Android Chrome
            let msNavButtonMeta = document.querySelector('meta[name="msapplication-navbutton-color"]');
            if (!msNavButtonMeta) {
                msNavButtonMeta = document.createElement('meta');
                msNavButtonMeta.name = 'msapplication-navbutton-color';
                document.head.appendChild(msNavButtonMeta);
            }
            msNavButtonMeta.content = '#E8E8E4';
            
            // For iOS Safari
            let appleStatusBarMeta = document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]');
            if (!appleStatusBarMeta) {
                appleStatusBarMeta = document.createElement('meta');
                appleStatusBarMeta.name = 'apple-mobile-web-app-status-bar-style';
                document.head.appendChild(appleStatusBarMeta);
            }
            appleStatusBarMeta.content = 'default';
            
            console.log('üé® System theme color set to #E8E8E4');
        }
        let initializationComplete = false;
        
        function triggerInitialization() {
            if (initializationComplete) {
                console.log('üîç Initialization already complete, skipping...');
                return;
            }
            
            console.log('üîç ===== TRIGGERING INITIALIZATION =====');
            console.log('üîç Document ready state:', document.readyState);
            console.log('üîç Viewing thread:', localStorage.getItem('viewing_thread'));
            
            // Set system theme color for seamless navigation bar integration
            setSystemThemeColor();
            
            // Check if we have a viewing_thread - if so, load it directly
            const viewingThread = localStorage.getItem('viewing_thread');
            if (viewingThread) {
                console.log('üîç Viewing thread detected, loading from library...');
                loadThreadFromLibrary();
                return;
            }
            
            // Wait for functions to be defined for normal initialization
            setTimeout(() => {
                console.log('üîç Checking if initializeChat function exists...');
                if (typeof initializeChat === 'function') {
                    console.log('‚úÖ initializeChat function found, calling it...');
                    
                    // Check login status first
                    console.log('üîç Step 0: Checking login status...');
                    checkLoginStatus();
                    
                    // Preload critical pages
                    console.log('üîç Step 1: Preloading pages...');
                    preloadPages();
                    
                    // Initialize chat functionality (this will load the thread)
                    console.log('üîç Step 2: Initializing chat...');
                    initializeChat();
                    
                    // Initialize user menu
                    console.log('üîç Step 3: Initializing user menu...');
                    initializeUserMenu();
                    
                    // Initialize phone form event listeners
                    console.log('üîç Step 4: Initializing phone form...');
                    initializePhoneForms();
                    
                    initializationComplete = true;
                    console.log('‚úÖ Initialization completed successfully');
                    
                } else {
                    console.log('‚ùå initializeChat function not yet defined, retrying...');
                    // Retry after a longer delay
                    setTimeout(() => {
                        if (typeof initializeChat === 'function') {
                            console.log('‚úÖ initializeChat function found on retry, calling it...');
                            initializeChat();
                            initializationComplete = true;
                        } else {
                            console.log('‚ùå initializeChat function still not found');
                        }
                    }, 500);
                }
            }, 200);
        }
        
        // SINGLE DOMContentLoaded listener - removes all duplicate initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç ===== DOM CONTENT LOADED EVENT FIRED =====');
            console.log('üîç Page URL:', window.location.href);
            console.log('üîç Viewing thread from localStorage:', localStorage.getItem('viewing_thread'));
            console.log('üîç Document ready state:', document.readyState);
            
            // Trigger initialization only once
            triggerInitialization();
        });
        
        // Manual test function for debugging thread loading
        function manualThreadLoadingTest() {
            console.log('üîç ===== MANUAL THREAD LOADING TEST START =====');
            const viewingThread = localStorage.getItem('viewing_thread');
            console.log('üîç Current viewing_thread:', viewingThread);
            
            if (!viewingThread) {
                console.log('‚ùå No viewing_thread found in localStorage');
                return;
            }
            
            console.log('üîç Testing loadThreadFromLibrary function...');
            if (typeof loadThreadFromLibrary === 'function') {
                console.log('‚úÖ loadThreadFromLibrary function exists, calling it...');
                // Thread loading removed
            } else {
                console.log('‚ùå loadThreadFromLibrary function not found');
            }
            console.log('üîç ===== MANUAL THREAD LOADING TEST END =====');
        }
        
        // Check login status function
        function checkLoginStatus() {
            console.log('üîç Checking login status...');
            
            const authToken = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
            const userId = localStorage.getItem('user_id');
            const isVerified = localStorage.getItem('is_verified');
            const userPhone = localStorage.getItem('user_phone') || localStorage.getItem('userPhone');
            
            console.log('üîç Login status check:', {
                authToken: !!authToken,
                userId: userId,
                isVerified: isVerified,
                userPhone: userPhone
            });
            
            // If user is not logged in, show login overlay
            if (!authToken || !userId || isVerified !== 'true') {
                console.log('‚ùå User not logged in, showing login overlay');
                const loginOverlay = document.getElementById('login-overlay');
                if (loginOverlay) {
                    loginOverlay.classList.remove('hidden');
                }
            } else {
                console.log('‚úÖ User is logged in, hiding login overlay');
                const loginOverlay = document.getElementById('login-overlay');
                if (loginOverlay) {
                    loginOverlay.classList.add('hidden');
                }
            }
        }
        
        // Initialize conversation function
        async function initializeConversation() {
            try {
                const response = await fetch('/api/chat/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: localStorage.getItem('user_id') || '1'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to initialize conversation');
                }
                
                const data = await response.json();
                console.log('‚úÖ Conversation initialized:', data);
            } catch (error) {
                console.error('‚ùå Error initializing conversation:', error);
            }
        }
        
        // Auto resize function
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }
        
        // Auto resize textarea function
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }
        
        // Handle input change function
        function handleInputChange(textarea) {
            autoResizeTextarea(textarea);
        }
        
        // Handle input focus function
        function handleInputFocus(textarea) {
            autoResizeTextarea(textarea);
        }
        
        // Hide bottom navigation function
        function hideBottomIcons() {
            const bottomNav = document.querySelector('.bottom-nav-container');
            if (bottomNav) {
                bottomNav.style.display = 'none';
            }
        }
        
        // Disable scrolling function
        function disableScrolling() {
            document.body.style.overflow = 'hidden';
        }
        
        // Enable scrolling function
        function enableScrolling() {
            document.body.style.overflow = 'auto';
        }
        
        // Show bottom navigation function
        function showBottomIcons() {
            const bottomNav = document.querySelector('.bottom-nav-container');
            if (bottomNav) {
                bottomNav.style.display = 'block';
            }
        }
        
        // Handle analysis expanded input key down function
        function handleAnalysisExpandedInputKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendAnalysisExpandedMessage();
            }
        }
        
        // Handle analysis input change function
        function handleAnalysisInputChange(textarea) {
            autoResizeTextarea(textarea);
        }
        
        // Send analysis expanded message function
        async function sendAnalysisExpandedMessage() {
            console.log('üöÄ sendAnalysisExpandedMessage function called');
            
            // SCROLL TO TOP immediately when send button is clicked
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            const messagesContainer = document.getElementById('chat-messages');
            if (messagesContainer) {
                messagesContainer.scrollTop = 0;
            }
            console.log('üì® SCROLLED TO TOP on send button click');
            
            const textarea = document.getElementById('analysis-expanded-user-input');
            const message = textarea.value.trim();
            
            if (!message) {
                console.log('‚ö†Ô∏è No message to send');
                return;
            }
            
            // Clear the input
            textarea.value = '';
            
            // Add user message to chat
            addMessage(message, true);
            
            // Send message to AI
            await sendMessageToAI(message);
        }
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'meno-blue': '#3B82F6',
                        'meno-gray': '#6B7280',
                        'meno-light-gray': '#F3F4F6'
                    }
                }
            }
        }
    </script>
    <style>
        /* Critical CSS for mobile performance */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        /* Allow text selection for chat messages and content */
        .chat-messages, .chat-messages *, .ai-message, .user-message, p, div[dir="rtl"] {
            -webkit-user-select: text;
            user-select: text;
            -webkit-touch-callout: default;
        }
        
        /* Keep inputs and textareas selectable */
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
        
        /* Keep buttons and clickable elements non-selectable for mobile UX */
        button, nav {
            -webkit-user-select: none;
            user-select: none;
        }
        
        html, body {
            font-family: 'IranSans', 'Vazirmatn', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 1.125rem; /* 18px */
            line-height: 1.6;
            background-color: #F8F9FA !important;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior: none;
        }
        
        .chat-container {
            min-height: 25rem; /* 400px */
            padding-bottom: 1.25rem; /* 20px */
            background-color: #F8F9FA;
        }
        
        /* Fix input bar layout */
        .input-bar {
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            height: 3.4375rem; /* 55px */
            border-radius: 9999px;
            background-color: #e8e8e4;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .user-input-container {
            width: 95%;
            max-width: 37.5rem; /* 600px */
            margin: 0 auto;
            margin-top: auto;
            /* Removed margin-bottom to allow proper fixed positioning */
            z-index: 50; /* Ensure it stays above other content */
        }
        
        /* Ensure proper spacing between elements */
        .main {
            padding-top: 5rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #F8F9FA;
        }
        
        .ai-message-font {
            font-size: 1.125rem !important; /* 18px */
        }
        
        /* Ensure chat messages are selectable and copyable */
        .chat-messages {
            -webkit-user-select: text;
            user-select: text;
            cursor: text;
        }
        
        .chat-messages .message-bubble {
            -webkit-user-select: text;
            user-select: text;
            cursor: text;
        }
        
        .chat-messages p, .chat-messages li, .chat-messages div {
            -webkit-user-select: text;
            user-select: text;
            cursor: text;
        }
        
        /* Make sure AI responses are selectable */
        .ai-response, .ai-message, .ai-content {
            -webkit-user-select: text;
            user-select: text;
            cursor: text;
        }
        
        /* Critical mobile viewport fixes */
        html {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            overflow-x: hidden;
        }
        
        body {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        
        /* Prevent mobile zoom on input focus */
        input, textarea, select {
            font-size: 1rem !important; /* 16px */
        }
        
        /* Force consistent background color throughout */
        html, body, main, .chat-container, .chat-messages, .main {
            background-color: #F8F9FA !important;
        }
        
        /* Bottom navigation styling - same as other pages */
        
        /* Navigation icon states */
        .nav-icon {
            color: #9CA3AF; /* Pale gray for inactive icons */
            transition: color 0.3s ease;
        }
        
        .nav-icon.active {
            color: #374151; /* Full color for active icon */
        }
        
        .nav-icon:hover {
            color: #6B7280; /* Slightly darker on hover */
        }
        
        /* Basic chat styling - clean slate for new system */
        .chat-messages {
            line-height: 1.6;
            background-color: #F8F9FA;
        }
        
        .chat-messages p {
            margin-bottom: 1rem;
        }
        
        /* Enhanced AI response styling for mobile */
        .chat-messages .message-bubble {
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        /* Ensure AI message content stays stable during streaming */
        .chat-messages .message-bubble:not([class*="bg-[#e8e8e4]"]) div {
            direction: rtl !important;
            text-align: right !important;
            unicode-bidi: bidi-override !important;
            text-align-last: right !important;
            writing-mode: horizontal-tb !important;
        }
        
        /* Better mobile typography */
        @media (max-width: 640px) {
            .chat-messages .message-bubble {
                font-size: 1rem !important; /* 16px */
                line-height: 1.5;
                padding: 1rem !important;
            }
            
            /* AI messages (right-aligned) - maximum width - same as detailed analysis */
            .chat-messages .message-bubble:not([class*="bg-[#e8e8e4]"]) {
                width: auto !important;
                max-width: calc(32rem + 0.15rem) !important;
                margin-left: auto !important;
                margin-right: 0 !important;
            }
            
            /* User messages (left-aligned) - full width */
            .chat-messages .message-bubble[class*="bg-[#e8e8e4]"] {
                max-width: 99% !important;
                margin-left: 0.5rem !important;
            }
            
            .chat-messages p {
                margin-bottom: 0.75rem;
            }
            
            .chat-messages li {
                margin-bottom: 0.5rem;
            }
            
            /* Simple mobile styling */
            p {
                font-size: 1.125rem !important; /* 18px */
                line-height: 1.6;
                margin-bottom: 1rem;
            }
        }
        
        /* Mobile touch optimizations */
        button {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s ease;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        /* Prevent zoom on input focus for mobile */
        input[type="text"], input[type="email"], textarea {
            font-size: 1rem !important; /* 16px */
        }
        
        /* Mobile scrollbar styling */
        ::-webkit-scrollbar {
            width: 0.375rem; /* 6px */
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.1875rem; /* 3px */
        }
        
        /* Hidden class for elements */
        .hidden {
            display: none !important;
        }
        

        

        


        /* Chat message content styling */
        .chat-message p {
            margin-bottom: 0.5rem;
        }

        .chat-message ul {
            margin: 0.5rem 0;
            padding-right: 1.5rem;
        }

        .chat-message li {
            

        
        .math-display {
            text-align: center !important;
            margin: 1rem 0 !important;
            font-size: 1.2em !important;
            font-family: 'Times New Roman', serif !important;
            color: #1f2937 !important;
        }
        
        .math-error {
            color: #dc2626 !important;
            font-style: italic !important;
            background-color: #fef2f2 !important;
            padding: 0.25rem 0.5rem !important;
            border-radius: 0.25rem !important;
        }
            margin-bottom: 0.3rem;
        }

        /* Bullet points and numbered lists styling */
        .ml-auto ul {
            list-style-type: disc;
            padding-right: 1.5rem;
            margin: 0.5rem 0;
        }

        .ml-auto ol {
            list-style-type: decimal;
            padding-right: 1.5rem;
            margin: 0.5rem 0;
        }

        .ml-auto li {
            margin-bottom: 0.3rem;
            text-align: right;
        }

        /* Study-mode content styling - GPT-like experience */
        /* Enhanced ChatGPT Study Mode Styling */
        /* ChatGPT Study Mode Styling - Integrated with main chat */
        .study-message {
            background: transparent;
            border-radius: 0;
            box-shadow: none;
            padding: 0;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #374151;
            max-width: 100%;
            word-wrap: break-word;
        }
        
        .study-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
            margin: 1.2rem 0 0.8rem 0;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid #e5e7eb;
            text-align: right;
        }
        
        .study-paragraph {
            font-size: 1.125rem; /* Match text-lg (18px) */
            font-weight: 400; /* Ensure normal font weight */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; /* Match main font */
            line-height: 1.6;
            margin-bottom: 0.8rem;
            color: #374151;
            text-align: right;
        }

        .study-list {
            margin: 0.8rem 0 !important;
            padding-right: 0 !important;
            list-style: none !important;
        }

        .study-list-item {
            margin-bottom: 0.4rem !important;
            font-size: 1.125rem !important; /* Match text-lg (18px) */
            font-weight: 400 !important; /* Ensure normal font weight */
            line-height: 1.6 !important;
            color: #374151 !important;
            text-align: right !important;
            display: block !important;
            list-style: none !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important; /* Match main font */
            position: relative !important;
            padding-right: 1.5rem !important;
        }

        .study-list-item::before {
            content: "‚Ä¢" !important;
            position: absolute !important;
            right: 0 !important;
            top: 0 !important;
            font-size: 2rem !important; /* Even bigger bullet points */
            font-weight: 400 !important; /* Same as text */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important; /* Same as text */
            color: #374151 !important; /* Same as text */
        }
        
        .study-list ol {
            counter-reset: list-counter;
        }

        .study-list ol .study-list-item {
            counter-increment: list-counter;
        }

        .study-list ol .study-list-item::before {
            content: counter(list-counter) ".";
            color: #6b7280;
            font-weight: bold;
            font-size: 2rem; /* Bigger numbered bullets */
            position: absolute;
            right: 0;
            top: 0;
        }
        
        .study-math {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0.5rem 0;
            margin: 0.5rem 0;
            text-align: center;
            font-family: 'Times New Roman', serif;
            font-size: 1.1rem;
            color: #374151;
        }
        
        /* Override positioning for thread loading - More specific to override media queries */
        #main-user-input.thread-loaded-position {
            bottom: 0px !important;
            padding-bottom: 1.25rem !important;
            margin-bottom: 0 !important;
        }
        
        /* Override all media queries for thread loading */
        @media (max-width: 1024px) {
            #main-user-input.thread-loaded-position {
                bottom: 0px !important;
                padding-bottom: 1.25rem !important;
                margin-bottom: 0 !important;
            }
        }
        
        @media (max-width: 768px) {
            #main-user-input.thread-loaded-position {
                bottom: 0px !important;
                padding-bottom: 1.25rem !important;
                margin-bottom: 0 !important;
            }
        }
        
        @media (max-width: 640px) {
            #main-user-input.thread-loaded-position {
                bottom: 0px !important;
                padding-bottom: 1.25rem !important;
                margin-bottom: 0 !important;
            }
        }
        
        @media (max-width: 480px) {
            #main-user-input.thread-loaded-position {
                bottom: 0px !important;
                padding-bottom: 1.25rem !important;
                margin-bottom: 0 !important;
            }
        }
        
        @media (min-width: 320px) and (max-width: 479px) {
            #main-user-input.thread-loaded-position {
                bottom: 0px !important;
                padding-bottom: 1.25rem !important;
                margin-bottom: 0 !important;
            }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .study-title {
                font-size: 1.1rem;
                margin: 1rem 0 0.6rem 0;
            }
            
            .study-paragraph {
                font-size: 0.9rem;
            }
            
            .study-list-item {
                font-size: 0.9rem;
            }
            
            .study-list-item::before {
                font-size: 2rem !important; /* Bigger bullets on mobile too */
            }
        }

        /* Emoji styling */
        .ml-auto span[class*="emoji"] {
            font-size: 1.1em;
            margin: 0 0.2rem;
        }



        /* AI message right alignment */
        .ml-auto {
            text-align: right;
        }
        
        .ml-auto p, .ml-auto div, .ml-auto span {
            text-align: right;
        }
        
        .ml-auto ul, .ml-auto ol {
            text-align: right;
        }
        
        .chat-message li {
            margin-bottom: 0.3rem;
        }

        /* Bullet point styling for chat messages */
        .chat-message p:contains('‚Ä¢') {
            margin-right: 1rem;
        }






        

        /* Mobile Performance Optimizations */
        @media (max-width: 768px) {
            /* Fix mobile layout issues */
            html, body {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            main {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }
            
            .user-input-container {
                width: 95% !important;
                max-width: 95% !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                position: fixed !important;
            }
            
        /* Enhanced Bottom Navigation Styles */
        .bottom-nav-container {
            background-color: #E8E8E4;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        /* Ensure seamless blending with system navigation */
        body {
            background-color: #F8F9FA !important;
        }
        
        /* Force system navigation bar color matching */
        @supports (padding: max(0px)) {
            .bottom-nav-container {
                padding-bottom: max(env(safe-area-inset-bottom), 0px);
            }
        }
        
        /* Additional system integration */
        html {
            background-color: #F8F9FA;
        }
        
        /* Ensure full-height background */
        body, html {
            min-height: 100vh;
            min-height: 100dvh; /* Dynamic viewport height for mobile */
        }
        
        .nav-item {
            min-width: 44px;
            min-height: 44px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .nav-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .nav-item.active .nav-icon {
            color: #1f2937;
            stroke-width: 2.5;
        }
        
        .nav-label {
            font-size: 0.75rem;
            font-weight: 500;
            transition: color 0.2s ease;
        }
        
        .nav-item.active .nav-label {
            color: #1f2937;
            font-weight: 600;
        }
        
        /* Mobile-first responsive design */
        @media (max-width: 640px) {
            .nav-content {
                padding: 0.75rem 1rem;
            }
            
            .nav-item {
                padding: 0.5rem;
            }
            
            .nav-label {
                display: none;
            }
        }
        
        @media (min-width: 641px) {
            .nav-content {
                padding: 1rem 1.5rem;
            }
            
            .nav-item {
                padding: 0.75rem;
            }
        }
        
        /* Desktop styles */
        @media (min-width: 1024px) {
            .nav-content {
                max-width: 600px;
                padding: 1rem 2rem;
            }
        }
            
            /* Optimize animations for mobile - exclude positioning elements */
            .chat-message,
            .user-input,
            .send-button,
            .message-bubble,
            .nav-icon {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
                -webkit-backface-visibility: hidden;
                backface-visibility: hidden;
            }
            
            /* Reduce motion for better performance */
            .chat-message,
            .user-input,
            .send-button {
                transition: all 0.2s ease;
            }
            
            /* Optimize scrolling */
            .chat-container {
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* Critical CSS for above-the-fold content */
        .user-input-container {
            will-change: transform;
            transform: translateZ(0);
        }
        
        /* Additional mobile fixes */
        @media (max-width: 480px) {
            /* Extra small screens */
            .user-input-container {
                width: 98% !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
            }
            
            .bottom-nav-container {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }
            
            main {
                padding-left: 0.25rem !important;
                padding-right: 0.25rem !important;
            }
        }
        
        /* Ensure proper mobile layout on all devices */
        @media screen and (max-width: 1024px) {
            body {
                -webkit-text-size-adjust: 100%;
                -ms-text-size-adjust: 100%;
            }
            
            /* Force proper mobile layout */
            html {
                -webkit-text-size-adjust: 100%;
                -ms-text-size-adjust: 100%;
            }
            
            /* Ensure input container stays centered */
            .user-input-container {
                position: fixed !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                z-index: 30 !important;
            }
            
            /* Ensure bottom navigation stays at bottom */
            .bottom-nav-container {
                position: fixed !important;
                bottom: 1rem !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 40 !important;
            }
        }
        
        /* Comprehensive Mobile Media Queries */
        
        /* Extra Small Devices (phones, 320px and up) */
        @media (min-width: 320px) and (max-width: 479px) {
            html, body {
                font-size: 0.875rem; /* 14px */
            }
            
            .user-input-container {
                width: 98% !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                bottom: 6.5rem !important; /* 104px */
            }
            
            .bottom-nav-container {
                padding: 0.75rem 0.5rem !important;
                bottom: 0.5rem !important;
            }
            
            main {
                padding-left: 0.25rem !important;
                padding-right: 0.25rem !important;
            }
        }
        
        /* Small Devices (phones, 480px and up) */
        @media (min-width: 480px) and (max-width: 639px) {
            html, body {
                font-size: 1rem; /* 16px */
            }
            
            .user-input-container {
                width: 95% !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                bottom: 7rem !important; /* 112px */
            }
            
            .bottom-nav-container {
                padding: 1rem 0.75rem !important;
                bottom: 0.75rem !important;
            }
        }
        
        /* Medium Devices (tablets, 640px and up) */
        @media (min-width: 640px) and (max-width: 767px) {
            html, body {
                font-size: 1.0625rem; /* 17px */
            }
            
            .user-input-container {
                width: 90% !important;
                max-width: 32rem !important; /* 512px */
                left: 50% !important;
                transform: translateX(-50%) !important;
                bottom: 7.5rem !important; /* 120px */
            }
            
            .bottom-nav-container {
                padding: 1rem 1rem !important;
                bottom: 1rem !important;
            }
        }
        
        /* Large Devices (desktops, 768px and up) */
        @media (min-width: 768px) and (max-width: 1023px) {
            html, body {
                font-size: 1.125rem; /* 18px */
            }
            
            .user-input-container {
                width: 85% !important;
                max-width: 37.5rem !important; /* 600px */
                left: 50% !important;
                transform: translateX(-50%) !important;
                bottom: 8rem !important; /* 128px */
            }
            
            .bottom-nav-container {
                padding: 1.25rem 1.25rem !important;
                bottom: 1.25rem !important;
            }
        }
        
        /* Extra Large Devices (large desktops, 1024px and up) */
        @media (min-width: 1024px) {
            html, body {
                font-size: 1.125rem; /* 18px */
            }
            
            .user-input-container {
                width: 80% !important;
                max-width: 37.5rem !important; /* 600px */
                left: 50% !important;
                transform: translateX(-50%) !important;
                bottom: 8.5rem !important; /* 136px */
            }
            
            .bottom-nav-container {
                padding: 1.5rem 1.5rem !important;
                bottom: 1.5rem !important;
            }
        }

    </style>
</head>
    <body style="background-color: #F8F9FA; padding-bottom: env(safe-area-inset-bottom);">
    <!-- Header -->
            <header id="main-header" class="fixed top-0 left-0 right-0 z-50 border-b border-gray-200" style="background-color: #F8F9FA;">
        <div class="flex justify-between items-center px-2 sm:px-3 py-3">
            <!-- Left: Menu Icon (Original - Two Thin Lines) -->
            <div class="flex items-center">
                <button class="p-2 hover:bg-gray-100 rounded-lg transition-colors" onclick="toggleUserMenu()" title="User Menu">
                <div class="flex flex-col space-y-1">
                        <div class="w-5 h-0.5 bg-gray-600"></div>
                        <div class="w-4 h-0.5 bg-gray-600"></div>
                </div>
                </button>
            </div>
            
            <!-- Center: App Title -->
            <div class="absolute left-1/2 transform -translate-x-1/2">
                <h1 class="text-lg sm:text-xl font-semibold text-gray-800">High School</h1>
            </div>
            
            <!-- Right: Share Icon -->
            <div class="flex items-center">
                <button class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Share" onclick="shareMainConversation()">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">ÿ≥€åÿ≥ÿ™ŸÖ ÿ¢ŸÖŸàÿ≤ÿ¥€å</h1>
                <p class="text-gray-600">Ÿàÿ±ŸàÿØ ÿ®ÿß ÿ¥ŸÖÿßÿ±Ÿá ŸÖŸàÿ®ÿß€åŸÑ</p>
            </div>

            <!-- Step 1: Phone Number -->
            <div id="login-step1" class="login-step active">
                <form id="phoneForm">
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            ÿ¥ŸÖÿßÿ±Ÿá ŸÖŸàÿ®ÿß€åŸÑ
                        </label>
                        <input 
                            type="tel" 
                            id="phoneNumber" 
                            class="phone-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="09123456789"
                            maxlength="11"
                            required
                            style="direction: ltr; text-align: left;"
                        >
                    </div>
                    
                    <button 
                        type="submit" 
                        id="sendCodeBtn"
                        class="btn-primary w-full text-white font-bold py-3 px-4 rounded-lg"
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"
                    >
                        <span id="sendText">ÿßÿ±ÿ≥ÿßŸÑ ⁄©ÿØ ÿ™ÿ£€å€åÿØ</span>
                        <span id="sendLoading" class="hidden">
                            <svg class="animate-spin h-5 w-5 text-white inline-block ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            ÿØÿ± ÿ≠ÿßŸÑ ÿßÿ±ÿ≥ÿßŸÑ...
                        </span>
                    </button>
                </form>
            </div>

            <!-- Step 2: Verification Code -->
            <div id="login-step2" class="login-step hidden">
                <form id="codeForm">
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            ⁄©ÿØ ÿ™ÿ£€å€åÿØ ÿßÿ±ÿ≥ÿßŸÑ ÿ¥ÿØŸá
                        </label>
                        <input 
                            type="text" 
                            id="verificationCode" 
                            class="code-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="123456"
                            maxlength="6"
                            required
                            style="direction: ltr; text-align: center; font-size: 1.5rem; letter-spacing: 0.5rem;"
                        >
                        <p class="text-sm text-gray-500 mt-2">
                            ⁄©ÿØ ÿ™ÿ£€å€åÿØ ÿ®Ÿá ÿ¥ŸÖÿßÿ±Ÿá <span id="displayPhone"></span> ÿßÿ±ÿ≥ÿßŸÑ ÿ¥ÿØ
                        </p>
                    </div>
                    
                    <button 
                        type="submit" 
                        id="verifyBtn"
                        class="btn-primary w-full text-white font-bold py-3 px-4 rounded-lg mb-4"
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"
                    >
                        <span id="verifyText">ÿ™ÿ£€å€åÿØ ⁄©ÿØ</span>
                        <span id="verifyLoading" class="hidden">
                            <svg class="animate-spin h-5 w-5 text-white inline-block ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            ÿØÿ± ÿ≠ÿßŸÑ ÿ™ÿ£€å€åÿØ...
                        </span>
                    </button>

                    <button 
                        type="button" 
                        id="resendBtn"
                        class="w-full text-gray-600 font-medium py-2 px-4 rounded-lg border border-gray-300 hover:bg-gray-50"
                    >
                        ÿßÿ±ÿ≥ÿßŸÑ ŸÖÿ¨ÿØÿØ ⁄©ÿØ
                    </button>
                </form>
            </div>

            <!-- Error Message -->
            <div id="login-error" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                <span id="login-error-text"></span>
            </div>

            <!-- Success Message -->
            <div id="login-success" class="hidden mt-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
                <span id="login-success-text"></span>
            </div>
        </div>
    </div>

    <!-- User Menu Overlay -->
    <div id="user-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="closeUserMenu()"></div>
    
    <!-- User Menu Panel -->
    <div id="user-menu-panel" class="fixed top-0 left-0 h-full w-80 bg-white shadow-lg z-50 transform -translate-x-full transition-transform duration-300">
        <div class="p-6">
            <!-- User Info Header -->
            <div class="flex items-center space-x-4 mb-6">
                <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">ÿ≠ÿ≥ÿßÿ® ⁄©ÿßÿ±ÿ®ÿ±€å</h3>
                    <p id="user-phone-display" class="text-sm text-gray-600"></p>
                </div>
            </div>
            
            <!-- Menu Items -->
            <div class="space-y-2">
                <button class="w-full text-right py-3 px-4 hover:bg-gray-100 rounded-lg transition-colors" onclick="closeUserMenu()">
                    <span class="text-gray-700">ÿ®ÿßÿ≤⁄Øÿ¥ÿ™</span>
                </button>
                
                <!-- Logout button disabled for mobile testing -->
                <!-- <button class="w-full text-right py-3 px-4 hover:bg-red-100 rounded-lg transition-colors text-red-600" onclick="logout()">
                    <span class="flex items-center justify-between">
                        <span>ÿÆÿ±Ÿàÿ¨ ÿßÿ≤ ÿ≠ÿ≥ÿßÿ®</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </span>
                </button> -->
            </div>
        </div>
    </div>

    <!-- Main Chat Container -->
            <main class="pt-24 px-2 sm:px-3 relative flex flex-col" style="background-color: #F8F9FA; min-height: 100vh;">
        <div class="max-w-full mx-auto flex-1">
            <!-- Chat Messages Container -->
            <div id="chat-messages" class="chat-container space-y-6 hidden" style="padding-bottom: 6.25rem; display: none;"> <!-- 100px -->
                <!-- Messages will be populated by JavaScript -->
            </div>
        </div>
    </main>
    
    <!-- User Input - Fixed positioning above icons -->
            <div id="main-user-input" class="user-input-container fixed left-1/2 transform -translate-x-1/2" style="width: 95%; max-width: 37.5rem; bottom: 7.5rem;"> <!-- 600px, 120px -->
            <!-- Input Bar (Search Bar) -->
                            <div class="input-bar bg-[#e8e8e4] rounded-full shadow-lg flex items-center px-6 py-3" style="height: 65px; border-radius: 9999px;">
                <!-- Recorder Button - Left Side -->
                <button class="absolute left-2 top-1/2 w-8 h-8 text-gray-600 rounded-full transition-all duration-200 flex items-center justify-center z-20 hover:bg-gray-200" style="transform: translateY(-50%);" onclick="startRecording()" title="Voice Recording">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="12" y1="19" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <line x1="8" y1="23" x2="16" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
                
                <!-- Center: Input Field -->
                <div class="flex-1 mx-4">
                    <script>
                        // Function to handle input focus - make button black immediately (Analysis Page Style)
                        function handleInputFocus(textarea) {
                            console.log(' Input focused, showing expanded input');
                            // Switch to chat header when input is focused
                            const expandedInputContainer = document.getElementById('expanded-input-container');
                            if (expandedInputContainer) {
                                expandedInputContainer.classList.remove('hidden');
                            }
                            textarea.classList.add('input-focused');
                            // Additional UI logic can be added here
                        }
                    </script>
                    <textarea 
                        id="user-input" 
                        class="user-input w-full px-2 py-2 pr-20 resize-none text-gray-900 placeholder-gray-500 text-xl transition-all duration-200 bg-transparent border-none outline-none"
                        placeholder="Learn anything..."
                        rows="1"
                        onclick="handleInputFocus(this)"
                        style="pointer-events: auto; min-height: 40px; cursor: pointer;"
                    ></textarea>
                </div>
                
                <!-- Paperclip Icon - Right Side -->
                <button 
                    class="absolute right-2 top-1/2 w-8 h-8 text-gray-600 rounded-full transition-all duration-200 flex items-center justify-center z-20 hover:bg-gray-200"
                    style="transform: translateY(-50%);"
                    onclick="attachDocument()"
                    title="Attach Document"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                
                <!-- Send Button - Between Paperclip and Right Edge -->
                <button 
                    id="main-send-button"
                    class="absolute right-12 top-1/2 w-12 h-12 bg-gray-400 text-white rounded-full transition-all duration-200 flex items-center justify-center z-20"
                    style="opacity: 0; pointer-events: none; transform: translateY(-50%) scale(0.75);"
                    onclick="sendMessage()"
                    title="Send Message"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V5M5 12l7-7 7 7"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Thin Border Separator -->
        <div class="border-b border-gray-200 mx-auto" style="width: 95%; max-width: 37.5rem;"></div> <!-- 600px -->
    </main>
    
    <!-- Enhanced Responsive Bottom Navigation Bar -->
    <nav class="bottom-nav-container fixed bottom-0 left-0 right-0 z-50" style="background-color: #E8E8E4; padding-bottom: env(safe-area-inset-bottom);">
        <div class="nav-content flex justify-around items-center py-3 px-4 max-w-md mx-auto">
            <!-- Home Icon -->
            <button class="nav-item flex flex-col items-center p-2 transition-all duration-200 hover:scale-105" onclick="handleChatClick()" title="Home">
                <svg class="w-6 h-6 text-gray-700 nav-icon active" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" stroke-width="2"/>
                </svg>
                <span class="nav-label text-xs text-gray-600 mt-1 hidden sm:block">Home</span>
            </button>
            
            <!-- Library Icon -->
            <button class="nav-item flex flex-col items-center p-2 transition-all duration-200 hover:scale-105" onclick="goToLibrary()" title="Library">
                <svg class="w-6 h-6 text-gray-700 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" stroke-width="2"/>
                </svg>
                <span class="nav-label text-xs text-gray-600 mt-1 hidden sm:block">Library</span>
            </button>
            
            <!-- Analysis Icon -->
            <button class="nav-item flex flex-col items-center p-2 transition-all duration-200 hover:scale-105" onclick="goToAnalysis()" title="Analysis">
                <svg class="w-6 h-6 text-gray-700 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" stroke-width="2"/>
                </svg>
                <span class="nav-label text-xs text-gray-600 mt-1 hidden sm:block">Analysis</span>
            </button>
            
            <!-- Test Icon -->
            <button class="nav-item flex flex-col items-center p-2 transition-all duration-200 hover:scale-105" onclick="goToTest()" title="Test">
                <svg class="w-6 h-6 text-gray-700 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="10" stroke-width="2"/>
                    <path d="M9 12l2 2 4-4" stroke-width="2"/>
                </svg>
                <span class="nav-label text-xs text-gray-600 mt-1 hidden sm:block">Test</span>
            </button>
            
            <!-- Settings Icon -->
            <button class="nav-item flex flex-col items-center p-2 transition-all duration-200 hover:scale-105" onclick="goToSettings()" title="Settings">
                <svg class="w-6 h-6 text-gray-700 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="3" stroke-width="2"/>
                    <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z" stroke-width="2"/>
                </svg>
                <span class="nav-label text-xs text-gray-600 mt-1 hidden sm:block">Settings</span>
            </button>
        </div>
    </nav>
        
                
                 <!-- Expanded Input Container (Hidden by default) - Analysis Page Style -->
                 <div id="analysis-expanded-input-container" class="fixed bottom-0 left-0 right-0 bg-[#e8e8e4] shadow-2xl hidden z-100" style="height: 100px; border-top: 1px solid #d1d5db;">
                     <div class="relative h-full p-6">
                         <!-- Expanded Textarea -->
                         <textarea 
                             id="analysis-expanded-user-input" 
                             class="w-full bg-transparent border-none resize-none focus:outline-none text-[#000000] font-sans text-4xl placeholder-[#1e1e1e] pr-20 text-right absolute top-2 right-0"
                             placeholder="Learn anything..."
                             rows="3"
                             onkeydown="handleAnalysisExpandedInputKeyDown(event)"
                             oninput="handleAnalysisInputChange(this)"
                             style="min-height: 80px; line-height: 1.5; cursor: text; font-size: 2.25rem;"
                         ></textarea>
                         
                         <!-- Recorder Icon Button - Right Side -->
                         <button class="recorder-button absolute bottom-3 right-14 w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors" style="background-color: #D4D4D0;" onclick="startRecording()" title="Voice Recording">
                             <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                 <path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                 <line x1="12" y1="19" x2="12" y2="23" stroke-width="2" stroke-linecap="round"/>
                                 <line x1="8" y1="23" x2="16" y2="23" stroke-width="2" stroke-linecap="round"/>
                                     </svg>
                                 </button>
                                 
                         <!-- Paperclip Icon Button - Very Right Side -->
                         <button class="document-button absolute bottom-3 right-4 w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors" style="background-color: #D4D4D0;" onclick="attachDocument()" title="Attach Document">
                             <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                     </svg>
                                 </button>
                         
                         <!-- Send Button - Left Side -->
                         <button id="analysis-expanded-send-button" class="send-button absolute bottom-3 left-4 w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors bg-gray-300" onclick="sendAnalysisExpandedMessage()" title="Send Message">
                             <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V5M5 12l7-7 7 7"/>
                             </svg>
                         </button>
                         
                     </div>
                 </div>
                     
        <!-- Chat Input for After AI Response (Hidden by default) - Analysis Page Style -->
        <div id="chat-input-after-response" class="fixed bottom-0 left-0 right-0 bg-transparent hidden z-50" style="padding-bottom: 0.25rem;">
            <div class="px-4 sm:px-6 pb-4" style="z-index: 10; pointer-events: none;">
                <div class="max-w-5xl mx-auto flex justify-center">
                    <div class="relative w-full max-w-2xl">
                        <div class="input-bar bg-[#e8e8e4] rounded-full shadow-lg flex items-center px-6 py-3" style="height: 65px; border-radius: 9999px;">
                         <textarea 
                                id="chat-input-field" 
                                class="user-input w-full px-2 py-2 pr-20 resize-none text-gray-900 placeholder-gray-500 text-xl transition-all duration-200 bg-transparent border-none outline-none"
                             placeholder="Learn anything..."
                                rows="1"
                                onclick="showExpandedInputFromChat()"
                                style="pointer-events: auto; min-height: 40px; cursor: pointer;"
                                readonly
                         ></textarea>
                         
                            <!-- Recorder Icon - Left Side -->
                            <button 
                                class="absolute left-2 top-1/2 w-8 h-8 text-gray-600 rounded-full transition-all duration-200 flex items-center justify-center z-20 hover:bg-gray-200"
                                style="transform: translateY(-50%);"
                                onclick="startRecording()"
                                title="Voice Recording"
                            >
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <line x1="12" y1="19" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    <line x1="8" y1="23" x2="16" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </button>
                            
                            <!-- Paperclip Icon - Right Side -->
                            <button 
                                class="absolute right-2 top-1/2 w-8 h-8 text-gray-600 rounded-full transition-all duration-200 flex items-center justify-center z-20 hover:bg-gray-200"
                                style="transform: translateY(-50%);"
                                onclick="attachDocument()"
                                title="Attach Document"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            
                            <!-- Send Button - Between Paperclip and Right Edge -->
                            <button 
                                id="chat-send-button"
                                class="absolute right-12 top-1/2 w-12 h-12 bg-gray-400 text-white rounded-full transition-all duration-200 flex items-center justify-center z-20"
                                style="opacity: 0; pointer-events: none; transform: translateY(-50%) scale(0.75);"
                                onclick="sendChatMessage()"
                                title="Send Message"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V5M5 12l7-7 7 7"/>
                    </svg>
                </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </main>
    

    
    <!-- Remove the separate white navigation bar -->
    
    <script>
        let currentConversationId = 'default';
        let isStreaming = false;
        let currentThreadId = null;
        let isThreadLoaded = false;
        
        
        
        // All events are handled by inline onclick, onfocus, onblur attributes
        
        // Initialize conversation
        async function initializeConversation() {
            try {
                const response = await fetch('/api/chat/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                currentConversationId = data.conversationId;
                console.log('New conversation started:', currentConversationId);
            } catch (error) {
                console.error('Failed to start conversation:', error);
            }
        }
        

        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            
            // Update button color based on typing
            const sendButton = document.getElementById('main-send-button');
            if (textarea.value.trim() !== '') {
                textarea.classList.add('typing-active');
                // Send button black when typing
                sendButton.classList.remove('bg-gray-400');
                sendButton.classList.add('bg-black');
            } else {
                textarea.classList.remove('typing-active');
                // Send button pale gray when empty
                sendButton.classList.remove('bg-black');
                sendButton.classList.add('bg-gray-400');
            }
        }
        
        // Auto-resize function for the chat bar textarea
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }
        
        // Function to handle input changes for button color
        function handleInputChange(textarea) {
            const sendButton = document.getElementById('main-send-button');
            if (textarea.value.length > 0) {
                // User is typing - make button black
                sendButton.classList.remove('bg-gray-400');
                sendButton.classList.add('bg-black');
            } else {
                // No text - make button pale gray
                sendButton.classList.remove('bg-black');
                sendButton.classList.add('bg-gray-400');
            }
        }
        
        // Function to show expanded input
        // Function to handle input focus - make button black immediately (Analysis Page Style)
        function handleInputFocus(textarea) {
            console.log('üéØ Input focused, showing expanded input');
            
            // Switch to chat header when input is focused
            switchToChatHeader();
            
            // Hide the regular chat input section
            const chatInputSection = document.getElementById('main-user-input');
            if (chatInputSection) {
                chatInputSection.style.display = 'none';
            }
            
            // Hide bottom navigation (icons) when showing expanded input
            const bottomNav = document.querySelector('.bottom-nav-container');
            if (bottomNav) {
                bottomNav.style.display = 'none';
            }
            
            // Show expanded input
            const expandedInput = document.getElementById('analysis-expanded-input-container');
            if (expandedInput) {
                expandedInput.classList.remove('hidden');
                expandedInput.style.display = 'block';
            }
            
            // Focus on the expanded textarea
            setTimeout(() => {
               const expandedTextarea = document.getElementById('analysis-expanded-user-input');
                if (expandedTextarea) {
                    expandedTextarea.focus();
                }
            }, 100);
        }
        
        // Function to hide bottom icons
        function hideBottomIcons() {
            const iconsContainer = document.querySelector('.bottom-nav-container');
            if (iconsContainer) {
                iconsContainer.style.display = 'none';
            }
        }
        
        // Function to disable page scrolling
        function disableScrolling() {
            document.body.style.overflow = 'hidden';
            document.documentElement.style.overflow = 'hidden';
        }
        
        // Function to enable page scrolling
        function enableScrolling() {
            document.body.style.overflow = 'auto';
            document.documentElement.style.overflow = 'auto';
        }
        
        // Function to show bottom icons
        function showBottomIcons() {
            const iconsContainer = document.querySelector('.bottom-nav-container');
            if (iconsContainer) {
                iconsContainer.style.display = 'flex';
            }
        }
        
        // Analysis Page Style Functions
        function handleAnalysisExpandedInputKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendAnalysisExpandedMessage();
            }
        }
        
        function handleAnalysisInputChange(textarea) {
            const sendButton = document.getElementById('analysis-expanded-send-button');
            if (sendButton) {
                if (textarea.value.trim()) {
                    sendButton.classList.remove('bg-gray-300');
                    sendButton.classList.add('bg-black');
                } else {
                    sendButton.classList.remove('bg-black');
                    sendButton.classList.add('bg-gray-300');
                }
            }
        }
        
        async function sendAnalysisExpandedMessage() {
            console.log('üöÄ sendAnalysisExpandedMessage function called');
            
            // SCROLL TO TOP immediately when send button is clicked
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            const messagesContainer = document.getElementById('chat-messages');
            if (messagesContainer) {
                messagesContainer.scrollTop = 0;
            }
            console.log('üì® SCROLLED TO TOP on send button click');
            
            const textarea = document.getElementById('analysis-expanded-user-input');
            const message = textarea.value.trim();
            
            if (message) {
                console.log('üìù Message content:', message);
                
                
                // Display user message using proper addMessage function
                addMessage(message, true);
                
                // Save user message to thread
                // Message saving removed
                
                // Clear input after displaying message
                textarea.value = '';
                
                // Hide expanded input immediately
                const expandedInput = document.getElementById('analysis-expanded-input-container');
                if (expandedInput) {
                    expandedInput.classList.add('hidden');
                    expandedInput.style.display = 'none';
                }
                
                // Hide bottom navigation during AI response
                const bottomNav = document.querySelector('.bottom-nav-container');
                if (bottomNav) {
                    bottomNav.style.display = 'none';
                }
                
                // Hide main user input during AI response
                const mainUserInput = document.getElementById('main-user-input');
                if (mainUserInput) {
                    mainUserInput.style.display = 'none';
                }
                
                // Small delay to ensure UI is properly updated
                await new Promise(resolve => setTimeout(resolve, 50));
                
                // Save user message to conversation (non-blocking)
                saveMessage('user', message).catch(error => {
                    console.log('‚ö†Ô∏è Failed to save user message:', error);
                });
                
                // Send message to AI using the existing sendMessageToAI function
                await sendMessageToAI(message);
            }
        }
        
        // Function to send message to AI (Analysis Page Style)
        async function sendMessageToAI(message) {
            console.log('üöÄ sendMessageToAI function called with message:', message);
            
            if (isStreaming) {
                console.log('‚ö†Ô∏è Already streaming, ignoring new message');
                return;
            }
            
            // Declare fullResponse outside try block so it's accessible in finally
            let fullResponse = '';
            
            try {
                isStreaming = true;
                
                
                // Build context for AI (recent conversation history)
                const contextForAI = [];
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer) {
                    const messageElements = messagesContainer.querySelectorAll('[id^="msg_"]');
                    const recentMessages = Array.from(messageElements).slice(-10); // Last 10 messages
                    
                    recentMessages.forEach(msgElement => {
                        const isUser = msgElement.classList.contains('justify-start');
                        const contentElement = msgElement.querySelector('div[class*="text-"]');
                        if (contentElement) {
                            contextForAI.push({
                                role: isUser ? 'user' : 'assistant',
                                content: contentElement.textContent.trim()
                            });
                        }
                    });
                }
                
                console.log('üì§ Making API call to /api/chat/stream');
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        thread_id: currentThreadId,
                        user_id: localStorage.getItem('user_id') || '1',
                        context: contextForAI
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Handle streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                // Create AI message using proper addMessage function
                const messageId = `ai-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                addMessage('', false, messageId);
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        
                        try {
                            // Remove "data: " prefix if present
                            let jsonLine = line;
                            if (line.startsWith('data: ')) {
                                jsonLine = line.substring(6);
                            }
                            
                            const data = JSON.parse(jsonLine);
                            console.log('üì• Received data:', data);
                            if (data.content) {
                                fullResponse += data.content;
                                console.log('üìù Full response so far:', fullResponse);
                                
                                // Update message content directly
                                updateMessageContent(messageId, fullResponse);
                            }
                        } catch (e) {
                            console.log('Non-JSON line:', line);
                        }
                    }
                }
                
                console.log('‚úÖ AI response completed');
                
                // Save AI response to conversation (non-blocking)
                if (fullResponse.trim()) {
                    saveMessage('assistant', fullResponse).catch(error => {
                        console.log('‚ö†Ô∏è Failed to save AI response:', error);
                    });
                }
                
                // If no response was received, show a fallback message
                if (!fullResponse.trim()) {
                    console.log('‚ö†Ô∏è No response content received, showing fallback');
                    updateMessageContent(messageId, 'ŸÖÿ™ÿ£ÿ≥ŸÅÿßŸÜŸá Ÿæÿßÿ≥ÿÆ ŸÖŸÜÿßÿ≥ÿ®€å ÿØÿ±€åÿßŸÅÿ™ ŸÜÿ¥ÿØ. ŸÑÿ∑ŸÅÿßŸã ÿØŸàÿ®ÿßÿ±Ÿá ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ€åÿØ.');
                }
                
            } catch (error) {
                console.error('‚ùå Error in sendMessageToAI:', error);
                // Show error message in chat
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'flex justify-start mb-4';
                    errorDiv.innerHTML = `
                        <div class="bg-red-100 rounded-lg px-4 py-2 max-w-xs lg:max-w-md">
                            <div class="text-red-800">ŸÖÿ™ÿ£ÿ≥ŸÅÿßŸÜŸá ÿÆÿ∑ÿß€å€å ÿ±ÿÆ ÿØÿßÿØ. ŸÑÿ∑ŸÅÿßŸã ÿØŸàÿ®ÿßÿ±Ÿá ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ€åÿØ.</div>
                        </div>
                    `;
                    messagesContainer.appendChild(errorDiv);
                }
            } finally {
                isStreaming = false;
                console.log('‚úÖ Streaming completed, flag reset');
                
                // Show user input after response completes (proper flow)
                showUserInputAfterResponse();
            }
        }
        
        // Throttle function for optimizing streaming updates
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }
        
        // Create throttled update function for faster streaming
        const throttledUpdateMessage = throttle(updateMessage, 16); // ~60fps
        
        // Simple function to update message content for sendMessageToAI
        function updateMessageContent(messageId, content) {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                // Debug: Check message positioning
                console.log('üîç Message element positioning:', {
                    justifyContent: messageElement.style.justifyContent,
                    className: messageElement.className,
                    messageId: messageId
                });
                
                // Find the content div with text-lg class (AI message structure)
                const contentDiv = messageElement.querySelector('.text-lg.leading-relaxed');
                if (contentDiv) {
                    // Format the content using the same formatting as addMessage
                    const formattedContent = formatChatContent(content);
                    contentDiv.innerHTML = formattedContent;
                    
                    // Ensure RTL direction is maintained
                    contentDiv.setAttribute('dir', 'rtl');
                    contentDiv.style.textAlign = 'right';
                    contentDiv.style.direction = 'rtl';
                }
            }
        }
        
        // Function to update an existing message (for streaming) - OPTIMIZED FOR SPEED
        function updateMessage(messageId, content) {
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                const messageBubble = messageElement.querySelector('div[style*="max-width"]');
                if (messageBubble) {
                    const contentDiv = messageBubble.querySelector('div');
                    if (contentDiv) {
                        // OPTIMIZATION: Only update if content actually changed
                        if (contentDiv.textContent === content) return;
                        
                        // Apply study mode formatting during streaming
                        const formattedContent = formatChatContent(content);
                        contentDiv.innerHTML = formattedContent;
                        
                        // CRITICAL: Force RTL alignment for AI messages during streaming
                        if (!messageElement.classList.contains('user-message')) {
                            // Set all RTL properties to prevent content movement
                            contentDiv.setAttribute('dir', 'rtl');
                            contentDiv.style.textAlign = 'right';
                            contentDiv.style.direction = 'rtl';
                            contentDiv.style.unicodeBidi = 'bidi-override';
                            contentDiv.style.textAlignLast = 'right';
                            contentDiv.style.writingMode = 'horizontal-tb';
                            
                            // Force the message bubble to stay right-aligned
                            messageBubble.style.marginLeft = 'auto';
                            messageBubble.style.marginRight = '0';
                            messageBubble.style.textAlign = 'right';
                            
                            // Force the message container to stay right-aligned
                            messageElement.style.justifyContent = 'flex-end';
                            messageElement.style.alignItems = 'flex-start';
                        }
                        
                        // OPTIMIZATION: Reduce layout calculations - only do once per update
                        messageElement.offsetHeight;
                        
                        // Apply interactive elements for streaming updates (only if needed)
                        if (content.includes('<button') || content.includes('<details')) {
                            addInteractiveElements(messageElement);
                        }
                    }
                }
            }
        }
        
        // Function to show user input after AI response completes (Analysis Page Style)
        function showUserInputAfterResponse() {
            // Show separate chat input (like analysis page)
            const chatInputAfterResponse = document.getElementById('chat-input-after-response');
            if (chatInputAfterResponse) {
                chatInputAfterResponse.classList.remove('hidden');
                chatInputAfterResponse.style.display = 'block';
                
                // Ensure it's positioned at the very bottom with 0.25rem padding
                chatInputAfterResponse.style.bottom = '0';
                chatInputAfterResponse.style.paddingBottom = '0.25rem';
                
                console.log('‚úÖ Chat input shown at bottom after response completion');
            }
            
            // Hide bottom navigation when chat input appears (like analysis page)
            const bottomNav = document.querySelector('.bottom-nav-container');
            if (bottomNav) {
                bottomNav.style.display = 'none';
            }
        }
        
        // Function to send message from chat input after response
        async function sendChatMessage() {
            // SCROLL TO TOP immediately when send button is clicked
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            const messagesContainer = document.getElementById('chat-messages');
            if (messagesContainer) {
                messagesContainer.scrollTop = 0;
            }
            console.log('üì® SCROLLED TO TOP on send button click');
            
            const chatInputField = document.getElementById('chat-input-field');
            const message = chatInputField.value.trim();
            
            if (message) {
                // Hide chat input and bottom navigation during AI response
                const chatInputAfterResponse = document.getElementById('chat-input-after-response');
                const bottomNav = document.querySelector('.bottom-nav-container');
                
                if (chatInputAfterResponse) {
                    chatInputAfterResponse.classList.add('hidden');
                    chatInputAfterResponse.style.display = 'none';
                }
                
                if (bottomNav) {
                    bottomNav.style.display = 'none';
                }
                
                // Remove thread-loaded-position class to maintain normal flow
                const mainUserInput = document.getElementById('main-user-input');
                if (mainUserInput) {
                    mainUserInput.classList.remove('thread-loaded-position');
                }
                
                // Send message to AI directly
                await sendMessageToAI(message);
            }
        }
        
        // Switch header to chat mode (three dots + share on left, cross on right)
        function switchToChatHeader() {
            console.log('üîÑ Switching to chat header');
            const header = document.getElementById('main-header');
            if (header) {
                header.innerHTML = `
                    <div class="flex justify-between items-center px-2 sm:px-3 py-3">
                        <!-- Left: Menu Icon + Share Icon -->
                        <div class="flex items-center space-x-2">
                            <!-- Menu Icon (Three Vertical Dots) -->
                            <button class="p-2 hover:bg-gray-100 rounded-lg transition-colors" onclick="toggleUserMenu()" title="User Menu">
                                <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                                    <circle cx="12" cy="6" r="2"/>
                                    <circle cx="12" cy="12" r="2"/>
                                    <circle cx="12" cy="18" r="2"/>
                                </svg>
                            </button>
                            
                            <!-- Share Icon -->
                            <button class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Share" onclick="shareMainConversation()">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Right: Cross/X Icon -->
                        <div class="flex items-center">
                            <button class="p-2 hover:bg-gray-100 rounded-lg transition-colors" onclick="handleHeaderClose()" title="Back to Main Page / Back to Library">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        // Switch header to main mode (original - two lines on left, share on right, title in center)
        function switchToMainHeader() {
            console.log('üîÑ Switching to main header');
            const header = document.getElementById('main-header');
            if (header) {
                header.innerHTML = `
                    <div class="flex justify-between items-center px-2 sm:px-3 py-3">
                        <!-- Left: Menu Icon (Original - Two Thin Lines) -->
                        <div class="flex items-center">
                            <button class="p-2 hover:bg-gray-100 rounded-lg transition-colors" onclick="toggleUserMenu()" title="User Menu">
                            <div class="flex flex-col space-y-1">
                                    <div class="w-5 h-0.5 bg-gray-600"></div>
                                    <div class="w-4 h-0.5 bg-gray-600"></div>
                            </div>
                            </button>
                        </div>
                        
                        <!-- Center: App Title -->
                        <div class="absolute left-1/2 transform -translate-x-1/2">
                            <h1 class="text-lg sm:text-xl font-semibold text-gray-800">High School</h1>
                        </div>
                        
                        <!-- Right: Share Icon -->
                        <div class="flex items-center">
                            <button class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Share" onclick="shareMainConversation()">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        // Handle header close button (X icon)
        function handleHeaderClose() {
            console.log('üîç Header close button clicked');
            
            // Check if we're in thread view mode by checking if bottom icons are hidden
            // and chat input after response is visible
            const bottomNav = document.querySelector('.bottom-nav-container');
            const chatInputAfterResponse = document.getElementById('chat-input-after-response');
            const mainUserInput = document.getElementById('main-user-input');
            
            const isThreadViewMode = (bottomNav && bottomNav.style.display === 'none') && 
                                   (chatInputAfterResponse && chatInputAfterResponse.style.display === 'block') &&
                                   (mainUserInput && mainUserInput.style.display === 'none');
            
            // Additional check: if we have a currentThreadId and isThreadLoaded is true, we're likely in thread view
            const hasActiveThread = currentThreadId && isThreadLoaded;
            
            console.log('üîç Detection results:', {
                bottomNavHidden: bottomNav && bottomNav.style.display === 'none',
                chatInputVisible: chatInputAfterResponse && chatInputAfterResponse.style.display === 'block',
                mainInputHidden: mainUserInput && mainUserInput.style.display === 'none',
                isThreadViewMode: isThreadViewMode,
                hasActiveThread: hasActiveThread,
                currentThreadId: currentThreadId,
                isThreadLoaded: isThreadLoaded
            });
            
            if (isThreadViewMode && hasActiveThread) {
                console.log('üìö In thread view mode, going back to library');
                // Restore normal UI state when going back from thread view
                showBottomIcons();
                
                // Hide chat input after response
                if (chatInputAfterResponse) {
                    chatInputAfterResponse.classList.add('hidden');
                    chatInputAfterResponse.style.display = 'none';
                }
                
                // Restore main user input to normal position
                if (mainUserInput) {
                    mainUserInput.style.display = 'block';
                    mainUserInput.style.visibility = 'visible';
                    mainUserInput.style.bottom = '7.5rem'; // Back to normal position above icons
                    mainUserInput.style.width = '95%';
                    mainUserInput.style.maxWidth = '37.5rem';
                }
                
                // Clear thread state
                currentThreadId = null;
                isThreadLoaded = false;
                
                // Go back to library page
                window.location.href = 'library.html';
            } else {
                console.log('üí¨ In real chat mode, going back to main chat');
                // Go back to main page with icons
                goBackToMainPage();
            }
        }
        
        // Go back to main page with icons
        function goBackToMainPage() {
            console.log('üè† Going back to main page');
            
            // Switch to main header
            switchToMainHeader();
            
            // Clear chat messages
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.innerHTML = '';
            }
            
            // Show welcome elements
            const welcomeElements = document.querySelectorAll('.welcome-container, .initial-chat-container, .chat-start-container');
            welcomeElements.forEach(element => {
                element.style.display = 'block';
            });
            
            // Hide chat input after response (if visible)
            const chatInputAfterResponse = document.getElementById('chat-input-after-response');
            if (chatInputAfterResponse) {
                chatInputAfterResponse.style.display = 'none';
            }
            
            // Show main user input with proper positioning (above icons)
            const mainUserInput = document.getElementById('main-user-input');
            if (mainUserInput) {
                mainUserInput.style.display = 'block';
                mainUserInput.style.visibility = 'visible';
                mainUserInput.style.opacity = '1';
                // Remove thread-loaded-position class to restore normal positioning
                mainUserInput.classList.remove('thread-loaded-position');
                // Reset to normal positioning above icons
                mainUserInput.style.bottom = '7.5rem'; // 120px - above icons
                mainUserInput.style.paddingBottom = '0';
            }
            
            // Show bottom navigation icons
            const bottomNav = document.querySelector('.bottom-nav-container');
            if (bottomNav) {
                bottomNav.style.display = 'flex';
                bottomNav.style.visibility = 'visible';
                bottomNav.style.opacity = '1';
            }
            
            console.log('‚úÖ Back to main page with icons');
        }
        
        // Start new chat and show main page with icons
        function startNewChatAndShowMainPage() {
            console.log('üÜï Starting new chat and showing main page');
            
            // Clear current thread data
            // Thread management removed
            
            // Clear localStorage
            localStorage.removeItem('viewing_thread');
            
            // Clear chat messages
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.innerHTML = '';
            }
            
            // Show welcome elements
            const welcomeElements = document.querySelectorAll('.welcome-container, .initial-chat-container, .chat-start-container');
            welcomeElements.forEach(element => {
                element.style.display = 'block';
            });
            
            // Show main user input with proper positioning (above icons)
            const mainUserInput = document.getElementById('main-user-input');
            if (mainUserInput) {
                mainUserInput.style.display = 'block';
                mainUserInput.style.visibility = 'visible';
                mainUserInput.style.opacity = '1';
                // Remove thread-loaded-position class to restore normal positioning
                mainUserInput.classList.remove('thread-loaded-position');
                // Reset to normal positioning above icons
                mainUserInput.style.bottom = '7.5rem'; // 120px - above icons
                mainUserInput.style.paddingBottom = '0';
            }
            
            // Show bottom navigation icons
            const bottomNav = document.querySelector('.bottom-nav-container');
            if (bottomNav) {
                bottomNav.style.display = 'flex';
                bottomNav.style.visibility = 'visible';
                bottomNav.style.opacity = '1';
            }
            
            console.log('‚úÖ New chat started and main page shown with icons');
        }
        
        // Start new conversation
        function startNewConversation() {
            console.log('üÜï Starting new conversation');
            
            // Clear current thread data
            // Thread management removed
            
            // Clear localStorage
            localStorage.removeItem('viewing_thread');
            
            // Reset page state
            resetPageState();
            
            // Clear chat messages
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.innerHTML = '';
            }
            
            // Show welcome elements
            const welcomeElements = document.querySelectorAll('.welcome-container, .initial-chat-container, .chat-start-container');
            welcomeElements.forEach(element => {
                element.style.display = 'block';
            });
            
            console.log('‚úÖ New conversation started');
        }

        // Function to show expanded input when clicking on chat input
        function showExpandedInputFromChat() {
            console.log('üéØ Chat input clicked, showing expanded input');
            
            // Hide main user input
            const mainUserInput = document.getElementById('main-user-input');
            if (mainUserInput) {
                mainUserInput.style.display = 'none';
            }
            
            // Hide chat input
            const chatInputAfterResponse = document.getElementById('chat-input-after-response');
            if (chatInputAfterResponse) {
                chatInputAfterResponse.classList.add('hidden');
                chatInputAfterResponse.style.display = 'none';
            }
            
            // Hide bottom navigation (icons)
            const bottomNav = document.querySelector('.bottom-nav-container');
            if (bottomNav) {
                bottomNav.style.display = 'none';
            }
            
            // Show expanded input
            const expandedInput = document.getElementById('analysis-expanded-input-container');
            if (expandedInput) {
                expandedInput.classList.remove('hidden');
                expandedInput.style.display = 'block';
                
                // Focus on the expanded textarea
                const expandedTextarea = document.getElementById('analysis-expanded-user-input');
                if (expandedTextarea) {
                    expandedTextarea.focus();
                }
            }
        }
        
        // Chat Input Functions (Analysis Page Style) - Removed unused functions since chat input is readonly
        
        // Function to hide second page
        function hideSecondPage() {
            // Hide second gainsboro page
            const secondPage = document.getElementById('second-gainsboro-page');
            if (secondPage) {
                secondPage.classList.add('hidden');
                secondPage.style.display = 'none';
            }
            
            // Hide expanded input
            const expandedInput = document.getElementById('analysis-expanded-input-container');
            if (expandedInput) {
                expandedInput.classList.add('hidden');
                expandedInput.style.display = 'none';
            }
            
            // Show main user input container and icons
            const userInputContainer = document.getElementById('main-user-input');
            if (userInputContainer) {
                userInputContainer.style.display = 'block';
                // Ensure proper fixed positioning
                userInputContainer.style.position = 'fixed';
                userInputContainer.style.bottom = '4.375rem'; // Match the inline style
                userInputContainer.style.left = '50%';
                userInputContainer.style.transform = 'translateX(-50%)';
                userInputContainer.style.zIndex = '50';
                userInputContainer.style.width = '95%';
                userInputContainer.style.maxWidth = '37.5rem';
            }
            
            // Show bottom icons again
            showBottomIcons();
            
            // Enable scrolling again
            enableScrolling();
        }
        
        // Handle Enter key in expanded input
        function handleExpandedInputKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // Add message to second gainsboro page
        function addExpandedMessage(content, isUser = false) {
            const chatArea = document.getElementById('second-page-chat-area');
            if (!chatArea) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex w-full ${isUser ? 'justify-start' : 'justify-end'} mb-4`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `px-3 sm:px-4 py-4 sm:py-5 rounded-2xl ${
                isUser 
                    ? 'bg-[#e8e8e4] text-black text-left' 
                    : 'w-full text-black text-right'
            } leading-relaxed text-base`;
            messageBubble.style.maxWidth = 'calc(32rem + 0.15rem)';
            if (isUser) {
                messageBubble.style.marginRight = 'auto';
            }
            
            // Use proper formatting for user messages too
            if (isUser) {
                messageBubble.textContent = content;
            } else {
                // For AI messages, use the robust formatting system
                const formattedContent = formatChatContent(content);
                messageBubble.innerHTML = formattedContent;
                // Force width override with inline styles - same as detailed analysis
                messageBubble.style.width = '100%';
                messageBubble.style.maxWidth = '100%';
            }
            
            messageDiv.appendChild(messageBubble);
            chatArea.appendChild(messageDiv);
            
            // VISUAL DEBUG: Check if message was actually added
            console.log('üîç VISUAL DEBUG - Message added to DOM:', {
                messageDiv: messageDiv,
                messageDivClasses: messageDiv.classList.toString(),
                messageDivStyles: messageDiv.style.cssText,
                messageDivOffsetWidth: messageDiv.offsetWidth,
                messageDivOffsetHeight: messageDiv.offsetHeight,
                chatAreaChildrenCount: chatArea.children.length,
                chatAreaScrollHeight: chatArea.scrollHeight
            });
            
            // Ensure proper spacing from bottom input
            if (chatArea.style.paddingBottom) {
                chatArea.scrollTop = chatArea.scrollHeight;
            } else {
            // Scroll to bottom
            chatArea.scrollTop = chatArea.scrollHeight;
            }
        }
        
        // Add streaming message placeholder in second gainsboro page
        function addExpandedStreamingMessage() {
            const chatArea = document.getElementById('second-page-chat-area');
            if (!chatArea) return null;
            
            // Create unique ID for each message
            const messageId = 'expanded-streaming-message-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = 'flex w-full justify-end mb-4';
            
            const messageBubble = document.createElement('div');
            messageBubble.className = 'w-full px-3 sm:px-4 py-4 sm:py-5 rounded-2xl text-black text-right leading-relaxed font-medium';
            messageBubble.style.cssText = 'font-size: 18px !important; font-weight: 500 !important;';
            messageBubble.innerHTML = '<span class="typing-indicator">...</span>';
            
            // Add a data attribute to make it easier to find
            messageBubble.setAttribute('data-message-bubble', 'true');
            
            // Force width override with inline styles - same as detailed analysis
            messageBubble.style.width = '100%';
            messageBubble.style.maxWidth = '100%';
            
            messageDiv.appendChild(messageBubble);
            chatArea.appendChild(messageDiv);
            
            // Ensure proper spacing from bottom input
            if (chatArea.style.paddingBottom) {
                chatArea.scrollTop = chatArea.scrollHeight;
            } else {
            // Scroll to bottom
            chatArea.scrollTop = chatArea.scrollHeight;
            }
            
            return messageId;
        }
        
        // Update streaming message in second gainsboro page - Simple typewriter + Enhanced final formatting
        function updateExpandedStreamingMessage(messageId, content) {
            console.log('üîÑ updateExpandedStreamingMessage called with:', messageId, content);
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                console.log('‚úÖ Found message element:', messageElement);
                const bubble = messageElement.querySelector('[data-message-bubble="true"]');
                if (bubble) {
                    console.log('‚úÖ Found bubble element, updating content');
                    
                    // Enhanced Study Mode formatting during streaming
                    const formattedContent = formatChatContent(content);
                    bubble.innerHTML = formattedContent;
                    
                    // Ensure font size is preserved
                    bubble.style.cssText = 'font-size: 18px !important; font-weight: 500 !important;';
                    
                    // Force width override with inline styles
                    bubble.style.width = '100%';
                    bubble.style.maxWidth = '100%';
                    
                    // Add interactive elements after content is set
                    setTimeout(() => {
                        addInteractiveElements(messageElement);
                    }, 100);
                    
                    // Ensure the content is selectable
                    bubble.style.webkitUserSelect = 'text';
                    bubble.style.userSelect = 'text';
                    bubble.style.cursor = 'text';
                    
                } else {
                    console.log('‚ùå Bubble element not found');
                }
            } else {
                console.log('‚ùå Message element not found for ID:', messageId);
            }
        }
        

        

        
        
        

        
                // Enable scrolling without hiding navigation
        function enableScrollingWithoutHidingNav() {
            // Enable scrolling for the page
            document.body.style.overflow = 'auto';
            document.documentElement.style.overflow = 'auto';
            console.log('‚úÖ Scrolling enabled without hiding navigation');
        }

        // Scroll to bottom of chat
        function scrollToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        // Start new chat function
        function startNewChat() {
            // Clear current conversation
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.innerHTML = '';
            }
            
            // Clear second page chat area
            const secondPageChatArea = document.getElementById('second-page-chat-area');
            if (secondPageChatArea) {
                secondPageChatArea.innerHTML = '';
            }
            
            // Reset conversation state
            currentConversationId = null;
            
            // Clear input
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.value = '';
            }
            
            // Clear expanded input
            const expandedInput = document.getElementById('expanded-user-input');
            if (expandedInput) {
                expandedInput.value = '';
            }
            
            // Initialize new conversation
            initializeConversation();
            
            console.log('üÜï New chat started');
        }
        
        // Show thread menu function
        
        // Share conversation function for second page
        function shareConversation() {
            const chatArea = document.getElementById('second-page-chat-area');
            if (!chatArea || chatArea.children.length === 0) {
                alert('Ÿá€å⁄Ü ⁄ØŸÅÿ™⁄ØŸà€å€å ÿ®ÿ±ÿß€å ÿßÿ¥ÿ™ÿ±ÿß⁄©‚Äå⁄Øÿ∞ÿßÿ±€å Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ');
                return;
            }
            
            // Collect all messages from second page
            let conversationText = '⁄ØŸÅÿ™⁄ØŸà€å ŸÖŸÜ ÿ®ÿß High School AI:\n\n';
            const messages = chatArea.children;
            
            for (let i = 0; i < messages.length; i++) {
                const message = messages[i];
                const isUser = message.classList.contains('justify-start');
                const messageContent = message.querySelector('[data-message-bubble="true"]');
                
                if (messageContent) {
                    const role = isUser ? 'ŸÖŸÜ' : 'AI';
                    conversationText += `${role}: ${messageContent.textContent}\n\n`;
                }
            }
            
            // Try to use Web Share API if available
            if (navigator.share) {
                navigator.share({
                    title: '⁄ØŸÅÿ™⁄ØŸà€å ŸÖŸÜ ÿ®ÿß High School AI',
                    text: conversationText,
                    url: window.location.href
                }).catch(err => {
                    console.log('Error sharing:', err);
                    fallbackShare(conversationText);
                });
            } else {
                fallbackShare(conversationText);
            }
        }
        
        // Copy conversation function
        function copyConversation() {
            const chatArea = document.getElementById('second-page-chat-area');
            if (!chatArea || chatArea.children.length === 0) {
                alert('Ÿá€å⁄Ü ⁄ØŸÅÿ™⁄ØŸà€å€å ÿ®ÿ±ÿß€å ⁄©Ÿæ€å ⁄©ÿ±ÿØŸÜ Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ');
                return;
            }
            
            // Collect all messages
            let conversationText = '⁄ØŸÅÿ™⁄ØŸà€å ŸÖŸÜ ÿ®ÿß High School AI:\n\n';
            const messages = chatArea.children;
            
            for (let i = 0; i < messages.length; i++) {
                const message = messages[i];
                const isUser = message.classList.contains('justify-start');
                const messageContent = message.querySelector('[data-message-bubble="true"]');
                
                if (messageContent) {
                    const role = isUser ? 'ŸÖŸÜ' : 'AI';
                    conversationText += `${role}: ${messageContent.textContent}\n\n`;
                }
            }
            
            // Copy to clipboard
            navigator.clipboard.writeText(conversationText).then(() => {
                alert('⁄ØŸÅÿ™⁄ØŸà ⁄©Ÿæ€å ÿ¥ÿØ! ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€åÿØ ÿ¢ŸÜ ÿ±ÿß ÿØÿ± Ÿáÿ± ÿ¨ÿß€å€å Ÿæ€åÿ≥ÿ™ ⁄©ŸÜ€åÿØ.');
            }).catch(() => {
                alert('ÿÆÿ∑ÿß ÿØÿ± ⁄©Ÿæ€å ⁄©ÿ±ÿØŸÜ ⁄ØŸÅÿ™⁄ØŸà');
            });
        }
        
        // Delete current thread function
        
        // Share main conversation function
        function shareMainConversation() {
            const chatMessages = document.getElementById('chat-messages');
            if (!chatMessages || chatMessages.children.length === 0) {
                alert('Ÿá€å⁄Ü ⁄ØŸÅÿ™⁄ØŸà€å€å ÿ®ÿ±ÿß€å ÿßÿ¥ÿ™ÿ±ÿß⁄©‚Äå⁄Øÿ∞ÿßÿ±€å Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ');
                return;
            }
            
            // Collect all messages from main chat area
            let conversationText = '⁄ØŸÅÿ™⁄ØŸà€å ŸÖŸÜ ÿ®ÿß High School AI:\n\n';
            const messages = chatMessages.children;
            
            for (let i = 0; i < messages.length; i++) {
                const message = messages[i];
                const isUser = message.classList.contains('justify-start');
                const messageContent = message.querySelector('[data-message-bubble="true"]');
                
                if (messageContent) {
                    const role = isUser ? 'ŸÖŸÜ' : 'AI';
                    conversationText += `${role}: ${messageContent.textContent}\n\n`;
                }
            }
            
            // Try to use Web Share API if available
            if (navigator.share) {
                navigator.share({
                    title: '⁄ØŸÅÿ™⁄ØŸà€å ŸÖŸÜ ÿ®ÿß High School AI',
                    text: conversationText,
                    url: window.location.href
                }).catch(err => {
                    console.log('Error sharing:', err);
                    fallbackShare(conversationText);
                });
            } else {
                fallbackShare(conversationText);
            }
        }
        
        // Fallback share function
        function fallbackShare(text) {
            // Copy to clipboard
            navigator.clipboard.writeText(text).then(() => {
                alert('⁄ØŸÅÿ™⁄ØŸà ⁄©Ÿæ€å ÿ¥ÿØ! ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€åÿØ ÿ¢ŸÜ ÿ±ÿß ÿØÿ± Ÿáÿ± ÿ¨ÿß€å€å Ÿæ€åÿ≥ÿ™ ⁄©ŸÜ€åÿØ.');
            }).catch(() => {
                // If clipboard fails, show the text in a prompt
                prompt('⁄ØŸÅÿ™⁄ØŸà ⁄©Ÿæ€å ÿ¥ÿØŸá (Ctrl+C ÿ®ÿ±ÿß€å ⁄©Ÿæ€å):', text);
            });
        }
        
                function addMessage(content, isUser = false, messageId = null, skipFormatting = false) {
            console.log('üîç ===== ADD MESSAGE DEBUG START =====');
            console.log('üì® addMessage called with:', { content: content.substring(0, 100) + '...', isUser, messageId, skipFormatting });
            
            const messagesContainer = document.getElementById('chat-messages');
            console.log('üì® Messages container:', messagesContainer);
            console.log('üì® Messages container current display:', messagesContainer ? messagesContainer.style.display : 'null');
            console.log('üì® Messages container current classes:', messagesContainer ? messagesContainer.classList.toString() : 'null');
            
            const messageDiv = document.createElement('div');
            
            if (messageId) {
                messageDiv.id = messageId;
                console.log('üì® Message ID set:', messageId);
            }
            
            // Proper message positioning - User left, AI right (RTL)
            messageDiv.className = `flex w-full ${isUser ? 'justify-start' : 'justify-end'} mb-6`;
            // Force positioning with inline styles to prevent CSS conflicts
            messageDiv.style.display = 'flex';
            messageDiv.style.width = '100%';
            messageDiv.style.justifyContent = isUser ? 'flex-start' : 'flex-end'; // User left, AI right
            messageDiv.style.alignItems = 'flex-start';
            messageDiv.style.marginBottom = '1.5rem';
            
            // Debug: Log positioning for AI messages
            if (!isUser) {
                console.log('üîç AI message positioning:', {
                    justifyContent: messageDiv.style.justifyContent,
                    className: messageDiv.className,
                    isUser: isUser
                });
            }
            
            // CRITICAL: Position ALL messages at top left for consistent UX
            messageDiv.style.position = 'relative';
            messageDiv.style.top = '0';
            messageDiv.style.left = '0';
            messageDiv.style.right = 'auto';
            messageDiv.style.bottom = 'auto';
            messageDiv.style.transform = 'none';
            messageDiv.style.marginTop = '0';
            messageDiv.style.marginLeft = '0';
            console.log('üì® Message div classes:', messageDiv.className);
            console.log('üì® Message div inline styles applied');
            
            // Check if content is already formatted (contains HTML tags)
            const isAlreadyFormatted = content.includes('<div') || content.includes('<p') || content.includes('<ul') || content.includes('<ol') || content.includes('<li');
            console.log('üì® Is content already formatted:', isAlreadyFormatted);
            
            // Format content properly for AI messages (only if not already formatted and not skipping)
            const displayContent = isUser ? content : (isAlreadyFormatted || skipFormatting ? content : formatChatContent(content));
            console.log('üì® Display content length:', displayContent.length);
            console.log('üì® Display content preview:', displayContent.substring(0, 100) + '...');
            
            const messageContent = `
                <div class="${isUser ? 'bg-gray-200 text-gray-900' : 'text-gray-900 ml-auto'} rounded-3xl px-3 py-4 ${isUser ? 'shadow-sm' : ''}" style="max-width: calc(32rem + 0.15rem); ${isUser ? 'margin-right: auto;' : 'margin-left: auto;'}">
                    <div class="${isUser ? 'text-base' : 'text-lg'} leading-relaxed" ${!isUser ? 'dir="rtl" style="text-align: right; direction: rtl; unicode-bidi: bidi-override; text-align-last: right; writing-mode: horizontal-tb;"' : ''}>${displayContent}</div>
                </div>
            `;
            
            messageDiv.innerHTML = messageContent;
            
            // All messages flow naturally (append at bottom)
            messagesContainer.appendChild(messageDiv);
            console.log('üì® Message appended naturally');
            
            console.log('üì® Message inserted at TOP of container');
            console.log('üì® Message div element:', messageDiv);
            console.log('üì® Message div innerHTML:', messageDiv.innerHTML);
            
            // Debug positioning after appending
            const messageRect = messageDiv.getBoundingClientRect();
            const containerRect = messagesContainer.getBoundingClientRect();
            console.log('üì® Message positioning debug:', {
                messageTop: messageRect.top,
                messageLeft: messageRect.left,
                containerTop: containerRect.top,
                containerLeft: containerRect.left,
                messageCount: messagesContainer.children.length,
                isFirstMessage: messagesContainer.children.length === 1
            });
            console.log('üì® Message div computed style:', window.getComputedStyle(messageDiv));
            
            // Show chat messages container if it's hidden
            if (messagesContainer.classList.contains('hidden') || messagesContainer.style.display === 'none') {
                // Remove hidden class and set proper display
                messagesContainer.classList.remove('hidden');
                messagesContainer.style.display = 'block';
                messagesContainer.style.visibility = 'visible';
                messagesContainer.style.opacity = '1';
                
                // Force immediate layout calculation and positioning
                messagesContainer.offsetHeight;
                
                // Ensure flexbox layout is properly applied
                messagesContainer.style.flexDirection = 'column';
                messagesContainer.style.alignItems = 'stretch';
                
                // Force another layout calculation
                messagesContainer.offsetHeight;
                console.log('üì® Chat messages container shown and positioned');
            }
            
            // CRITICAL: Force ALL messages to top-left positioning
            setTimeout(() => {
                console.log('üì® FORCING TOP-LEFT POSITIONING for all messages');
                
                // Force this specific message positioning based on type
                messageDiv.style.setProperty('position', 'relative', 'important');
                messageDiv.style.setProperty('top', '0', 'important');
                messageDiv.style.setProperty('left', '0', 'important');
                messageDiv.style.setProperty('margin-top', '0', 'important');
                messageDiv.style.setProperty('margin-left', '0', 'important');
                messageDiv.style.setProperty('justify-content', isUser ? 'flex-start' : 'flex-end', 'important');
                messageDiv.style.setProperty('align-items', 'flex-start', 'important');
                
                // Also fix the message bubble inside based on message type
                const messageBubble = messageDiv.querySelector('div');
                if (messageBubble) {
                    if (isUser) {
                        messageBubble.style.setProperty('margin-right', 'auto', 'important');
                        messageBubble.style.setProperty('margin-left', '0', 'important');
                    } else {
                        messageBubble.style.setProperty('margin-left', 'auto', 'important');
                        messageBubble.style.setProperty('margin-right', '0', 'important');
                    }
                }
                
                // Force layout calculation
                messageDiv.offsetHeight;
                console.log('üì® TOP-LEFT POSITIONING FORCED');
            }, 10);
            
            // Force visibility and proper positioning for message div
            messageDiv.style.display = 'flex';
            messageDiv.style.visibility = 'visible';
            messageDiv.style.opacity = '1';
            // Ensure proper flexbox behavior
            messageDiv.style.width = '100%';
            messageDiv.style.flexDirection = 'row';
            // Disable any transitions that might interfere
            messageDiv.style.transition = 'none';
            
            // Scroll logic removed - now handled in send button functions
            
            // Force immediate positioning for first message
            if (isUser && messagesContainer.children.length === 1) {
                messageDiv.style.justifyContent = 'flex-start';
                messageDiv.style.alignItems = 'flex-start';
                console.log('üì® First user message positioning forced');
            }
            
            console.log('üì® Message div forced visible and positioned');
            
            // Enable scrolling after first message without hiding navigation
            enableScrollingWithoutHidingNav();
            
            // Immediate positioning fix with enhanced debugging
            requestAnimationFrame(() => {
                // Force immediate layout calculation
                messageDiv.offsetHeight;
                // Ensure the message is positioned correctly
                const computedStyle = window.getComputedStyle(messageDiv);
                const containerStyle = window.getComputedStyle(messagesContainer);
                
                console.log('üì® Message computed style after positioning:', {
                    display: computedStyle.display,
                    justifyContent: computedStyle.justifyContent,
                    alignItems: computedStyle.alignItems,
                    flexDirection: computedStyle.flexDirection,
                    width: computedStyle.width,
                    marginLeft: computedStyle.marginLeft,
                    marginRight: computedStyle.marginRight,
                    textAlign: computedStyle.textAlign,
                    position: computedStyle.position,
                    left: computedStyle.left,
                    right: computedStyle.right,
                    transform: computedStyle.transform
                });
                
                console.log('üì® Container computed style:', {
                    display: containerStyle.display,
                    justifyContent: containerStyle.justifyContent,
                    alignItems: containerStyle.alignItems,
                    flexDirection: containerStyle.flexDirection,
                    textAlign: containerStyle.textAlign,
                    width: containerStyle.width,
                    maxWidth: containerStyle.maxWidth,
                    margin: containerStyle.margin,
                    padding: containerStyle.padding
                });
                
                // Check if this is the first message and force positioning
                if (isUser && messagesContainer.children.length === 1) {
                    console.log('üì® FIRST MESSAGE DETECTED - Forcing positioning');
                    
                    // Fix the container first - remove centering
                    const mainContainer = messagesContainer.parentElement;
                    if (mainContainer && mainContainer.classList.contains('mx-auto')) {
                        console.log('üì® Removing mx-auto from main container');
                        mainContainer.classList.remove('mx-auto');
                        mainContainer.style.setProperty('margin-left', '0', 'important');
                        mainContainer.style.setProperty('margin-right', '0', 'important');
                    }
                    
                    // Remove any centering classes and force left alignment
                    messageDiv.classList.remove('justify-center', 'text-center', 'mx-auto');
                    messageDiv.classList.add('justify-start', 'text-left');
                    
                    // Force positioning with !important
                    messageDiv.style.setProperty('justify-content', 'flex-start', 'important');
                    messageDiv.style.setProperty('align-items', 'flex-start', 'important');
                    messageDiv.style.setProperty('text-align', 'left', 'important');
                    messageDiv.style.setProperty('margin-left', '0', 'important');
                    messageDiv.style.setProperty('margin-right', 'auto', 'important');
                    messageDiv.style.setProperty('width', '100%', 'important');
                    messageDiv.style.setProperty('display', 'flex', 'important');
                    
                    // Also fix the message bubble inside
                    const messageBubble = messageDiv.querySelector('.bg-gray-200, .text-gray-900');
                    if (messageBubble) {
                        messageBubble.style.setProperty('margin-right', 'auto', 'important');
                        messageBubble.style.setProperty('margin-left', '0', 'important');
                        messageBubble.style.setProperty('text-align', 'left', 'important');
                    }
                    
                    // Force multiple layout calculations
                    messageDiv.offsetHeight;
                    messageDiv.offsetHeight;
                    messageDiv.offsetHeight;
                    
                    console.log('üì® FIRST MESSAGE - Positioning forced with !important');
                }
                
                console.log('üì® Message positioning finalized');
            });
            
            
            // Apply study mode formatting and interactive elements for AI messages
            if (!isUser) {
                console.log('‚úÖ Applying study mode formatting and interactive elements');
                addInteractiveElements(messageDiv);
            }
            
            // Scroll to show the new message at the top
            setTimeout(() => {
                if (isUser) {
                    // For user messages, scroll to show the new message
                    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    // For AI responses, scroll to show the new content below input
                    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
            
            console.log(`Message added: ${isUser ? 'User' : 'AI'} - Total messages: ${messagesContainer.children.length}`);
            console.log('üîç ===== ADD MESSAGE DEBUG END =====');
            
            return messageDiv;
        }
        
        function addStreamingMessage() {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            const messageId = `msg_${Date.now()}`;
            
            messageDiv.id = messageId;
            // AI messages always on the right
            messageDiv.className = 'flex w-full justify-end mb-4';
            
            const messageContent = `
                <div class="ml-auto max-w-full text-gray-900 rounded-3xl px-3 py-4">
                    <div class="text-lg leading-relaxed flex items-center justify-center">
                        <div class="spinning-logo-container">
                            <div class="thinking-text">ÿØÿ± ÿ≠ÿßŸÑ ŸÅ⁄©ÿ± ⁄©ÿ±ÿØŸÜ...</div>
                        </div>
                    </div>
                </div>
            `;
            
            messageDiv.innerHTML = messageContent;
            messagesContainer.appendChild(messageDiv);
            
            // Enable scrolling when streaming starts without hiding navigation
            enableScrollingWithoutHidingNav();
            
            // Scroll to show the new message at the top
            setTimeout(() => {
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
            
            console.log(`Streaming message added - Total messages: ${messagesContainer.children.length}`);
            
            return messageId;
        }
        
        function updateStreamingMessage(messageId, content) {
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                // Ensure the message div maintains its right alignment
                messageDiv.className = 'flex w-full justify-end';
                
                const textElement = messageDiv.querySelector('div');
                
                // Enhanced Study Mode formatting during streaming
                const formattedContent = formatChatContent(content);
                textElement.innerHTML = `<div class="text-right"><span class="text-lg leading-relaxed">${formattedContent}</span></div>`;
                
                // Add interactive elements after content is set
                setTimeout(() => {
                    addInteractiveElements(messageDiv);
                }, 100);
                
                        // Mathematical rendering simplified for deployment
        console.log('‚úÖ Mathematical rendering simplified for deployment');
                
                // Always scroll to show latest content below input
                const messagesContainer = document.getElementById('chat-messages');
                setTimeout(() => {
                    // Scroll to show the new message below input
                    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 50);
            }
        }

        // Enhanced ChatGPT Study Mode formatting with typewriter effect preserved - OPTIMIZED FOR SPEED
        // Enhanced Study Mode Rendering System
        function formatChatContent(content) {
            if (!content || typeof content !== 'string') {
                return '<div class="study-message">ŸÖÿ™ÿ£ÿ≥ŸÅÿßŸÜŸá ŸÖÿ≠ÿ™Ÿàÿß€å€å ÿ®ÿ±ÿß€å ŸÜŸÖÿß€åÿ¥ Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ.</div>';
            }
            
            // OPTIMIZATION: Cache formatted content to avoid re-processing
            if (formatChatContent.cache && formatChatContent.cache[content]) {
                return formatChatContent.cache[content];
            }
            
            // Parse and format the content
            const parsedContent = parseStudyContent(content);
            const result = `<div class="study-message" dir="rtl">${parsedContent}</div>`;
            
            // OPTIMIZATION: Cache the result (limit cache size)
            if (!formatChatContent.cache) {
                formatChatContent.cache = {};
            }
            if (Object.keys(formatChatContent.cache).length < 10) {
                formatChatContent.cache[content] = result;
            }
            
            return result;
        }
        
        // Parse AI output text into structured HTML (Simple bullet points only) - OPTIMIZED FOR SPEED
        function parseStudyContent(text) {
            // OPTIMIZATION: Use single regex operations instead of multiple replace calls
            let processedText = text
                // Remove markdown formatting in one pass
                .replace(/\*\*(.*?)\*\*/g, '$1')  // Bold
                .replace(/\*(.*?)\*/g, '$1')      // Italic
                .replace(/`(.*?)`/g, '$1')         // Code
                .replace(/^#{1,6}\s+(.+)$/gm, '$1') // Headers
                .replace(/^- /gm, '‚Ä¢ ')            // Convert - to ‚Ä¢
                .replace(/^\+ /gm, '‚Ä¢ ')           // Convert + to ‚Ä¢
                .replace(/^\* /gm, '‚Ä¢ ');          // Convert * to ‚Ä¢
            
            // OPTIMIZATION: Process lines more efficiently
            const lines = processedText.split('\n');
            const processedLines = lines.map(line => {
                const trimmedLine = line.trim();
                if (trimmedLine.startsWith('‚Ä¢')) {
                    return `<div class="bullet-point">${trimmedLine}</div>`;
                } else if (trimmedLine.length > 0) {
                    return `<div class="paragraph">${trimmedLine}</div>`;
                }
                return '';
            });
            
            return processedLines.join('');
        }
        
        // Add interactive elements (simplified - no buttons, no collapsible)
        function addInteractiveElements(messageElement) {
            const studyMessage = messageElement.querySelector('.study-message');
            if (!studyMessage) return;
            
            // Process math equations with MathJax
            const mathElements = studyMessage.querySelectorAll('.study-math');
            mathElements.forEach(math => {
                math.style.textAlign = 'center';
                math.style.margin = '1rem 0';
                math.style.display = 'block';
            });
            
            // Re-render MathJax
            setTimeout(() => {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    console.log('üî¢ Processing MathJax for study message');
                    MathJax.typesetPromise([studyMessage]).then(() => {
                        console.log('‚úÖ MathJax processing completed');
                    });
                }
            }, 100);
        }
        
        async function sendMessage() {
            console.log('üöÄ sendMessage function called');
            if (isStreaming) {
                console.log('‚ö†Ô∏è Already streaming, ignoring new message');
                return;
            }
            
            try {
                console.log('üîç Getting message from expanded input...');
            
            // Get message from expanded input
                const expandedInput = document.getElementById('analysis-expanded-user-input');
            let message = '';
            
            if (expandedInput && expandedInput.value.trim() !== '') {
                message = expandedInput.value.trim();
                console.log('üìù Message from expanded input:', message);
            } else {
                console.log('‚ö†Ô∏è No message found in expanded input');
                return;
            }
            
            // Clear the input
            expandedInput.value = '';
            
            // Hide expanded input and show main input
            hideChatInput();
            
            // Send message to AI
            await sendMessageToAI(message);
            
        } catch (error) {
            console.error('‚ùå Error in sendMessage:', error);
            // Always reset streaming flag on error
            isStreaming = false;
            // Show oval input on error for retry
            // Expanded input already hidden after sending - no need to show main input again
        }
    }

        // Stream AI response with thread context
        async function streamAIResponseWithContext(message, messageId, isExpanded = false) {
            try {
                console.log('üöÄ Starting AI call with thread context');
                console.log('üìù User message:', message);
                
                // Ensure we have a thread ID
                // Thread check removed
        
        // ... rest of streamAIResponseWithContext logic ...
        // (If you have additional logic, ensure it is inside this function)
            } catch (error) {
                console.error('‚ùå Error in streamAIResponseWithContext:', error);
            }
        }
        
        // This DOMContentLoaded listener has been consolidated above
        
        function initializeUserMenu() {
            const userPhone = localStorage.getItem('user_phone');
            const userMenu = document.getElementById('user-menu');
            
            if (userPhone && userMenu) {
                const phoneDisplay = userMenu.querySelector('#user-phone-display');
                if (phoneDisplay) {
                    phoneDisplay.textContent = userPhone;
                }
            }
        }
        
        // Phone verification functions - moved to consolidated DOMContentLoaded above
        
        // SMS verification functions
        async function sendVerificationCode(phoneNumber) {
            const sendBtn = document.getElementById('sendCodeBtn');
            const sendText = document.getElementById('sendText');
            const sendLoading = document.getElementById('sendLoading');
            
            setLoginLoading(sendBtn, sendText, sendLoading, true);
            hideLoginMessages();
            
            try {
                const response = await fetch('/api/send-verification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phoneNumber })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showLoginSuccess('⁄©ÿØ ÿ™ÿ£€å€åÿØ ÿßÿ±ÿ≥ÿßŸÑ ÿ¥ÿØ');
                    showLoginStep(2);
                    startResendTimer();
                } else {
                    showLoginError(result.message || 'ÿÆÿ∑ÿß ÿØÿ± ÿßÿ±ÿ≥ÿßŸÑ ⁄©ÿØ');
                }
            } catch (error) {
                console.error('Send code error:', error);
                showLoginError('ÿÆÿ∑ÿß ÿØÿ± ÿßÿ±ÿ™ÿ®ÿßÿ∑ ÿ®ÿß ÿ≥ÿ±Ÿàÿ±');
            } finally {
                setLoginLoading(sendBtn, sendText, sendLoading, false);
            }
        }
        
        async function verifyCode(phoneNumber, code) {
            const verifyBtn = document.getElementById('verifyBtn');
            const verifyText = document.getElementById('verifyText');
            const verifyLoading = document.getElementById('verifyLoading');
            
            setLoginLoading(verifyBtn, verifyText, verifyLoading, true);
            hideLoginMessages();
            
            try {
                const response = await fetch('/api/verify-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phoneNumber, code })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    localStorage.setItem('user_phone', phoneNumber);
                    localStorage.setItem('auth_token', result.token);
                    showLoginSuccess('Ÿàÿ±ŸàÿØ ŸÖŸàŸÅŸÇ€åÿ™‚Äåÿ¢ŸÖ€åÿ≤!');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showLoginError(result.message || '⁄©ÿØ ÿ™ÿ£€å€åÿØ ÿßÿ¥ÿ™ÿ®ÿßŸá ÿßÿ≥ÿ™');
                }
            } catch (error) {
                console.error('Verify code error:', error);
                showLoginError('ÿÆÿ∑ÿß ÿØÿ± ÿßÿ±ÿ™ÿ®ÿßÿ∑ ÿ®ÿß ÿ≥ÿ±Ÿàÿ±');
            } finally {
                setLoginLoading(verifyBtn, verifyText, verifyLoading, false);
            }
        }

        // UI Helper functions
        function showLoginStep(stepNumber) {
            document.querySelectorAll('.login-step').forEach(step => {
                step.classList.add('hidden');
            });
            document.getElementById(`step${stepNumber}`).classList.remove('hidden');
        }


        // Additional helper functions
                
        
        
        function attachDocument() {
            console.log('üìÑ Attaching document...');
            alert('Document attachment feature (to be implemented)');
        }
        
        // Handle Enter key for both input fields
        function handleKeyDown(event, textarea) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        

        

        


        // Initialize page with comprehensive debugging
        // REMOVED: Duplicate DOMContentLoaded listener - now handled above
        

        
        // User Menu Functions
        function initializeUserMenu() {
            const userPhone = localStorage.getItem('user_phone');
            const userPhoneDisplay = document.getElementById('user-phone-display');
            
            if (userPhone && userPhoneDisplay) {
                // Format phone number for display (show first 3 and last 4 digits)
                const formattedPhone = userPhone.replace(/(\d{3})(\d{4})(\d{4})/, '$1***$3');
                userPhoneDisplay.textContent = formattedPhone;
            }
        }
        
        // Login System Functions
        let currentPhoneNumber = '';
        let resendTimer = null;
        let resendCountdown = 60;

        // Initialize phone form event listeners
        function initializePhoneForms() {
            const phoneForm = document.getElementById('phoneForm');
            const codeForm = document.getElementById('codeForm');
            const resendBtn = document.getElementById('resendBtn');

            if (phoneForm) {
                phoneForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const phoneNumber = document.getElementById('phoneNumber').value.trim();
                    if (!phoneNumber) {
                        showLoginError('ŸÑÿ∑ŸÅÿßŸã ÿ¥ŸÖÿßÿ±Ÿá ŸÖŸàÿ®ÿß€åŸÑ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ');
                        return;
                    }

                    if (!/^09\d{9}$/.test(phoneNumber)) {
                        showLoginError('ÿ¥ŸÖÿßÿ±Ÿá ŸÖŸàÿ®ÿß€åŸÑ ÿ®ÿß€åÿØ ÿ®ÿß 09 ÿ¥ÿ±Ÿàÿπ ÿ¥ÿØŸá Ÿà 11 ÿ±ŸÇŸÖ ÿ®ÿßÿ¥ÿØ');
                        return;
                    }

                    currentPhoneNumber = phoneNumber;
                    await sendVerificationCode(phoneNumber);
                });
            }

            if (codeForm) {
                codeForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const code = document.getElementById('verificationCode').value.trim();
                    if (!code) {
                        showLoginError('ŸÑÿ∑ŸÅÿßŸã ⁄©ÿØ ÿ™ÿ£€å€åÿØ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ');
                        return;
                    }

                    if (!/^\d{6}$/.test(code)) {
                        showLoginError('⁄©ÿØ ÿ™ÿ£€å€åÿØ ÿ®ÿß€åÿØ 6 ÿ±ŸÇŸÖ ÿ®ÿßÿ¥ÿØ');
                        return;
                    }

                    await verifyCode(currentPhoneNumber, code);
                });
            }

            if (resendBtn) {
                resendBtn.addEventListener('click', async () => {
                    if (resendTimer) return;
                    await sendVerificationCode(currentPhoneNumber);
                });
            }

            // Format phone number input
            const phoneInput = document.getElementById('phoneNumber');
            if (phoneInput) {
                phoneInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 11) value = value.substring(0, 11);
                    e.target.value = value;
                });
            }

            // Format verification code input
            const codeInput = document.getElementById('verificationCode');
            if (codeInput) {
                codeInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 6) value = value.substring(0, 6);
                    e.target.value = value;
                });
            }
        }

        // Send verification code
        // Duplicate sendVerificationCode removed to fix redeclaration error.
        // Use the version defined earlier in the file.


        // Verify code
        async function verifyCode(phoneNumber, code) {
            const verifyBtn = document.getElementById('verifyBtn');
            const verifyText = document.getElementById('verifyText');
            const verifyLoading = document.getElementById('verifyLoading');
            
            setLoginLoading(verifyBtn, verifyText, verifyLoading, true);
            hideLoginMessages();

            try {
                const response = await fetch('/api/verify-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phoneNumber, code })
                });

                const data = await response.json();

                if (data.success) {
                    // Store token and hide login overlay
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('userPhone', data.phoneNumber);
                    showLoginSuccess('Ÿàÿ±ŸàÿØ ŸÖŸàŸÅŸÇ€åÿ™‚Äåÿ¢ŸÖ€åÿ≤!');
                    
                    // Update user data and hide overlay
                    localStorage.setItem('user_id', '1');
                    localStorage.setItem('is_verified', 'true');
                    localStorage.setItem('user_phone', data.phoneNumber);
                    
                    setTimeout(() => {
                        document.getElementById('login-overlay').classList.add('hidden');
                    }, 1500);
                } else {
                    showLoginError(data.error || '⁄©ÿØ ÿ™ÿ£€å€åÿØ ŸÜÿßŸÖÿπÿ™ÿ®ÿ± ÿßÿ≥ÿ™');
                }
            } catch (error) {
                console.error('Verify code error:', error);
                showLoginError('ÿÆÿ∑ÿß ÿØÿ± ÿßÿ±ÿ™ÿ®ÿßÿ∑ ÿ®ÿß ÿ≥ÿ±Ÿàÿ±');
            } finally {
                setLoginLoading(verifyBtn, verifyText, verifyLoading, false);
            }
        }

        // UI Helper functions
        function showLoginStep(stepNumber) {
            document.querySelectorAll('.login-step').forEach(step => {
                step.classList.add('hidden');
                step.classList.remove('active');
            });
            document.getElementById(`login-step${stepNumber}`).classList.remove('hidden');
            document.getElementById(`login-step${stepNumber}`).classList.add('active');
        }

        function setLoginLoading(button, textElement, loadingElement, isLoading) {
            if (isLoading) {
                button.disabled = true;
                textElement.style.display = 'none';
                loadingElement.classList.remove('hidden');
            } else {
                button.disabled = false;
                textElement.style.display = 'inline';
                loadingElement.classList.add('hidden');
            }
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('login-error');
            const errorText = document.getElementById('login-error-text');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('login-success').classList.add('hidden');
        }

        function showLoginSuccess(message) {
            const successDiv = document.getElementById('login-success');
            const successText = document.getElementById('login-success-text');
            successText.textContent = message;
            successDiv.classList.remove('hidden');
            document.getElementById('login-error').classList.add('hidden');
        }

        function hideLoginMessages() {
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('login-success').classList.add('hidden');
        }

        function startResendTimer() {
            const resendBtn = document.getElementById('resendBtn');
            resendCountdown = 60;
            resendBtn.disabled = true;
            resendBtn.textContent = `ÿßÿ±ÿ≥ÿßŸÑ ŸÖÿ¨ÿØÿØ (${resendCountdown})`;
            
            resendTimer = setInterval(() => {
                resendCountdown--;
                if (resendCountdown <= 0) {
                    clearInterval(resendTimer);
                    resendBtn.disabled = false;
                    resendBtn.textContent = 'ÿßÿ±ÿ≥ÿßŸÑ ŸÖÿ¨ÿØÿØ ⁄©ÿØ';
                    resendTimer = null;
                } else {
                    resendBtn.textContent = `ÿßÿ±ÿ≥ÿßŸÑ ŸÖÿ¨ÿØÿØ (${resendCountdown})`;
                }
            }, 1000);
        }

        // Logout function
        function logout() {
            // Logout disabled for mobile testing
            console.log('üîç Logout disabled for mobile testing');
            closeUserMenu();
        }
        
        function toggleUserMenu() {
            const overlay = document.getElementById('user-menu-overlay');
            const panel = document.getElementById('user-menu-panel');
            
            if (overlay.classList.contains('hidden')) {
                // Open menu
                overlay.classList.remove('hidden');
                panel.classList.remove('-translate-x-full');
            } else {
                // Close menu
                closeUserMenu();
            }
        }
        
        function closeUserMenu() {
            const overlay = document.getElementById('user-menu-overlay');
            const panel = document.getElementById('user-menu-panel');
            
            overlay.classList.add('hidden');
            panel.classList.add('-translate-x-full');
        }
        
        function logout() {
            localStorage.removeItem('user_id');
            localStorage.removeItem('user_phone');
            localStorage.removeItem('is_verified');
            localStorage.removeItem('is_logged_in');
            
            // Close menu
            closeUserMenu();
            
            // Redirect to auth page
            window.location.href = 'auth.html';
        }
        
        // Preload pages for faster mobile navigation
        function preloadPages() {
            const pages = ['test.html', 'question-analysis.html', 'chapters.html', 'analysis-results.html'];
            pages.forEach(page => {
                const link = document.createElement('link');
                link.rel = 'prefetch';
                link.href = page;
                document.head.appendChild(link);
            });
        }
        
        // Thread Management Functions - REBUILT FROM SCRATCH

        // Initialize chat functionality - SIMPLE AND CLEAN
        function initializeChat() {
            console.log('üöÄ Initializing chat...');
            console.log('üîç Current URL:', window.location.href);
            console.log('üîç Document ready state:', document.readyState);
            
            // Pre-initialize chat container to prevent first message positioning issues
            const chatContainer = document.getElementById('chat-messages');
            if (chatContainer) {
                // Ensure container is ready for messages
                chatContainer.style.display = 'none';
                chatContainer.style.visibility = 'hidden';
                chatContainer.style.opacity = '0';
                chatContainer.style.flexDirection = 'column';
                chatContainer.style.alignItems = 'stretch';
                console.log('üì® Chat container pre-initialized');
            }
            

        // Close initializeChat function
        }

        // Display thread conversation - SIMPLE AND CLEAN
        function displayThreadConversation(thread, messages) {
            console.log('üîç ===== DISPLAY THREAD CONVERSATION DEBUG START =====');
            console.log('üì± Displaying thread conversation:', thread.title);
            console.log('üì± Thread object:', thread);
            console.log('üì± Messages to display:', messages.length);
            console.log('üì± Messages array:', messages);
            
            // Set thread context for continuing conversation
            window.isThreadLoaded = true;
            console.log('üîç Thread context set for continuing conversation');
            
            // Update page title and header
            document.title = thread.title || '⁄ØŸÅÿ™⁄ØŸà';
            const headerTitle = document.querySelector('.header-title');
            if (headerTitle) {
                headerTitle.textContent = thread.title || '⁄ØŸÅÿ™⁄ØŸà';
            }
            
            // Switch to chat header when thread is loaded
            console.log('üîç Step 1: Switching to chat header...');
            switchToChatHeader();
            console.log('‚úÖ Chat header switched');
            
            // Get chat container
            console.log('üîç Step 2: Getting chat messages container...');
            const chatMessages = document.getElementById('chat-messages');
            console.log('üì± Chat messages container found:', !!chatMessages);
            console.log('üì± Chat messages element:', chatMessages);
            
            if (!chatMessages) {
                console.error('‚ùå Chat messages container not found');
                console.error('‚ùå Available elements with "chat" in ID:', 
                    Array.from(document.querySelectorAll('[id*="chat"]')).map(el => el.id));
                return;
            }
            
            console.log('üì± Chat messages container current state:', {
                display: chatMessages.style.display,
                visibility: chatMessages.style.visibility,
                opacity: chatMessages.style.opacity,
                innerHTML: chatMessages.innerHTML.length,
                children: chatMessages.children.length
            });
            
            // Clear existing content
            console.log('üîç Step 3: Clearing existing content...');
            chatMessages.innerHTML = '';
            console.log('üì± Chat messages container cleared, new innerHTML length:', chatMessages.innerHTML.length);
            
            // Add messages with debugging (no separate title header)
            console.log('üîç Step 4: Adding messages...');
            console.log('üîç Total messages to display:', messages.length);
            console.log('üîç Messages data:', messages);
            
            if (messages.length === 0) {
                console.log('‚ö†Ô∏è No messages to display');
                console.log('üîç ===== DISPLAY THREAD CONVERSATION DEBUG END =====');
                return;
            }
            
            console.log('üîç Processing each message...');
            messages.forEach((message, index) => {
                console.log(`üîç Processing message ${index + 1}/${messages.length}:`, {
                    id: message.id,
                    sender_role: message.sender_role,
                    content_length: message.content?.length,
                    content_preview: message.content?.substring(0, 50) + '...',
                    created_at: message.created_at
                });
                
                const isUser = message.sender_role === 'user';
                console.log(`üîç Message ${index + 1} is user:`, isUser);
                
                try {
                    addMessage(message.content, isUser, message.id);
                    console.log(`‚úÖ Message ${index + 1} added successfully`);
                } catch (error) {
                    console.error(`‚ùå Error adding message ${index + 1}:`, error);
                }
            });
            
            // Show chat interface
            console.log('üîç Step 5: Showing chat interface...');
            chatMessages.style.display = 'block';
            chatMessages.style.visibility = 'visible';
            chatMessages.style.opacity = '1';
            
            console.log('üì± Chat messages container final state:', {
                display: chatMessages.style.display,
                visibility: chatMessages.style.visibility,
                opacity: chatMessages.style.opacity,
                children: chatMessages.children.length
            });
            
            // Show main user input at bottom (like chat flow)
            console.log('üîç Step 6: Showing main user input...');
            const mainUserInput = document.getElementById('main-user-input');
            if (mainUserInput) {
                mainUserInput.style.display = 'block';
                mainUserInput.style.visibility = 'visible';
                mainUserInput.style.opacity = '1';
                // Override CSS media queries to position at bottom
                mainUserInput.style.bottom = '0px';
                mainUserInput.style.paddingBottom = '0.25rem';
                mainUserInput.style.position = 'fixed';
                mainUserInput.style.left = '50%';
                mainUserInput.style.transform = 'translateX(-50%)';
                mainUserInput.style.zIndex = '50';
                // Add class to override media queries
                mainUserInput.classList.add('thread-loaded-position');
                console.log('‚úÖ Main user input positioned at bottom for thread loading');
            } else {
                console.error('‚ùå Main user input element not found');
            }
            
            // Hide bottom navigation for thread loading (like chat flow)
            console.log('üîç Step 7: Hiding bottom navigation...');
            const bottomNav = document.querySelector('.bottom-nav-container');
            if (bottomNav) {
                bottomNav.style.display = 'none';
                bottomNav.style.visibility = 'hidden';
                bottomNav.style.opacity = '0';
                console.log('‚úÖ Bottom navigation hidden for thread loading');
            } else {
                console.error('‚ùå Bottom navigation element not found');
            }
            
            console.log('‚úÖ Thread conversation displayed successfully');
            console.log('üîç ===== DISPLAY THREAD CONVERSATION DEBUG END =====');
        }
        
        // Simple page state reset
        function resetPageState() {
            console.log('üîÑ Resetting page state...');
            
            // Hide welcome elements
            const welcomeElements = document.querySelectorAll('.welcome-container, .initial-chat-container, .chat-start-container');
            welcomeElements.forEach(element => {
                element.style.display = 'none';
            });
            
            // Show chat interface
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.style.display = 'block';
                chatMessages.style.visibility = 'visible';
                chatMessages.style.opacity = '1';
            }
            
            // Show main user input
            const mainUserInput = document.getElementById('main-user-input');
            if (mainUserInput) {
                mainUserInput.style.display = 'block';
                mainUserInput.style.visibility = 'visible';
                mainUserInput.style.opacity = '1';
            }
            
            // Show bottom navigation (force show)
            const bottomNav = document.querySelector('.bottom-nav-container');
            if (bottomNav) {
                bottomNav.style.display = 'flex';
                bottomNav.style.visibility = 'visible';
                bottomNav.style.opacity = '1';
                bottomNav.classList.remove('hidden');
                console.log('‚úÖ Bottom navigation shown in resetPageState');
            } else {
                console.error('‚ùå Bottom navigation element not found in resetPageState');
            }
            
            console.log('‚úÖ Page state reset complete');
        }

        // Load thread context into UI - SIMPLE AND CLEAN
        function loadThreadContext(thread, messages) {
            console.log('üì± Loading thread context:', thread.title);
            
            // Get chat container
            const chatMessages = document.getElementById('chat-messages');
            if (!chatMessages) {
                console.error('‚ùå Chat messages container not found');
                return;
            }
            
            // Clear existing content
            chatMessages.innerHTML = '';
            
            // Add thread title
            const titleHeader = document.createElement('div');
            titleHeader.className = 'text-center mb-6 p-4 bg-white rounded-lg shadow-sm';
            titleHeader.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-2">${thread.title}</h2>
                <p class="text-gray-600">${messages.length} Ÿæ€åÿßŸÖ</p>
            `;
            chatMessages.appendChild(titleHeader);
            
            // Add messages
            messages.forEach(message => {
                const isUser = message.sender_role === 'user';
                addMessage(message.content, isUser, message.id);
            });
            
            // Show chat interface
            chatMessages.style.display = 'block';
            chatMessages.style.visibility = 'visible';
            chatMessages.style.opacity = '1';
            
            console.log('‚úÖ Thread context loaded successfully');
        }
        
        // Create a completely new, simple thread display
        function createSimpleThreadDisplay(thread, messages) {
            console.log('üîç ===== CREATE SIMPLE THREAD DISPLAY START =====');
            console.log('üîç Creating simple thread display for:', thread.title);
            
            // Clear the second page completely
            const secondPage = document.getElementById('second-gainsboro-page');
            if (secondPage) {
                secondPage.innerHTML = '';
                console.log('üîç Second page cleared');
            }
            
            // Create a simple container
            const container = document.createElement('div');
            container.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background-color: #F8F9FA !important;
                z-index: 100 !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                padding: 20px !important;
                overflow-y: auto !important;
                font-family: Arial, sans-serif !important;
            `;
            
            // Add thread title
            const title = document.createElement('h1');
            title.textContent = thread.title;
            title.style.cssText = `
                color: #333 !important;
                font-size: 24px !important;
                margin-bottom: 20px !important;
                text-align: center !important;
                background: white !important;
                padding: 15px !important;
                border-radius: 10px !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            `;
            container.appendChild(title);
            
            // Add messages
            messages.forEach((message, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    margin: 15px 0 !important;
                    padding: 15px !important;
                    border-radius: 10px !important;
                    max-width: 80% !important;
                    word-wrap: break-word !important;
                    ${message.sender_role === 'user' 
                        ? 'background-color: #e3f2fd !important; margin-left: 0 !important; margin-right: auto !important;' 
                        : 'background-color: transparent !important; margin-left: auto !important; margin-right: 0 !important;'
                    }
                `;
                
                const content = document.createElement('div');
                content.innerHTML = message.content;
                content.style.cssText = `
                    color: #333 !important;
                    font-size: 1rem !important; /* 16px */
                    line-height: 1.5 !important;
                `;
                
                messageDiv.appendChild(content);
                container.appendChild(messageDiv);
            });
            
            // Add input area
            const inputArea = document.createElement('div');
            inputArea.style.cssText = `
                position: fixed !important;
                bottom: 20px !important;
                left: 20px !important;
                right: 20px !important;
                background: white !important;
                padding: 15px !important;
                border-radius: 25px !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
                z-index: 101 !important;
            `;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Type your message...';
            input.style.cssText = `
                width: 100% !important;
                border: none !important;
                outline: none !important;
                font-size: 1rem !important; /* 16px */
                padding: 10px !important;
            `;
            
            inputArea.appendChild(input);
            container.appendChild(inputArea);
            
            // Add to second page
            if (secondPage) {
                secondPage.appendChild(container);
                console.log('üîç Simple thread display created and added to second page');
            }
            
            console.log('üîç ===== CREATE SIMPLE THREAD DISPLAY END =====');
        }
        
        // Visual debugging function to identify visible elements
        function debugVisibleElements() {
            console.log('üîç ===== VISUAL DEBUGGING START =====');
            
            // Check all visible elements
            const allElements = document.querySelectorAll('*');
            const visibleElements = [];
            
            allElements.forEach(element => {
                const computedStyle = window.getComputedStyle(element);
                const isVisible = computedStyle.display !== 'none' && 
                                computedStyle.visibility !== 'hidden' && 
                                computedStyle.opacity !== '0' &&
                                computedStyle.position !== 'absolute' &&
                                element.offsetWidth > 0 && 
                                element.offsetHeight > 0;
                
                if (isVisible && (element.id || element.className)) {
                    visibleElements.push({
                        element: element,
                        id: element.id,
                        className: element.className,
                        tagName: element.tagName,
                        display: computedStyle.display,
                        visibility: computedStyle.visibility,
                        opacity: computedStyle.opacity,
                        position: computedStyle.position,
                        zIndex: computedStyle.zIndex
                    });
                }
            });
            
            console.log('üîç VISIBLE ELEMENTS:', visibleElements.length);
            visibleElements.forEach((item, index) => {
                console.log(`üîç Visible element ${index + 1}:`, {
                    tag: item.tagName,
                    id: item.id,
                    class: item.className,
                    display: item.display,
                    visibility: item.visibility,
                    opacity: item.opacity,
                    position: item.position,
                    zIndex: item.zIndex
                });
            });
            
            console.log('üîç ===== VISUAL DEBUGGING END =====');
            return visibleElements;
        }
        
        // Setup thread UI with SIMPLE UI approach that actually works
        function setupThreadUI(messages) {
            console.log('üîç ===== SETUP THREAD UI WITH SIMPLE APPROACH START =====');
            
            const secondPage = document.getElementById('second-gainsboro-page');
            if (!secondPage) {
                console.log('‚ùå Second page not found');
                return;
            }
            
            // CLEAR everything and start fresh (like simple UI)
            console.log('üîç Clearing second page completely...');
            secondPage.innerHTML = '';
            
            // Create main container with AGGRESSIVE inline styles (like simple UI)
            const container = document.createElement('div');
            container.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background-color: #f5f5f5 !important;
                z-index: 90 !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                overflow: visible !important;
            `;
            
            // Create chat area with AGGRESSIVE inline styles and proper scrolling
            const chatArea = document.createElement('div');
            chatArea.style.cssText = `
                position: absolute !important;
                top: 60px !important;
                left: 4px !important;
                right: 4px !important;
                bottom: 40px !important;
                overflow-y: scroll !important;
                overflow-x: hidden !important;
                padding: 8px 4px 100px 4px !important;
                background-color: transparent !important;
                z-index: 50 !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                scroll-behavior: smooth !important;
                -webkit-overflow-scrolling: touch !important;
            `;
            
            // Add messages directly to chat area
            if (messages && messages.length > 0) {
                console.log(`üîç Loading ${messages.length} messages with SIMPLE approach...`);
                
                messages.forEach((message, index) => {
                    console.log(`üîç Loading message ${index + 1}:`, message.sender_role);
                    
                    const messageDiv = document.createElement('div');
                    messageDiv.style.cssText = `
                        display: flex !important;
                        width: 100% !important;
                        margin-bottom: 16px !important;
                        justify-content: ${message.sender_role === 'user' ? 'flex-start' : 'flex-end'} !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                    `;
                    
                    const messageBubble = document.createElement('div');
                    messageBubble.style.cssText = `
                        padding: 16px 20px !important;
                        border-radius: 16px !important;
                        max-width: 95% !important;
                        background-color: ${message.sender_role === 'user' ? '#e8e8e4' : 'transparent'} !important;
                        color: black !important;
                        text-align: ${message.sender_role === 'user' ? 'left' : 'right'} !important;
                        line-height: 1.6 !important;
                        font-size: 1rem !important; /* 16px */
                        display: block !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        width: ${message.sender_role === 'user' ? 'auto' : '100%'} !important;
                    `;
                    
                    if (message.sender_role === 'user') {
                        messageBubble.textContent = message.content;
                    } else {
                        // Use the formatting system for AI messages
                        const formattedContent = formatChatContent(message.content);
                        messageBubble.innerHTML = formattedContent;
                    }
                    
                    messageDiv.appendChild(messageBubble);
                    chatArea.appendChild(messageDiv);
                });
                
                console.log(`üîç Successfully loaded ${messages.length} messages with SIMPLE approach`);
                
                // Auto-scroll to bottom after loading messages
                setTimeout(() => {
                    chatArea.scrollTop = chatArea.scrollHeight;
                    console.log('üîç Auto-scrolled to bottom after loading messages');
                }, 100);
            }
            
            // Create user input area (like real chat) - starts visible with proper positioning
            const userInputArea = document.createElement('div');
            userInputArea.id = 'thread-user-input';
            userInputArea.style.cssText = `
                position: fixed !important;
                bottom: 2px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                width: 90% !important;
                max-width: 500px !important;
                height: 65px !important;
                background-color: #E8E8E4 !important;
                border-radius: 30px !important;
                border: 1px solid #6b7280 !important;
                display: flex !important;
                align-items: center !important;
                padding: 0 20px !important;
                z-index: 2000 !important;
                visibility: visible !important;
                opacity: 1 !important;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
                margin-bottom: 20px !important;
            `;
            
            const userInput = document.createElement('input');
            userInput.type = 'text';
            userInput.placeholder = 'Type your message...';
            userInput.style.cssText = `
                flex: 1 !important;
                border: none !important;
                outline: none !important;
                background: transparent !important;
                font-size: 1rem !important; /* 16px */
                color: black !important;
                padding: 0 !important;
                margin: 0 !important;
            `;
            
            // Create microphone/recorder icon
            const microphoneIcon = document.createElement('button');
            microphoneIcon.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <line x1="12" y1="19" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <line x1="8" y1="23" x2="16" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            `;
            microphoneIcon.style.cssText = `
                width: 32px !important;
                height: 32px !important;
                border-radius: 50% !important;
                background-color: transparent !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                color: #666 !important;
                transition: all 0.2s !important;
                margin-right: 8px !important;
            `;
            
            // Add hover effect for microphone
            microphoneIcon.addEventListener('mouseenter', () => {
                microphoneIcon.style.backgroundColor = '#f0f0f0';
                microphoneIcon.style.color = '#333';
            });
            microphoneIcon.addEventListener('mouseleave', () => {
                microphoneIcon.style.backgroundColor = 'transparent';
                microphoneIcon.style.color = '#666';
            });
            
            // Add click event for microphone (placeholder)
            microphoneIcon.addEventListener('click', () => {
                console.log('üîç Microphone clicked, starting recording...');
                alert('Voice recording (to be implemented)');
            });
            
            // Create paperclip/attachment icon
            const paperclipIcon = document.createElement('button');
            paperclipIcon.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            `;
            paperclipIcon.style.cssText = `
                position: absolute !important;
                right: 8px !important;
                top: 50% !important;
                transform: translateY(-50%) !important;
                width: 32px !important;
                height: 32px !important;
                border-radius: 50% !important;
                background-color: transparent !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                color: #666 !important;
                transition: all 0.2s !important;
                z-index: 10 !important;
            `;
            
            // Add hover effect for paperclip
            paperclipIcon.addEventListener('mouseenter', () => {
                paperclipIcon.style.backgroundColor = '#f0f0f0';
                paperclipIcon.style.color = '#333';
            });
            paperclipIcon.addEventListener('mouseleave', () => {
                paperclipIcon.style.backgroundColor = 'transparent';
                paperclipIcon.style.color = '#666';
            });
            
            // Add click event for paperclip (placeholder)
            paperclipIcon.addEventListener('click', () => {
                console.log('üìé Paperclip clicked, attaching document...');
                alert('Document attachment (to be implemented)');
            });
            
            userInputArea.appendChild(userInput);
            userInputArea.appendChild(microphoneIcon);
            userInputArea.appendChild(paperclipIcon);
            
            // Create expanded input area (like real chat) - starts hidden with proper positioning
            const expandedInputArea = document.createElement('div');
            expandedInputArea.id = 'thread-expanded-input';
            expandedInputArea.style.cssText = `
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                height: 100px !important;
                background-color: #e8e8e4 !important;
                border-top: 1px solid #d1d5db !important;
                display: none !important;
                z-index: 2001 !important;
                padding: 24px !important;
            `;
            
            const expandedInput = document.createElement('textarea');
            expandedInput.placeholder = 'Learn anything...';
            expandedInput.style.cssText = `
                width: 100% !important;
                min-height: 80px !important;
                border: none !important;
                outline: none !important;
                background: transparent !important;
                font-size: 2.25rem !important;
                color: black !important;
                padding: 0 !important;
                margin: 0 !important;
                resize: none !important;
                font-family: sans-serif !important;
                line-height: 1.5 !important;
                cursor: text !important;
                text-align: right !important;
                position: absolute !important;
                top: 8px !important;
                right: 0 !important;
                padding-right: 80px !important;
            `;
            
            // Create send button for expanded input
            const expandedSendButton = document.createElement('button');
            expandedSendButton.innerHTML = `
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V5M5 12l7-7 7 7"/>
                </svg>
            `;
            expandedSendButton.style.cssText = `
                position: absolute !important;
                bottom: 12px !important;
                left: 16px !important;
                width: 40px !important;
                height: 40px !important;
                border-radius: 50% !important;
                background-color: black !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                transition: background-color 0.2s !important;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
            `;
            
            // Add focus event to show expanded input (like real chat)
            async (params) => {
                userInput.addEventListener('focus', () => {
                    console.log('üîç User input focused, showing expanded input...');
                    userInputArea.style.display = 'none';
                    expandedInputArea.style.display = 'block';
                    expandedInput.focus();
                });
            }
            
            // Add blur event to hide expanded input if empty
            expandedInput.addEventListener('blur', () => {
                setTimeout(() => {
                    if (!expandedInput.value.trim()) {
                        console.log('üîç Expanded input blurred and empty, hiding...');
                        expandedInputArea.style.display = 'none';
                        userInputArea.style.display = 'flex';
                    }
                }, 100);
            });
            
            // Add input change event for button state
            expandedInput.addEventListener('input', () => {
                if (expandedInput.value.trim()) {
                    expandedSendButton.style.backgroundColor = 'black';
                    expandedSendButton.style.opacity = '1';
            } else {
                    expandedSendButton.style.backgroundColor = '#CCCCCC';
                    expandedSendButton.style.opacity = '0.6';
                }
            });
            
            // Add click event to expanded send button
            expandedSendButton.addEventListener('click', () => {
                const message = expandedInput.value.trim();
                if (message) {
                    console.log('üîç Expanded send button clicked, message:', message);
                    sendMessageFromThreadUI(message, chatArea, expandedInput, userInputArea, expandedInputArea);
                }
            });
            
            // Add Enter key event to expanded input
            expandedInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const message = expandedInput.value.trim();
                    if (message) {
                        console.log('üîç Enter key pressed in expanded input, message:', message);
                        sendMessageFromThreadUI(message, chatArea, expandedInput, userInputArea, expandedInputArea);
                    }
                }
            });
            
            // Assemble the input areas
            userInputArea.appendChild(userInput);
            expandedInputArea.appendChild(expandedInput);
            expandedInputArea.appendChild(expandedSendButton);
            
            // Create recorder button for thread expanded input
            const threadExpandedRecorderButton = document.createElement('button');
            threadExpandedRecorderButton.innerHTML = `
                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <line x1="12" y1="19" x2="12" y2="23" stroke-width="2" stroke-linecap="round"/>
                    <line x1="8" y1="23" x2="16" y2="23" stroke-width="2" stroke-linecap="round"/>
                </svg>
            `;
            threadExpandedRecorderButton.style.cssText = `
                position: absolute !important;
                bottom: 12px !important;
                right: 48px !important;
                width: 32px !important;
                height: 32px !important;
                border-radius: 50% !important;
                background-color: transparent !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                color: #666 !important;
                transition: all 0.2s !important;
            `;
            
            // Create document button for thread expanded input
            const threadExpandedDocumentButton = document.createElement('button');
            threadExpandedDocumentButton.innerHTML = `
                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            `;
            threadExpandedDocumentButton.style.cssText = `
                position: absolute !important;
                bottom: 12px !important;
                right: 16px !important;
                width: 32px !important;
                height: 32px !important;
                border-radius: 50% !important;
                background-color: transparent !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                color: #666 !important;
                transition: all 0.2s !important;
            `;
            
            // Add click events
            threadExpandedRecorderButton.addEventListener('click', () => {
                console.log('üé§ Thread expanded recorder clicked');
                alert('Voice recording (to be implemented)');
            });
            
            threadExpandedDocumentButton.addEventListener('click', () => {
                console.log('üìé Thread expanded document clicked');
                alert('Document attachment (to be implemented)');
            });
            
            expandedInputArea.appendChild(threadExpandedRecorderButton);
            expandedInputArea.appendChild(threadExpandedDocumentButton);
            
            // Initial button state
            expandedSendButton.style.backgroundColor = '#CCCCCC';
            expandedSendButton.style.opacity = '0.6';
            
            // Create top navigation bar (like real chat)
            const topNavBar = document.createElement('div');
            topNavBar.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                height: 60px !important;
                background-color: #f5f5f5 !important;
                border-bottom: 1px solid #e0e0e0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                padding: 0 20px !important;
                z-index: 2002 !important;
            `;
            
            // Create left top element (user account icon - two thin lines, one shorter)
            const leftTopButton = document.createElement('button');
            leftTopButton.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 6h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M4 12h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            `;
            leftTopButton.style.cssText = `
                width: 40px !important;
                height: 40px !important;
                border-radius: 50% !important;
                background-color: transparent !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                color: #333 !important;
                transition: background-color 0.2s !important;
            `;
            
            // Add hover effect for user account button
            leftTopButton.addEventListener('mouseenter', () => {
                leftTopButton.style.backgroundColor = '#f0f0f0';
            });
            leftTopButton.addEventListener('mouseleave', () => {
                leftTopButton.style.backgroundColor = 'transparent';
            });
            
            // Add click event for user account button (go back to library)
            leftTopButton.addEventListener('click', () => {
                console.log('üîç User account button clicked, returning to library...');
                // Library navigation removed
            });
            
            // Create left side container for menu button
            const leftButtonsContainer = document.createElement('div');
            leftButtonsContainer.style.cssText = `
                display: flex !important;
                align-items: center !important;
                gap: 8px !important;
            `;
            
            // Create menu button (three vertical dots) - moved to left
            const menuButton = document.createElement('button');
            menuButton.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="2" fill="currentColor"/>
                    <circle cx="12" cy="5" r="2" fill="currentColor"/>
                    <circle cx="12" cy="19" r="2" fill="currentColor"/>
                </svg>
            `;
            menuButton.style.cssText = `
                width: 40px !important;
                height: 40px !important;
                border-radius: 50% !important;
                background-color: transparent !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                color: #333 !important;
                transition: background-color 0.2s !important;
            `;
            
            // Add hover effect for menu button
            menuButton.addEventListener('mouseenter', () => {
                menuButton.style.backgroundColor = '#f0f0f0';
            });
            menuButton.addEventListener('mouseleave', () => {
                menuButton.style.backgroundColor = 'transparent';
            });
            
            // Add click event for menu button (delete/options)
            menuButton.addEventListener('click', () => {
                console.log('üîç Menu button clicked, showing options...');
                // Thread menu removed
            });
            
            // Create right side container for back button (cross icon)
            const rightButtonsContainer = document.createElement('div');
            rightButtonsContainer.style.cssText = `
                display: flex !important;
                align-items: center !important;
                gap: 8px !important;
                margin-left: auto !important;
            `;
            
            // Create back button (cross icon) for returning to library
            const backButton = document.createElement('button');
            backButton.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" stroke="currentColor" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            `;
            backButton.style.cssText = `
                width: 40px !important;
                height: 40px !important;
                border-radius: 50% !important;
                background-color: transparent !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                color: #333 !important;
                transition: background-color 0.2s !important;
            `;
            
            // Add hover effect for back button
            backButton.addEventListener('mouseenter', () => {
                backButton.style.backgroundColor = '#f0f0f0';
            });
            
            backButton.addEventListener('mouseleave', () => {
                backButton.style.backgroundColor = 'transparent';
            });
            
            // Add click event for back button (return to library)
            backButton.addEventListener('click', () => {
                console.log('üîç Back button clicked, returning to library...');
                // Navigate to library page
                // Library navigation removed
            });
            
            // Add back button to right container
            rightButtonsContainer.appendChild(backButton);
            
            // Create share button (will go in left container next to menu)
            const shareButton = document.createElement('button');
            shareButton.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #333 !important;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" stroke="currentColor" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                </svg>
            `;
            shareButton.style.cssText = `
                width: 40px !important;
                height: 40px !important;
                border-radius: 50% !important;
                background-color: transparent !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                color: #333 !important;
                transition: background-color 0.2s !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            
            // Force SVG color
            shareButton.querySelector('svg').style.color = '#333';
            shareButton.querySelector('path').style.stroke = '#333';
            
            // Add hover effect for share button
            shareButton.addEventListener('mouseenter', () => {
                shareButton.style.backgroundColor = '#f0f0f0';
            });
            shareButton.addEventListener('mouseleave', () => {
                shareButton.style.backgroundColor = 'transparent';
            });
            
            // Add click event for share button
            shareButton.addEventListener('click', () => {
                console.log('üîç Share button clicked, sharing thread...');
                alert('Share thread (to be implemented)');
            });
            
            // Assemble the left buttons container (both menu and share buttons)
            leftButtonsContainer.appendChild(menuButton);
            leftButtonsContainer.appendChild(shareButton);
            
            // Assemble the top navigation (left container with menu+share, right container with back)
            topNavBar.appendChild(leftButtonsContainer);
            topNavBar.appendChild(rightButtonsContainer);
            
            // Debug: Check if buttons are properly added
            console.log('üîç Left buttons container added:', leftButtonsContainer);
            console.log('üîç Right buttons container added:', rightButtonsContainer);
            console.log('üîç Share button added:', shareButton);
            console.log('üîç Menu button added:', menuButton);
            console.log('üîç Back button added:', backButton);
            console.log('üîç Top nav bar children:', topNavBar.children.length);
            console.log('üîç Share button innerHTML:', shareButton.innerHTML);
            console.log('üîç Share button computed display:', window.getComputedStyle(shareButton).display);
            console.log('üîç Share button computed visibility:', window.getComputedStyle(shareButton).visibility);
            
            // Debug: Check button visibility
            console.log('üîç Share button computed styles:', window.getComputedStyle(shareButton));
            console.log('üîç Menu button computed styles:', window.getComputedStyle(menuButton));
            console.log('üîç Share button display:', window.getComputedStyle(shareButton).display);
            console.log('üîç Menu button display:', window.getComputedStyle(menuButton).display);
            
            // Assemble the container
            container.appendChild(topNavBar);
            container.appendChild(chatArea);
            container.appendChild(userInputArea);
            container.appendChild(expandedInputArea);
            secondPage.appendChild(container);
            
            // Scroll to bottom
            setTimeout(() => {
                chatArea.scrollTop = chatArea.scrollHeight;
                console.log('üîç Scrolled to bottom with SIMPLE approach');
            }, 100);
            
            console.log('üîç ===== SETUP THREAD UI WITH SIMPLE APPROACH END =====');
        }
        
        // Additional functions
        
        // Handle chat click
        function handleChatClick() {
            console.log('üí¨ Chat button clicked');
            // This function can be used for any chat-related actions
            // For now, it's just a placeholder
        }
        
        // Conversation saving functions
        async function createThread(title = null) {
            try {
                const userId = localStorage.getItem('user_id') || '1';
                const response = await fetch('/api/threads', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        user_id: userId,
                        title: title || '⁄ØŸÅÿ™⁄ØŸà€å ÿ¨ÿØ€åÿØ'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üîç Thread creation response:', data);
                
                if (data.success) {
                    // Handle both response formats
                    if (data.thread && data.thread.thread_id) {
                        currentThreadId = data.thread.thread_id;
                    } else if (data.thread_id) {
                        currentThreadId = data.thread_id;
                    } else {
                        throw new Error('No thread ID in response');
                    }
                    console.log('‚úÖ Thread created:', currentThreadId);
                    return currentThreadId;
                } else {
                    console.error('‚ùå Thread creation failed:', data);
                    throw new Error(data.error || 'Failed to create thread');
                }
            } catch (error) {
                console.error('‚ùå Error creating thread:', error);
                return null;
            }
        }
        
        async function saveMessage(role, content) {
            if (!currentThreadId) {
                console.log('‚ö†Ô∏è No thread ID, creating new thread');
                const threadId = await createThread();
                if (!threadId) {
                    console.log('‚ö†Ô∏è Thread creation failed, continuing without saving');
                    return;
                }
            }
            
            try {
                const response = await fetch(`/api/threads/${currentThreadId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        sender_role: role, 
                        content: content 
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('‚úÖ Message saved:', data.message_id);
                } else {
                    throw new Error(data.error || 'Failed to save message');
                }
            } catch (error) {
                console.error('‚ùå Error saving message:', error);
            }
        }
        
        async function loadThreadMessages(threadId) {
            try {
                const response = await fetch(`/api/threads/${threadId}/messages`);
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ Loaded messages for thread:', threadId);
                    return data.messages;
                } else {
                    throw new Error(data.error || 'Failed to load messages');
                }
            } catch (error) {
                console.error('‚ùå Error loading messages:', error);
                return [];
            }
        }
        
        async function loadThreadFromLibrary() {
            const viewingThread = localStorage.getItem('viewing_thread');
            if (!viewingThread) return;
            
            console.log('üìö Loading thread from library:', viewingThread);
            currentThreadId = viewingThread;
            isThreadLoaded = true;
            
            // Switch to chat header for thread view
            switchToChatHeader();
            
            // Hide bottom icons for clean chat interface
            hideBottomIcons();
            
            // Hide main user input completely in thread view mode
            const mainUserInput = document.getElementById('main-user-input');
            if (mainUserInput) {
                mainUserInput.style.display = 'none';
                mainUserInput.style.visibility = 'hidden';
            }
            
            // Load messages for this thread
            const messages = await loadThreadMessages(viewingThread);
            
            // Clear current chat
            const messagesContainer = document.getElementById('chat-messages');
            if (messagesContainer) {
                messagesContainer.innerHTML = '';
            }
            
            // Display loaded messages
            messages.forEach(message => {
                const isUser = message.sender_role === 'user';
                addMessage(message.content, isUser);
            });
            
            // Show chat input at bottom for continuing conversation
            const chatInputAfterResponse = document.getElementById('chat-input-after-response');
            if (chatInputAfterResponse) {
                chatInputAfterResponse.classList.remove('hidden');
                chatInputAfterResponse.style.display = 'block';
                chatInputAfterResponse.style.bottom = '0';
                chatInputAfterResponse.style.paddingBottom = '0.25rem';
                console.log('‚úÖ Chat input shown at bottom for thread view');
            }
            
            // Clear the viewing_thread flag
            localStorage.removeItem('viewing_thread');
            
            console.log('‚úÖ Thread loaded from library with clean chat interface');
        }
        
        function showLoginPrompt() {
            const chatMessages = document.getElementById('chat-messages');
            const loginPrompt = document.createElement('div');
            loginPrompt.className = 'flex justify-center items-center py-8';
            loginPrompt.innerHTML = `
                <div class="text-center">
                    <div class="text-gray-500 mb-4">üîê</div>
                    <h3 class="text-lg font-medium mb-2">ÿ®ÿ±ÿß€å ÿ∞ÿÆ€åÿ±Ÿá ⁄ØŸÅÿ™⁄ØŸàŸáÿß Ÿàÿßÿ±ÿØ ÿ¥Ÿà€åÿØ</h3>
                    <p class="text-gray-500 mb-4">⁄ØŸÅÿ™⁄ØŸàŸáÿß€å ÿ¥ŸÖÿß ÿØÿ± ⁄©ÿ™ÿßÿ®ÿÆÿßŸÜŸá ÿ∞ÿÆ€åÿ±Ÿá ÿÆŸàÿßŸáÿØ ÿ¥ÿØ</p>
                    <button onclick="window.location.href='auth.html'" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                        Ÿàÿ±ŸàÿØ / ÿ´ÿ®ÿ™ ŸÜÿßŸÖ
                    </button>
                </div>
            `;
            chatMessages.appendChild(loginPrompt);
        }
    </script>
</body>
</html>
