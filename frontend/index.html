<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="light-content">
    <meta name="theme-color" content="#E8E8E4">
    <meta name="msapplication-navbutton-color" content="#E8E8E4">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap"></noscript>
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    
    <!-- Preload other pages for faster navigation -->
    <link rel="prefetch" href="test.html">
    <link rel="prefetch" href="question-analysis.html">
    <link rel="prefetch" href="chapters.html">
    <link rel="prefetch" href="analysis-results.html">
    
    <!-- Apple Touch Icons for iOS -->
    <!-- <link rel="apple-touch-icon" href="/icon-192.png"> -->
    <!-- <link rel="apple-touch-icon" sizes="152x152" href="/icon-192.png"> -->
    <!-- <link rel="apple-touch-icon" sizes="180x180" href="/icon-192.png"> -->
    <!-- <link rel="apple-touch-icon" sizes="167x167" href="/icon-192.png"> -->
    
    <!-- Web App Manifest for mobile app-like experience -->
    <!-- <link rel="manifest" href="/manifest.json"> -->
    
    <title>ŸÖŸêŸÜŸà - €åÿßÿØ⁄Ø€åÿ±€å ŸáŸàÿ¥ŸÖŸÜÿØ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://polyfill.io">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Suppress Tailwind CDN production warning
        window.tailwind = window.tailwind || {};
        window.tailwind.config = window.tailwind.config || {};
        window.tailwind.config.safelist = [];
    </script>
    <!-- Enhanced MathJax for comprehensive math rendering -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                packages: {'[+]': ['ams', 'amscd', 'amssymb', 'mathtools', 'physics', 'bm', 'cancel', 'cases', 'empheq', 'geometry', 'mhchem', 'pgf', 'textmacros', 'unicode', 'upgreek', 'verbatim']}
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/ams', '[tex]/amscd', '[tex]/amssymb', '[tex]/mathtools', '[tex]/physics', '[tex]/bm', '[tex]/cancel', '[tex]/cases', '[tex]/empheq', '[tex]/geometry', '[tex]/mhchem', '[tex]/pgf', '[tex]/textmacros', '[tex]/unicode', '[tex]/upgreek', '[tex]/verbatim']
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script>
        // Check login status on page load
        function checkLoginStatus() {
            // Login functionality disabled for mobile testing
            console.log('üîç Login check disabled for mobile testing');
            
            // Always hide login overlay
            const loginOverlay = document.getElementById('login-overlay');
            if (loginOverlay) {
                loginOverlay.classList.add('hidden');
                console.log('‚úÖ Login overlay hidden (disabled)');
            }
            
            // Set default user data for testing
            localStorage.setItem('user_id', '1');
            localStorage.setItem('is_verified', 'true');
            localStorage.setItem('userPhone', '09050512907');
            localStorage.setItem('authToken', 'test_token');
            
            return true;
        }
        
        // Check login status after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
        checkLoginStatus();
        });
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'meno-blue': '#3B82F6',
                        'meno-gray': '#6B7280',
                        'meno-light-gray': '#F3F4F6'
                    }
                }
            }
        }
    </script>
    <style>
        /* Critical CSS for mobile performance */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        /* Allow text selection for chat messages and content */
        .chat-messages, .chat-messages *, .ai-message, .user-message, p, div[dir="rtl"] {
            -webkit-user-select: text;
            user-select: text;
            -webkit-touch-callout: default;
        }
        
        /* Keep inputs and textareas selectable */
        input, textarea {
            -webkit-user-select: text;
            user-select: text;
        }
        
        /* Keep buttons and clickable elements non-selectable for mobile UX */
        button, nav {
            -webkit-user-select: none;
            user-select: none;
        }
        
        html, body {
            font-family: 'IranSans', 'Vazirmatn', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 1.125rem; /* 18px */
            line-height: 1.6;
            background-color: #F8F9FA !important;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior: none;
        }
        
        .chat-container {
            min-height: 25rem; /* 400px */
            padding-bottom: 1.25rem; /* 20px */
            background-color: #F8F9FA;
        }
        
        /* Fix input bar layout */
        .input-bar {
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            height: 3.4375rem; /* 55px */
            border-radius: 9999px;
            background-color: #e8e8e4;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .user-input-container {
            width: 95%;
            max-width: 37.5rem; /* 600px */
            margin: 0 auto;
            margin-top: auto;
            margin-bottom: 2rem;
        }
        
        /* Ensure proper spacing between elements */
        .main {
            padding-top: 5rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #F8F9FA;
        }
        
        .ai-message-font {
            font-size: 1.125rem !important; /* 18px */
        }
        
        /* Ensure chat messages are selectable and copyable */
        .chat-messages {
            -webkit-user-select: text;
            user-select: text;
            cursor: text;
        }
        
        .chat-messages .message-bubble {
            -webkit-user-select: text;
            user-select: text;
            cursor: text;
        }
        
        .chat-messages p, .chat-messages li, .chat-messages div {
            -webkit-user-select: text;
            user-select: text;
            cursor: text;
        }
        
        /* Make sure AI responses are selectable */
        .ai-response, .ai-message, .ai-content {
            -webkit-user-select: text;
            user-select: text;
            cursor: text;
        }
        
        /* Critical mobile viewport fixes */
        html {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            overflow-x: hidden;
        }
        
        body {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        
        /* Prevent mobile zoom on input focus */
        input, textarea, select {
            font-size: 1rem !important; /* 16px */
        }
        
        /* Force consistent background color throughout */
        html, body, main, .chat-container, .chat-messages, .main {
            background-color: #F8F9FA !important;
        }
        
        /* Bottom navigation styling - same as other pages */
        
        /* Navigation icon states */
        .nav-icon {
            color: #9CA3AF; /* Pale gray for inactive icons */
            transition: color 0.3s ease;
        }
        
        .nav-icon.active {
            color: #374151; /* Full color for active icon */
        }
        
        .nav-icon:hover {
            color: #6B7280; /* Slightly darker on hover */
        }
        
        /* Basic chat styling - clean slate for new system */
        .chat-messages {
            line-height: 1.6;
            background-color: #F8F9FA;
        }
        
        .chat-messages p {
            margin-bottom: 1rem;
        }
        
        /* Enhanced AI response styling for mobile */
        .chat-messages .message-bubble {
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        /* Force maximum width for AI responses - same as detailed analysis */
        .chat-messages .message-bubble:not([class*="bg-[#e8e8e4]"]) {
            width: 100% !important;
            max-width: 100% !important;
        }
        
        /* Better mobile typography */
        @media (max-width: 640px) {
            .chat-messages .message-bubble {
                font-size: 1rem !important; /* 16px */
                line-height: 1.5;
                padding: 1rem !important;
            }
            
            /* AI messages (right-aligned) - maximum width - same as detailed analysis */
            .chat-messages .message-bubble:not([class*="bg-[#e8e8e4]"]) {
                width: 100% !important;
                max-width: 100% !important;
                margin-right: 0 !important;
            }
            
            /* User messages (left-aligned) - full width */
            .chat-messages .message-bubble[class*="bg-[#e8e8e4]"] {
                max-width: 99% !important;
                margin-left: 0.5rem !important;
            }
            
            .chat-messages p {
                margin-bottom: 0.75rem;
            }
            
            .chat-messages li {
                margin-bottom: 0.5rem;
            }
            
            /* Simple mobile styling */
            p {
                font-size: 1.125rem !important; /* 18px */
                line-height: 1.6;
                margin-bottom: 1rem;
            }
        }
        
        /* Mobile touch optimizations */
        button {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s ease;
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        /* Prevent zoom on input focus for mobile */
        input[type="text"], input[type="email"], textarea {
            font-size: 1rem !important; /* 16px */
        }
        
        /* Mobile scrollbar styling */
        ::-webkit-scrollbar {
            width: 0.375rem; /* 6px */
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.1875rem; /* 3px */
        }
        
        /* Hidden class for elements */
        .hidden {
            display: none !important;
        }
        

        

        


        /* Chat message content styling */
        .chat-message p {
            margin-bottom: 0.5rem;
        }

        .chat-message ul {
            margin: 0.5rem 0;
            padding-right: 1.5rem;
        }

        .chat-message li {
            

        
        .math-display {
            text-align: center !important;
            margin: 1rem 0 !important;
            font-size: 1.2em !important;
            font-family: 'Times New Roman', serif !important;
            color: #1f2937 !important;
        }
        
        .math-error {
            color: #dc2626 !important;
            font-style: italic !important;
            background-color: #fef2f2 !important;
            padding: 0.25rem 0.5rem !important;
            border-radius: 0.25rem !important;
        }
            margin-bottom: 0.3rem;
        }

        /* Bullet points and numbered lists styling */
        .ml-auto ul {
            list-style-type: disc;
            padding-right: 1.5rem;
            margin: 0.5rem 0;
        }

        .ml-auto ol {
            list-style-type: decimal;
            padding-right: 1.5rem;
            margin: 0.5rem 0;
        }

        .ml-auto li {
            margin-bottom: 0.3rem;
            text-align: right;
        }

        /* Study-mode content styling - GPT-like experience */
        /* Enhanced ChatGPT Study Mode Styling */
        /* ChatGPT Study Mode Styling - Integrated with main chat */
        .study-message {
            background: transparent;
            border-radius: 0;
            box-shadow: none;
            padding: 0;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #374151;
            max-width: 100%;
            word-wrap: break-word;
        }
        
        .study-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
            margin: 1.2rem 0 0.8rem 0;
            padding-bottom: 0.3rem;
            border-bottom: 1px solid #e5e7eb;
            text-align: right;
        }
        
        .study-paragraph {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 0.8rem;
            color: #374151;
            text-align: right;
        }

        .study-list {
            margin: 0.8rem 0;
            padding-right: 1.5rem;
            list-style-type: disc !important;
            list-style-position: outside !important;
        }

        .study-list-item {
            margin-bottom: 0.4rem;
            font-size: 1rem;
            line-height: 1.6;
            color: #374151;
            text-align: right;
            display: list-item !important;
            list-style-type: disc !important;
        }
        
        .study-list ol {
            counter-reset: list-counter;
        }

        .study-list ol .study-list-item {
            counter-increment: list-counter;
        }

        .study-list ol .study-list-item::before {
            content: counter(list-counter) ".";
            color: #6b7280;
            font-weight: bold;
            font-size: 1rem;
            position: absolute;
            right: 0;
            top: 0;
        }
        
        .study-math {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0.5rem 0;
            margin: 0.5rem 0;
            text-align: center;
            font-family: 'Times New Roman', serif;
            font-size: 1.1rem;
            color: #374151;
        }
        
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .study-title {
                font-size: 1.1rem;
                margin: 1rem 0 0.6rem 0;
            }
            
            .study-paragraph {
                font-size: 0.9rem;
            }
            
            .study-list-item {
                font-size: 0.9rem;
            }
        }

        /* Emoji styling */
        .ml-auto span[class*="emoji"] {
            font-size: 1.1em;
            margin: 0 0.2rem;
        }



        /* AI message right alignment */
        .ml-auto {
            text-align: right;
        }
        
        .ml-auto p, .ml-auto div, .ml-auto span {
            text-align: right;
        }
        
        .ml-auto ul, .ml-auto ol {
            text-align: right;
        }
        
        .chat-message li {
            margin-bottom: 0.3rem;
        }

        /* Bullet point styling for chat messages */
        .chat-message p:contains('‚Ä¢') {
            margin-right: 1rem;
        }






        

        /* Mobile Performance Optimizations */
        @media (max-width: 768px) {
            /* Fix mobile layout issues */
            html, body {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            main {
                width: 100% !important;
                max-width: 100% !important;
                margin: 0 !important;
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }
            
            .user-input-container {
                width: 95% !important;
                max-width: 95% !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                position: fixed !important;
            }
            
            .icons-container {
                width: 100% !important;
                max-width: 100% !important;
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }
            
            /* Optimize animations for mobile - exclude positioning elements */
            .chat-message,
            .user-input,
            .send-button,
            .message-bubble,
            .nav-icon {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
                -webkit-backface-visibility: hidden;
                backface-visibility: hidden;
            }
            
            /* Reduce motion for better performance */
            .chat-message,
            .user-input,
            .send-button {
                transition: all 0.2s ease;
            }
            
            /* Optimize scrolling */
            .chat-container {
                -webkit-overflow-scrolling: touch;
                overflow-scrolling: touch;
            }
        }
        
        /* Critical CSS for above-the-fold content */
        .user-input-container {
            will-change: transform;
            transform: translateZ(0);
        }
        
        /* Additional mobile fixes */
        @media (max-width: 480px) {
            /* Extra small screens */
            .user-input-container {
                width: 98% !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
            }
            
            .icons-container {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }
            
            main {
                padding-left: 0.25rem !important;
                padding-right: 0.25rem !important;
            }
        }
        
        /* Ensure proper mobile layout on all devices */
        @media screen and (max-width: 1024px) {
            body {
                -webkit-text-size-adjust: 100%;
                -ms-text-size-adjust: 100%;
            }
            
            /* Force proper mobile layout */
            html {
                -webkit-text-size-adjust: 100%;
                -ms-text-size-adjust: 100%;
            }
            
            /* Ensure input container stays centered */
            .user-input-container {
                position: fixed !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                z-index: 30 !important;
            }
            
            /* Ensure icons container stays at bottom */
            .icons-container {
                position: fixed !important;
                bottom: 1rem !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 40 !important;
            }
        }
        
        /* Comprehensive Mobile Media Queries */
        
        /* Extra Small Devices (phones, 320px and up) */
        @media (min-width: 320px) and (max-width: 479px) {
            html, body {
                font-size: 0.875rem; /* 14px */
            }
            
            .user-input-container {
                width: 98% !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                bottom: 3.5rem !important; /* 56px */
            }
            
            .icons-container {
                padding: 0.75rem 0.5rem !important;
                bottom: 0.5rem !important;
            }
            
            main {
                padding-left: 0.25rem !important;
                padding-right: 0.25rem !important;
            }
        }
        
        /* Small Devices (phones, 480px and up) */
        @media (min-width: 480px) and (max-width: 639px) {
            html, body {
                font-size: 1rem; /* 16px */
            }
            
            .user-input-container {
                width: 95% !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                bottom: 4rem !important; /* 64px */
            }
            
            .icons-container {
                padding: 1rem 0.75rem !important;
                bottom: 0.75rem !important;
            }
        }
        
        /* Medium Devices (tablets, 640px and up) */
        @media (min-width: 640px) and (max-width: 767px) {
            html, body {
                font-size: 1.0625rem; /* 17px */
            }
            
            .user-input-container {
                width: 90% !important;
                max-width: 32rem !important; /* 512px */
                left: 50% !important;
                transform: translateX(-50%) !important;
                bottom: 4.25rem !important; /* 68px */
            }
            
            .icons-container {
                padding: 1rem 1rem !important;
                bottom: 1rem !important;
            }
        }
        
        /* Large Devices (desktops, 768px and up) */
        @media (min-width: 768px) and (max-width: 1023px) {
            html, body {
                font-size: 1.125rem; /* 18px */
            }
            
            .user-input-container {
                width: 85% !important;
                max-width: 37.5rem !important; /* 600px */
                left: 50% !important;
                transform: translateX(-50%) !important;
                bottom: 4.5rem !important; /* 72px */
            }
            
            .icons-container {
                padding: 1.25rem 1.25rem !important;
                bottom: 1.25rem !important;
            }
        }
        
        /* Extra Large Devices (large desktops, 1024px and up) */
        @media (min-width: 1024px) {
            html, body {
                font-size: 1.125rem; /* 18px */
            }
            
            .user-input-container {
                width: 80% !important;
                max-width: 37.5rem !important; /* 600px */
                left: 50% !important;
                transform: translateX(-50%) !important;
                bottom: 4.75rem !important; /* 76px */
            }
            
            .icons-container {
                padding: 1.5rem 1.5rem !important;
                bottom: 1.5rem !important;
            }
        }

    </style>
</head>
    <body style="background-color: #F8F9FA;">
    <!-- Header -->
            <header id="main-header" class="fixed top-0 left-0 right-0 z-50 border-b border-gray-200" style="background-color: #F8F9FA;">
        <div class="flex justify-between items-center px-2 sm:px-3 py-3">
            <!-- Left: Menu Icon -->
            <div class="flex items-center">
                <button class="p-2 hover:bg-gray-100 rounded-lg transition-colors" onclick="toggleUserMenu()" title="User Menu">
                <div class="flex flex-col space-y-1">
                        <div class="w-5 h-0.5 bg-gray-600"></div>
                        <div class="w-4 h-0.5 bg-gray-600"></div>
                </div>
                </button>
            </div>
            
            <!-- Center: App Title -->
            <div class="absolute left-1/2 transform -translate-x-1/2">
                <h1 class="text-lg sm:text-xl font-semibold text-gray-800">High School</h1>
            </div>
            
            <!-- Right: Settings -->
            <div class="flex items-center space-x-4">
                <button class="p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Share" onclick="shareMainConversation()">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">ÿ≥€åÿ≥ÿ™ŸÖ ÿ¢ŸÖŸàÿ≤ÿ¥€å</h1>
                <p class="text-gray-600">Ÿàÿ±ŸàÿØ ÿ®ÿß ÿ¥ŸÖÿßÿ±Ÿá ŸÖŸàÿ®ÿß€åŸÑ</p>
            </div>

            <!-- Step 1: Phone Number -->
            <div id="login-step1" class="login-step active">
                <form id="phoneForm">
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            ÿ¥ŸÖÿßÿ±Ÿá ŸÖŸàÿ®ÿß€åŸÑ
                        </label>
                        <input 
                            type="tel" 
                            id="phoneNumber" 
                            class="phone-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="09123456789"
                            maxlength="11"
                            required
                            style="direction: ltr; text-align: left;"
                        >
                    </div>
                    
                    <button 
                        type="submit" 
                        id="sendCodeBtn"
                        class="btn-primary w-full text-white font-bold py-3 px-4 rounded-lg"
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"
                    >
                        <span id="sendText">ÿßÿ±ÿ≥ÿßŸÑ ⁄©ÿØ ÿ™ÿ£€å€åÿØ</span>
                        <span id="sendLoading" class="hidden">
                            <svg class="animate-spin h-5 w-5 text-white inline-block ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            ÿØÿ± ÿ≠ÿßŸÑ ÿßÿ±ÿ≥ÿßŸÑ...
                        </span>
                    </button>
                </form>
            </div>

            <!-- Step 2: Verification Code -->
            <div id="login-step2" class="login-step hidden">
                <form id="codeForm">
                    <div class="mb-6">
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            ⁄©ÿØ ÿ™ÿ£€å€åÿØ ÿßÿ±ÿ≥ÿßŸÑ ÿ¥ÿØŸá
                        </label>
                        <input 
                            type="text" 
                            id="verificationCode" 
                            class="code-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="123456"
                            maxlength="6"
                            required
                            style="direction: ltr; text-align: center; font-size: 1.5rem; letter-spacing: 0.5rem;"
                        >
                        <p class="text-sm text-gray-500 mt-2">
                            ⁄©ÿØ ÿ™ÿ£€å€åÿØ ÿ®Ÿá ÿ¥ŸÖÿßÿ±Ÿá <span id="displayPhone"></span> ÿßÿ±ÿ≥ÿßŸÑ ÿ¥ÿØ
                        </p>
                    </div>
                    
                    <button 
                        type="submit" 
                        id="verifyBtn"
                        class="btn-primary w-full text-white font-bold py-3 px-4 rounded-lg mb-4"
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"
                    >
                        <span id="verifyText">ÿ™ÿ£€å€åÿØ ⁄©ÿØ</span>
                        <span id="verifyLoading" class="hidden">
                            <svg class="animate-spin h-5 w-5 text-white inline-block ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            ÿØÿ± ÿ≠ÿßŸÑ ÿ™ÿ£€å€åÿØ...
                        </span>
                    </button>

                    <button 
                        type="button" 
                        id="resendBtn"
                        class="w-full text-gray-600 font-medium py-2 px-4 rounded-lg border border-gray-300 hover:bg-gray-50"
                    >
                        ÿßÿ±ÿ≥ÿßŸÑ ŸÖÿ¨ÿØÿØ ⁄©ÿØ
                    </button>
                </form>
            </div>

            <!-- Error Message -->
            <div id="login-error" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                <span id="login-error-text"></span>
            </div>

            <!-- Success Message -->
            <div id="login-success" class="hidden mt-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
                <span id="login-success-text"></span>
            </div>
        </div>
    </div>

    <!-- User Menu Overlay -->
    <div id="user-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="closeUserMenu()"></div>
    
    <!-- User Menu Panel -->
    <div id="user-menu-panel" class="fixed top-0 left-0 h-full w-80 bg-white shadow-lg z-50 transform -translate-x-full transition-transform duration-300">
        <div class="p-6">
            <!-- User Info Header -->
            <div class="flex items-center space-x-4 mb-6">
                <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">ÿ≠ÿ≥ÿßÿ® ⁄©ÿßÿ±ÿ®ÿ±€å</h3>
                    <p id="user-phone-display" class="text-sm text-gray-600"></p>
                </div>
            </div>
            
            <!-- Menu Items -->
            <div class="space-y-2">
                <button class="w-full text-right py-3 px-4 hover:bg-gray-100 rounded-lg transition-colors" onclick="closeUserMenu()">
                    <span class="text-gray-700">ÿ®ÿßÿ≤⁄Øÿ¥ÿ™</span>
                </button>
                
                <!-- Logout button disabled for mobile testing -->
                <!-- <button class="w-full text-right py-3 px-4 hover:bg-red-100 rounded-lg transition-colors text-red-600" onclick="logout()">
                    <span class="flex items-center justify-between">
                        <span>ÿÆÿ±Ÿàÿ¨ ÿßÿ≤ ÿ≠ÿ≥ÿßÿ®</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                        </svg>
                    </span>
                </button> -->
            </div>
        </div>
    </div>

    <!-- Main Chat Container -->
            <main class="pt-24 px-2 sm:px-3 relative flex flex-col" style="background-color: #F8F9FA; min-height: 100vh;">
        <div class="max-w-full mx-auto flex-1">
            <!-- Chat Messages Container -->
            <div id="chat-messages" class="chat-container space-y-6 hidden" style="padding-bottom: 6.25rem;"> <!-- 100px -->
                <!-- Messages will be populated by JavaScript -->
            </div>
        </div>
    </main>
    
    <!-- User Input - Fixed positioning above icons -->
            <div id="main-user-input" class="user-input-container fixed left-1/2 transform -translate-x-1/2" style="width: 95%; max-width: 37.5rem; bottom: 4.375rem;"> <!-- 600px, 70px -->
            <!-- Input Bar (Search Bar) -->
                            <div class="input-bar bg-[#e8e8e4] rounded-full shadow-lg flex items-center px-6 py-3" style="height: 4.0625rem; border-radius: 9999px;"> <!-- 65px -->
                <!-- Recorder Button - Left Side -->
                <button class="recorder-button p-2 hover:bg-gray-200 rounded-full transition-colors" onclick="startRecording()" title="Voice Recording">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <line x1="12" y1="19" x2="12" y2="23" stroke-width="2" stroke-linecap="round"/>
                        <line x1="8" y1="23" x2="16" y2="23" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
                
                <!-- Center: Input Field -->
                <div class="flex-1 mx-4">
                    <textarea 
                        id="user-input" 
                        class="w-full bg-transparent border-none resize-none focus:outline-none text-[#000000] text-right font-sans placeholder-[#1e1e1e]"
                        placeholder="Learn anything..."
                        rows="1"
                        dir="rtl"
                        oninput="autoResize(this)"
                        onkeydown="handleKeyDown(event, this)"
                        onclick="showExpandedInput(); hideBottomIcons(); disableScrolling()"
                        style="min-height: 1.25rem; max-height: 7.5rem; line-height: 1.25rem; cursor: text; font-size: 1rem;" <!-- 20px, 120px, 20px, 16px -->
                    ></textarea>
                </div>
                
                <!-- Paperclip Icon Button - Very Right Side -->
                <button class="document-button ml-2 p-2 hover:bg-gray-200 rounded-full transition-colors" onclick="attachDocument()" title="Attach Document">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Thin Border Separator -->
        <div class="border-b border-gray-200 mx-auto" style="width: 95%; max-width: 37.5rem;"></div> <!-- 600px -->
    </main>
    
    <!-- Four Icons - Standard Mobile Navigation Bar - Separated for independent positioning -->
    <div class="icons-container fixed bottom-4 left-0 right-0 py-4 px-3 sm:px-4 flex justify-around items-center space-x-8 z-40">
                         <!-- First Icon: Document with pencil (Chat page) -->
             <button class="icon-button p-2 hover:text-gray-600 transition-colors" onclick="handleChatClick()">
                 <svg class="w-6 h-6 nav-icon active" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                     <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke-width="2"/>
                     <path d="M14 2v6h6" stroke-width="2"/>
                     <path d="M16 13H8" stroke-width="2"/>
                     <path d="M16 17H8" stroke-width="2"/>
                     <path d="M10 9H8" stroke-width="2"/>
                 </svg>
             </button>
             
             <!-- Second Icon: Open book (Library) -->
             <button class="icon-button p-2 hover:text-gray-600 transition-colors" onclick="window.location.href='library.html'">
                 <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                     <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" stroke-width="2"/>
                 </svg>
             </button>
             
             <!-- Third Icon: Circle with tick inside (Test page) -->
             <button class="icon-button p-2 hover:text-gray-600 transition-colors" onclick="goToTest()">
                 <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                     <circle cx="12" cy="12" r="10" stroke-width="2"/>
                     <path d="M9 12l2 2 4-4" stroke-width="2"/>
                 </svg>
             </button>
            
            
        </div>
        
                 <!-- Second Gainsboro Page (Hidden by default) - This is the REAL second page -->
                 <div id="second-gainsboro-page" class="fixed inset-0 bg-[#F8F9FA] z-90 hidden">
                     <!-- Header for Second Page (matching thread UI) -->
                     <div id="second-page-header" class="fixed top-0 left-0 right-0 border-b border-gray-200 z-100" style="height: 3.75rem; background-color: #F8F9FA;"> <!-- 60px -->
                         <div class="flex items-center justify-between h-full px-2 sm:px-3">
                             <!-- Left: Menu and New Chat buttons -->
                             <div class="flex items-center gap-2">
                                 <!-- Menu button (three vertical dots) -->
                                 <button onclick="showThreadMenu()" class="w-10 h-10 rounded-full bg-transparent hover:bg-gray-200 flex items-center justify-center transition-colors">
                                     <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #333;">
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" stroke="currentColor" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
                                     </svg>
                                 </button>
                                 
                                 <!-- Share button (share icon) -->
                                 <button onclick="shareConversation()" class="w-10 h-10 rounded-full bg-transparent hover:bg-gray-200 flex items-center justify-center transition-colors">
                                     <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #333;">
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" stroke="currentColor" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                                     </svg>
                                 </button>
                             </div>
                             
                             <!-- Right: Back button (cross icon) -->
                             <button onclick="hideSecondPage()" class="w-10 h-10 rounded-full bg-transparent hover:bg-gray-200 flex items-center justify-center transition-colors">
                                 <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #333;">
                                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" stroke="currentColor" d="M6 18L18 6M6 6l12 12"></path>
                                 </svg>
                             </button>
                         </div>
                     </div>
                     
                     <!-- Chat Messages Area - Adjusted for header -->
                     <div id="second-page-chat-area" class="absolute top-16 left-1 right-1 sm:left-2 sm:right-2 bottom-32 overflow-y-auto p-0.5 sm:p-1">
                         <!-- Messages will appear here on the second gainsboro page -->
                     </div>
                     

                 </div>
                
                 <!-- Expanded Input (Hidden by default) - Just for typing -->
                 <div id="expanded-input-container" class="fixed bottom-0 left-0 right-0 bg-[#e8e8e4] rounded-t-3xl shadow-2xl hidden z-100" style="height: 6.25rem; border-top: 1px solid #d1d5db;"> <!-- 100px -->
                     <div class="relative h-full p-3 sm:p-4">
                         <!-- Expanded Textarea - Full Section -->
                         <textarea 
                             id="expanded-user-input" 
                             class="w-full bg-transparent border-none resize-none focus:outline-none text-[#000000] font-sans text-3xl placeholder-[#1e1e1e] pr-20 text-right absolute top-2 right-0"
                             placeholder="Learn anything..."
                             rows="3"
                             onkeydown="handleExpandedInputKeyDown(event)"
                             oninput="handleInputChange(this)"
                             style="min-height: 5rem; line-height: 1.5; cursor: text;" <!-- 80px -->
                         ></textarea>
                         
                        <!-- Paperclip Icon Button - Very Right Side -->
                        <button class="document-button absolute bottom-3 right-4 w-8 h-8 bg-transparent rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors" onclick="attachDocument()" title="Attach Document">
                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        
                        <!-- Recorder Button - Left of Paperclip -->
                        <button class="recorder-button absolute bottom-3 right-12 w-8 h-8 bg-transparent rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors" onclick="startRecording()" title="Voice Recording">
                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <line x1="12" y1="19" x2="12" y2="23" stroke-width="2" stroke-linecap="round"/>
                                <line x1="8" y1="23" x2="16" y2="23" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </button>
                        
                        <!-- Send Button - Circle with Arrow at Left Bottom -->
                        <button id="send-button" class="absolute bottom-3 left-4 w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center hover:bg-gray-600 transition-colors shadow-lg" onclick="event.preventDefault(); sendMessage(); return false;">
                            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V5M5 12l7-7 7 7"/>
                    </svg>
                </button>
            </div>
        </div>
        
    </main>
    

    
    <!-- Remove the separate white navigation bar -->
    
    <script>
        let currentConversationId = 'default';
        let isStreaming = false;
        
        // Simple approach - no complex event listeners needed
        // All events are handled by inline onclick, onfocus, onblur attributes
        
        // Initialize conversation
        async function initializeConversation() {
            try {
                const response = await fetch('/api/chat-start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                currentConversationId = data.conversationId;
                console.log('New conversation started:', currentConversationId);
            } catch (error) {
                console.error('Failed to start conversation:', error);
            }
        }
        

        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            
            // Update button color based on typing
            const sendButton = document.getElementById('send-button');
            if (textarea.value.trim() !== '') {
                textarea.classList.add('typing-active');
                // Send button black when typing
                sendButton.classList.remove('bg-gray-400');
                sendButton.classList.add('bg-black');
            } else {
                textarea.classList.remove('typing-active');
                // Send button pale gray when empty
                sendButton.classList.remove('bg-black');
                sendButton.classList.add('bg-gray-400');
            }
        }
        
        // Auto-resize function for the chat bar textarea
        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }
        
        // Function to handle input changes for button color
        function handleInputChange(textarea) {
            const sendButton = document.getElementById('send-button');
            if (textarea.value.length > 0) {
                // User is typing - make button black
                sendButton.classList.remove('bg-gray-400');
                sendButton.classList.add('bg-black');
            } else {
                // No text - make button pale gray
                sendButton.classList.remove('bg-black');
                sendButton.classList.add('bg-gray-400');
            }
        }
        
        // Function to show expanded input
        function showExpandedInput() {
            // Hide main header to prevent overlap
            const mainHeader = document.getElementById('main-header');
            if (mainHeader) {
                mainHeader.style.display = 'none';
            }
            
            // Hide main user input container
            const userInputContainer = document.getElementById('main-user-input');
            if (userInputContainer) {
                userInputContainer.style.display = 'none';
            }
            
            // Hide bottom navigation icons
            hideBottomIcons();
            
            // Show second gainsboro page FIRST (background)
            const secondPage = document.getElementById('second-gainsboro-page');
            if (secondPage) {
                secondPage.classList.remove('hidden');
                secondPage.style.display = 'block';
            }
            
            // Show expanded input ON TOP of second page
            const expandedInput = document.getElementById('expanded-input-container');
            if (expandedInput) {
                expandedInput.classList.remove('hidden');
                expandedInput.style.display = 'block';
            }
            
            // Focus on the expanded textarea
            setTimeout(() => {
                const expandedTextarea = document.getElementById('expanded-user-input');
                if (expandedTextarea) {
                    expandedTextarea.focus();
                }
            }, 100);
        }
        
        // Function to hide bottom icons
        function hideBottomIcons() {
            const iconsContainer = document.querySelector('.icons-container');
            if (iconsContainer) {
                iconsContainer.style.display = 'none';
            }
        }
        
        // Function to disable page scrolling
        function disableScrolling() {
            document.body.style.overflow = 'hidden';
            document.documentElement.style.overflow = 'hidden';
        }
        
        // Function to enable page scrolling
        function enableScrolling() {
            document.body.style.overflow = 'auto';
            document.documentElement.style.overflow = 'auto';
        }
        
        // Function to show bottom icons
        function showBottomIcons() {
            const iconsContainer = document.querySelector('.icons-container');
            if (iconsContainer) {
                iconsContainer.style.display = 'flex';
            }
        }
        
        // Function to collapse only the expanded input but stay on same page
        function collapseExpandedInputOnly() {
            // Hide expanded input container
            const expandedInput = document.getElementById('expanded-input-container');
            if (expandedInput) {
                expandedInput.classList.add('hidden');
                expandedInput.style.display = 'none';
            }
            
            // Show main user input container (oval input) but keep it on the second page
            const userInputContainer = document.getElementById('main-user-input');
            if (userInputContainer) {
                userInputContainer.style.display = 'block';
                // Position it at the very bottom with 1px distance
                userInputContainer.style.position = 'fixed';
                userInputContainer.style.bottom = '1px';
                userInputContainer.style.left = '50%';
                userInputContainer.style.transform = 'translateX(-50%)';
                userInputContainer.style.zIndex = '1000';
                userInputContainer.style.width = '95%';
                userInputContainer.style.maxWidth = '600px';
                
                // Add border for second page user input
                const inputBar = userInputContainer.querySelector('.input-bar');
                if (inputBar) {
                    inputBar.style.border = '0.5px solid #6b7280';
                }
            }
            
            // Adjust chat area to have bottom padding so text doesn't go behind input
            const chatArea = document.getElementById('second-page-chat-area');
            if (chatArea) {
                chatArea.style.paddingBottom = '120px'; // More space for proper positioning
                chatArea.style.bottom = '0px'; // Ensure it goes to the very bottom
                chatArea.scrollTop = chatArea.scrollHeight; // Scroll to bottom
            }
            
            // Keep the second gainsboro page visible (don't hide it)
            const secondPage = document.getElementById('second-gainsboro-page');
            if (secondPage) {
                secondPage.classList.remove('hidden');
                secondPage.style.display = 'block';
            }
            
            // Keep bottom icons hidden (as requested)
            const iconsContainer = document.querySelector('.icons-container');
            if (iconsContainer) {
                iconsContainer.style.display = 'none';
            }
            
            // Keep scrolling disabled to maintain the chat view
            document.body.style.overflow = 'hidden';
            document.documentElement.style.overflow = 'hidden';
        }
        
        // Function to hide expanded input
        function hideExpandedInput() {
            // Show main user input container and icons
            const userInputContainer = document.getElementById('main-user-input');
            if (userInputContainer) {
                userInputContainer.style.display = 'block';
            }
            
            // Show bottom icons again
            showBottomIcons();
            
            // Enable scrolling again
            enableScrolling();
            
            // Hide expanded input
            const expandedInput = document.getElementById('expanded-input-container');
            if (expandedInput) {
                expandedInput.classList.add('hidden');
                expandedInput.style.display = 'none';
            }
            
            // Hide second gainsboro page
            const secondPage = document.getElementById('second-gainsboro-page');
            if (secondPage) {
                secondPage.classList.add('hidden');
                secondPage.style.display = 'none';
            }
        }
        
        // Function to hide second page
        function hideSecondPage() {
            // Show main header again
            const mainHeader = document.getElementById('main-header');
            if (mainHeader) {
                mainHeader.style.display = 'block';
            }
            
            // Hide second gainsboro page
            const secondPage = document.getElementById('second-gainsboro-page');
            if (secondPage) {
                secondPage.classList.add('hidden');
                secondPage.style.display = 'none';
            }
            
            // Hide expanded input
            const expandedInput = document.getElementById('expanded-input-container');
            if (expandedInput) {
                expandedInput.classList.add('hidden');
                expandedInput.style.display = 'none';
            }
            
            // Show main user input container and icons
            const userInputContainer = document.getElementById('main-user-input');
            if (userInputContainer) {
                userInputContainer.style.display = 'block';
            }
            
            // Show bottom icons again
            showBottomIcons();
            
            // Enable scrolling again
            enableScrolling();
        }
        
        // Handle Enter key in expanded input
        function handleExpandedInputKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // Add message to second gainsboro page
        function addExpandedMessage(content, isUser = false) {
            const chatArea = document.getElementById('second-page-chat-area');
            if (!chatArea) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex w-full ${isUser ? 'justify-start' : 'justify-end'} mb-4`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `px-3 sm:px-4 py-4 sm:py-5 rounded-2xl ${
                isUser 
                    ? 'max-w-[99%] sm:max-w-[98%] lg:max-w-[97%] bg-[#e8e8e4] text-black text-left' 
                    : 'w-full text-black text-right'
            } leading-relaxed text-base`;
            
            // Use proper formatting for user messages too
            if (isUser) {
                messageBubble.textContent = content;
            } else {
                // For AI messages, use the robust formatting system
                const formattedContent = formatChatContent(content);
                messageBubble.innerHTML = formattedContent;
                // Force width override with inline styles - same as detailed analysis
                messageBubble.style.width = '100%';
                messageBubble.style.maxWidth = '100%';
            }
            
            messageDiv.appendChild(messageBubble);
            chatArea.appendChild(messageDiv);
            
            // VISUAL DEBUG: Check if message was actually added
            console.log('üîç VISUAL DEBUG - Message added to DOM:', {
                messageDiv: messageDiv,
                messageDivClasses: messageDiv.classList.toString(),
                messageDivStyles: messageDiv.style.cssText,
                messageDivOffsetWidth: messageDiv.offsetWidth,
                messageDivOffsetHeight: messageDiv.offsetHeight,
                chatAreaChildrenCount: chatArea.children.length,
                chatAreaScrollHeight: chatArea.scrollHeight
            });
            
            // Ensure proper spacing from bottom input
            if (chatArea.style.paddingBottom) {
                chatArea.scrollTop = chatArea.scrollHeight;
            } else {
            // Scroll to bottom
            chatArea.scrollTop = chatArea.scrollHeight;
            }
        }
        
        // Add streaming message placeholder in second gainsboro page
        function addExpandedStreamingMessage() {
            const chatArea = document.getElementById('second-page-chat-area');
            if (!chatArea) return null;
            
            // Create unique ID for each message
            const messageId = 'expanded-streaming-message-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = 'flex w-full justify-end mb-4';
            
            const messageBubble = document.createElement('div');
            messageBubble.className = 'w-full px-3 sm:px-4 py-4 sm:py-5 rounded-2xl text-black text-right leading-relaxed font-medium';
            messageBubble.style.cssText = 'font-size: 18px !important; font-weight: 500 !important;';
            messageBubble.innerHTML = '<span class="typing-indicator">...</span>';
            
            // Add a data attribute to make it easier to find
            messageBubble.setAttribute('data-message-bubble', 'true');
            
            // Force width override with inline styles - same as detailed analysis
            messageBubble.style.width = '100%';
            messageBubble.style.maxWidth = '100%';
            
            messageDiv.appendChild(messageBubble);
            chatArea.appendChild(messageDiv);
            
            // Ensure proper spacing from bottom input
            if (chatArea.style.paddingBottom) {
                chatArea.scrollTop = chatArea.scrollHeight;
            } else {
            // Scroll to bottom
            chatArea.scrollTop = chatArea.scrollHeight;
            }
            
            return messageId;
        }
        
        // Update streaming message in second gainsboro page - Simple typewriter + Enhanced final formatting
        function updateExpandedStreamingMessage(messageId, content) {
            console.log('üîÑ updateExpandedStreamingMessage called with:', messageId, content);
            const messageElement = document.getElementById(messageId);
            if (messageElement) {
                console.log('‚úÖ Found message element:', messageElement);
                const bubble = messageElement.querySelector('[data-message-bubble="true"]');
                if (bubble) {
                    console.log('‚úÖ Found bubble element, updating content');
                    
                    // Enhanced Study Mode formatting during streaming
                    const formattedContent = formatChatContent(content);
                    bubble.innerHTML = formattedContent;
                    
                    // Ensure font size is preserved
                    bubble.style.cssText = 'font-size: 18px !important; font-weight: 500 !important;';
                    
                    // Force width override with inline styles
                    bubble.style.width = '100%';
                    bubble.style.maxWidth = '100%';
                    
                    // Add interactive elements after content is set
                    setTimeout(() => {
                        addInteractiveElements(messageElement);
                    }, 100);
                    
                    // Ensure the content is selectable
                    bubble.style.webkitUserSelect = 'text';
                    bubble.style.userSelect = 'text';
                    bubble.style.cursor = 'text';
                    
                } else {
                    console.log('‚ùå Bubble element not found');
                }
            } else {
                console.log('‚ùå Message element not found for ID:', messageId);
            }
        }
        

        

        
        
        

        
                // Enable scrolling without hiding navigation
        function enableScrollingWithoutHidingNav() {
            // Enable scrolling for the page
            document.body.style.overflow = 'auto';
            document.documentElement.style.overflow = 'auto';
            console.log('‚úÖ Scrolling enabled without hiding navigation');
        }

        // Scroll to bottom of chat
        function scrollToBottom() {
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        // Start new chat function
        function startNewChat() {
            // Clear current conversation
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.innerHTML = '';
            }
            
            // Clear second page chat area
            const secondPageChatArea = document.getElementById('second-page-chat-area');
            if (secondPageChatArea) {
                secondPageChatArea.innerHTML = '';
            }
            
            // Reset conversation state
            currentConversationId = null;
            currentThreadId = null;
            
            // Clear input
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.value = '';
            }
            
            // Clear expanded input
            const expandedInput = document.getElementById('expanded-user-input');
            if (expandedInput) {
                expandedInput.value = '';
            }
            
            // Initialize new conversation
            initializeConversation();
            
            console.log('üÜï New chat started');
        }
        
        // Show thread menu function
        function showThreadMenu() {
            const options = [
                'ÿ≠ÿ∞ŸÅ ⁄ØŸÅÿ™⁄ØŸà',
                'ÿ¢ÿ±ÿ¥€åŸà ⁄ØŸÅÿ™⁄ØŸà', 
                'ÿßÿ¥ÿ™ÿ±ÿß⁄©‚Äå⁄Øÿ∞ÿßÿ±€å',
                '⁄©Ÿæ€å ⁄ØŸÅÿ™⁄ØŸà',
                'ÿ™ŸÜÿ∏€åŸÖÿßÿ™'
            ];
            
            const choice = prompt(`⁄Øÿ≤€åŸÜŸá‚ÄåŸáÿß€å ⁄ØŸÅÿ™⁄ØŸà:\n\n${options.map((option, index) => `${index + 1}. ${option}`).join('\n')}\n\nŸÑÿ∑ŸÅÿßŸã ÿ¥ŸÖÿßÿ±Ÿá ⁄Øÿ≤€åŸÜŸá ŸÖŸàÿ±ÿØ ŸÜÿ∏ÿ± ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ:`);
            
            if (choice) {
                const optionIndex = parseInt(choice) - 1;
                if (optionIndex >= 0 && optionIndex < options.length) {
                    const selectedOption = options[optionIndex];
                    console.log('üîç Selected option:', selectedOption);
                    
                    switch(selectedOption) {
                        case 'ÿ≠ÿ∞ŸÅ ⁄ØŸÅÿ™⁄ØŸà':
                            if (confirm('ÿ¢€åÿß ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØ ⁄©Ÿá ŸÖ€å‚ÄåÿÆŸàÿßŸá€åÿØ ÿß€åŸÜ ⁄ØŸÅÿ™⁄ØŸà ÿ±ÿß ÿ≠ÿ∞ŸÅ ⁄©ŸÜ€åÿØÿü')) {
                                deleteCurrentThread();
                            }
                            break;
                        case 'ÿ¢ÿ±ÿ¥€åŸà ⁄ØŸÅÿ™⁄ØŸà':
                            archiveCurrentThread();
                            break;
                        case 'ÿßÿ¥ÿ™ÿ±ÿß⁄©‚Äå⁄Øÿ∞ÿßÿ±€å':
                            shareConversation();
                            break;
                        case '⁄©Ÿæ€å ⁄ØŸÅÿ™⁄ØŸà':
                            copyConversation();
                            break;
                        case 'ÿ™ŸÜÿ∏€åŸÖÿßÿ™':
                            showThreadSettings();
                            break;
                    }
                } else {
                    alert('⁄Øÿ≤€åŸÜŸá ŸÜÿßŸÖÿπÿ™ÿ®ÿ± ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ÿØŸá ÿßÿ≥ÿ™.');
                }
            }
        }
        
        // Share conversation function for second page
        function shareConversation() {
            const chatArea = document.getElementById('second-page-chat-area');
            if (!chatArea || chatArea.children.length === 0) {
                alert('Ÿá€å⁄Ü ⁄ØŸÅÿ™⁄ØŸà€å€å ÿ®ÿ±ÿß€å ÿßÿ¥ÿ™ÿ±ÿß⁄©‚Äå⁄Øÿ∞ÿßÿ±€å Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ');
                return;
            }
            
            // Collect all messages from second page
            let conversationText = '⁄ØŸÅÿ™⁄ØŸà€å ŸÖŸÜ ÿ®ÿß High School AI:\n\n';
            const messages = chatArea.children;
            
            for (let i = 0; i < messages.length; i++) {
                const message = messages[i];
                const isUser = message.classList.contains('justify-start');
                const messageContent = message.querySelector('[data-message-bubble="true"]');
                
                if (messageContent) {
                    const role = isUser ? 'ŸÖŸÜ' : 'AI';
                    conversationText += `${role}: ${messageContent.textContent}\n\n`;
                }
            }
            
            // Try to use Web Share API if available
            if (navigator.share) {
                navigator.share({
                    title: '⁄ØŸÅÿ™⁄ØŸà€å ŸÖŸÜ ÿ®ÿß High School AI',
                    text: conversationText,
                    url: window.location.href
                }).catch(err => {
                    console.log('Error sharing:', err);
                    fallbackShare(conversationText);
                });
            } else {
                fallbackShare(conversationText);
            }
        }
        
        // Copy conversation function
        function copyConversation() {
            const chatArea = document.getElementById('second-page-chat-area');
            if (!chatArea || chatArea.children.length === 0) {
                alert('Ÿá€å⁄Ü ⁄ØŸÅÿ™⁄ØŸà€å€å ÿ®ÿ±ÿß€å ⁄©Ÿæ€å ⁄©ÿ±ÿØŸÜ Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ');
                return;
            }
            
            // Collect all messages
            let conversationText = '⁄ØŸÅÿ™⁄ØŸà€å ŸÖŸÜ ÿ®ÿß High School AI:\n\n';
            const messages = chatArea.children;
            
            for (let i = 0; i < messages.length; i++) {
                const message = messages[i];
                const isUser = message.classList.contains('justify-start');
                const messageContent = message.querySelector('[data-message-bubble="true"]');
                
                if (messageContent) {
                    const role = isUser ? 'ŸÖŸÜ' : 'AI';
                    conversationText += `${role}: ${messageContent.textContent}\n\n`;
                }
            }
            
            // Copy to clipboard
            navigator.clipboard.writeText(conversationText).then(() => {
                alert('⁄ØŸÅÿ™⁄ØŸà ⁄©Ÿæ€å ÿ¥ÿØ! ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€åÿØ ÿ¢ŸÜ ÿ±ÿß ÿØÿ± Ÿáÿ± ÿ¨ÿß€å€å Ÿæ€åÿ≥ÿ™ ⁄©ŸÜ€åÿØ.');
            }).catch(() => {
                alert('ÿÆÿ∑ÿß ÿØÿ± ⁄©Ÿæ€å ⁄©ÿ±ÿØŸÜ ⁄ØŸÅÿ™⁄ØŸà');
            });
        }
        
        // Delete current thread function
        function deleteCurrentThread() {
            if (currentThreadId) {
                // Here you would call API to delete the thread
                console.log('üóëÔ∏è Deleting thread:', currentThreadId);
                alert('⁄ØŸÅÿ™⁄ØŸà ÿ≠ÿ∞ŸÅ ÿ¥ÿØ');
                hideSecondPage();
            } else {
                alert('Ÿá€å⁄Ü ⁄ØŸÅÿ™⁄ØŸà€å€å ÿ®ÿ±ÿß€å ÿ≠ÿ∞ŸÅ ⁄©ÿ±ÿØŸÜ Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ');
            }
        }
        
        // Archive current thread function
        function archiveCurrentThread() {
            if (currentThreadId) {
                // Here you would call API to archive the thread
                console.log('üì¶ Archiving thread:', currentThreadId);
                alert('⁄ØŸÅÿ™⁄ØŸà ÿ¢ÿ±ÿ¥€åŸà ÿ¥ÿØ');
            } else {
                alert('Ÿá€å⁄Ü ⁄ØŸÅÿ™⁄ØŸà€å€å ÿ®ÿ±ÿß€å ÿ¢ÿ±ÿ¥€åŸà ⁄©ÿ±ÿØŸÜ Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ');
            }
        }
        
        // Show thread settings function
        function showThreadSettings() {
            alert('ÿ™ŸÜÿ∏€åŸÖÿßÿ™ ⁄ØŸÅÿ™⁄ØŸà (ÿØÿ± ÿ≠ÿßŸÑ ÿ™Ÿàÿ≥ÿπŸá)');
        }
        
        // Share main conversation function
        function shareMainConversation() {
            const chatMessages = document.getElementById('chat-messages');
            if (!chatMessages || chatMessages.children.length === 0) {
                alert('Ÿá€å⁄Ü ⁄ØŸÅÿ™⁄ØŸà€å€å ÿ®ÿ±ÿß€å ÿßÿ¥ÿ™ÿ±ÿß⁄©‚Äå⁄Øÿ∞ÿßÿ±€å Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ');
                return;
            }
            
            // Collect all messages from main chat area
            let conversationText = '⁄ØŸÅÿ™⁄ØŸà€å ŸÖŸÜ ÿ®ÿß High School AI:\n\n';
            const messages = chatMessages.children;
            
            for (let i = 0; i < messages.length; i++) {
                const message = messages[i];
                const isUser = message.classList.contains('justify-start');
                const messageContent = message.querySelector('[data-message-bubble="true"]');
                
                if (messageContent) {
                    const role = isUser ? 'ŸÖŸÜ' : 'AI';
                    conversationText += `${role}: ${messageContent.textContent}\n\n`;
                }
            }
            
            // Try to use Web Share API if available
            if (navigator.share) {
                navigator.share({
                    title: '⁄ØŸÅÿ™⁄ØŸà€å ŸÖŸÜ ÿ®ÿß High School AI',
                    text: conversationText,
                    url: window.location.href
                }).catch(err => {
                    console.log('Error sharing:', err);
                    fallbackShare(conversationText);
                });
            } else {
                fallbackShare(conversationText);
            }
        }
        
        // Fallback share function
        function fallbackShare(text) {
            // Copy to clipboard
            navigator.clipboard.writeText(text).then(() => {
                alert('⁄ØŸÅÿ™⁄ØŸà ⁄©Ÿæ€å ÿ¥ÿØ! ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€åÿØ ÿ¢ŸÜ ÿ±ÿß ÿØÿ± Ÿáÿ± ÿ¨ÿß€å€å Ÿæ€åÿ≥ÿ™ ⁄©ŸÜ€åÿØ.');
            }).catch(() => {
                // If clipboard fails, show the text in a prompt
                prompt('⁄ØŸÅÿ™⁄ØŸà ⁄©Ÿæ€å ÿ¥ÿØŸá (Ctrl+C ÿ®ÿ±ÿß€å ⁄©Ÿæ€å):', text);
            });
        }
        
                function addMessage(content, isUser = false, messageId = null, skipFormatting = false) {
            console.log('üîç ===== ADD MESSAGE DEBUG START =====');
            console.log('üì® addMessage called with:', { content: content.substring(0, 100) + '...', isUser, messageId, skipFormatting });
            
            const messagesContainer = document.getElementById('chat-messages');
            console.log('üì® Messages container:', messagesContainer);
            console.log('üì® Messages container current display:', messagesContainer ? messagesContainer.style.display : 'null');
            console.log('üì® Messages container current classes:', messagesContainer ? messagesContainer.classList.toString() : 'null');
            
            const messageDiv = document.createElement('div');
            
            if (messageId) {
                messageDiv.id = messageId;
                console.log('üì® Message ID set:', messageId);
            }
            
            // Proper message positioning - user left, AI right
            messageDiv.className = `flex w-full ${isUser ? 'justify-start' : 'justify-end'} mb-6`;
            console.log('üì® Message div classes:', messageDiv.className);
            
            // Check if content is already formatted (contains HTML tags)
            const isAlreadyFormatted = content.includes('<div') || content.includes('<p') || content.includes('<ul') || content.includes('<ol') || content.includes('<li');
            console.log('üì® Is content already formatted:', isAlreadyFormatted);
            
            // Format content properly for AI messages (only if not already formatted and not skipping)
            const displayContent = isUser ? content : (isAlreadyFormatted || skipFormatting ? content : formatChatContent(content));
            console.log('üì® Display content length:', displayContent.length);
            console.log('üì® Display content preview:', displayContent.substring(0, 100) + '...');
            
            const messageContent = `
                <div class="max-w-full ${isUser ? 'bg-gray-200 text-gray-900' : 'text-gray-900'} rounded-3xl px-3 py-4 ${isUser ? 'shadow-sm' : ''} ${!isUser ? 'ml-auto' : ''}">
                    <div class="${isUser ? 'text-base' : 'text-lg'} leading-relaxed" ${!isUser ? 'dir="rtl"' : ''}>${displayContent}</div>
                </div>
            `;
            
            messageDiv.innerHTML = messageContent;
            messagesContainer.appendChild(messageDiv);
            console.log('üì® Message appended to container');
            
            // Enable scrolling after first message without hiding navigation
            enableScrollingWithoutHidingNav();
            
            
            // Mathematical rendering simplified for deployment
            if (!isUser) {
                console.log('‚úÖ Mathematical rendering simplified for deployment');
            }
            
            // Scroll to show the new message at the top
            setTimeout(() => {
                if (isUser) {
                    // For user messages, scroll to show the new message
                    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    // For AI responses, scroll to show the new content below input
                    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
            
            console.log(`Message added: ${isUser ? 'User' : 'AI'} - Total messages: ${messagesContainer.children.length}`);
            console.log('üîç ===== ADD MESSAGE DEBUG END =====');
            
            return messageDiv;
        }
        
        function addStreamingMessage() {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            const messageId = `msg_${Date.now()}`;
            
            messageDiv.id = messageId;
            // AI messages always on the right
            messageDiv.className = 'flex w-full justify-end mb-4';
            
            const messageContent = `
                <div class="ml-auto max-w-full text-gray-900 rounded-3xl px-3 py-4">
                    <div class="text-lg leading-relaxed flex items-center justify-center">
                        <div class="spinning-logo-container">
                            <div class="thinking-text">ÿØÿ± ÿ≠ÿßŸÑ ŸÅ⁄©ÿ± ⁄©ÿ±ÿØŸÜ...</div>
                        </div>
                    </div>
                </div>
            `;
            
            messageDiv.innerHTML = messageContent;
            messagesContainer.appendChild(messageDiv);
            
            // Enable scrolling when streaming starts without hiding navigation
            enableScrollingWithoutHidingNav();
            
            // Scroll to show the new message at the top
            setTimeout(() => {
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
            
            console.log(`Streaming message added - Total messages: ${messagesContainer.children.length}`);
            
            return messageId;
        }
        
        function updateStreamingMessage(messageId, content) {
            const messageDiv = document.getElementById(messageId);
            if (messageDiv) {
                // Ensure the message div maintains its right alignment
                messageDiv.className = 'flex w-full justify-end';
                
                const textElement = messageDiv.querySelector('div');
                
                // Enhanced Study Mode formatting during streaming
                const formattedContent = formatChatContent(content);
                textElement.innerHTML = `<div class="text-right"><span class="text-lg leading-relaxed">${formattedContent}</span></div>`;
                
                // Add interactive elements after content is set
                setTimeout(() => {
                    addInteractiveElements(messageDiv);
                }, 100);
                
                        // Mathematical rendering simplified for deployment
        console.log('‚úÖ Mathematical rendering simplified for deployment');
                
                // Always scroll to show latest content below input
                const messagesContainer = document.getElementById('chat-messages');
                setTimeout(() => {
                    // Scroll to show the new message below input
                    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 50);
            }
        }

        // Enhanced ChatGPT Study Mode formatting with typewriter effect preserved
        // Enhanced Study Mode Rendering System
        function formatChatContent(content) {
            if (!content || typeof content !== 'string') {
                return '<div class="study-message">ŸÖÿ™ÿ£ÿ≥ŸÅÿßŸÜŸá ŸÖÿ≠ÿ™Ÿàÿß€å€å ÿ®ÿ±ÿß€å ŸÜŸÖÿß€åÿ¥ Ÿàÿ¨ŸàÿØ ŸÜÿØÿßÿ±ÿØ.</div>';
            }
            
            // Parse and format the content
            const parsedContent = parseStudyContent(content);
            return `<div class="study-message" dir="rtl">${parsedContent}</div>`;
        }
        
        // Parse AI output text into structured HTML (Simple bullet points only)
        function parseStudyContent(text) {
            // Remove all markdown formatting - keep only bullet points
            let processedText = text;
            
            // Remove markdown bold (convert **text** to plain text)
            processedText = processedText.replace(/\*\*(.*?)\*\*/g, '$1');
            
            // Remove markdown italic (convert *text* to plain text)
            processedText = processedText.replace(/\*(.*?)\*/g, '$1');
            
            // Remove markdown code (convert `text` to plain text)
            processedText = processedText.replace(/`(.*?)`/g, '$1');
            
            // Remove markdown headers
            processedText = processedText.replace(/^#{1,6}\s+(.+)$/gm, '$1');
            
            // Convert lines starting with - to start with ‚Ä¢ instead
            processedText = processedText.replace(/^- /gm, '‚Ä¢ ');
            
            // Remove any remaining dash symbols from content - only use ‚Ä¢
            processedText = processedText.replace(/-/g, '');
            
            const lines = processedText.split('\n');
            let result = [];
            let currentList = [];
            let listType = 'ul';
            let inList = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (!line) {
                    // Empty line - close current list if exists
                    if (inList && currentList.length > 0) {
                        result.push(`<${listType} class="study-list">${currentList.join('')}</${listType}>`);
                        currentList = [];
                        inList = false;
                    }
                    continue;
                }
                
                // Detect bullet points (ONLY lines starting with ‚Ä¢ - ignore -, *, etc.)
                if (line.startsWith('‚Ä¢')) {
                    if (!inList) {
                        inList = true;
                        listType = 'ul';
                        currentList = [];
                    }
                    // Remove the ‚Ä¢ symbol and get the content
                    const content = line.substring(1).trim();
                    currentList.push(`<li class="study-list-item">${content}</li>`);
                    console.log('üîµ Creating bullet point:', content);
                    continue;
                }
                
                // Detect numbered lists (lines starting with 1., 2., etc.)
                const numberedMatch = line.match(/^(\d+)\.\s+(.+)$/);
                if (numberedMatch) {
                    if (!inList || listType !== 'ol') {
                    if (inList && currentList.length > 0) {
                            result.push(`<${listType} class="study-list">${currentList.join('')}</${listType}>`);
                        }
                        inList = true;
                        listType = 'ol';
                        currentList = [];
                    }
                    currentList.push(`<li class="study-list-item">${numberedMatch[2]}</li>`);
                    continue;
                }
                
                // Detect math equations (comprehensive LaTeX detection)
                if (line.includes('\\(') || line.includes('\\[') || line.includes('\\frac') || line.includes('\\times') || 
                    line.includes('\\sqrt') || line.includes('\\sum') || line.includes('\\int') || line.includes('\\lim') ||
                    line.includes('\\sin') || line.includes('\\cos') || line.includes('\\tan') || line.includes('\\log') ||
                    line.includes('\\alpha') || line.includes('\\beta') || line.includes('\\gamma') || line.includes('\\delta') ||
                    line.includes('\\pi') || line.includes('\\theta') || line.includes('\\lambda') || line.includes('\\mu') ||
                    line.includes('\\sigma') || line.includes('\\omega') || line.includes('\\infty') || line.includes('\\partial') ||
                    line.includes('\\nabla') || line.includes('\\pm') || line.includes('\\mp') || line.includes('\\leq') ||
                    line.includes('\\geq') || line.includes('\\neq') || line.includes('\\approx') || line.includes('\\equiv') ||
                    line.includes('\\in') || line.includes('\\subset') || line.includes('\\supset') || line.includes('\\cup') ||
                    line.includes('\\cap') || line.includes('\\emptyset') || line.includes('\\rightarrow') || line.includes('\\leftarrow') ||
                    line.includes('\\Rightarrow') || line.includes('\\Leftarrow') || line.includes('\\Leftrightarrow') ||
                    line.includes('\\begin') || line.includes('\\end') || line.includes('\\matrix') || line.includes('\\pmatrix') ||
                    line.includes('\\bmatrix') || line.includes('\\vmatrix') || line.includes('\\det') || line.includes('\\text') ||
                    line.match(/\\[a-zA-Z]+/) || line.match(/\$.*\$/) || line.match(/\\[\[\](){}]/)) {
            if (inList && currentList.length > 0) {
                        result.push(`<${listType} class="study-list">${currentList.join('')}</${listType}>`);
                        currentList = [];
                        inList = false;
                    }
                    result.push(`<div class="study-math">${line}</div>`);
                    continue;
                }
                
                // Regular paragraph
                if (inList && currentList.length > 0) {
                    result.push(`<${listType} class="study-list">${currentList.join('')}</${listType}>`);
                    currentList = [];
                    inList = false;
                }
                result.push(`<p class="study-paragraph">${line}</p>`);
            }
            
            // Close any remaining list
            if (inList && currentList.length > 0) {
                result.push(`<${listType} class="study-list">${currentList.join('')}</${listType}>`);
            }
            
            return result.join('');
        }
        
        // Add interactive elements (simplified - no buttons, no collapsible)
        function addInteractiveElements(messageElement) {
            const studyMessage = messageElement.querySelector('.study-message');
            if (!studyMessage) return;
            
            // Process math equations with MathJax
            const mathElements = studyMessage.querySelectorAll('.study-math');
            mathElements.forEach(math => {
                // MathJax will automatically process these elements
                math.style.display = 'block';
            });
            
            // Re-render MathJax
            waitForMathJax(() => {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    console.log('üî¢ Processing MathJax for study message');
                    MathJax.typesetPromise([studyMessage]).then(() => {
                        console.log('‚úÖ MathJax processing completed');
                    });
                }
            });
        }
        
        
        
        
        

        
        async function sendMessage() {
            console.log('üöÄ sendMessage function called');
            if (isStreaming) {
                console.log('‚ö†Ô∏è Already streaming, ignoring new message');
                return;
            }
            
            try {
            
            // Get message from expanded input
            const expandedInput = document.getElementById('expanded-user-input');
            let message = '';
            
            if (expandedInput && expandedInput.value.trim() !== '') {
                message = expandedInput.value.trim();
            }
            
            console.log('üìù Message content:', message);
            if (!message) return;
            
            // Create new thread if none exists
            if (!currentThreadId) {
                const title = message.length > 50 ? message.substring(0, 50) + '...' : message;
                await createNewThread(title);
            }
            
            // Add user message to second gainsboro page
            addExpandedMessage(message, true);
            
            // Clear the expanded input
            if (expandedInput) {
                expandedInput.value = '';
            }
            
            // Hide expanded input but don't show oval input yet - wait for response completion
            const expandedInputContainer = document.getElementById('expanded-input-container');
            if (expandedInputContainer) {
                expandedInputContainer.classList.add('hidden');
                expandedInputContainer.style.display = 'none';
            }
            
            // Add AI response placeholder in second gainsboro page
            const streamingMessageId = addExpandedStreamingMessage();
            isStreaming = true;
            
            // Add timeout safety to reset streaming flag
            const streamingTimeout = setTimeout(() => {
                console.log('‚ö†Ô∏è Streaming timeout reached, resetting flag');
                isStreaming = false;
            }, 60000); // 60 second timeout
            
            try {
                // Use streaming API for real-time response with conversation context
                const aiResponse = await streamAIResponseWithContext(message, streamingMessageId, true); // true = expanded mode
                
                // Add AI response placeholder in second gainsboro page
                await saveMessageToThread(message, aiResponse);
                
                // Clear timeout since streaming completed successfully
                clearTimeout(streamingTimeout);
                
                // Show oval input when response is complete for better UX
                collapseExpandedInputOnly();
                
            } catch (error) {
                console.error('Failed to get AI response:', error);
                updateExpandedStreamingMessage(streamingMessageId, 'ŸÖÿ™ÿ£ÿ≥ŸÅÿßŸÜŸá ÿÆÿ∑ÿß€å€å ÿ±ÿÆ ÿØÿßÿØ. ŸÑÿ∑ŸÅÿßŸã ÿØŸàÿ®ÿßÿ±Ÿá ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ€åÿØ.');
                
                // Clear timeout on error
                clearTimeout(streamingTimeout);
                
                // Show oval input on error for retry
                collapseExpandedInputOnly();
            } finally {
                // Always reset streaming flag
                isStreaming = false;
                console.log('‚úÖ Streaming completed, flag reset');
            }
            } catch (error) {
                console.error('‚ùå Error in sendMessage:', error);
                // Always reset streaming flag on error
                isStreaming = false;
                // Show oval input on error for retry
                collapseExpandedInputOnly();
            }
        }

        // Stream AI response with thread context
        async function streamAIResponseWithContext(message, messageId, isExpanded = false) {
            try {
                console.log('üöÄ Starting AI call with thread context');
                console.log('üìù User message:', message);
                console.log('üÜî Thread ID:', currentThreadId);
                
                // Ensure we have a thread ID
                if (!currentThreadId) {
                    console.log('üîç No thread ID, creating new thread...');
                    const title = message.length > 50 ? message.substring(0, 50) + '...' : message;
                    currentThreadId = await createNewThread(title);
                    if (!currentThreadId) {
                        console.error('‚ùå Failed to create thread');
                        return;
                    }
                }
                
                // Get thread context for AI
                const contextMessages = await getThreadContext(4000); // 4000 token limit
                console.log('üìö Context messages for AI:', contextMessages.length);
                
                // Prepare context for AI
                const contextForAI = contextMessages.map(msg => ({
                    role: msg.sender_role === 'user' ? 'user' : 'assistant',
                    content: msg.content
                }));
                
                console.log('üìö Using context messages:', contextForAI.length);
                
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        conversationId: currentThreadId || 'new_thread',
                        context: contextForAI
                    })
                });
                
                console.log('üì° Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            console.log('üîç Processing data line:', data.substring(0, 100));
                            
                            if (data === '[DONE]') {
                                console.log('‚úÖ Received [DONE] signal');
                                return fullResponse;
                            }
                            
                            try {
                                const parsed = JSON.parse(data);
                                console.log('üìù Parsed data:', parsed);
                                
                                if (parsed.content && parsed.type === 'chunk') {
                                    console.log('‚úÖ Valid chunk received, content:', parsed.content);
                                    fullResponse += parsed.content;
                                
                                    // Original fast streaming - no delay
                                
                                    // Update message based on mode
                                    if (isExpanded) {
                                        console.log('üîÑ Updating expanded streaming message');
                                        updateExpandedStreamingMessage(messageId, fullResponse);
                                    } else {
                                        console.log('üîÑ Updating main streaming message');
                                        updateStreamingMessage(messageId, fullResponse);
                                    }
                                } else {
                                    console.log('‚ö†Ô∏è Invalid chunk format:', parsed);
                                }
                            } catch (e) {
                                console.log('‚ùå JSON parsing error:', e.message);
                                // Ignore parsing errors for incomplete chunks
                            }
                        }
                    }
                }
                
                return fullResponse;
                
            } catch (error) {
                console.error('Streaming error:', error);
                throw error;
            }
        }

        // Save conversation to database
        async function saveConversationToDatabase(userMessage, aiResponse) {
            try {
                // Get user ID from localStorage
                const userId = localStorage.getItem('user_id');
                
                // If no user is logged in, don't save
                if (!userId) {
                    console.log('‚ö†Ô∏è No user logged in, skipping save');
                    return;
                }
                
                // Create a title from the user message (first 50 characters)
                const title = userMessage.length > 50 ? userMessage.substring(0, 50) + '...' : userMessage;
                
                // Create the full conversation content with formatted AI response
                const content = `ÿ≥ŸàÿßŸÑ: ${userMessage}\n\nŸæÿßÿ≥ÿÆ: ${formatChatContent(aiResponse)}`;
                
                const response = await fetch('/api/conversations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        title: title,
                        content: content,
                        type: 'chat',
                        subject: null,
                        grade: null,
                        field: null,
                        chapter: null,
                        book: null
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ Conversation saved to database with ID:', data.id);
                } else {
                    console.error('‚ùå Failed to save conversation:', data.error);
                }
                
            } catch (error) {
                console.error('‚ùå Error saving conversation to database:', error);
            }
        }
        
        async function streamAIResponse(message, messageId, isExpanded = false) {
            try {
                console.log('üöÄ Starting API call to /api/chat/stream');
                console.log('üìù Message:', message);
                console.log('üÜî Conversation ID:', currentConversationId);
                
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        conversationId: currentConversationId
                    })
                });
                
                console.log('üì° Response status:', response.status);
                console.log('üì° Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            console.log('üîç Processing data line:', data.substring(0, 100));
                            
                            if (data === '[DONE]') {
                                console.log('‚úÖ Received [DONE] signal');
                                // Add final response to conversation history
                                return fullResponse;
                            }
                            
                                                            try {
                                    const parsed = JSON.parse(data);
                                console.log('üìù Parsed data:', parsed);
                                
                                    if (parsed.content && parsed.type === 'chunk') {
                                    console.log('‚úÖ Valid chunk received, content:', parsed.content);
                                        fullResponse += parsed.content;
                                    
                                    // Original fast streaming - no delay
                                    
                                    // Update message based on mode
                                    if (isExpanded) {
                                        console.log('üîÑ Updating expanded streaming message');
                                        updateExpandedStreamingMessage(messageId, fullResponse);
                                    } else {
                                        console.log('üîÑ Updating main streaming message');
                                        updateStreamingMessage(messageId, fullResponse);
                                    }
                                } else {
                                    console.log('‚ö†Ô∏è Invalid chunk format:', parsed);
                                    }
                                } catch (e) {
                                console.log('‚ùå JSON parsing error:', e.message);
                                // Ignore parsing errors for incomplete chunks
                                }
                        }
                    }
                }
                
                return fullResponse;
                
            } catch (error) {
                console.error('Streaming error:', error);
                throw error;
            }
        }
        
        // Voice recording function
        function startRecording() {
            console.log('üé§ Starting voice recording...');
            alert('Voice recording feature (to be implemented)');
        }
        
        function attachDocument() {
            console.log('üìÑ Attaching document...');
            alert('Document attachment feature (to be implemented)');
        }
        
        // Handle Enter key for both input fields
        function handleKeyDown(event, textarea) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        

        

        


        // Initialize page with comprehensive debugging
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç ===== DOM CONTENT LOADED DEBUG START =====');
            console.log('üîç Page URL:', window.location.href);
            console.log('üîç Page title:', document.title);
            console.log('üîç Viewing thread from localStorage:', localStorage.getItem('viewing_thread'));
            
            // Preload critical pages for faster mobile navigation
            console.log('üîç Step 1: Preloading pages...');
            preloadPages();
            
            // Initialize chat functionality
            console.log('üîç Step 2: Initializing chat...');
            initializeChat();
            
            // Initialize user menu
            console.log('üîç Step 3: Initializing user menu...');
            initializeUserMenu();
            
            console.log('üîç ===== DOM CONTENT LOADED DEBUG END =====');
        });
        

        
        // User Menu Functions
        function initializeUserMenu() {
            const userPhone = localStorage.getItem('user_phone');
            const userPhoneDisplay = document.getElementById('user-phone-display');
            
            if (userPhone && userPhoneDisplay) {
                // Format phone number for display (show first 3 and last 4 digits)
                const formattedPhone = userPhone.replace(/(\d{3})(\d{4})(\d{4})/, '$1***$3');
                userPhoneDisplay.textContent = formattedPhone;
            }
        }
        
        // Login System Functions
        let currentPhoneNumber = '';
        let resendTimer = null;
        let resendCountdown = 60;

        // Phone form submission
        document.addEventListener('DOMContentLoaded', function() {
            const phoneForm = document.getElementById('phoneForm');
            const codeForm = document.getElementById('codeForm');
            const resendBtn = document.getElementById('resendBtn');

            if (phoneForm) {
                phoneForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const phoneNumber = document.getElementById('phoneNumber').value.trim();
                    if (!phoneNumber) {
                        showLoginError('ŸÑÿ∑ŸÅÿßŸã ÿ¥ŸÖÿßÿ±Ÿá ŸÖŸàÿ®ÿß€åŸÑ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ');
                        return;
                    }

                    if (!/^09\d{9}$/.test(phoneNumber)) {
                        showLoginError('ÿ¥ŸÖÿßÿ±Ÿá ŸÖŸàÿ®ÿß€åŸÑ ÿ®ÿß€åÿØ ÿ®ÿß 09 ÿ¥ÿ±Ÿàÿπ ÿ¥ÿØŸá Ÿà 11 ÿ±ŸÇŸÖ ÿ®ÿßÿ¥ÿØ');
                        return;
                    }

                    currentPhoneNumber = phoneNumber;
                    await sendVerificationCode(phoneNumber);
                });
            }

            if (codeForm) {
                codeForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const code = document.getElementById('verificationCode').value.trim();
                    if (!code) {
                        showLoginError('ŸÑÿ∑ŸÅÿßŸã ⁄©ÿØ ÿ™ÿ£€å€åÿØ ÿ±ÿß Ÿàÿßÿ±ÿØ ⁄©ŸÜ€åÿØ');
                        return;
                    }

                    if (!/^\d{6}$/.test(code)) {
                        showLoginError('⁄©ÿØ ÿ™ÿ£€å€åÿØ ÿ®ÿß€åÿØ 6 ÿ±ŸÇŸÖ ÿ®ÿßÿ¥ÿØ');
                        return;
                    }

                    await verifyCode(currentPhoneNumber, code);
                });
            }

            if (resendBtn) {
                resendBtn.addEventListener('click', async () => {
                    if (resendTimer) return;
                    await sendVerificationCode(currentPhoneNumber);
                });
            }

            // Format phone number input
            const phoneInput = document.getElementById('phoneNumber');
            if (phoneInput) {
                phoneInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 11) value = value.substring(0, 11);
                    e.target.value = value;
                });
            }

            // Format verification code input
            const codeInput = document.getElementById('verificationCode');
            if (codeInput) {
                codeInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 6) value = value.substring(0, 6);
                    e.target.value = value;
                });
            }
        });

        // Send verification code
        async function sendVerificationCode(phoneNumber) {
            const sendBtn = document.getElementById('sendCodeBtn');
            const sendText = document.getElementById('sendText');
            const sendLoading = document.getElementById('sendLoading');
            
            setLoginLoading(sendBtn, sendText, sendLoading, true);
            hideLoginMessages();

            try {
                const response = await fetch('/api/send-verification', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phoneNumber })
                });

                const data = await response.json();

                if (data.success) {
                    showLoginStep(2);
                    document.getElementById('displayPhone').textContent = phoneNumber;
                    startResendTimer();
                    showLoginSuccess('⁄©ÿØ ÿ™ÿ£€å€åÿØ ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿßÿ±ÿ≥ÿßŸÑ ÿ¥ÿØ');
                } else {
                    showLoginError(data.error || 'ÿÆÿ∑ÿß ÿØÿ± ÿßÿ±ÿ≥ÿßŸÑ ⁄©ÿØ ÿ™ÿ£€å€åÿØ');
                }
            } catch (error) {
                console.error('Send code error:', error);
                showLoginError('ÿÆÿ∑ÿß ÿØÿ± ÿßÿ±ÿ™ÿ®ÿßÿ∑ ÿ®ÿß ÿ≥ÿ±Ÿàÿ±');
            } finally {
                setLoginLoading(sendBtn, sendText, sendLoading, false);
            }
        }

        // Verify code
        async function verifyCode(phoneNumber, code) {
            const verifyBtn = document.getElementById('verifyBtn');
            const verifyText = document.getElementById('verifyText');
            const verifyLoading = document.getElementById('verifyLoading');
            
            setLoginLoading(verifyBtn, verifyText, verifyLoading, true);
            hideLoginMessages();

            try {
                const response = await fetch('/api/verify-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phoneNumber, code })
                });

                const data = await response.json();

                if (data.success) {
                    // Store token and hide login overlay
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('userPhone', data.phoneNumber);
                    showLoginSuccess('Ÿàÿ±ŸàÿØ ŸÖŸàŸÅŸÇ€åÿ™‚Äåÿ¢ŸÖ€åÿ≤!');
                    
                    // Update user data and hide overlay
                    localStorage.setItem('user_id', '1');
                    localStorage.setItem('is_verified', 'true');
                    localStorage.setItem('user_phone', data.phoneNumber);
                    
                    setTimeout(() => {
                        document.getElementById('login-overlay').classList.add('hidden');
                    }, 1500);
                } else {
                    showLoginError(data.error || '⁄©ÿØ ÿ™ÿ£€å€åÿØ ŸÜÿßŸÖÿπÿ™ÿ®ÿ± ÿßÿ≥ÿ™');
                }
            } catch (error) {
                console.error('Verify code error:', error);
                showLoginError('ÿÆÿ∑ÿß ÿØÿ± ÿßÿ±ÿ™ÿ®ÿßÿ∑ ÿ®ÿß ÿ≥ÿ±Ÿàÿ±');
            } finally {
                setLoginLoading(verifyBtn, verifyText, verifyLoading, false);
            }
        }

        // UI Helper functions
        function showLoginStep(stepNumber) {
            document.querySelectorAll('.login-step').forEach(step => {
                step.classList.add('hidden');
                step.classList.remove('active');
            });
            document.getElementById(`login-step${stepNumber}`).classList.remove('hidden');
            document.getElementById(`login-step${stepNumber}`).classList.add('active');
        }

        function setLoginLoading(button, textElement, loadingElement, isLoading) {
            if (isLoading) {
                button.disabled = true;
                textElement.style.display = 'none';
                loadingElement.classList.remove('hidden');
            } else {
                button.disabled = false;
                textElement.style.display = 'inline';
                loadingElement.classList.add('hidden');
            }
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('login-error');
            const errorText = document.getElementById('login-error-text');
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('login-success').classList.add('hidden');
        }

        function showLoginSuccess(message) {
            const successDiv = document.getElementById('login-success');
            const successText = document.getElementById('login-success-text');
            successText.textContent = message;
            successDiv.classList.remove('hidden');
            document.getElementById('login-error').classList.add('hidden');
        }

        function hideLoginMessages() {
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('login-success').classList.add('hidden');
        }

        function startResendTimer() {
            const resendBtn = document.getElementById('resendBtn');
            resendCountdown = 60;
            resendBtn.disabled = true;
            resendBtn.textContent = `ÿßÿ±ÿ≥ÿßŸÑ ŸÖÿ¨ÿØÿØ (${resendCountdown})`;
            
            resendTimer = setInterval(() => {
                resendCountdown--;
                if (resendCountdown <= 0) {
                    clearInterval(resendTimer);
                    resendBtn.disabled = false;
                    resendBtn.textContent = 'ÿßÿ±ÿ≥ÿßŸÑ ŸÖÿ¨ÿØÿØ ⁄©ÿØ';
                    resendTimer = null;
                } else {
                    resendBtn.textContent = `ÿßÿ±ÿ≥ÿßŸÑ ŸÖÿ¨ÿØÿØ (${resendCountdown})`;
                }
            }, 1000);
        }

        // Logout function
        function logout() {
            // Logout disabled for mobile testing
            console.log('üîç Logout disabled for mobile testing');
            closeUserMenu();
        }
        
        function toggleUserMenu() {
            const overlay = document.getElementById('user-menu-overlay');
            const panel = document.getElementById('user-menu-panel');
            
            if (overlay.classList.contains('hidden')) {
                // Open menu
                overlay.classList.remove('hidden');
                panel.classList.remove('-translate-x-full');
            } else {
                // Close menu
                closeUserMenu();
            }
        }
        
        function closeUserMenu() {
            const overlay = document.getElementById('user-menu-overlay');
            const panel = document.getElementById('user-menu-panel');
            
            overlay.classList.add('hidden');
            panel.classList.add('-translate-x-full');
        }
        
        function logout() {
            localStorage.removeItem('user_id');
            localStorage.removeItem('user_phone');
            localStorage.removeItem('is_verified');
            localStorage.removeItem('is_logged_in');
            
            // Close menu
            closeUserMenu();
            
            // Redirect to auth page
            window.location.href = 'auth.html';
        }
        
        // Preload pages for faster mobile navigation
        function preloadPages() {
            const pages = ['test.html', 'question-analysis.html', 'chapters.html', 'analysis-results.html'];
            pages.forEach(page => {
                const link = document.createElement('link');
                link.rel = 'prefetch';
                link.href = page;
                document.head.appendChild(link);
            });
        }
        
        // Thread Management Variables
        let currentThreadId = null;
        let threadMessages = [];
        let isThreadLoaded = false;
        
        // Thread Management Functions

        // Initialize chat functionality with comprehensive debugging
        function initializeChat() {
            console.log('üîç ===== INITIALIZE CHAT DEBUG START =====');
            console.log('üîç Current URL:', window.location.href);
            console.log('üîç Current thread ID:', currentThreadId);
            console.log('üîç Is thread loaded:', isThreadLoaded);
            
            checkUserStatus();
            
            // Check if we're loading from library (viewing a thread)
            const viewingThread = localStorage.getItem('viewing_thread');
            console.log('üîç Viewing thread from localStorage:', viewingThread);
            
            if (viewingThread) {
                console.log('üîç Loading thread from library:', viewingThread);
                loadThreadFromLibrary(viewingThread);
            } else {
                console.log('üîç Normal initialization - starting new session');
                initializeConversation();
            }
            
            console.log('üîç ===== INITIALIZE CHAT DEBUG END =====');
        }

        // Load thread from library with comprehensive debugging and robust state reset
        async function loadThreadFromLibrary(threadId) {
            console.log('üîç ===== THREAD LOADING DEBUG START =====');
            console.log('üîç Thread ID:', threadId);
            
            try {
                let userId = localStorage.getItem('user_id');
                console.log('üîç User ID:', userId);
                
                // For MVP, use default user ID if not found
                if (!userId) {
                    userId = '1';
                    localStorage.setItem('user_id', userId);
                    console.log('üîß Using default user ID for MVP in loadThreadFromLibrary:', userId);
                }

                console.log('üîç Step 1: Getting thread data...');
                // Get thread data
                const threadResponse = await fetch(`/api/threads/${threadId}?user_id=${userId}`);
                const threadData = await threadResponse.json();
                
                console.log('üîç Thread response:', threadData);
                
                if (!threadData.success) {
                    console.error('üîç ERROR: Failed to load thread:', threadData.error);
                    return;
                }

                console.log('üîç Step 2: Getting thread messages...');
                // Get thread messages
                const messagesResponse = await fetch(`/api/threads/${threadId}/messages?limit=100`);
                const messagesData = await messagesResponse.json();
                
                console.log('üîç Messages response:', messagesData);
                
                if (!messagesData.success) {
                    console.error('üîç ERROR: Failed to load messages:', messagesData.error);
                    return;
                }

                console.log('üîç Step 3: Setting up thread data...');
                // Set up thread data
                currentThreadId = threadId;
                threadMessages = messagesData.messages;
                isThreadLoaded = true;
                
                console.log('üîç Thread loaded:', threadData.thread.title);
                console.log('üîç Messages loaded:', threadMessages.length);
                console.log('üîç Current thread ID set to:', currentThreadId);

                console.log('üîç Step 4: COMPLETE PAGE STATE RESET...');
                // Complete page state reset - more aggressive approach
                await completePageStateReset();
                
                console.log('üîç Step 5: Ensuring second page is visible...');
                // Ensure second page is visible before loading thread context
                const secondPage = document.getElementById('second-gainsboro-page');
                if (secondPage) {
                    secondPage.style.display = 'block';
                    secondPage.style.visibility = 'visible';
                    secondPage.style.opacity = '1';
                    secondPage.classList.remove('hidden');
                    console.log('üîç Second page made visible');
                }
                
                console.log('üîç Step 6: Loading thread context into UI...');
                // Load thread context into UI
                loadThreadContext(threadData.thread, threadMessages);
                
                console.log('üîç Step 7: Clearing stored thread ID...');
                // Clear the stored thread ID
                localStorage.removeItem('viewing_thread');
                
                console.log('üîç ===== THREAD LOADING DEBUG END =====');
                
            } catch (error) {
                console.error('üîç ERROR in loadThreadFromLibrary:', error);
                console.log('üîç ===== THREAD LOADING DEBUG END (ERROR) =====');
            }
        }
        
        // Complete page state reset - ULTRA AGGRESSIVE approach
        async function completePageStateReset() {
            console.log('üîç ===== ULTRA AGGRESSIVE PAGE STATE RESET START =====');
            
            // Hide ALL possible UI elements that could cause conflicts - EXPANDED LIST
            const elementsToHide = [
                'main-user-input',
                'chat-messages', 
                'second-gainsboro-page',
                'expanded-input-container',
                'initial-chat-container',
                'welcome-container',
                'chat-start-container',
                'welcome-message',
                'initial-state',
                'chat-container',
                'user-input-container',
                'input-bar',
                'main-container',
                'app-container',
                'page-container'
            ];
            
            elementsToHide.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    console.log(`üîç ULTRA HIDING element: ${elementId}`);
                    // Don't hide essential elements for thread display
                    if (elementId !== 'second-gainsboro-page' && elementId !== 'chat-messages' && elementId !== 'main-user-input') {
                        // Ultra aggressive hiding
                        element.style.display = 'none !important';
                        element.style.visibility = 'hidden !important';
                        element.style.opacity = '0 !important';
                        element.style.zIndex = '-999 !important';
                        element.style.position = 'absolute';
                        element.style.left = '-9999px';
                        element.style.top = '-9999px';
                        element.classList.add('hidden');
                        element.classList.add('ultra-hidden');
                } else {
                        console.log(`üîç SKIPPING essential element: ${elementId}`);
                    }
                }
            });
            
            // Hide any elements with specific classes - EXPANDED LIST
            const classSelectors = [
                '.border-b.border-gray-200',
                '.input-bar',
                '.chat-container',
                '.user-input-container',
                '.welcome-message',
                '.initial-state',
                '.welcome-container',
                '.chat-start-container',
                '.main-container',
                '.app-container',
                '.page-container',
                '.fixed',
                '.absolute',
                '.relative'
            ];
            
            classSelectors.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(element => {
                    console.log(`üîç ULTRA HIDING element with class: ${selector}`);
                    // Ultra aggressive hiding
                    element.style.display = 'none !important';
                    element.style.visibility = 'hidden !important';
                    element.style.opacity = '0 !important';
                    element.style.zIndex = '-999 !important';
                    element.classList.add('hidden');
                    element.classList.add('ultra-hidden');
                });
            });
            
            // Hide ALL divs that might be causing issues - BUT NOT THE SECOND PAGE
            const allDivs = document.querySelectorAll('div');
            allDivs.forEach((div, index) => {
                // Only hide divs that are likely to be UI elements
                if (div.id || div.className.includes('container') || div.className.includes('page') || div.className.includes('main')) {
                    console.log(`üîç Checking div ${index}:`, div.id, div.className);
                    // Don't hide the second page - we need it for thread display
                    if (div.id !== 'second-gainsboro-page' && div.id !== 'chat-messages' && div.id !== 'main-user-input') {
                        div.style.display = 'none';
                        div.style.visibility = 'hidden';
                        div.style.opacity = '0';
                    }
                }
            });
            
            // Clear any existing messages
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                console.log('üîç Clearing chat messages container');
                chatMessages.innerHTML = '';
            }
            
            // Reset body styles
            document.body.style.overflow = 'auto';
            document.body.style.backgroundColor = '#F8F9FA';
            document.body.style.position = 'relative';
            
            // Maximum speed page transition - minimal delay
            await new Promise(resolve => setTimeout(resolve, 10));
            
            console.log('üîç ===== ULTRA AGGRESSIVE PAGE STATE RESET END =====');
        }

        // Load thread context into UI with comprehensive debugging - simplified approach
        function loadThreadContext(thread, messages) {
            console.log('üîç ===== LOAD THREAD CONTEXT DEBUG START =====');
            console.log('üîç Thread title:', thread.title);
            console.log('üîç Messages count:', messages.length);
            
            // Direct approach - no delays, just show the thread content
            console.log('üîç Step 1: Showing second page directly...');
            
            // Show the second gainsboro page
            const secondPage = document.getElementById('second-gainsboro-page');
            console.log('üîç Second page element:', secondPage);
            if (secondPage) {
                console.log('üîç Second page current classes:', secondPage.classList.toString());
                console.log('üîç Second page current display:', secondPage.style.display);
                
                // Show the second page - RESET ALL POSITION STYLES
                secondPage.classList.remove('hidden');
                secondPage.classList.remove('ultra-hidden');
                secondPage.style.display = 'block';
                secondPage.style.visibility = 'visible';
                secondPage.style.opacity = '1';
                secondPage.style.zIndex = '90';
                // Reset position styles that were set by ultra-aggressive hiding
                secondPage.style.position = 'fixed';
                secondPage.style.left = '0';
                secondPage.style.top = '0';
                secondPage.style.right = '0';
                secondPage.style.bottom = '0';
                console.log('üîç Second page shown directly with position reset');
                
                // Force show the second page with maximum visibility
                console.log('üîç FORCE SHOWING second page with maximum visibility...');
                
                // Remove all conflicting classes and styles
                secondPage.className = 'fixed inset-0 bg-[#F8F9FA] z-90';
                secondPage.removeAttribute('style');
                
                // Apply maximum visibility styles
                secondPage.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    right: 0 !important;
                    bottom: 0 !important;
                    width: 100vw !important;
                    height: 100vh !important;
                    background-color: #F8F9FA !important;
                    z-index: 90 !important;
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    margin: 0 !important;
                    padding: 0 !important;
                    border: none !important;
                    overflow: visible !important;
                `;
                
                console.log('üîç Second page FORCE SHOWN with maximum visibility');
                console.log('üîç Second page final styles:', secondPage.style.cssText);
                
                // Setup the thread UI immediately with original chat system
                setupThreadUI(messages);
                    } else {
                console.error('üîç ERROR: Second page element not found!');
            }
            
            console.log('üîç ===== LOAD THREAD CONTEXT DEBUG END =====');
        }
        
        // Create a completely new, simple thread display
        function createSimpleThreadDisplay(thread, messages) {
            console.log('üîç ===== CREATE SIMPLE THREAD DISPLAY START =====');
            console.log('üîç Creating simple thread display for:', thread.title);
            
            // Clear the second page completely
            const secondPage = document.getElementById('second-gainsboro-page');
            if (secondPage) {
                secondPage.innerHTML = '';
                console.log('üîç Second page cleared');
            }
            
            // Create a simple container
            const container = document.createElement('div');
            container.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background-color: #F8F9FA !important;
                z-index: 100 !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                padding: 20px !important;
                overflow-y: auto !important;
                font-family: Arial, sans-serif !important;
            `;
            
            // Add thread title
            const title = document.createElement('h1');
            title.textContent = thread.title;
            title.style.cssText = `
                color: #333 !important;
                font-size: 24px !important;
                margin-bottom: 20px !important;
                text-align: center !important;
                background: white !important;
                padding: 15px !important;
                border-radius: 10px !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
            `;
            container.appendChild(title);
            
            // Add messages
            messages.forEach((message, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.style.cssText = `
                    margin: 15px 0 !important;
                    padding: 15px !important;
                    border-radius: 10px !important;
                    max-width: 80% !important;
                    word-wrap: break-word !important;
                    ${message.sender_role === 'user' 
                        ? 'background-color: #e3f2fd !important; margin-left: 0 !important; margin-right: auto !important;' 
                        : 'background-color: transparent !important; margin-left: auto !important; margin-right: 0 !important;'
                    }
                `;
                
                const content = document.createElement('div');
                content.innerHTML = message.content;
                content.style.cssText = `
                    color: #333 !important;
                    font-size: 1rem !important; /* 16px */
                    line-height: 1.5 !important;
                `;
                
                messageDiv.appendChild(content);
                container.appendChild(messageDiv);
            });
            
            // Add input area
            const inputArea = document.createElement('div');
            inputArea.style.cssText = `
                position: fixed !important;
                bottom: 20px !important;
                left: 20px !important;
                right: 20px !important;
                background: white !important;
                padding: 15px !important;
                border-radius: 25px !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
                z-index: 101 !important;
            `;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Type your message...';
            input.style.cssText = `
                width: 100% !important;
                border: none !important;
                outline: none !important;
                font-size: 1rem !important; /* 16px */
                padding: 10px !important;
            `;
            
            inputArea.appendChild(input);
            container.appendChild(inputArea);
            
            // Add to second page
            if (secondPage) {
                secondPage.appendChild(container);
                console.log('üîç Simple thread display created and added to second page');
            }
            
            console.log('üîç ===== CREATE SIMPLE THREAD DISPLAY END =====');
        }
        
        // Visual debugging function to identify visible elements
        function debugVisibleElements() {
            console.log('üîç ===== VISUAL DEBUGGING START =====');
            
            // Check all visible elements
            const allElements = document.querySelectorAll('*');
            const visibleElements = [];
            
            allElements.forEach(element => {
                const computedStyle = window.getComputedStyle(element);
                const isVisible = computedStyle.display !== 'none' && 
                                computedStyle.visibility !== 'hidden' && 
                                computedStyle.opacity !== '0' &&
                                computedStyle.position !== 'absolute' &&
                                element.offsetWidth > 0 && 
                                element.offsetHeight > 0;
                
                if (isVisible && (element.id || element.className)) {
                    visibleElements.push({
                        element: element,
                        id: element.id,
                        className: element.className,
                        tagName: element.tagName,
                        display: computedStyle.display,
                        visibility: computedStyle.visibility,
                        opacity: computedStyle.opacity,
                        position: computedStyle.position,
                        zIndex: computedStyle.zIndex
                    });
                }
            });
            
            console.log('üîç VISIBLE ELEMENTS:', visibleElements.length);
            visibleElements.forEach((item, index) => {
                console.log(`üîç Visible element ${index + 1}:`, {
                    tag: item.tagName,
                    id: item.id,
                    class: item.className,
                    display: item.display,
                    visibility: item.visibility,
                    opacity: item.opacity,
                    position: item.position,
                    zIndex: item.zIndex
                });
            });
            
            console.log('üîç ===== VISUAL DEBUGGING END =====');
            return visibleElements;
        }
        
        // Setup thread UI with SIMPLE UI approach that actually works
        function setupThreadUI(messages) {
            console.log('üîç ===== SETUP THREAD UI WITH SIMPLE APPROACH START =====');
            
            const secondPage = document.getElementById('second-gainsboro-page');
            if (!secondPage) {
                console.log('‚ùå Second page not found');
                return;
            }
            
            // CLEAR everything and start fresh (like simple UI)
            console.log('üîç Clearing second page completely...');
            secondPage.innerHTML = '';
            
            // Create main container with AGGRESSIVE inline styles (like simple UI)
            const container = document.createElement('div');
            container.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background-color: #f5f5f5 !important;
                z-index: 90 !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                overflow: visible !important;
            `;
            
            // Create chat area with AGGRESSIVE inline styles and proper scrolling
            const chatArea = document.createElement('div');
            chatArea.style.cssText = `
                position: absolute !important;
                top: 60px !important;
                left: 4px !important;
                right: 4px !important;
                bottom: 40px !important;
                overflow-y: scroll !important;
                overflow-x: hidden !important;
                padding: 8px 4px 100px 4px !important;
                background-color: transparent !important;
                z-index: 50 !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                scroll-behavior: smooth !important;
                -webkit-overflow-scrolling: touch !important;
            `;
            
            // Add messages directly to chat area
            if (messages && messages.length > 0) {
                console.log(`üîç Loading ${messages.length} messages with SIMPLE approach...`);
                
                messages.forEach((message, index) => {
                    console.log(`üîç Loading message ${index + 1}:`, message.sender_role);
                    
                    const messageDiv = document.createElement('div');
                    messageDiv.style.cssText = `
                        display: flex !important;
                        width: 100% !important;
                        margin-bottom: 16px !important;
                        justify-content: ${message.sender_role === 'user' ? 'flex-start' : 'flex-end'} !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                    `;
                    
                    const messageBubble = document.createElement('div');
                    messageBubble.style.cssText = `
                        padding: 16px 20px !important;
                        border-radius: 16px !important;
                        max-width: 95% !important;
                        background-color: ${message.sender_role === 'user' ? '#e8e8e4' : 'transparent'} !important;
                        color: black !important;
                        text-align: ${message.sender_role === 'user' ? 'left' : 'right'} !important;
                        line-height: 1.6 !important;
                        font-size: 1rem !important; /* 16px */
                        display: block !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        width: ${message.sender_role === 'user' ? 'auto' : '100%'} !important;
                    `;
                    
                    if (message.sender_role === 'user') {
                        messageBubble.textContent = message.content;
                    } else {
                        // Use the formatting system for AI messages
                        const formattedContent = formatChatContent(message.content);
                        messageBubble.innerHTML = formattedContent;
                    }
                    
                    messageDiv.appendChild(messageBubble);
                    chatArea.appendChild(messageDiv);
                });
                
                console.log(`üîç Successfully loaded ${messages.length} messages with SIMPLE approach`);
                
                // Auto-scroll to bottom after loading messages
                setTimeout(() => {
                    chatArea.scrollTop = chatArea.scrollHeight;
                    console.log('üîç Auto-scrolled to bottom after loading messages');
                }, 100);
            }
            
            // Create user input area (like real chat) - starts visible with proper positioning
            const userInputArea = document.createElement('div');
            userInputArea.id = 'thread-user-input';
            userInputArea.style.cssText = `
                position: fixed !important;
                bottom: 2px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                width: 90% !important;
                max-width: 500px !important;
                height: 65px !important;
                background-color: #E8E8E4 !important;
                border-radius: 30px !important;
                border: 1px solid #6b7280 !important;
                display: flex !important;
                align-items: center !important;
                padding: 0 20px !important;
                z-index: 2000 !important;
                visibility: visible !important;
                opacity: 1 !important;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
                margin-bottom: 20px !important;
            `;
            
            const userInput = document.createElement('input');
            userInput.type = 'text';
            userInput.placeholder = 'Type your message...';
            userInput.style.cssText = `
                flex: 1 !important;
                border: none !important;
                outline: none !important;
                background: transparent !important;
                font-size: 1rem !important; /* 16px */
                color: black !important;
                padding: 0 !important;
                margin: 0 !important;
            `;
            
            // Create microphone/recorder icon
            const microphoneIcon = document.createElement('button');
            microphoneIcon.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <line x1="12" y1="19" x2="12" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <line x1="8" y1="23" x2="16" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            `;
            microphoneIcon.style.cssText = `
                width: 32px !important;
                height: 32px !important;
                border-radius: 50% !important;
                background-color: transparent !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                color: #666 !important;
                transition: all 0.2s !important;
                margin-right: 8px !important;
            `;
            
            // Add hover effect for microphone
            microphoneIcon.addEventListener('mouseenter', () => {
                microphoneIcon.style.backgroundColor = '#f0f0f0';
                microphoneIcon.style.color = '#333';
            });
            microphoneIcon.addEventListener('mouseleave', () => {
                microphoneIcon.style.backgroundColor = 'transparent';
                microphoneIcon.style.color = '#666';
            });
            
            // Add click event for microphone (placeholder)
            microphoneIcon.addEventListener('click', () => {
                console.log('üîç Microphone clicked, starting recording...');
                alert('Voice recording (to be implemented)');
            });
            
            // Create paperclip/attachment icon
            const paperclipIcon = document.createElement('button');
            paperclipIcon.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            `;
            paperclipIcon.style.cssText = `
                position: absolute !important;
                right: 8px !important;
                top: 50% !important;
                transform: translateY(-50%) !important;
                width: 32px !important;
                height: 32px !important;
                border-radius: 50% !important;
                background-color: transparent !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                color: #666 !important;
                transition: all 0.2s !important;
                z-index: 10 !important;
            `;
            
            // Add hover effect for paperclip
            paperclipIcon.addEventListener('mouseenter', () => {
                paperclipIcon.style.backgroundColor = '#f0f0f0';
                paperclipIcon.style.color = '#333';
            });
            paperclipIcon.addEventListener('mouseleave', () => {
                paperclipIcon.style.backgroundColor = 'transparent';
                paperclipIcon.style.color = '#666';
            });
            
            // Add click event for paperclip (placeholder)
            paperclipIcon.addEventListener('click', () => {
                console.log('üìé Paperclip clicked, attaching document...');
                alert('Document attachment (to be implemented)');
            });
            
            userInputArea.appendChild(userInput);
            userInputArea.appendChild(microphoneIcon);
            userInputArea.appendChild(paperclipIcon);
            
            // Create expanded input area (like real chat) - starts hidden with proper positioning
            const expandedInputArea = document.createElement('div');
            expandedInputArea.id = 'thread-expanded-input';
            expandedInputArea.style.cssText = `
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                height: 100px !important;
                background-color: #e8e8e4 !important;
                border-radius: 24px 24px 0 0 !important;
                border-top: 1px solid #d1d5db !important;
                display: none !important;
                z-index: 2001 !important;
                padding: 24px !important;
            `;
            
            const expandedInput = document.createElement('textarea');
            expandedInput.placeholder = 'Learn anything...';
            expandedInput.style.cssText = `
                width: 100% !important;
                min-height: 80px !important;
                border: none !important;
                outline: none !important;
                background: transparent !important;
                font-size: 24px !important;
                color: black !important;
                padding: 0 !important;
                margin: 0 !important;
                resize: none !important;
                font-family: sans-serif !important;
                line-height: 1.5 !important;
                cursor: text !important;
                text-align: right !important;
                position: absolute !important;
                top: 8px !important;
                right: 0 !important;
                padding-right: 80px !important;
            `;
            
            // Create send button for expanded input
            const expandedSendButton = document.createElement('button');
            expandedSendButton.innerHTML = `
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V5M5 12l7-7 7 7"/>
                </svg>
            `;
            expandedSendButton.style.cssText = `
                position: absolute !important;
                bottom: 12px !important;
                left: 16px !important;
                width: 40px !important;
                height: 40px !important;
                border-radius: 50% !important;
                background-color: black !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                transition: background-color 0.2s !important;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
            `;
            
            // Add focus event to show expanded input (like real chat)
            userInput.addEventListener('focus', () => {
                console.log('üîç User input focused, showing expanded input...');
                userInputArea.style.display = 'none';
                expandedInputArea.style.display = 'block';
                expandedInput.focus();
            });
            
            // Add blur event to hide expanded input if empty
            expandedInput.addEventListener('blur', () => {
                setTimeout(() => {
                    if (!expandedInput.value.trim()) {
                        console.log('üîç Expanded input blurred and empty, hiding...');
                        expandedInputArea.style.display = 'none';
                        userInputArea.style.display = 'flex';
                    }
                }, 100);
            });
            
            // Add input change event for button state
            expandedInput.addEventListener('input', () => {
                if (expandedInput.value.trim()) {
                    expandedSendButton.style.backgroundColor = 'black';
                    expandedSendButton.style.opacity = '1';
            } else {
                    expandedSendButton.style.backgroundColor = '#CCCCCC';
                    expandedSendButton.style.opacity = '0.6';
                }
            });
            
            // Add click event to expanded send button
            expandedSendButton.addEventListener('click', () => {
                const message = expandedInput.value.trim();
                if (message) {
                    console.log('üîç Expanded send button clicked, message:', message);
                    sendMessageFromThreadUI(message, chatArea, expandedInput, userInputArea, expandedInputArea);
                }
            });
            
            // Add Enter key event to expanded input
            expandedInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const message = expandedInput.value.trim();
                    if (message) {
                        console.log('üîç Enter key pressed in expanded input, message:', message);
                        sendMessageFromThreadUI(message, chatArea, expandedInput, userInputArea, expandedInputArea);
                    }
                }
            });
            
            // Assemble the input areas
            userInputArea.appendChild(userInput);
            expandedInputArea.appendChild(expandedInput);
            expandedInputArea.appendChild(expandedSendButton);
            
            // Create recorder button for thread expanded input
            const threadExpandedRecorderButton = document.createElement('button');
            threadExpandedRecorderButton.innerHTML = `
                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <line x1="12" y1="19" x2="12" y2="23" stroke-width="2" stroke-linecap="round"/>
                    <line x1="8" y1="23" x2="16" y2="23" stroke-width="2" stroke-linecap="round"/>
                </svg>
            `;
            threadExpandedRecorderButton.style.cssText = `
                position: absolute !important;
                bottom: 12px !important;
                right: 48px !important;
                width: 32px !important;
                height: 32px !important;
                border-radius: 50% !important;
                background-color: transparent !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                color: #666 !important;
                transition: all 0.2s !important;
            `;
            
            // Create document button for thread expanded input
            const threadExpandedDocumentButton = document.createElement('button');
            threadExpandedDocumentButton.innerHTML = `
                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66L9.64 16.2a2 2 0 0 1-2.83-2.83l8.49-8.49" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            `;
            threadExpandedDocumentButton.style.cssText = `
                position: absolute !important;
                bottom: 12px !important;
                right: 16px !important;
                width: 32px !important;
                height: 32px !important;
                border-radius: 50% !important;
                background-color: transparent !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                color: #666 !important;
                transition: all 0.2s !important;
            `;
            
            // Add click events
            threadExpandedRecorderButton.addEventListener('click', () => {
                console.log('üé§ Thread expanded recorder clicked');
                alert('Voice recording (to be implemented)');
            });
            
            threadExpandedDocumentButton.addEventListener('click', () => {
                console.log('üìé Thread expanded document clicked');
                alert('Document attachment (to be implemented)');
            });
            
            expandedInputArea.appendChild(threadExpandedRecorderButton);
            expandedInputArea.appendChild(threadExpandedDocumentButton);
            
            // Initial button state
            expandedSendButton.style.backgroundColor = '#CCCCCC';
            expandedSendButton.style.opacity = '0.6';
            
            // Create top navigation bar (like real chat)
            const topNavBar = document.createElement('div');
            topNavBar.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                height: 60px !important;
                background-color: #f5f5f5 !important;
                border-bottom: 1px solid #e0e0e0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: space-between !important;
                padding: 0 20px !important;
                z-index: 2002 !important;
            `;
            
            // Create left top element (user account icon - two thin lines, one shorter)
            const leftTopButton = document.createElement('button');
            leftTopButton.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 6h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M4 12h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            `;
            leftTopButton.style.cssText = `
                width: 40px !important;
                height: 40px !important;
                border-radius: 50% !important;
                background-color: transparent !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                color: #333 !important;
                transition: background-color 0.2s !important;
            `;
            
            // Add hover effect for user account button
            leftTopButton.addEventListener('mouseenter', () => {
                leftTopButton.style.backgroundColor = '#f0f0f0';
            });
            leftTopButton.addEventListener('mouseleave', () => {
                leftTopButton.style.backgroundColor = 'transparent';
            });
            
            // Add click event for user account button (go back to library)
            leftTopButton.addEventListener('click', () => {
                console.log('üîç User account button clicked, returning to library...');
                window.location.href = '/library.html';
            });
            
            // Create left side container for menu button
            const leftButtonsContainer = document.createElement('div');
            leftButtonsContainer.style.cssText = `
                display: flex !important;
                align-items: center !important;
                gap: 8px !important;
            `;
            
            // Create menu button (three vertical dots) - moved to left
            const menuButton = document.createElement('button');
            menuButton.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="2" fill="currentColor"/>
                    <circle cx="12" cy="5" r="2" fill="currentColor"/>
                    <circle cx="12" cy="19" r="2" fill="currentColor"/>
                </svg>
            `;
            menuButton.style.cssText = `
                width: 40px !important;
                height: 40px !important;
                border-radius: 50% !important;
                background-color: transparent !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                color: #333 !important;
                transition: background-color 0.2s !important;
            `;
            
            // Add hover effect for menu button
            menuButton.addEventListener('mouseenter', () => {
                menuButton.style.backgroundColor = '#f0f0f0';
            });
            menuButton.addEventListener('mouseleave', () => {
                menuButton.style.backgroundColor = 'transparent';
            });
            
            // Add click event for menu button (delete/options)
            menuButton.addEventListener('click', () => {
                console.log('üîç Menu button clicked, showing options...');
                showThreadMenu();
            });
            
            // Create right side container for back button (cross icon)
            const rightButtonsContainer = document.createElement('div');
            rightButtonsContainer.style.cssText = `
                display: flex !important;
                align-items: center !important;
                gap: 8px !important;
                margin-left: auto !important;
            `;
            
            // Create back button (cross icon) for returning to library
            const backButton = document.createElement('button');
            backButton.innerHTML = `
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" stroke="currentColor" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            `;
            backButton.style.cssText = `
                width: 40px !important;
                height: 40px !important;
                border-radius: 50% !important;
                background-color: transparent !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                color: #333 !important;
                transition: background-color 0.2s !important;
            `;
            
            // Add hover effect for back button
            backButton.addEventListener('mouseenter', () => {
                backButton.style.backgroundColor = '#f0f0f0';
            });
            
            backButton.addEventListener('mouseleave', () => {
                backButton.style.backgroundColor = 'transparent';
            });
            
            // Add click event for back button (return to library)
            backButton.addEventListener('click', () => {
                console.log('üîç Back button clicked, returning to library...');
                // Navigate to library page
                window.location.href = '/library.html';
            });
            
            // Add back button to right container
            rightButtonsContainer.appendChild(backButton);
            
            // Create share button (will go in left container next to menu)
            const shareButton = document.createElement('button');
            shareButton.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: #333 !important;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" stroke="currentColor" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                </svg>
            `;
            shareButton.style.cssText = `
                width: 40px !important;
                height: 40px !important;
                border-radius: 50% !important;
                background-color: transparent !important;
                border: none !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                color: #333 !important;
                transition: background-color 0.2s !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            
            // Force SVG color
            shareButton.querySelector('svg').style.color = '#333';
            shareButton.querySelector('path').style.stroke = '#333';
            
            // Add hover effect for share button
            shareButton.addEventListener('mouseenter', () => {
                shareButton.style.backgroundColor = '#f0f0f0';
            });
            shareButton.addEventListener('mouseleave', () => {
                shareButton.style.backgroundColor = 'transparent';
            });
            
            // Add click event for share button
            shareButton.addEventListener('click', () => {
                console.log('üîç Share button clicked, sharing thread...');
                alert('Share thread (to be implemented)');
            });
            
            // Assemble the left buttons container (both menu and share buttons)
            leftButtonsContainer.appendChild(menuButton);
            leftButtonsContainer.appendChild(shareButton);
            
            // Assemble the top navigation (left container with menu+share, right container with back)
            topNavBar.appendChild(leftButtonsContainer);
            topNavBar.appendChild(rightButtonsContainer);
            
            // Debug: Check if buttons are properly added
            console.log('üîç Left buttons container added:', leftButtonsContainer);
            console.log('üîç Right buttons container added:', rightButtonsContainer);
            console.log('üîç Share button added:', shareButton);
            console.log('üîç Menu button added:', menuButton);
            console.log('üîç Back button added:', backButton);
            console.log('üîç Top nav bar children:', topNavBar.children.length);
            console.log('üîç Share button innerHTML:', shareButton.innerHTML);
            console.log('üîç Share button computed display:', window.getComputedStyle(shareButton).display);
            console.log('üîç Share button computed visibility:', window.getComputedStyle(shareButton).visibility);
            
            // Debug: Check button visibility
            console.log('üîç Share button computed styles:', window.getComputedStyle(shareButton));
            console.log('üîç Menu button computed styles:', window.getComputedStyle(menuButton));
            console.log('üîç Share button display:', window.getComputedStyle(shareButton).display);
            console.log('üîç Menu button display:', window.getComputedStyle(menuButton).display);
            
            // Assemble the container
            container.appendChild(topNavBar);
            container.appendChild(chatArea);
            container.appendChild(userInputArea);
            container.appendChild(expandedInputArea);
            secondPage.appendChild(container);
            
            // Scroll to bottom
            setTimeout(() => {
                chatArea.scrollTop = chatArea.scrollHeight;
                console.log('üîç Scrolled to bottom with SIMPLE approach');
            }, 100);
            
            console.log('üîç ===== SETUP THREAD UI WITH SIMPLE APPROACH END =====');
        }
        
        // Send message from thread UI with proper input flow
        async function sendMessageFromThreadUI(message, chatArea, inputElement, userInputArea, expandedInputArea) {
            console.log('üîç ===== SEND MESSAGE FROM THREAD UI START =====');
            console.log('üîç Message:', message);
            console.log('üîç Current thread ID:', currentThreadId);
            
            if (!message.trim()) {
                console.log('‚ùå Empty message, ignoring');
                return;
            }
            
            // Ensure we have a thread ID before proceeding
            if (!currentThreadId) {
                console.log('üîç No thread ID, creating new thread...');
                const title = message.length > 50 ? message.substring(0, 50) + '...' : message;
                currentThreadId = await createNewThread(title);
                if (!currentThreadId) {
                    console.error('‚ùå Failed to create thread');
                    return;
                }
            }
            
            // Clear input and hide expanded input (like real chat)
            inputElement.value = '';
            if (expandedInputArea) {
                expandedInputArea.style.display = 'none';
            }
            // Don't show user input immediately - wait for response completion
            // User input will be shown when streaming completes for better UX
            console.log('üîç Input cleared and expanded input hidden');
            
            // Add user message to chat area immediately
            const userMessageDiv = document.createElement('div');
            userMessageDiv.style.cssText = `
                display: flex !important;
                width: 100% !important;
                margin-bottom: 16px !important;
                justify-content: flex-start !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            
            const userMessageBubble = document.createElement('div');
            userMessageBubble.style.cssText = `
                padding: 16px 20px !important;
                border-radius: 16px !important;
                max-width: 95% !important;
                background-color: #e8e8e4 !important;
                color: black !important;
                text-align: left !important;
                line-height: 1.6 !important;
                font-size: 1rem !important; /* 16px */
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                width: auto !important;
            `;
            userMessageBubble.textContent = message;
            
            userMessageDiv.appendChild(userMessageBubble);
            chatArea.appendChild(userMessageDiv);
            
            // Add AI response placeholder
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.style.cssText = `
                display: flex !important;
                width: 100% !important;
                margin-bottom: 16px !important;
                justify-content: flex-end !important;
                visibility: visible !important;
                opacity: 1 !important;
            `;
            
            const aiMessageBubble = document.createElement('div');
            aiMessageBubble.style.cssText = `
                padding: 16px 20px !important;
                border-radius: 16px !important;
                max-width: 95% !important;
                background-color: transparent !important;
                color: black !important;
                text-align: right !important;
                line-height: 1.6 !important;
                font-size: 1rem !important; /* 16px */
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
                width: 100% !important;
            `;
            aiMessageBubble.innerHTML = '<span class="typing-indicator">...</span>';
            
            aiMessageDiv.appendChild(aiMessageBubble);
            chatArea.appendChild(aiMessageDiv);
            
            // Scroll to bottom
            chatArea.scrollTop = chatArea.scrollHeight;
            
            try {
                // Step 1: Load thread message history for context
                console.log('üîç Loading thread context for conversation management...');
                const contextResponse = await fetch(`/api/threads/${currentThreadId}/messages`);
                if (!contextResponse.ok) {
                    throw new Error(`Failed to load thread context: ${contextResponse.status}`);
                }
                
                const contextData = await contextResponse.json();
                console.log('üîç Thread context loaded:', contextData.messages.length, 'messages');
                
                // Convert thread messages to conversation context format (last 10 messages)
                const recentMessages = contextData.messages.slice(-10); // Last 10 messages
                const conversationContext = recentMessages.map(msg => ({
                    role: msg.sender_role,
                    content: msg.content
                    // Remove timestamp as it's not needed for the API
                }));
                
                console.log('üîç Conversation context prepared:', conversationContext.length, 'messages');
                console.log('üîç Context preview:', conversationContext.map(msg => ({
                    role: msg.role,
                    content: msg.content.substring(0, 50) + '...'
                })));
                
                // Step 2: Send user message to backend
                console.log('üîç Sending user message to backend...');
                console.log('üîç Thread ID:', currentThreadId);
                console.log('üîç Message content:', message);
                
                const response = await fetch(`/api/threads/${currentThreadId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: message,
                        sender_role: 'user'
                    })
                });
                
                console.log('üîç Response status:', response.status);
                console.log('üîç Response ok:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Server error response:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('üîç Message sent successfully:', result);
                
                // Step 3: Get AI response using streaming endpoint with context
                const aiResponse = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        conversationId: currentThreadId,
                        context: conversationContext // Send conversation history as context
                    })
                });
                
                if (!aiResponse.ok) {
                    throw new Error(`HTTP error! status: ${aiResponse.status}`);
                }
                
                // Handle streaming response
                console.log('üîç Starting to process streaming response...');
                const reader = aiResponse.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                
                try {
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) {
                            console.log('üîç Streaming completed');
                            break;
                        }
                        
                        const chunk = decoder.decode(value);
                        console.log('üîç Received chunk:', chunk.substring(0, 100) + '...');
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                console.log('üîç Processing data line:', data.substring(0, 50) + '...');
                                if (data && data !== '[DONE]') {
                                    try {
                                        const parsed = JSON.parse(data);
                                        console.log('üîç Parsed data:', parsed);
                                        if (parsed.content) {
                                            fullResponse += parsed.content;
                                            console.log('üîç Full response so far:', fullResponse.substring(0, 100) + '...');
                                            // Update AI message with current response
                                            const formattedContent = formatChatContent(fullResponse);
                                            aiMessageBubble.innerHTML = formattedContent;
                                            // Scroll to bottom
                                            chatArea.scrollTop = chatArea.scrollHeight;
                                        }
                                    } catch (e) {
                                        console.log('üîç JSON parse error:', e.message);
                                        // Try to handle plain text response
                                        if (data && !data.includes('{') && !data.includes('}')) {
                                            fullResponse += data;
                                            console.log('üîç Added plain text:', data);
                                            const formattedContent = formatChatContent(fullResponse);
                                            aiMessageBubble.innerHTML = formattedContent;
                                            chatArea.scrollTop = chatArea.scrollHeight;
                                        }
                                    }
                                } else if (data === '[DONE]') {
                                    console.log('üîç Streaming completed');
                                    break;
                                }
                            }
                        }
                    }
                } finally {
                    reader.releaseLock();
                }
                
                console.log('üîç Final full response:', fullResponse);
                
                console.log('üîç AI response received (streaming):', fullResponse);
                
                // Save AI response to database (only if we have content)
                if (fullResponse && fullResponse.trim()) {
                    try {
                        console.log('üîç Saving AI response to database:', fullResponse.substring(0, 100) + '...');
                        const aiResponseSave = await fetch(`/api/threads/${currentThreadId}/messages`, {
                    method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                    body: JSON.stringify({
                                content: fullResponse,
                                sender_role: 'assistant'
                    })
                });
                
                        if (aiResponseSave.ok) {
                            console.log('üîç AI response saved to database');
            } else {
                            const errorText = await aiResponseSave.text();
                            console.log('‚ö†Ô∏è Failed to save AI response to database:', errorText);
                }
            } catch (error) {
                        console.log('‚ö†Ô∏è Error saving AI response:', error);
                    }
                } else {
                    console.log('‚ö†Ô∏è AI response is empty, not saving to database');
                }
                
                // Scroll to bottom
                chatArea.scrollTop = chatArea.scrollHeight;
                
                // Show user input when response is complete for better UX
                if (userInputArea) {
                    userInputArea.style.display = 'flex';
                    console.log('üîç User input shown after response completion');
                }
                
                console.log('üîç ===== SEND MESSAGE FROM THREAD UI SUCCESS =====');
                
            } catch (error) {
                console.error('‚ùå Error sending message:', error);
                aiMessageBubble.innerHTML = '<span style="color: red;">ÿÆÿ∑ÿß ÿØÿ± ÿßÿ±ÿ≥ÿßŸÑ Ÿæ€åÿßŸÖ. ŸÑÿ∑ŸÅÿßŸã ÿØŸàÿ®ÿßÿ±Ÿá ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ€åÿØ.</span>';
                
                // Show user input on error for retry
                if (userInputArea) {
                    userInputArea.style.display = 'flex';
                    console.log('üîç User input shown after error');
                }
            }
        }

        // Hide initial chat state when loading from library with comprehensive debugging
        function hideInitialChatState() {
            console.log('üîç ===== HIDE INITIAL STATE DEBUG START =====');
            
            // Hide the main user input initially
            const mainUserInput = document.getElementById('main-user-input');
            console.log('üîç Main user input element:', mainUserInput);
            if (mainUserInput) {
                console.log('üîç Main user input current display:', mainUserInput.style.display);
                mainUserInput.style.display = 'none';
                console.log('üîç Main user input hidden');
            }
            
            // Hide the main chat messages container initially
            const chatMessages = document.getElementById('chat-messages');
            console.log('üîç Chat messages element:', chatMessages);
            if (chatMessages) {
                console.log('üîç Chat messages current display:', chatMessages.style.display);
                chatMessages.style.display = 'none';
                console.log('üîç Chat messages hidden');
            }
            
            // Hide the thin border separator
            const separator = document.querySelector('.border-b.border-gray-200');
            console.log('üîç Separator element:', separator);
            if (separator) {
                console.log('üîç Separator current display:', separator.style.display);
                separator.style.display = 'none';
                console.log('üîç Separator hidden');
            }
            
            // Ensure the second page is hidden initially - be more aggressive
            const secondPage = document.getElementById('second-gainsboro-page');
            console.log('üîç Second page element:', secondPage);
            if (secondPage) {
                console.log('üîç Second page classes:', secondPage.classList.toString());
                console.log('üîç Second page current display:', secondPage.style.display);
                
                // Force hide with multiple methods to ensure it's hidden
                secondPage.classList.add('hidden');
                secondPage.style.display = 'none';
                secondPage.style.visibility = 'hidden';
                secondPage.style.opacity = '0';
                secondPage.style.zIndex = '-1';
                console.log('üîç Second page aggressively hidden');
            }
            
            // Hide expanded input if it exists
            const expandedInput = document.getElementById('expanded-input-container');
            console.log('üîç Expanded input element:', expandedInput);
            if (expandedInput) {
                console.log('üîç Expanded input classes:', expandedInput.classList.toString());
                console.log('üîç Expanded input current display:', expandedInput.style.display);
                expandedInput.classList.add('hidden');
                expandedInput.style.display = 'none';
                console.log('üîç Expanded input hidden');
            }
            
            // Hide any streaming messages
            const streamingMessages = document.querySelectorAll('[id^="streaming-message-"]');
            console.log('üîç Streaming messages found:', streamingMessages.length);
            streamingMessages.forEach((msg, index) => {
                console.log(`üîç Streaming message ${index + 1}:`, msg.id, 'display:', msg.style.display);
                msg.style.display = 'none';
            });
            
            // Hide any existing messages in chat container
            if (chatMessages) {
                console.log('üîç Chat messages innerHTML length:', chatMessages.innerHTML.length);
                chatMessages.innerHTML = '';
                console.log('üîç Chat messages cleared');
            }
            
            // Reset any conflicting styles
            const body = document.body;
            console.log('üîç Body element:', body);
            if (body) {
                console.log('üîç Body current overflow:', body.style.overflow);
                body.style.overflow = 'auto';
                console.log('üîç Body overflow reset to auto');
            }
            
            console.log('üîç ===== HIDE INITIAL STATE DEBUG END =====');
        }

        // Save message to current thread
        async function saveMessageToThread(userMessage, aiResponse) {
            if (!currentThreadId) {
                console.log('‚ö†Ô∏è No thread loaded, skipping save');
                return;
            }
            
            try {
                const userId = localStorage.getItem('user_id');
                if (!userId) {
                    console.log('‚ö†Ô∏è No user logged in, skipping save');
                    return;
                }

                // Add user message to thread
                const userMessageResponse = await fetch(`/api/threads/${currentThreadId}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sender_role: 'user',
                        content: userMessage,
                        token_count: estimateTokenCount(userMessage)
                    })
                });

                // Add AI response to thread
                const aiMessageResponse = await fetch(`/api/threads/${currentThreadId}/messages`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sender_role: 'assistant',
                        content: aiResponse,
                        token_count: estimateTokenCount(aiResponse)
                    })
                });

                if (userMessageResponse.ok && aiMessageResponse.ok) {
                    console.log('‚úÖ Messages saved to thread:', currentThreadId);
                    } else {
                    console.error('‚ùå Failed to save messages to thread');
                    }
                
                } catch (error) {
                console.error('‚ùå Error saving messages to thread:', error);
            }
        }

        // Create new thread when starting a new conversation
        async function createNewThread(title) {
            try {
                // For MVP, use default user ID if no user is logged in
                let userId = localStorage.getItem('user_id');
                if (!userId) {
                    userId = '1'; // Default user ID for MVP
                    localStorage.setItem('user_id', userId);
                    console.log('üîß Using default user ID for MVP:', userId);
                }

                const response = await fetch('/api/threads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        title: title,
                        summary: null
                    })
                });

                const data = await response.json();
                if (data.success) {
                    currentThreadId = data.thread.id;
                    threadMessages = [];
                    isThreadLoaded = true;
                    console.log('‚úÖ New thread created:', currentThreadId);
                    return currentThreadId;
                } else {
                    console.error('‚ùå Failed to create thread:', data.error);
                    return null;
                }
            } catch (error) {
                console.error('‚ùå Error creating thread:', error);
                return null;
            }
        }

        // Get recent messages for AI context
        async function getThreadContext(maxTokens = 4000) {
            if (!currentThreadId) {
                return [];
            }

            try {
                const response = await fetch(`/api/threads/${currentThreadId}/context?max_tokens=${maxTokens}`);
                const data = await response.json();
                
                if (data.success) {
                    return data.messages;
                } else {
                    console.error('Failed to get thread context:', data.error);
                    return [];
                }
            } catch (error) {
                console.error('Error getting thread context:', error);
                return [];
            }
        }

        // Estimate token count (simple approximation)
        function estimateTokenCount(text) {
            // Rough approximation: 1 token ‚âà 4 characters for Persian/Arabic text
            return Math.ceil(text.length / 4);
        }

        // Check user login status
        function checkUserStatus() {
            const userId = localStorage.getItem('user_id');
            const userPhone = localStorage.getItem('user_phone');
            const isLoggedIn = localStorage.getItem('is_logged_in') === 'true';
            const isVerified = localStorage.getItem('is_verified') === 'true';
            
            if (!isLoggedIn || !userId || !userPhone || !isVerified) {
                // For MVP, set default values instead of clearing data
                localStorage.setItem('user_id', '1');
                localStorage.setItem('user_phone', '09123456789');
                localStorage.setItem('is_logged_in', 'true');
                localStorage.setItem('is_verified', 'true');
                console.log('üîß Set default user values for MVP');
            }
        }

        // Show login prompt
        function showLoginPrompt() {
            const chatMessages = document.getElementById('chat-messages');
            const loginPrompt = document.createElement('div');
            loginPrompt.className = 'flex justify-center items-center py-8';
            loginPrompt.innerHTML = `
                <div class="text-center">
                    <div class="text-gray-500 mb-4">üîê</div>
                    <h3 class="text-lg font-medium mb-2">ÿ®ÿ±ÿß€å ÿ∞ÿÆ€åÿ±Ÿá ⁄ØŸÅÿ™⁄ØŸàŸáÿß Ÿàÿßÿ±ÿØ ÿ¥Ÿà€åÿØ</h3>
                    <p class="text-gray-500 mb-4">⁄ØŸÅÿ™⁄ØŸàŸáÿß€å ÿ¥ŸÖÿß ÿØÿ± ⁄©ÿ™ÿßÿ®ÿÆÿßŸÜŸá ÿ∞ÿÆ€åÿ±Ÿá ÿÆŸàÿßŸáÿØ ÿ¥ÿØ</p>
                    <button onclick="window.location.href='auth.html'" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                        Ÿàÿ±ŸàÿØ / ÿ´ÿ®ÿ™ ŸÜÿßŸÖ
                    </button>
                </div>
            `;
            chatMessages.appendChild(loginPrompt);
        }
        
        // Function to go to test page
        function goToTest() {
            console.log('üîç Navigating to test page...');
            try {
                window.location.href = 'test.html';
            } catch (error) {
                console.error('‚ùå Navigation error:', error);
                // Fallback: try direct assignment
                window.location = 'test.html';
            }
        }
    </script>
</body>
</html>



